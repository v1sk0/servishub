{% extends "layouts/supplier.html" %}

{% block title %}Krediti - ServisHub{% endblock %}

{% block content %}
<div x-data="creditsPage()" x-init="init()">

    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Krediti</h1>
            <p class="text-gray-600 mt-1">Pregled stanja i istorija transakcija</p>
        </div>
    </div>

    <!-- Balance Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <!-- Current Balance -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center">
                    <svg class="w-5 h-5 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75C20.25 16.153 16.556 18 12 18s-8.25-1.847-8.25-4.125v-3.75m16.5 0c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125" />
                    </svg>
                </div>
                <p class="text-sm text-gray-500">Stanje</p>
            </div>
            <p class="text-3xl font-bold text-gray-900" x-text="balance.toFixed(0)"></p>
            <p class="text-xs text-gray-500 mt-1">kredita</p>
        </div>

        <!-- Purchased -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center">
                    <svg class="w-5 h-5 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <p class="text-sm text-gray-500">Kupljeno</p>
            </div>
            <p class="text-3xl font-bold text-gray-900" x-text="totalPurchased.toFixed(0)"></p>
            <p class="text-xs text-gray-500 mt-1">kredita ukupno</p>
        </div>

        <!-- Spent -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-10 h-10 rounded-lg bg-red-100 flex items-center justify-center">
                    <svg class="w-5 h-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6" />
                    </svg>
                </div>
                <p class="text-sm text-gray-500">Potroseno</p>
            </div>
            <p class="text-3xl font-bold text-gray-900" x-text="totalSpent.toFixed(0)"></p>
            <p class="text-xs text-gray-500 mt-1">kredita ukupno</p>
        </div>

        <!-- Free received -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-10 h-10 rounded-lg bg-amber-100 flex items-center justify-center">
                    <svg class="w-5 h-5 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 11.25v8.25a1.5 1.5 0 01-1.5 1.5H5.25a1.5 1.5 0 01-1.5-1.5v-8.25M12 4.875A2.625 2.625 0 109.375 7.5H12m0-2.625V7.5m0-2.625A2.625 2.625 0 1114.625 7.5H12m0 0V21m-8.625-9.75h18c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125h-18c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
                    </svg>
                </div>
                <p class="text-sm text-gray-500">Besplatno</p>
            </div>
            <p class="text-3xl font-bold text-gray-900" x-text="totalFree.toFixed(0)"></p>
            <p class="text-xs text-gray-500 mt-1">bonus kredita</p>
        </div>
    </div>

    <!-- Transaction History -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Istorija transakcija</h2>
        </div>

        <!-- Loading -->
        <div x-show="loading" class="p-8 text-center">
            <div class="inline-block w-6 h-6 border-2 border-purple-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="text-gray-500 mt-2">Ucitavanje...</p>
        </div>

        <!-- Empty state -->
        <div x-show="!loading && transactions.length === 0" class="p-8 text-center">
            <p class="text-gray-500">Nema transakcija</p>
        </div>

        <!-- Table -->
        <div x-show="!loading && transactions.length > 0" class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Datum</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Opis</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tip</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Iznos</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Stanje</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    <template x-for="txn in transactions" :key="txn.id">
                        <tr>
                            <td class="px-6 py-3 text-sm text-gray-500 whitespace-nowrap" x-text="formatDate(txn.created_at)"></td>
                            <td class="px-6 py-3 text-sm text-gray-900" x-text="txn.description || '-'"></td>
                            <td class="px-6 py-3">
                                <span class="inline-flex px-2 py-0.5 text-xs font-medium rounded-full"
                                      :class="getTypeClass(txn.type)"
                                      x-text="getTypeLabel(txn.type)"></span>
                            </td>
                            <td class="px-6 py-3 text-sm text-right font-medium whitespace-nowrap"
                                :class="txn.amount >= 0 ? 'text-green-600' : 'text-red-600'"
                                x-text="(txn.amount >= 0 ? '+' : '') + txn.amount.toFixed(0)"></td>
                            <td class="px-6 py-3 text-sm text-right text-gray-500 whitespace-nowrap"
                                x-text="txn.balance_after.toFixed(0)"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div x-show="totalPages > 1" class="px-6 py-3 border-t border-gray-200 flex items-center justify-between">
            <p class="text-sm text-gray-500">
                Strana <span x-text="page"></span> od <span x-text="totalPages"></span>
            </p>
            <div class="flex gap-2">
                <button @click="prevPage()" :disabled="page <= 1"
                        class="px-3 py-1 text-sm border rounded-lg disabled:opacity-50 hover:bg-gray-50">Prethodna</button>
                <button @click="nextPage()" :disabled="page >= totalPages"
                        class="px-3 py-1 text-sm border rounded-lg disabled:opacity-50 hover:bg-gray-50">Sledeca</button>
            </div>
        </div>
    </div>
</div>

<script>
function creditsPage() {
    return {
        balance: 0,
        totalPurchased: 0,
        totalSpent: 0,
        totalFree: 0,
        transactions: [],
        loading: true,
        page: 1,
        totalPages: 1,

        async init() {
            await Promise.all([
                this.loadBalance(),
                this.loadHistory()
            ]);
        },

        async loadBalance() {
            try {
                const data = await supplierApi('/credits/');
                this.balance = data.balance || 0;
                this.totalPurchased = data.total_purchased || 0;
                this.totalSpent = data.total_spent || 0;
                this.totalFree = data.total_received_free || 0;
            } catch (e) {
                console.error('Failed to load balance:', e);
            }
        },

        async loadHistory() {
            this.loading = true;
            try {
                const data = await supplierApi(`/credits/history?page=${this.page}&per_page=20`);
                this.transactions = data.transactions || [];
                this.totalPages = data.pages || 1;
            } catch (e) {
                console.error('Failed to load history:', e);
            } finally {
                this.loading = false;
            }
        },

        prevPage() {
            if (this.page > 1) {
                this.page--;
                this.loadHistory();
            }
        },

        nextPage() {
            if (this.page < this.totalPages) {
                this.page++;
                this.loadHistory();
            }
        },

        getTypeLabel(type) {
            const labels = {
                'PURCHASE': 'Kupovina',
                'WELCOME': 'Dobrodoslica',
                'PROMO': 'Promo',
                'CONNECTION_FEE': 'Narudzbina',
                'FEATURED': 'Istaknuto',
                'PREMIUM': 'Premium',
                'BOOST': 'Boost',
                'REFUND': 'Povracaj',
                'SMS_NOTIFICATION': 'SMS',
            };
            return labels[type] || type;
        },

        getTypeClass(type) {
            const classes = {
                'PURCHASE': 'bg-green-100 text-green-800',
                'WELCOME': 'bg-purple-100 text-purple-800',
                'PROMO': 'bg-amber-100 text-amber-800',
                'CONNECTION_FEE': 'bg-blue-100 text-blue-800',
                'REFUND': 'bg-gray-100 text-gray-800',
            };
            return classes[type] || 'bg-gray-100 text-gray-800';
        },

        formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('sr-RS') + ' ' + d.toLocaleTimeString('sr-RS', { hour: '2-digit', minute: '2-digit' });
        }
    };
}
</script>
{% endblock %}
