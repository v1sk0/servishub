{% extends "layouts/tenant.html" %}

{% block title %}Dnevni prometi - Finansije{% endblock %}

{% block page_content %}
<div x-data="posReport()" x-init="loadData()">
    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between mb-6">
        <div class="min-w-0 flex-1">
            <nav class="flex mb-2" aria-label="Breadcrumb">
                <ol class="flex items-center space-x-2">
                    <li><a href="/finance" class="text-gray-400 hover:text-gray-500">Finansije</a></li>
                    <li><span class="text-gray-400">/</span></li>
                    <li class="text-gray-700 font-medium">Dnevni prometi</li>
                </ol>
            </nav>
            <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl">Dnevni prometi po kasi</h2>
            <p class="mt-1 text-sm text-gray-500">Z-izvestaji po lokacijama</p>
        </div>
        <div class="mt-4 flex gap-2 md:ml-4 md:mt-0">
            <div class="inline-flex rounded-md shadow-sm">
                <button @click="setPeriod(7)" :class="days == 7 ? 'bg-primary-600 text-white' : 'bg-white text-gray-700'" class="px-3 py-2 text-sm font-medium rounded-l-md border border-gray-300">7 dana</button>
                <button @click="setPeriod(30)" :class="days == 30 ? 'bg-primary-600 text-white' : 'bg-white text-gray-700'" class="px-3 py-2 text-sm font-medium border-t border-b border-gray-300 -ml-px">30 dana</button>
                <button @click="setPeriod(90)" :class="days == 90 ? 'bg-primary-600 text-white' : 'bg-white text-gray-700'" class="px-3 py-2 text-sm font-medium border-t border-b border-gray-300 -ml-px">90 dana</button>
                <button @click="setPeriod(365)" :class="days == 365 ? 'bg-primary-600 text-white' : 'bg-white text-gray-700'" class="px-3 py-2 text-sm font-medium rounded-r-md border border-gray-300 -ml-px">Godina</button>
            </div>
        </div>
    </div>

    <!-- Summary RSD -->
    <div class="bg-white shadow rounded-lg p-6 mb-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Promet (RSD)</h3>
        <div class="grid grid-cols-1 gap-6 sm:grid-cols-3">
            <div>
                <p class="text-sm font-medium text-gray-500">Ukupan promet</p>
                <p class="mt-1 text-3xl font-semibold text-gray-900" x-text="formatPrice(data.total || 0)"></p>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-500">Gotovina</p>
                <p class="mt-1 text-3xl font-semibold text-green-600" x-text="formatPrice(data.total_cash || 0)"></p>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-500">Kartica</p>
                <p class="mt-1 text-3xl font-semibold text-blue-600" x-text="formatPrice(data.total_card || 0)"></p>
            </div>
        </div>
    </div>

    <!-- Summary EUR (prikazuje se samo ako ima EUR prometa) -->
    <div class="bg-yellow-50 border border-yellow-200 shadow rounded-lg p-6 mb-6" x-show="(data.total_eur || 0) > 0">
        <h3 class="text-lg font-medium text-yellow-800 mb-4">Promet (EUR) â€” Interna kasa</h3>
        <div class="grid grid-cols-1 gap-6 sm:grid-cols-3">
            <div>
                <p class="text-sm font-medium text-yellow-700">Ukupan promet</p>
                <p class="mt-1 text-3xl font-semibold text-yellow-900" x-text="formatEur(data.total_eur || 0)"></p>
            </div>
            <div>
                <p class="text-sm font-medium text-yellow-700">Gotovina</p>
                <p class="mt-1 text-3xl font-semibold text-green-600" x-text="formatEur(data.total_cash_eur || 0)"></p>
            </div>
            <div>
                <p class="text-sm font-medium text-yellow-700">Kartica</p>
                <p class="mt-1 text-3xl font-semibold text-blue-600" x-text="formatEur(data.total_card_eur || 0)"></p>
            </div>
        </div>
    </div>

    <!-- Table -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <table class="min-w-full divide-y divide-gray-300">
            <thead class="bg-gray-50">
                <tr>
                    <th class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900">Datum</th>
                    <th class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Lokacija</th>
                    <th class="px-3 py-3.5 text-right text-sm font-semibold text-gray-900">Gotovina</th>
                    <th class="px-3 py-3.5 text-right text-sm font-semibold text-gray-900">Kartica</th>
                    <th class="px-3 py-3.5 text-right text-sm font-semibold text-gray-900">Ukupno</th>
                    <th class="px-3 py-3.5 text-right text-sm font-semibold text-gray-900">Racuna</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                <template x-for="item in data.days || []" :key="item.date + '-' + item.location_id">
                    <tr>
                        <td class="py-3 pl-4 pr-3 text-sm font-medium text-gray-900" x-text="item.date"></td>
                        <td class="px-3 py-3 text-sm text-gray-500" x-text="item.location"></td>
                        <td class="px-3 py-3 text-right text-sm text-green-600" x-text="formatPrice(item.cash)"></td>
                        <td class="px-3 py-3 text-right text-sm text-blue-600" x-text="formatPrice(item.card)"></td>
                        <td class="px-3 py-3 text-right text-sm font-medium text-gray-900" x-text="formatPrice(item.total)"></td>
                        <td class="px-3 py-3 text-right text-sm text-gray-500" x-text="item.receipt_count"></td>
                    </tr>
                </template>
                <tr x-show="!data.days || data.days.length === 0">
                    <td colspan="6" class="px-6 py-12 text-center text-sm text-gray-500">Nema Z-izvestaja za izabrani period</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
function posReport() {
    return {
        days: 30,
        data: {},
        async loadData() {
            const token = sessionStorage.getItem('access_token');
            const res = await fetch(`/api/v1/finance/pos-daily?days=${this.days}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) this.data = await res.json();
        },
        setPeriod(d) { this.days = d; this.loadData(); },
        formatPrice(val) {
            return new Intl.NumberFormat('sr-RS', { style: 'currency', currency: 'RSD', maximumFractionDigits: 0 }).format(val || 0);
        },
        formatEur(val) {
            return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(val || 0);
        }
    }
}
</script>
{% endblock %}
