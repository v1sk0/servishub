{% extends "layouts/tenant.html" %}

{% block title %}Kasa - ServisHub{% endblock %}

{% block page_content %}
<style>
    /* TiM Kasa stil — fullscreen, keyboard-first */
    .kasa-wrapper { display: flex; flex-direction: column; height: calc(100vh - 64px); overflow: hidden; background: #f3f4f6; }
    .kasa-header { flex-shrink: 0; }
    .kasa-body { flex: 1; display: flex; overflow: hidden; gap: 0; }
    .kasa-table-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .kasa-right-panel { width: 280px; flex-shrink: 0; display: flex; flex-direction: column; border-left: 1px solid #e5e7eb; background: #fff; }
    .kasa-input-area { flex-shrink: 0; border-top: 1px solid #e5e7eb; background: #fff; }
    .kasa-bottom-bar { flex-shrink: 0; }
    .kasa-total { font-size: 3rem; font-weight: 700; color: #dc2626; font-family: 'Courier New', monospace; }
    .kasa-table-scroll { flex: 1; overflow-y: auto; }
    .kasa-table th { background: #374151; color: #fff; position: sticky; top: 0; z-index: 1; }
    .kasa-table tr.selected { background: #dbeafe; }
    .kasa-table tr:hover:not(.selected) { background: #f9fafb; }
    .kasa-fn-btn { display: inline-flex; flex-direction: column; align-items: center; padding: 6px 14px; border: 1px solid #d1d5db;
                   border-radius: 6px; background: #f9fafb; font-size: 12px; cursor: pointer; min-width: 80px; }
    .kasa-fn-btn:hover { background: #e5e7eb; }
    .kasa-fn-btn .fn-key { font-weight: 700; color: #374151; font-size: 11px; }
    .kasa-fn-btn .fn-label { color: #6b7280; font-size: 11px; }
    .last-receipt-row { display: flex; justify-content: space-between; padding: 2px 0; font-size: 13px; }
    .last-receipt-label { color: #6b7280; }
    .last-receipt-value { font-weight: 600; color: #111827; font-family: monospace; }

    /* Artikl lista modal */
    .artikl-modal { max-height: 70vh; }
    .artikl-item { cursor: pointer; transition: background 0.1s; }
    .artikl-item:hover { background: #eff6ff; }
    .artikl-item.selected { background: #dbeafe; }
</style>

<div x-data="posRegister()" x-init="init()" @keydown.window="handleKeyboard($event)" x-cloak>
    <div class="kasa-wrapper">

        <!-- ============ HEADER ============ -->
        <div class="kasa-header bg-white border-b border-gray-300 px-4 py-2 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <span class="font-bold text-gray-800 text-sm">Promet</span>
                <span class="font-bold text-gray-800 text-sm">Prodaja</span>
                <span class="inline-flex items-center rounded px-2 py-0.5 text-xs font-bold uppercase"
                      :class="fiscalMode ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'"
                      x-text="fiscalMode ? 'Fiskalna' : 'Interna'"></span>
                <span class="text-xs text-gray-500" x-text="currentLocationName"></span>
                <span class="text-xs text-gray-400" x-text="todayFormatted"></span>
            </div>
            <div class="flex items-center gap-3">
                <a href="/pos/receipts" class="text-xs text-gray-500 hover:text-gray-700">Svi racuni</a>
                <a href="/dashboard" class="text-xs text-gray-500 hover:text-gray-700">Nazad</a>
            </div>
        </div>

        <!-- ============ BODY ============ -->
        <div class="kasa-body">

            <!-- LEFT: Table + Input -->
            <div class="kasa-table-area">
                <!-- Table -->
                <div class="kasa-table-scroll bg-white">
                    <table class="kasa-table w-full text-sm">
                        <thead>
                            <tr>
                                <th class="text-left py-2 px-3 w-12">#</th>
                                <th class="text-left py-2 px-3 w-28">Sifra</th>
                                <th class="text-left py-2 px-3">Naziv</th>
                                <th class="text-center py-2 px-3 w-20">Kolicina</th>
                                <th class="text-right py-2 px-3 w-24">Cena</th>
                                <th class="text-center py-2 px-3 w-20">Popust(%)</th>
                                <th class="text-right py-2 px-3 w-28">Vrednost</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="(item, idx) in items" :key="idx">
                                <tr @click="selectedIndex = idx" :class="{'selected': selectedIndex === idx}"
                                    class="border-b border-gray-100 cursor-pointer">
                                    <td class="py-2 px-3 text-gray-400" x-text="idx + 1"></td>
                                    <td class="py-2 px-3 text-gray-600 font-mono text-xs" x-text="item.barcode || item.sku || '-'"></td>
                                    <td class="py-2 px-3 font-medium text-gray-900" x-text="item.name"></td>
                                    <td class="py-2 px-3 text-center" x-text="item.quantity"></td>
                                    <td class="py-2 px-3 text-right font-mono" x-text="fmtPrice(item.price)"></td>
                                    <td class="py-2 px-3 text-center" x-text="item.discount > 0 ? item.discount + '%' : ''"></td>
                                    <td class="py-2 px-3 text-right font-bold font-mono" x-text="fmtPrice(itemTotal(item))"></td>
                                </tr>
                            </template>
                            <!-- Prazni redovi za vizuelni efekat -->
                            <template x-if="items.length === 0">
                                <tr><td colspan="7" class="py-12 text-center text-gray-300 text-sm">Skenirajte barkod ili unesite sifru artikla</td></tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <!-- Input zona -->
                <div class="kasa-input-area p-4">
                    <div class="flex gap-6">
                        <!-- Leva strana: inputi -->
                        <div class="flex-1 space-y-2">
                            <!-- Sifra -->
                            <div class="flex items-center gap-2">
                                <label class="text-sm font-medium text-gray-700 w-20">Sifra:</label>
                                <input x-ref="barcodeInput" type="text" x-model="searchQuery"
                                       @keydown.enter.prevent="onBarcodeEnter()"
                                       class="flex-1 rounded border-gray-300 px-3 py-1.5 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                       placeholder="Barkod / sifra" autofocus>
                                <button @click="showArtiklModal = true" class="px-3 py-1.5 border border-gray-300 rounded bg-gray-50 hover:bg-gray-100 text-sm"
                                        title="Lista artikala">
                                    <svg class="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                                </button>
                            </div>
                            <!-- Naziv (readonly) -->
                            <div class="flex items-center gap-2">
                                <label class="text-sm font-medium text-gray-700 w-20">Naziv:</label>
                                <input type="text" x-model="pendingItem.name" readonly tabindex="-1"
                                       class="flex-1 rounded border-gray-200 bg-gray-50 px-3 py-1.5 text-sm">
                            </div>
                            <!-- Kolicina + Rezim -->
                            <div class="flex items-center gap-2">
                                <label class="text-sm font-medium text-gray-700 w-20">Kolicina:</label>
                                <input x-ref="qtyInput" type="number" x-model.number="pendingItem.quantity" min="1" step="1"
                                       @keydown.enter.prevent="confirmPendingItem()"
                                       class="w-20 rounded border-gray-300 px-3 py-1.5 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <select x-model="qtyMode" class="rounded border-gray-300 px-2 py-1.5 text-xs text-gray-600">
                                    <option value="auto">Bez unosa kolicine</option>
                                    <option value="manual">Unos kolicine</option>
                                </select>
                                <button @click="confirmPendingItem()" x-show="pendingItem.name"
                                        class="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-500">
                                    Dodaj
                                </button>
                            </div>
                            <!-- Cena + Izmena cene -->
                            <div class="flex items-center gap-2">
                                <label class="text-sm font-medium text-gray-700 w-20">Cena:</label>
                                <input type="number" x-model.number="pendingItem.price" step="0.01"
                                       :readonly="!allowPriceEdit" :class="allowPriceEdit ? '' : 'bg-gray-50'"
                                       class="w-28 rounded border-gray-300 px-3 py-1.5 text-sm shadow-sm">
                                <label class="flex items-center gap-1 text-xs text-gray-500 cursor-pointer">
                                    <input type="checkbox" x-model="allowPriceEdit" class="rounded border-gray-300 text-blue-600">
                                    Izmena cene
                                </label>
                            </div>
                            <!-- Popust -->
                            <div class="flex items-center gap-2">
                                <label class="text-sm font-medium text-gray-700 w-20">Popust:</label>
                                <select x-model="pendingItem.discount" class="rounded border-gray-300 px-2 py-1.5 text-sm text-gray-600">
                                    <option value="0">Bez popusta</option>
                                    <option value="5">5%</option>
                                    <option value="10">10%</option>
                                    <option value="15">15%</option>
                                    <option value="20">20%</option>
                                    <option value="25">25%</option>
                                    <option value="30">30%</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT PANEL: Total + Poslednji racun -->
            <div class="kasa-right-panel">
                <!-- Total -->
                <div class="flex-1 flex flex-col items-center justify-center p-6">
                    <div class="kasa-total" x-text="fmtPrice(total)"></div>
                    <div class="text-xs text-gray-400 mt-1">RSD</div>
                </div>

                <!-- Poslednji racun -->
                <div class="border-t border-gray-200 p-4" x-show="lastReceipt">
                    <div class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Poslednji racun</div>
                    <div class="space-y-1">
                        <div class="last-receipt-row">
                            <span class="last-receipt-label">Iznos:</span>
                            <span class="last-receipt-value" x-text="lastReceipt ? fmtPrice(lastReceipt.total) : '0,00'"></span>
                        </div>
                        <div class="last-receipt-row">
                            <span class="last-receipt-label">Kartica:</span>
                            <span class="last-receipt-value" x-text="lastReceipt ? fmtPrice(lastReceipt.card || 0) : '0,00'"></span>
                        </div>
                        <div class="last-receipt-row">
                            <span class="last-receipt-label">Gotovina:</span>
                            <span class="last-receipt-value" x-text="lastReceipt ? fmtPrice(lastReceipt.cash || 0) : '0,00'"></span>
                        </div>
                        <div class="last-receipt-row">
                            <span class="last-receipt-label">Povracaj:</span>
                            <span class="last-receipt-value" x-text="lastReceipt ? fmtPrice(lastReceipt.change || 0) : '0,00'"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============ BOTTOM BAR — Function keys ============ -->
        <div class="kasa-bottom-bar bg-white border-t border-gray-300 px-4 py-2 flex items-center gap-2 flex-wrap">
            <button class="kasa-fn-btn" @click="openCashDrawer()">
                <span class="fn-key">F5</span><span class="fn-label">Fioka</span>
            </button>
            <button class="kasa-fn-btn" @click="openPaymentModal()" :disabled="items.length === 0"
                    :class="items.length === 0 ? 'opacity-40 cursor-not-allowed' : ''">
                <span class="fn-key">F6</span><span class="fn-label">Racun</span>
            </button>
            <button class="kasa-fn-btn" @click="editQuantity()">
                <span class="fn-key">F7</span><span class="fn-label">Kolicina</span>
            </button>
            <button class="kasa-fn-btn" @click="deleteItem()">
                <span class="fn-key">F8</span><span class="fn-label">Brisanje</span>
            </button>
            <button class="kasa-fn-btn" @click="applyDiscount()">
                <span class="fn-key">ALT+P</span><span class="fn-label">Popust</span>
            </button>
            <div class="flex-1"></div>
            <button class="kasa-fn-btn" @click="generateZReport()">
                <span class="fn-key">Z</span><span class="fn-label">Dnevni izvestaj</span>
            </button>
            <button class="kasa-fn-btn" @click="showXReport()">
                <span class="fn-key">X</span><span class="fn-label">Tekuci promet</span>
            </button>
        </div>
    </div>

    <!-- ============ F6 PAYMENT MODAL ============ -->
    <div x-show="paymentModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center"
         @keydown.escape.window="if(paymentModal) paymentModal = false">
        <div class="fixed inset-0 bg-black/50" @click="paymentModal = false"></div>
        <div class="relative bg-white rounded-lg shadow-2xl w-full max-w-2xl mx-4" @keydown.enter.prevent="confirmPayment()">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-bold text-gray-900">Izdavanje racuna</h3>
            </div>
            <div class="flex">
                <!-- Leva strana: iznosi -->
                <div class="w-1/2 p-6 border-r border-gray-200">
                    <div class="mb-6">
                        <div class="text-sm text-gray-500">Ukupno:</div>
                        <div class="text-3xl font-bold text-gray-900 font-mono" x-text="fmtPrice(total)"></div>
                    </div>

                    <div class="space-y-3">
                        <div class="flex items-center gap-3">
                            <button @click="payMethod = 'CARD'; focusPaymentInput()"
                                    class="w-24 text-left px-3 py-2 rounded text-sm font-medium border"
                                    :class="payMethod === 'CARD' ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-gray-200'">
                                Kartica <span class="text-xs text-gray-400">F6</span>
                            </button>
                            <input type="number" x-model.number="pay.card" step="0.01" min="0" @input="recalcCash()"
                                   class="flex-1 rounded border-gray-300 px-3 py-2 text-sm text-right font-mono">
                        </div>
                        <div class="flex items-center gap-3">
                            <button @click="payMethod = 'TRANSFER'; focusPaymentInput()"
                                    class="w-24 text-left px-3 py-2 rounded text-sm font-medium border"
                                    :class="payMethod === 'TRANSFER' ? 'border-purple-500 bg-purple-50 text-purple-700' : 'border-gray-200'">
                                Prenos
                            </button>
                            <input type="number" x-model.number="pay.transfer" step="0.01" min="0" @input="recalcCash()"
                                   class="flex-1 rounded border-gray-300 px-3 py-2 text-sm text-right font-mono">
                        </div>
                        <div class="flex items-center gap-3">
                            <button @click="payMethod = 'CASH'; focusPaymentInput()"
                                    class="w-24 text-left px-3 py-2 rounded text-sm font-bold border"
                                    :class="payMethod === 'CASH' ? 'border-green-500 bg-green-50 text-green-700' : 'border-gray-200'">
                                Gotovina
                            </button>
                            <input x-ref="cashInput" type="number" x-model.number="pay.cash" step="0.01" min="0"
                                   @input="calcChange()"
                                   class="flex-1 rounded border-gray-300 px-3 py-2 text-sm text-right font-mono font-bold bg-blue-50 border-blue-300 focus:border-blue-500 focus:ring-blue-500">
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-bold text-gray-700">Povracaj:</span>
                            <span class="text-2xl font-bold font-mono" :class="payChange >= 0 ? 'text-gray-900' : 'text-red-600'"
                                  x-text="fmtPrice(payChange)"></span>
                        </div>
                    </div>
                </div>

                <!-- Desna strana: opcije -->
                <div class="w-1/2 p-6">
                    <div class="space-y-4">
                        <!-- Popust na ceo racun -->
                        <div>
                            <label class="text-sm font-medium text-gray-700">Popust na ceo racun:</label>
                            <div class="flex items-center gap-2 mt-1">
                                <input type="number" x-model.number="receiptDiscount" step="0.01" min="0" max="100"
                                       @input="recalcCash()"
                                       class="w-20 rounded border-gray-300 px-3 py-1.5 text-sm text-right">
                                <span class="text-sm text-gray-500">%</span>
                            </div>
                        </div>

                        <!-- B2B -->
                        <div>
                            <label class="flex items-center gap-2 text-sm cursor-pointer">
                                <input type="checkbox" x-model="showB2B" class="rounded border-gray-300 text-blue-600">
                                <span class="font-medium text-gray-700">Racun za komitenta</span>
                            </label>
                            <div x-show="showB2B" class="mt-2 space-y-2">
                                <input type="text" x-model="buyerPib" placeholder="PIB kupca (9 cifara)"
                                       class="w-full rounded border-gray-300 px-3 py-1.5 text-sm">
                                <input type="text" x-model="buyerName" placeholder="Naziv kupca"
                                       class="w-full rounded border-gray-300 px-3 py-1.5 text-sm">
                            </div>
                        </div>

                        <!-- Napomena -->
                        <div>
                            <label class="text-sm font-medium text-gray-700">Napomena:</label>
                            <textarea x-model="receiptNote" rows="2"
                                      class="mt-1 w-full rounded border-gray-300 px-3 py-1.5 text-sm"></textarea>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end gap-3">
                        <button @click="confirmPayment()" :disabled="issuing"
                                class="px-6 py-2.5 bg-blue-600 text-white rounded font-bold text-sm hover:bg-blue-500 disabled:opacity-50">
                            <span x-text="issuing ? 'Izdavanje...' : 'Potvrdi'"></span>
                        </button>
                        <button @click="paymentModal = false"
                                class="px-4 py-2.5 bg-gray-100 text-gray-700 rounded font-medium text-sm hover:bg-gray-200">
                            Odustani <span class="text-xs text-gray-400">ESC</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============ ARTIKL LISTA MODAL ============ -->
    <div x-show="showArtiklModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center"
         @keydown.escape.window="if(showArtiklModal) showArtiklModal = false">
        <div class="fixed inset-0 bg-black/50" @click="showArtiklModal = false"></div>
        <div class="relative bg-white rounded-lg shadow-2xl w-full max-w-xl mx-4 artikl-modal flex flex-col">
            <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-sm font-bold text-gray-900">Odabir artikla</h3>
                <button @click="showArtiklModal = false" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div class="px-4 py-3 border-b border-gray-100">
                <input x-ref="artiklSearch" type="text" x-model="artiklSearchQuery"
                       @input.debounce.300ms="searchArtikli()"
                       placeholder="Pretrazi po imenu, barkodu, sifri..."
                       class="w-full rounded border-gray-300 px-3 py-2 text-sm">
            </div>
            <div class="flex-1 overflow-y-auto">
                <template x-for="a in artiklResults" :key="a.type + '-' + a.id">
                    <div @click="selectArtikl(a)" class="artikl-item px-4 py-2 border-b border-gray-50 flex items-center justify-between">
                        <div>
                            <div class="text-sm font-medium text-gray-900" x-text="a.name"></div>
                            <div class="flex items-center gap-2 mt-0.5">
                                <span class="text-xs px-1.5 py-0.5 rounded"
                                      :class="{'bg-purple-100 text-purple-700': a.type==='GOODS', 'bg-orange-100 text-orange-700': a.type==='SPARE_PART', 'bg-cyan-100 text-cyan-700': a.type==='PHONE'}"
                                      x-text="a.type==='GOODS' ? 'Roba' : a.type==='SPARE_PART' ? 'Deo' : 'Telefon'"></span>
                                <span class="text-xs text-gray-400" x-show="a.barcode" x-text="a.barcode"></span>
                                <span class="text-xs text-gray-400" x-text="'Stanje: ' + a.stock"></span>
                            </div>
                        </div>
                        <span class="text-sm font-bold font-mono text-gray-900" x-text="fmtPrice(a.price)"></span>
                    </div>
                </template>
                <div x-show="artiklSearchQuery && artiklResults.length === 0" class="p-6 text-center text-sm text-gray-400">
                    Nema rezultata
                </div>
                <div x-show="!artiklSearchQuery" class="p-6 text-center text-sm text-gray-400">
                    Unesite tekst za pretragu
                </div>
            </div>
        </div>
    </div>

    <!-- ============ X REPORT MODAL ============ -->
    <div x-show="showXReportModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center"
         @keydown.escape.window="if(showXReportModal) showXReportModal = false">
        <div class="fixed inset-0 bg-black/50" @click="showXReportModal = false"></div>
        <div class="relative bg-white rounded-lg shadow-2xl w-full max-w-md mx-4 p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">X Izvestaj - Tekuci promet</h3>
            <template x-if="xReportData">
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between"><span class="text-gray-500">Promet:</span><span class="font-bold font-mono" x-text="fmtPrice(xReportData.total_revenue) + ' RSD'"></span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Trosak:</span><span class="font-mono" x-text="fmtPrice(xReportData.total_cost) + ' RSD'"></span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Profit:</span><span class="font-bold font-mono text-green-600" x-text="fmtPrice(xReportData.total_profit) + ' RSD'"></span></div>
                    <div class="border-t border-gray-200 pt-2"></div>
                    <div class="flex justify-between"><span class="text-gray-500">Gotovina:</span><span class="font-mono" x-text="fmtPrice(xReportData.total_cash) + ' RSD'"></span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Kartica:</span><span class="font-mono" x-text="fmtPrice(xReportData.total_card) + ' RSD'"></span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Prenos:</span><span class="font-mono" x-text="fmtPrice(xReportData.total_transfer) + ' RSD'"></span></div>
                    <div class="border-t border-gray-200 pt-2"></div>
                    <div class="flex justify-between"><span class="text-gray-500">Racuni:</span><span class="font-mono" x-text="xReportData.receipt_count"></span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Stornirani:</span><span class="font-mono" x-text="xReportData.voided_count"></span></div>
                </div>
            </template>
            <div class="mt-4 text-right">
                <button @click="showXReportModal = false" class="px-4 py-2 bg-gray-100 text-gray-700 rounded text-sm hover:bg-gray-200">Zatvori</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div x-show="toast.show" x-cloak
         x-transition:enter="transform ease-out duration-300"
         x-transition:enter-start="translate-y-2 opacity-0"
         x-transition:enter-end="translate-y-0 opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed bottom-16 right-4 z-50 rounded-lg p-4 shadow-lg max-w-sm"
         :class="toast.type === 'success' ? 'bg-green-50 text-green-800 border border-green-200' : 'bg-red-50 text-red-800 border border-red-200'">
        <span x-text="toast.message"></span>
    </div>
</div>

<script>
function posRegister() {
    return {
        // Session
        session: null,
        fiscalMode: false,
        currentLocationId: null,
        currentLocationName: '',
        locations: [],

        // Items (lokalni — ne cuvaju se na serveru dok se ne izda)
        items: [],
        selectedIndex: -1,

        // Pending item (dok se unosi)
        pendingItem: { name: '', price: 0, quantity: 1, discount: 0, type: '', id: null, barcode: '', purchase_price: 0 },
        searchQuery: '',
        qtyMode: 'auto', // 'auto' = bez unosa kol, 'manual' = unos kol
        allowPriceEdit: false,

        // Payment modal
        paymentModal: false,
        payMethod: 'CASH',
        pay: { cash: 0, card: 0, transfer: 0 },
        payChange: 0,
        receiptDiscount: 0,
        receiptNote: '',
        showB2B: false,
        buyerPib: '',
        buyerName: '',
        issuing: false,

        // Artikl modal
        showArtiklModal: false,
        artiklSearchQuery: '',
        artiklResults: [],

        // Last receipt
        lastReceipt: null,

        // X Report
        showXReportModal: false,
        xReportData: null,

        // Toast
        toast: { show: false, message: '', type: 'success' },

        // Computed
        get total() {
            return this.items.reduce((sum, i) => sum + this.itemTotal(i), 0);
        },

        get todayFormatted() {
            return new Date().toLocaleDateString('sr-RS');
        },

        itemTotal(item) {
            const base = item.price * item.quantity;
            return item.discount > 0 ? base * (1 - item.discount / 100) : base;
        },

        // ==========================================
        // INIT
        // ==========================================
        async init() {
            await this.loadUserLocation();
            await this.loadSession();
            this.$nextTick(() => {
                if (this.$refs.barcodeInput) this.$refs.barcodeInput.focus();
            });
        },

        async loadUserLocation() {
            try {
                const res = await api('/api/v1/auth/me');
                if (res.ok) {
                    const data = await res.json();
                    this.locations = data.locations || [];
                    if (this.locations.length >= 1) {
                        const primary = this.locations.find(l => l.is_primary) || this.locations[0];
                        this.currentLocationId = primary.id;
                        this.currentLocationName = primary.name;
                    }
                }
            } catch (e) { console.error('Failed to load location', e); }
        },

        async loadSession() {
            if (!this.currentLocationId) return;
            try {
                const res = await api(`/api/v1/pos/register/current?location_id=${this.currentLocationId}`);
                if (res.ok) {
                    this.session = await res.json();
                    this.fiscalMode = this.session.fiscal_mode || false;
                }
            } catch (e) { console.error('Failed to load session', e); }
        },

        // ==========================================
        // KEYBOARD
        // ==========================================
        handleKeyboard(e) {
            // Dozvoli F-keys uvek
            if (e.key === 'F5') { e.preventDefault(); this.openCashDrawer(); }
            else if (e.key === 'F6') { e.preventDefault(); if (this.items.length > 0) this.openPaymentModal(); }
            else if (e.key === 'F7') { e.preventDefault(); this.editQuantity(); }
            else if (e.key === 'F8') { e.preventDefault(); this.deleteItem(); }
            else if (e.altKey && (e.key === 'p' || e.key === 'P')) { e.preventDefault(); this.applyDiscount(); }
            else if (e.key === 'Escape') {
                if (this.paymentModal) { this.paymentModal = false; }
                else if (this.showArtiklModal) { this.showArtiklModal = false; }
                else if (this.showXReportModal) { this.showXReportModal = false; }
            }
        },

        // ==========================================
        // BARCODE / SEARCH
        // ==========================================
        async onBarcodeEnter() {
            const q = this.searchQuery.trim();
            if (!q) return;

            try {
                const res = await api(`/api/v1/pos/search-items?q=${encodeURIComponent(q)}`);
                if (!res.ok) return;
                const data = await res.json();
                const results = data.items || [];

                if (results.length === 0) {
                    this.showToast('Artikal nije pronadjen: ' + q, 'error');
                    return;
                }

                if (results.length === 1) {
                    this.selectArtikl(results[0]);
                } else {
                    // Vise rezultata — otvori modal
                    this.artiklResults = results;
                    this.artiklSearchQuery = q;
                    this.showArtiklModal = true;
                }
            } catch (e) {
                this.showToast('Greska pri pretrazi', 'error');
            }
        },

        selectArtikl(a) {
            this.pendingItem = {
                name: a.name,
                price: a.price,
                quantity: 1,
                discount: 0,
                type: a.type,
                id: a.id,
                barcode: a.barcode || '',
                purchase_price: a.purchase_price || 0,
            };
            this.showArtiklModal = false;
            this.searchQuery = '';

            if (this.qtyMode === 'auto') {
                // Odmah dodaj sa qty=1
                this.confirmPendingItem();
            } else {
                // Focus na kolicinu
                this.$nextTick(() => {
                    if (this.$refs.qtyInput) this.$refs.qtyInput.focus();
                });
            }
        },

        confirmPendingItem() {
            if (!this.pendingItem.name) return;

            // Proveri da li vec postoji isti artikal — povecaj kolicinu
            const existing = this.items.find(i => i.type === this.pendingItem.type && i.id === this.pendingItem.id && i.id !== null);
            if (existing && this.qtyMode === 'auto') {
                existing.quantity += this.pendingItem.quantity;
            } else {
                this.items.push({ ...this.pendingItem });
            }

            // Reset
            this.pendingItem = { name: '', price: 0, quantity: 1, discount: 0, type: '', id: null, barcode: '', purchase_price: 0 };
            this.searchQuery = '';
            this.selectedIndex = this.items.length - 1;

            this.$nextTick(() => {
                if (this.$refs.barcodeInput) this.$refs.barcodeInput.focus();
            });
        },

        // ==========================================
        // ARTIKL MODAL SEARCH
        // ==========================================
        async searchArtikli() {
            if (this.artiklSearchQuery.length < 2) { this.artiklResults = []; return; }
            try {
                const res = await api(`/api/v1/pos/search-items?q=${encodeURIComponent(this.artiklSearchQuery)}`);
                if (res.ok) {
                    const data = await res.json();
                    this.artiklResults = data.items || [];
                }
            } catch (e) { console.error(e); }
        },

        // ==========================================
        // ITEM OPERATIONS (F7, F8, ALT+P)
        // ==========================================
        editQuantity() {
            if (this.selectedIndex < 0 || this.selectedIndex >= this.items.length) {
                this.showToast('Izaberite stavku u tabeli', 'error');
                return;
            }
            const newQty = prompt('Nova kolicina:', this.items[this.selectedIndex].quantity);
            if (newQty !== null && !isNaN(newQty) && parseInt(newQty) > 0) {
                this.items[this.selectedIndex].quantity = parseInt(newQty);
            }
        },

        deleteItem() {
            if (this.selectedIndex < 0 || this.selectedIndex >= this.items.length) {
                this.showToast('Izaberite stavku u tabeli', 'error');
                return;
            }
            this.items.splice(this.selectedIndex, 1);
            if (this.selectedIndex >= this.items.length) this.selectedIndex = this.items.length - 1;
        },

        applyDiscount() {
            if (this.selectedIndex < 0 || this.selectedIndex >= this.items.length) {
                this.showToast('Izaberite stavku u tabeli', 'error');
                return;
            }
            const disc = prompt('Popust (%):', this.items[this.selectedIndex].discount);
            if (disc !== null && !isNaN(disc) && parseFloat(disc) >= 0 && parseFloat(disc) <= 100) {
                this.items[this.selectedIndex].discount = parseFloat(disc);
            }
        },

        openCashDrawer() {
            this.showToast('Fioka otvorena (stub)', 'success');
        },

        // ==========================================
        // F6 — PAYMENT MODAL
        // ==========================================
        openPaymentModal() {
            if (this.items.length === 0) return;

            this.payMethod = 'CASH';
            this.pay = { cash: this.total, card: 0, transfer: 0 };
            this.payChange = 0;
            this.receiptDiscount = 0;
            this.receiptNote = '';
            this.showB2B = false;
            this.buyerPib = '';
            this.buyerName = '';
            this.paymentModal = true;

            this.$nextTick(() => {
                if (this.$refs.cashInput) {
                    this.$refs.cashInput.focus();
                    this.$refs.cashInput.select();
                }
            });
        },

        recalcCash() {
            // Gotovina = ukupno - kartica - prenos (sa popustom)
            const discountedTotal = this.getDiscountedTotal();
            this.pay.cash = Math.max(0, discountedTotal - (this.pay.card || 0) - (this.pay.transfer || 0));
            this.calcChange();
        },

        calcChange() {
            const discountedTotal = this.getDiscountedTotal();
            const totalPaid = (this.pay.cash || 0) + (this.pay.card || 0) + (this.pay.transfer || 0);
            this.payChange = Math.max(0, totalPaid - discountedTotal);
        },

        getDiscountedTotal() {
            if (this.receiptDiscount > 0) {
                return this.total * (1 - this.receiptDiscount / 100);
            }
            return this.total;
        },

        focusPaymentInput() {
            this.$nextTick(() => {
                if (this.$refs.cashInput) this.$refs.cashInput.focus();
            });
        },

        // ==========================================
        // CONFIRM PAYMENT — POST /receipts/quick
        // ==========================================
        async confirmPayment() {
            if (this.issuing || this.items.length === 0) return;
            this.issuing = true;

            // Determine payment method
            let pm = 'CASH';
            if (this.pay.card > 0 && this.pay.cash <= 0 && this.pay.transfer <= 0) pm = 'CARD';
            else if (this.pay.transfer > 0 && this.pay.cash <= 0 && this.pay.card <= 0) pm = 'TRANSFER';
            else if ((this.pay.card > 0 || this.pay.transfer > 0) && this.pay.cash > 0) pm = 'MIXED';

            const body = {
                location_id: this.currentLocationId,
                items: this.items.map(i => ({
                    type: i.type || 'CUSTOM',
                    id: i.id || null,
                    quantity: i.quantity,
                    unit_price: i.price,
                    discount_pct: i.discount || 0,
                    item_name: i.name,
                    purchase_price: i.purchase_price || 0,
                })),
                payment_method: pm,
                idempotency_key: `pos-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`,
            };

            if (this.pay.cash > 0) body.cash_received = this.pay.cash;
            if (this.pay.card > 0) body.card_amount = this.pay.card;
            if (this.pay.transfer > 0) body.transfer_amount = this.pay.transfer;
            if (this.receiptDiscount > 0) body.discount_pct = this.receiptDiscount;
            if (this.showB2B && this.buyerPib) {
                body.buyer_pib = this.buyerPib;
                body.buyer_name = this.buyerName;
            }

            try {
                const res = await api('/api/v1/pos/receipts/quick', 'POST', body);
                if (res.ok) {
                    const data = await res.json();

                    // Sacuvaj poslednji racun info
                    this.lastReceipt = {
                        total: data.total_amount,
                        card: this.pay.card,
                        cash: this.pay.cash,
                        change: data.cash_change || 0,
                        number: data.receipt_number,
                    };

                    this.items = [];
                    this.selectedIndex = -1;
                    this.paymentModal = false;

                    let msg = `Racun ${data.receipt_number} izdat`;
                    if (data.cash_change && data.cash_change > 0) {
                        msg += ` — Povracaj: ${this.fmtPrice(data.cash_change)} RSD`;
                    }
                    this.showToast(msg, 'success');

                    // Reload session stats
                    await this.loadSession();

                    this.$nextTick(() => {
                        if (this.$refs.barcodeInput) this.$refs.barcodeInput.focus();
                    });
                } else {
                    const err = await res.json();
                    this.showToast(err.error || 'Greska pri izdavanju', 'error');
                }
            } catch (e) {
                this.showToast('Greska: ' + e.message, 'error');
            } finally {
                this.issuing = false;
            }
        },

        // ==========================================
        // REPORTS
        // ==========================================
        async showXReport() {
            try {
                const res = await api(`/api/v1/pos/reports/x?location_id=${this.currentLocationId}`);
                if (res.ok) {
                    this.xReportData = await res.json();
                    this.showXReportModal = true;
                } else {
                    const err = await res.json();
                    this.showToast(err.error || 'Nema podataka', 'error');
                }
            } catch (e) {
                this.showToast('Greska', 'error');
            }
        },

        async generateZReport() {
            if (!confirm('Generisi dnevni Z izvestaj?')) return;
            try {
                const res = await api('/api/v1/pos/reports/z', 'POST', {
                    location_id: this.currentLocationId
                });
                if (res.ok) {
                    const data = await res.json();
                    this.showToast(`Z izvestaj generisan — Promet: ${this.fmtPrice(data.total_revenue)} RSD`, 'success');
                } else {
                    const err = await res.json();
                    this.showToast(err.error || 'Greska', 'error');
                }
            } catch (e) {
                this.showToast('Greska', 'error');
            }
        },

        // ==========================================
        // HELPERS
        // ==========================================
        fmtPrice(val) {
            if (val == null) return '0,00';
            return Number(val).toLocaleString('sr-RS', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        },

        showToast(message, type) {
            this.toast = { show: true, message, type };
            setTimeout(() => { this.toast.show = false; }, 4000);
        }
    };
}
</script>
{% endblock %}
