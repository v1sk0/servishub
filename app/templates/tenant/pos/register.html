{% extends "layouts/tenant.html" %}

{% block title %}Kasa - ServisHub{% endblock %}

{% block page_content %}
<style>
    /* ============================================
       POS REGISTER — GLASSMORPHISM DESIGN
       Works with both Light & Dark (.glass-theme)
       ============================================ */

    /* Break out of parent padding for fullscreen */
    .pos-fullscreen {
        margin: -1.5rem -1rem;
        height: calc(100vh - 64px);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
    }
    @media (min-width: 640px) { .pos-fullscreen { margin: -1.5rem -1.5rem; } }
    @media (min-width: 1024px) { .pos-fullscreen { margin: -1.5rem -2rem; } }

    /* ---- LIGHT THEME ---- */
    .pos-fullscreen {
        background: linear-gradient(160deg, #f0f4ff 0%, #e8edf5 40%, #f5f3ff 100%);
    }
    .pos-header {
        background: rgba(255,255,255,0.72);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        border-bottom: 1px solid rgba(148,163,184,0.2);
    }
    .pos-card {
        background: rgba(255,255,255,0.65);
        backdrop-filter: blur(16px) saturate(180%);
        -webkit-backdrop-filter: blur(16px) saturate(180%);
        border: 1px solid rgba(148,163,184,0.18);
        border-radius: 16px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.04), 0 1px 3px rgba(0,0,0,0.03);
    }
    .pos-card-solid {
        background: rgba(255,255,255,0.85);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(148,163,184,0.15);
        border-radius: 14px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.03);
    }
    .pos-table thead th {
        background: rgba(241,245,249,0.9);
        color: #475569;
        font-weight: 600;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 1px solid rgba(148,163,184,0.2);
    }
    .pos-table tbody tr { border-bottom: 1px solid rgba(148,163,184,0.08); transition: background 0.15s; }
    .pos-table tbody tr:hover { background: rgba(59,130,246,0.04); }
    .pos-table tbody tr.selected { background: rgba(59,130,246,0.08); }
    .pos-table td { color: #334155; }

    .pos-total-display {
        background: linear-gradient(135deg, rgba(255,255,255,0.8), rgba(241,245,249,0.6));
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(148,163,184,0.15);
        border-radius: 16px;
    }
    .pos-total-value { color: #dc2626; }
    .pos-total-label { color: #94a3b8; }

    .pos-bottom-bar {
        background: rgba(255,255,255,0.72);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        border-top: 1px solid rgba(148,163,184,0.2);
    }
    .pos-fn-btn {
        background: rgba(255,255,255,0.6);
        border: 1px solid rgba(148,163,184,0.2);
        border-radius: 10px;
        transition: all 0.2s cubic-bezier(0.4,0,0.2,1);
        box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    .pos-fn-btn:hover { background: rgba(255,255,255,0.9); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .pos-fn-btn:active { transform: translateY(0); }
    .pos-fn-btn .fn-key { color: #3b82f6; }
    .pos-fn-btn .fn-label { color: #64748b; }

    .pos-input {
        background: rgba(255,255,255,0.7) !important;
        border: 1px solid rgba(148,163,184,0.25) !important;
        border-radius: 10px !important;
        color: #1e293b !important;
        transition: all 0.2s !important;
    }
    .pos-input:focus {
        background: rgba(255,255,255,0.95) !important;
        border-color: rgba(59,130,246,0.5) !important;
        box-shadow: 0 0 0 3px rgba(59,130,246,0.1), 0 2px 8px rgba(59,130,246,0.08) !important;
    }
    .pos-input::placeholder { color: #94a3b8 !important; }

    .pos-badge { border-radius: 8px; font-weight: 600; letter-spacing: 0.03em; }
    .pos-badge-fiscal { background: rgba(34,197,94,0.12); color: #16a34a; border: 1px solid rgba(34,197,94,0.2); }
    .pos-badge-internal { background: rgba(59,130,246,0.12); color: #2563eb; border: 1px solid rgba(59,130,246,0.2); }

    .pos-last-receipt { color: #475569; }
    .pos-last-receipt .lr-label { color: #94a3b8; }
    .pos-last-receipt .lr-value { color: #1e293b; }

    /* Modal overlay */
    .pos-modal-overlay { background: rgba(15,23,42,0.4); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); }
    .pos-modal {
        background: rgba(255,255,255,0.92);
        backdrop-filter: blur(24px) saturate(200%);
        -webkit-backdrop-filter: blur(24px) saturate(200%);
        border: 1px solid rgba(148,163,184,0.2);
        border-radius: 20px;
        box-shadow: 0 25px 60px rgba(0,0,0,0.12), 0 4px 16px rgba(0,0,0,0.06);
    }
    .pos-modal h3 { color: #0f172a; }
    .pos-modal .modal-divider { border-color: rgba(148,163,184,0.15); }

    /* Payment method buttons */
    .pay-method-btn {
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.2s;
        border: 1.5px solid rgba(148,163,184,0.2);
        background: rgba(255,255,255,0.5);
        color: #475569;
    }
    .pay-method-btn:hover { background: rgba(255,255,255,0.8); }
    .pay-method-btn.pay-active-cash { border-color: rgba(34,197,94,0.5); background: rgba(34,197,94,0.08); color: #16a34a; }
    .pay-method-btn.pay-active-card { border-color: rgba(59,130,246,0.5); background: rgba(59,130,246,0.08); color: #2563eb; }
    .pay-method-btn.pay-active-transfer { border-color: rgba(139,92,246,0.5); background: rgba(139,92,246,0.08); color: #7c3aed; }

    .pos-btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
        color: #fff;
        border: none;
        border-radius: 12px;
        font-weight: 700;
        box-shadow: 0 4px 14px rgba(59,130,246,0.3);
        transition: all 0.2s;
    }
    .pos-btn-primary:hover { box-shadow: 0 6px 20px rgba(59,130,246,0.4); transform: translateY(-1px); }
    .pos-btn-primary:active { transform: translateY(0); }
    .pos-btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

    .pos-btn-secondary {
        background: rgba(148,163,184,0.12);
        color: #475569;
        border: 1px solid rgba(148,163,184,0.2);
        border-radius: 12px;
        font-weight: 600;
        transition: all 0.2s;
    }
    .pos-btn-secondary:hover { background: rgba(148,163,184,0.2); }

    /* Artikl item in list */
    .pos-artikl-item {
        transition: all 0.15s;
        border-radius: 10px;
        border: 1px solid transparent;
    }
    .pos-artikl-item:hover { background: rgba(59,130,246,0.06); border-color: rgba(59,130,246,0.12); }

    .pos-change-positive { color: #16a34a; }
    .pos-change-negative { color: #dc2626; }

    /* Empty state */
    .pos-empty-icon { color: rgba(148,163,184,0.4); }
    .pos-empty-text { color: #94a3b8; }

    /* Toast */
    .pos-toast {
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.12);
    }
    .pos-toast-success { background: rgba(34,197,94,0.12); border: 1px solid rgba(34,197,94,0.2); color: #16a34a; }
    .pos-toast-error { background: rgba(239,68,68,0.12); border: 1px solid rgba(239,68,68,0.2); color: #dc2626; }

    /* Scrollbar */
    .pos-scroll::-webkit-scrollbar { width: 6px; }
    .pos-scroll::-webkit-scrollbar-track { background: transparent; }
    .pos-scroll::-webkit-scrollbar-thumb { background: rgba(148,163,184,0.25); border-radius: 3px; }
    .pos-scroll::-webkit-scrollbar-thumb:hover { background: rgba(148,163,184,0.4); }

    /* ---- DARK / GLASS THEME ---- */
    .glass-theme .pos-fullscreen {
        background: radial-gradient(ellipse at 20% 0%, rgba(59,130,246,0.08) 0%, transparent 50%),
                    radial-gradient(ellipse at 80% 100%, rgba(139,92,246,0.06) 0%, transparent 50%),
                    linear-gradient(160deg, #0c1222 0%, #0a0f1a 50%, #0d1117 100%) !important;
    }
    .glass-theme .pos-header {
        background: rgba(15,23,42,0.7) !important;
        border-bottom-color: rgba(255,255,255,0.06) !important;
    }
    .glass-theme .pos-card {
        background: rgba(255,255,255,0.04) !important;
        border-color: rgba(255,255,255,0.06) !important;
        box-shadow: 0 4px 24px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.04) !important;
    }
    .glass-theme .pos-card-solid {
        background: rgba(255,255,255,0.06) !important;
        border-color: rgba(255,255,255,0.08) !important;
        box-shadow: 0 2px 12px rgba(0,0,0,0.15) !important;
    }
    .glass-theme .pos-table thead th {
        background: rgba(255,255,255,0.03) !important;
        color: #64748b !important;
        border-bottom-color: rgba(255,255,255,0.06) !important;
    }
    .glass-theme .pos-table tbody tr { border-bottom-color: rgba(255,255,255,0.04) !important; }
    .glass-theme .pos-table tbody tr:hover { background: rgba(255,255,255,0.04) !important; }
    .glass-theme .pos-table tbody tr.selected { background: rgba(59,130,246,0.1) !important; }
    .glass-theme .pos-table td { color: #cbd5e1 !important; }

    .glass-theme .pos-total-display {
        background: rgba(255,255,255,0.03) !important;
        border-color: rgba(255,255,255,0.06) !important;
    }
    .glass-theme .pos-total-value { color: #f87171 !important; }
    .glass-theme .pos-total-label { color: #64748b !important; }

    .glass-theme .pos-bottom-bar {
        background: rgba(15,23,42,0.7) !important;
        border-top-color: rgba(255,255,255,0.06) !important;
    }
    .glass-theme .pos-fn-btn {
        background: rgba(255,255,255,0.05) !important;
        border-color: rgba(255,255,255,0.08) !important;
        box-shadow: 0 1px 3px rgba(0,0,0,0.15) !important;
    }
    .glass-theme .pos-fn-btn:hover { background: rgba(255,255,255,0.1) !important; box-shadow: 0 4px 12px rgba(0,0,0,0.25) !important; }
    .glass-theme .pos-fn-btn .fn-key { color: #60a5fa !important; }
    .glass-theme .pos-fn-btn .fn-label { color: #94a3b8 !important; }

    .glass-theme .pos-input {
        background: rgba(255,255,255,0.04) !important;
        border-color: rgba(255,255,255,0.1) !important;
        color: #f1f5f9 !important;
    }
    .glass-theme .pos-input:focus {
        background: rgba(255,255,255,0.08) !important;
        border-color: rgba(96,165,250,0.4) !important;
        box-shadow: 0 0 0 3px rgba(96,165,250,0.1), 0 2px 8px rgba(96,165,250,0.06) !important;
    }
    .glass-theme .pos-input::placeholder { color: #475569 !important; }

    .glass-theme .pos-badge-fiscal { background: rgba(34,197,94,0.15) !important; color: #4ade80 !important; border-color: rgba(34,197,94,0.2) !important; }
    .glass-theme .pos-badge-internal { background: rgba(96,165,250,0.15) !important; color: #60a5fa !important; border-color: rgba(96,165,250,0.2) !important; }

    .glass-theme .pos-last-receipt { color: #94a3b8 !important; }
    .glass-theme .pos-last-receipt .lr-label { color: #64748b !important; }
    .glass-theme .pos-last-receipt .lr-value { color: #e2e8f0 !important; }

    .glass-theme .pos-modal-overlay { background: rgba(0,0,0,0.6) !important; }
    .glass-theme .pos-modal {
        background: rgba(15,23,42,0.92) !important;
        border-color: rgba(255,255,255,0.08) !important;
        box-shadow: 0 25px 60px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.05) !important;
    }
    .glass-theme .pos-modal h3 { color: #f1f5f9 !important; }
    .glass-theme .pos-modal .modal-divider { border-color: rgba(255,255,255,0.06) !important; }

    .glass-theme .pay-method-btn {
        border-color: rgba(255,255,255,0.08) !important;
        background: rgba(255,255,255,0.04) !important;
        color: #94a3b8 !important;
    }
    .glass-theme .pay-method-btn:hover { background: rgba(255,255,255,0.08) !important; }
    .glass-theme .pay-method-btn.pay-active-cash { border-color: rgba(34,197,94,0.4) !important; background: rgba(34,197,94,0.1) !important; color: #4ade80 !important; }
    .glass-theme .pay-method-btn.pay-active-card { border-color: rgba(96,165,250,0.4) !important; background: rgba(96,165,250,0.1) !important; color: #60a5fa !important; }
    .glass-theme .pay-method-btn.pay-active-transfer { border-color: rgba(167,139,250,0.4) !important; background: rgba(139,92,246,0.1) !important; color: #a78bfa !important; }

    .glass-theme .pos-btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #7c3aed 100%) !important;
        box-shadow: 0 4px 14px rgba(59,130,246,0.25) !important;
    }
    .glass-theme .pos-btn-secondary {
        background: rgba(255,255,255,0.06) !important;
        color: #94a3b8 !important;
        border-color: rgba(255,255,255,0.1) !important;
    }
    .glass-theme .pos-btn-secondary:hover { background: rgba(255,255,255,0.1) !important; }

    .glass-theme .pos-artikl-item:hover { background: rgba(255,255,255,0.06) !important; border-color: rgba(96,165,250,0.15) !important; }

    .glass-theme .pos-change-positive { color: #4ade80 !important; }
    .glass-theme .pos-change-negative { color: #f87171 !important; }

    .glass-theme .pos-empty-icon { color: rgba(255,255,255,0.08) !important; }
    .glass-theme .pos-empty-text { color: #475569 !important; }

    .glass-theme .pos-toast-success { background: rgba(34,197,94,0.15) !important; border-color: rgba(34,197,94,0.25) !important; color: #4ade80 !important; }
    .glass-theme .pos-toast-error { background: rgba(239,68,68,0.15) !important; border-color: rgba(239,68,68,0.25) !important; color: #f87171 !important; }

    .glass-theme .pos-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1) !important; }
    .glass-theme .pos-scroll::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2) !important; }

    /* Checkbox styling */
    .glass-theme .pos-checkbox {
        background: rgba(255,255,255,0.06) !important;
        border-color: rgba(255,255,255,0.15) !important;
    }

    /* ---- ANIMATIONS ---- */
    @keyframes pos-fade-in { from { opacity: 0; transform: scale(0.97) translateY(6px); } to { opacity: 1; transform: scale(1) translateY(0); } }
    @keyframes pos-slide-up { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    .pos-animate-in { animation: pos-fade-in 0.25s cubic-bezier(0.4,0,0.2,1); }
    .pos-animate-slide { animation: pos-slide-up 0.2s cubic-bezier(0.4,0,0.2,1); }

    /* ---- RESPONSIVE ---- */
    @media (max-width: 1024px) {
        .pos-body { flex-direction: column !important; }
        .pos-right-panel { width: 100% !important; flex-direction: row !important; border-left: none !important; border-top: 1px solid rgba(148,163,184,0.15); }
    }
</style>

<div x-data="posRegister()" x-init="init()" @keydown.window="handleKeyboard($event)" x-cloak>
    <div class="pos-fullscreen">

        <!-- ============ HEADER ============ -->
        <div class="pos-header flex-shrink-0 px-5 py-2.5 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <!-- Logo / branding -->
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                    </svg>
                    <span class="font-bold text-sm tracking-tight" style="color: inherit;">Kasa</span>
                </div>
                <div class="h-4 w-px bg-gray-300 dark:bg-gray-700 hidden sm:block"></div>
                <span class="pos-badge px-2.5 py-1 text-[10px] uppercase"
                      :class="fiscalMode ? 'pos-badge-fiscal' : 'pos-badge-internal'"
                      x-text="fiscalMode ? 'Fiskalna' : 'Interna'"></span>
                <span class="text-xs font-medium hidden sm:inline" style="color: inherit; opacity:0.6" x-text="currentLocationName"></span>
                <span class="text-[11px] hidden md:inline" style="color: inherit; opacity:0.4" x-text="todayFormatted"></span>
            </div>
            <div class="flex items-center gap-2">
                <a href="/pos/receipts" class="pos-btn-secondary px-3 py-1.5 text-xs inline-flex items-center gap-1.5">
                    <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    Racuni
                </a>
                <a href="/dashboard" class="pos-btn-secondary px-3 py-1.5 text-xs inline-flex items-center gap-1.5">
                    <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 17l-5-5m0 0l5-5m-5 5h12"/></svg>
                    Nazad
                </a>
            </div>
        </div>

        <!-- ============ BODY ============ -->
        <div class="pos-body flex-1 flex overflow-hidden p-3 gap-3" style="min-height: 0;">

            <!-- LEFT: Table + Input -->
            <div class="flex-1 flex flex-col gap-3 min-w-0">
                <!-- Table Card -->
                <div class="pos-card flex-1 flex flex-col overflow-hidden min-h-0">
                    <div class="pos-scroll flex-1 overflow-y-auto">
                        <table class="pos-table w-full text-sm" style="border-collapse: separate; border-spacing: 0;">
                            <thead>
                                <tr>
                                    <th class="text-left py-2.5 px-4 w-10 sticky top-0 z-10">#</th>
                                    <th class="text-left py-2.5 px-3 w-24 sticky top-0 z-10">Sifra</th>
                                    <th class="text-left py-2.5 px-3 sticky top-0 z-10">Naziv</th>
                                    <th class="text-center py-2.5 px-3 w-16 sticky top-0 z-10">Kol.</th>
                                    <th class="text-right py-2.5 px-3 w-24 sticky top-0 z-10">Cena</th>
                                    <th class="text-center py-2.5 px-3 w-16 sticky top-0 z-10">Pop.%</th>
                                    <th class="text-right py-2.5 px-4 w-28 sticky top-0 z-10">Vrednost</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(item, idx) in items" :key="idx">
                                    <tr @click="selectedIndex = idx"
                                        :class="{'selected': selectedIndex === idx}"
                                        class="cursor-pointer pos-animate-slide">
                                        <td class="py-2.5 px-4 tabular-nums" style="opacity:0.4" x-text="idx + 1"></td>
                                        <td class="py-2.5 px-3 font-mono text-xs" style="opacity:0.6" x-text="item.barcode || item.sku || '-'"></td>
                                        <td class="py-2.5 px-3 font-semibold" x-text="item.name"></td>
                                        <td class="py-2.5 px-3 text-center tabular-nums font-medium" x-text="item.quantity"></td>
                                        <td class="py-2.5 px-3 text-right tabular-nums font-mono" x-text="fmtPrice(item.price)"></td>
                                        <td class="py-2.5 px-3 text-center tabular-nums" x-text="item.discount > 0 ? item.discount + '%' : ''"></td>
                                        <td class="py-2.5 px-4 text-right tabular-nums font-bold font-mono" x-text="fmtPrice(itemTotal(item))"></td>
                                    </tr>
                                </template>
                                <template x-if="items.length === 0">
                                    <tr>
                                        <td colspan="7" class="py-16 text-center">
                                            <div class="flex flex-col items-center gap-3">
                                                <svg class="w-12 h-12 pos-empty-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                                                </svg>
                                                <span class="pos-empty-text text-sm">Skenirajte barkod ili unesite sifru artikla</span>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Input Card -->
                <div class="pos-card-solid flex-shrink-0 p-4">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-6 gap-y-2.5">
                        <!-- Sifra -->
                        <div class="flex items-center gap-2">
                            <label class="text-xs font-semibold uppercase tracking-wide w-16 flex-shrink-0" style="opacity:0.5">Sifra</label>
                            <input x-ref="barcodeInput" type="text" x-model="searchQuery"
                                   @keydown.enter.prevent="onBarcodeEnter()"
                                   class="pos-input flex-1 px-3 py-2 text-sm" placeholder="Barkod / sifra" autofocus>
                            <button @click="showArtiklModal = true" class="pos-fn-btn p-2" title="Lista artikala">
                                <svg class="w-4 h-4" style="opacity:0.6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>
                            </button>
                        </div>
                        <!-- Naziv -->
                        <div class="flex items-center gap-2">
                            <label class="text-xs font-semibold uppercase tracking-wide w-16 flex-shrink-0" style="opacity:0.5">Naziv</label>
                            <input type="text" x-model="pendingItem.name" readonly tabindex="-1"
                                   class="pos-input flex-1 px-3 py-2 text-sm" style="opacity:0.7">
                        </div>
                        <!-- Kolicina + Rezim -->
                        <div class="flex items-center gap-2">
                            <label class="text-xs font-semibold uppercase tracking-wide w-16 flex-shrink-0" style="opacity:0.5">Kol.</label>
                            <input x-ref="qtyInput" type="number" x-model.number="pendingItem.quantity" min="1" step="1"
                                   @keydown.enter.prevent="confirmPendingItem()"
                                   class="pos-input w-20 px-3 py-2 text-sm text-center">
                            <select x-model="qtyMode" class="pos-input px-2 py-2 text-xs flex-1">
                                <option value="auto">Bez unosa kolicine</option>
                                <option value="manual">Unos kolicine</option>
                            </select>
                            <button @click="confirmPendingItem()" x-show="pendingItem.name"
                                    class="pos-btn-primary px-4 py-2 text-xs">
                                Dodaj
                            </button>
                        </div>
                        <!-- Cena + Popust -->
                        <div class="flex items-center gap-2">
                            <label class="text-xs font-semibold uppercase tracking-wide w-16 flex-shrink-0" style="opacity:0.5">Cena</label>
                            <input type="number" x-model.number="pendingItem.price" step="0.01"
                                   :readonly="!allowPriceEdit"
                                   class="pos-input w-28 px-3 py-2 text-sm text-right" :style="!allowPriceEdit ? 'opacity:0.5' : ''">
                            <label class="flex items-center gap-1.5 text-[11px] cursor-pointer flex-shrink-0" style="opacity:0.6">
                                <input type="checkbox" x-model="allowPriceEdit" class="pos-checkbox rounded w-3.5 h-3.5">
                                Izmena cene
                            </label>
                            <div class="h-4 w-px" style="background: rgba(148,163,184,0.15)"></div>
                            <label class="text-xs font-semibold uppercase tracking-wide flex-shrink-0" style="opacity:0.5">Pop.</label>
                            <select x-model="pendingItem.discount" class="pos-input w-24 px-2 py-2 text-xs">
                                <option value="0">Bez</option>
                                <option value="5">5%</option>
                                <option value="10">10%</option>
                                <option value="15">15%</option>
                                <option value="20">20%</option>
                                <option value="25">25%</option>
                                <option value="30">30%</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT PANEL: Total + Last Receipt -->
            <div class="pos-right-panel w-64 xl:w-72 flex-shrink-0 flex flex-col gap-3">
                <!-- Total display -->
                <div class="pos-total-display flex-1 flex flex-col items-center justify-center p-6">
                    <div class="pos-total-label text-[10px] uppercase font-bold tracking-widest mb-2">Ukupno</div>
                    <div class="pos-total-value text-4xl xl:text-5xl font-extrabold tabular-nums tracking-tight" style="font-family: 'Inter', system-ui, -apple-system, sans-serif;"
                         x-text="fmtPrice(total)"></div>
                    <div class="pos-total-label text-xs mt-1.5 font-medium">RSD</div>
                </div>

                <!-- Last receipt info -->
                <div class="pos-card-solid p-4 pos-last-receipt" x-show="lastReceipt" x-transition>
                    <div class="text-[10px] font-bold uppercase tracking-widest mb-3" style="opacity:0.5">Poslednji racun</div>
                    <div class="space-y-1.5">
                        <div class="flex justify-between text-xs">
                            <span class="lr-label">Broj:</span>
                            <span class="lr-value font-mono font-semibold" x-text="lastReceipt?.number || '-'"></span>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span class="lr-label">Iznos:</span>
                            <span class="lr-value font-mono font-bold" x-text="lastReceipt ? fmtPrice(lastReceipt.total) : '0,00'"></span>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span class="lr-label">Kartica:</span>
                            <span class="lr-value font-mono" x-text="lastReceipt ? fmtPrice(lastReceipt.card || 0) : '0,00'"></span>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span class="lr-label">Gotovina:</span>
                            <span class="lr-value font-mono" x-text="lastReceipt ? fmtPrice(lastReceipt.cash || 0) : '0,00'"></span>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span class="lr-label">Povracaj:</span>
                            <span class="lr-value font-mono pos-change-positive" x-text="lastReceipt ? fmtPrice(lastReceipt.change || 0) : '0,00'"></span>
                        </div>
                    </div>
                </div>

                <!-- Session stats mini -->
                <div class="pos-card-solid p-4 pos-last-receipt" x-show="session">
                    <div class="text-[10px] font-bold uppercase tracking-widest mb-3" style="opacity:0.5">Danas</div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="text-center">
                            <div class="lr-value text-lg font-bold font-mono" x-text="session?.receipt_count || 0"></div>
                            <div class="lr-label text-[10px]">Racuna</div>
                        </div>
                        <div class="text-center">
                            <div class="lr-value text-lg font-bold font-mono" x-text="fmtPrice(session?.total_revenue || 0)"></div>
                            <div class="lr-label text-[10px]">Promet</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============ BOTTOM BAR ============ -->
        <div class="pos-bottom-bar flex-shrink-0 px-4 py-2 flex items-center gap-2 flex-wrap">
            <button class="pos-fn-btn flex flex-col items-center px-3 py-1.5 min-w-[68px]" @click="openCashDrawer()">
                <span class="fn-key text-[11px] font-bold">F5</span><span class="fn-label text-[10px]">Fioka</span>
            </button>
            <button class="pos-fn-btn flex flex-col items-center px-3 py-1.5 min-w-[68px]"
                    @click="openPaymentModal()" :disabled="items.length === 0"
                    :style="items.length === 0 ? 'opacity:0.35; cursor:not-allowed' : ''">
                <span class="fn-key text-[11px] font-bold">F6</span><span class="fn-label text-[10px]">Racun</span>
            </button>
            <button class="pos-fn-btn flex flex-col items-center px-3 py-1.5 min-w-[68px]" @click="editQuantity()">
                <span class="fn-key text-[11px] font-bold">F7</span><span class="fn-label text-[10px]">Kolicina</span>
            </button>
            <button class="pos-fn-btn flex flex-col items-center px-3 py-1.5 min-w-[68px]" @click="deleteItem()">
                <span class="fn-key text-[11px] font-bold">F8</span><span class="fn-label text-[10px]">Brisanje</span>
            </button>
            <button class="pos-fn-btn flex flex-col items-center px-3 py-1.5 min-w-[68px]" @click="applyDiscount()">
                <span class="fn-key text-[11px] font-bold leading-tight" style="font-size:9px">ALT+P</span><span class="fn-label text-[10px]">Popust</span>
            </button>
            <div class="flex-1"></div>
            <button class="pos-fn-btn flex flex-col items-center px-3 py-1.5 min-w-[80px]" @click="generateZReport()">
                <span class="fn-key text-[11px] font-bold">Z</span><span class="fn-label text-[10px]">Dnevni izv.</span>
            </button>
            <button class="pos-fn-btn flex flex-col items-center px-3 py-1.5 min-w-[80px]" @click="showXReport()">
                <span class="fn-key text-[11px] font-bold">X</span><span class="fn-label text-[10px]">Promet</span>
            </button>
        </div>
    </div>

    <!-- ============ F6 PAYMENT MODAL ============ -->
    <div x-show="paymentModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center"
         @keydown.escape.window="if(paymentModal) paymentModal = false">
        <div class="pos-modal-overlay fixed inset-0" @click="paymentModal = false"></div>
        <div class="pos-modal pos-animate-in relative w-full max-w-2xl mx-4" @keydown.enter.prevent="confirmPayment()">
            <!-- Header -->
            <div class="px-6 py-4 flex items-center justify-between">
                <h3 class="text-lg font-bold">Izdavanje racuna</h3>
                <button @click="paymentModal = false" class="pos-btn-secondary w-8 h-8 flex items-center justify-center rounded-full text-sm">&times;</button>
            </div>
            <div class="modal-divider border-b"></div>

            <div class="flex">
                <!-- Left: amounts -->
                <div class="w-1/2 p-6">
                    <!-- Total -->
                    <div class="mb-5">
                        <div class="text-xs font-semibold uppercase tracking-wide mb-1" style="opacity:0.5">Ukupno</div>
                        <div class="text-3xl font-extrabold tabular-nums" style="font-family: 'Inter', system-ui, sans-serif;"
                             x-text="fmtPrice(getDiscountedTotal())"></div>
                    </div>

                    <!-- Payment methods -->
                    <div class="space-y-2.5">
                        <div class="flex items-center gap-2.5">
                            <button @click="payMethod = 'CARD'; focusPaymentInput()"
                                    class="pay-method-btn w-24 text-left px-3 py-2 text-sm"
                                    :class="payMethod === 'CARD' ? 'pay-active-card' : ''">
                                Kartica
                            </button>
                            <input type="number" x-model.number="pay.card" step="0.01" min="0" @input="recalcCash()"
                                   class="pos-input flex-1 px-3 py-2 text-sm text-right tabular-nums font-mono">
                        </div>
                        <div class="flex items-center gap-2.5">
                            <button @click="payMethod = 'TRANSFER'; focusPaymentInput()"
                                    class="pay-method-btn w-24 text-left px-3 py-2 text-sm"
                                    :class="payMethod === 'TRANSFER' ? 'pay-active-transfer' : ''">
                                Prenos
                            </button>
                            <input type="number" x-model.number="pay.transfer" step="0.01" min="0" @input="recalcCash()"
                                   class="pos-input flex-1 px-3 py-2 text-sm text-right tabular-nums font-mono">
                        </div>
                        <div class="flex items-center gap-2.5">
                            <button @click="payMethod = 'CASH'; focusPaymentInput()"
                                    class="pay-method-btn w-24 text-left px-3 py-2 text-sm font-bold"
                                    :class="payMethod === 'CASH' ? 'pay-active-cash' : ''">
                                Gotovina
                            </button>
                            <input x-ref="cashInput" type="number" x-model.number="pay.cash" step="0.01" min="0"
                                   @input="calcChange()"
                                   class="pos-input flex-1 px-3 py-2 text-sm text-right tabular-nums font-mono font-bold"
                                   style="border-width: 2px !important;">
                        </div>
                    </div>

                    <!-- Change -->
                    <div class="mt-5 pt-4" style="border-top: 1px solid rgba(148,163,184,0.15);">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-bold" style="opacity:0.7">Povracaj:</span>
                            <span class="text-2xl font-extrabold tabular-nums font-mono"
                                  :class="payChange >= 0 ? 'pos-change-positive' : 'pos-change-negative'"
                                  x-text="fmtPrice(payChange)"></span>
                        </div>
                    </div>
                </div>

                <!-- Right: options -->
                <div class="w-1/2 p-6" style="border-left: 1px solid rgba(148,163,184,0.1);">
                    <div class="space-y-5">
                        <!-- Discount -->
                        <div>
                            <label class="text-xs font-semibold uppercase tracking-wide" style="opacity:0.5">Popust na ceo racun</label>
                            <div class="flex items-center gap-2 mt-1.5">
                                <input type="number" x-model.number="receiptDiscount" step="0.01" min="0" max="100"
                                       @input="recalcCash()"
                                       class="pos-input w-20 px-3 py-2 text-sm text-right tabular-nums">
                                <span class="text-sm font-medium" style="opacity:0.5">%</span>
                            </div>
                        </div>

                        <!-- B2B -->
                        <div>
                            <label class="flex items-center gap-2 text-sm cursor-pointer">
                                <input type="checkbox" x-model="showB2B" class="pos-checkbox rounded w-4 h-4">
                                <span class="font-semibold text-xs">Racun za komitenta (B2B)</span>
                            </label>
                            <div x-show="showB2B" x-transition class="mt-2.5 space-y-2">
                                <input type="text" x-model="buyerPib" placeholder="PIB kupca (9 cifara)"
                                       class="pos-input w-full px-3 py-2 text-sm">
                                <input type="text" x-model="buyerName" placeholder="Naziv kupca"
                                       class="pos-input w-full px-3 py-2 text-sm">
                            </div>
                        </div>

                        <!-- Note -->
                        <div>
                            <label class="text-xs font-semibold uppercase tracking-wide" style="opacity:0.5">Napomena</label>
                            <textarea x-model="receiptNote" rows="2"
                                      class="pos-input mt-1.5 w-full px-3 py-2 text-sm resize-none"></textarea>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end gap-2.5">
                        <button @click="confirmPayment()" :disabled="issuing"
                                class="pos-btn-primary px-6 py-2.5 text-sm">
                            <span x-text="issuing ? 'Izdavanje...' : 'Potvrdi'"></span>
                        </button>
                        <button @click="paymentModal = false"
                                class="pos-btn-secondary px-4 py-2.5 text-sm">
                            Odustani <span style="opacity:0.4; font-size:10px">ESC</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============ ARTIKL LISTA MODAL ============ -->
    <div x-show="showArtiklModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center"
         @keydown.escape.window="if(showArtiklModal) showArtiklModal = false">
        <div class="pos-modal-overlay fixed inset-0" @click="showArtiklModal = false"></div>
        <div class="pos-modal pos-animate-in relative w-full max-w-xl mx-4 flex flex-col" style="max-height: 70vh;">
            <div class="px-5 py-3.5 flex items-center justify-between">
                <h3 class="text-sm font-bold">Odabir artikla</h3>
                <button @click="showArtiklModal = false" class="pos-btn-secondary w-7 h-7 flex items-center justify-center rounded-full text-xs">&times;</button>
            </div>
            <div class="modal-divider border-b"></div>
            <div class="px-5 py-3">
                <input x-ref="artiklSearch" type="text" x-model="artiklSearchQuery"
                       @input.debounce.300ms="searchArtikli()"
                       placeholder="Pretrazi po imenu, barkodu, sifri..."
                       class="pos-input w-full px-3 py-2.5 text-sm">
            </div>
            <div class="flex-1 overflow-y-auto pos-scroll px-3 pb-3">
                <template x-for="a in artiklResults" :key="a.type + '-' + a.id">
                    <div @click="selectArtikl(a)" class="pos-artikl-item px-3 py-2.5 flex items-center justify-between cursor-pointer mb-0.5">
                        <div>
                            <div class="text-sm font-semibold" x-text="a.name"></div>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="pos-badge px-1.5 py-0.5 text-[10px]"
                                      :class="{'pos-badge-internal': a.type==='GOODS', 'pos-badge-fiscal': a.type==='SPARE_PART'}"
                                      x-text="a.type==='GOODS' ? 'Roba' : a.type==='SPARE_PART' ? 'Deo' : 'Telefon'"></span>
                                <span class="text-[11px]" style="opacity:0.4" x-show="a.barcode" x-text="a.barcode"></span>
                                <span class="text-[11px]" style="opacity:0.4" x-text="'Stanje: ' + a.stock"></span>
                            </div>
                        </div>
                        <span class="text-sm font-bold font-mono tabular-nums" x-text="fmtPrice(a.price)"></span>
                    </div>
                </template>
                <div x-show="artiklSearchQuery && artiklResults.length === 0" class="py-8 text-center">
                    <span class="pos-empty-text text-sm">Nema rezultata</span>
                </div>
                <div x-show="!artiklSearchQuery" class="py-8 text-center">
                    <span class="pos-empty-text text-sm">Unesite tekst za pretragu</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ============ X REPORT MODAL ============ -->
    <div x-show="showXReportModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center"
         @keydown.escape.window="if(showXReportModal) showXReportModal = false">
        <div class="pos-modal-overlay fixed inset-0" @click="showXReportModal = false"></div>
        <div class="pos-modal pos-animate-in relative w-full max-w-md mx-4 p-6">
            <h3 class="text-lg font-bold mb-5">X Izvestaj — Tekuci promet</h3>
            <template x-if="xReportData">
                <div class="space-y-2.5 text-sm">
                    <div class="flex justify-between"><span style="opacity:0.5">Promet:</span><span class="font-bold tabular-nums font-mono" x-text="fmtPrice(xReportData.total_revenue) + ' RSD'"></span></div>
                    <div class="flex justify-between"><span style="opacity:0.5">Trosak:</span><span class="tabular-nums font-mono" x-text="fmtPrice(xReportData.total_cost) + ' RSD'"></span></div>
                    <div class="flex justify-between"><span style="opacity:0.5">Profit:</span><span class="font-bold tabular-nums font-mono pos-change-positive" x-text="fmtPrice(xReportData.total_profit) + ' RSD'"></span></div>
                    <div class="modal-divider border-b my-2"></div>
                    <div class="flex justify-between"><span style="opacity:0.5">Gotovina:</span><span class="tabular-nums font-mono" x-text="fmtPrice(xReportData.total_cash) + ' RSD'"></span></div>
                    <div class="flex justify-between"><span style="opacity:0.5">Kartica:</span><span class="tabular-nums font-mono" x-text="fmtPrice(xReportData.total_card) + ' RSD'"></span></div>
                    <div class="flex justify-between"><span style="opacity:0.5">Prenos:</span><span class="tabular-nums font-mono" x-text="fmtPrice(xReportData.total_transfer) + ' RSD'"></span></div>
                    <div class="modal-divider border-b my-2"></div>
                    <div class="flex justify-between"><span style="opacity:0.5">Racuni:</span><span class="tabular-nums font-mono font-bold" x-text="xReportData.receipt_count"></span></div>
                    <div class="flex justify-between"><span style="opacity:0.5">Stornirani:</span><span class="tabular-nums font-mono" x-text="xReportData.voided_count"></span></div>
                </div>
            </template>
            <div class="mt-5 text-right">
                <button @click="showXReportModal = false" class="pos-btn-secondary px-5 py-2 text-sm">Zatvori</button>
            </div>
        </div>
    </div>

    <!-- ============ TOAST ============ -->
    <div x-show="toast.show" x-cloak
         x-transition:enter="transform ease-out duration-300"
         x-transition:enter-start="translate-y-3 opacity-0 scale-95"
         x-transition:enter-end="translate-y-0 opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 scale-100"
         x-transition:leave-end="opacity-0 scale-95"
         class="fixed bottom-16 right-4 z-[60] pos-toast p-4 max-w-sm"
         :class="toast.type === 'success' ? 'pos-toast-success' : 'pos-toast-error'">
        <div class="flex items-center gap-2">
            <template x-if="toast.type === 'success'">
                <svg class="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
            </template>
            <template x-if="toast.type === 'error'">
                <svg class="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
            </template>
            <span class="text-sm font-medium" x-text="toast.message"></span>
        </div>
    </div>
</div>

<script>
function posRegister() {
    return {
        // Session
        session: null,
        fiscalMode: false,
        currentLocationId: null,
        currentLocationName: '',
        locations: [],

        // Items (lokalni — ne cuvaju se na serveru dok se ne izda)
        items: [],
        selectedIndex: -1,

        // Pending item (dok se unosi)
        pendingItem: { name: '', price: 0, quantity: 1, discount: 0, type: '', id: null, barcode: '', purchase_price: 0 },
        searchQuery: '',
        qtyMode: 'auto',
        allowPriceEdit: false,

        // Payment modal
        paymentModal: false,
        payMethod: 'CASH',
        pay: { cash: 0, card: 0, transfer: 0 },
        payChange: 0,
        receiptDiscount: 0,
        receiptNote: '',
        showB2B: false,
        buyerPib: '',
        buyerName: '',
        issuing: false,

        // Artikl modal
        showArtiklModal: false,
        artiklSearchQuery: '',
        artiklResults: [],

        // Last receipt
        lastReceipt: null,

        // X Report
        showXReportModal: false,
        xReportData: null,

        // Toast
        toast: { show: false, message: '', type: 'success' },

        // Computed
        get total() {
            return this.items.reduce((sum, i) => sum + this.itemTotal(i), 0);
        },

        get todayFormatted() {
            return new Date().toLocaleDateString('sr-RS');
        },

        itemTotal(item) {
            const base = item.price * item.quantity;
            return item.discount > 0 ? base * (1 - item.discount / 100) : base;
        },

        // ==========================================
        // INIT
        // ==========================================
        async init() {
            await this.loadUserLocation();
            await this.loadSession();
            this.$nextTick(() => {
                if (this.$refs.barcodeInput) this.$refs.barcodeInput.focus();
            });
        },

        async loadUserLocation() {
            try {
                const res = await api('/api/v1/auth/me');
                if (res.ok) {
                    const data = await res.json();
                    this.locations = data.locations || [];
                    if (this.locations.length >= 1) {
                        const primary = this.locations.find(l => l.is_primary) || this.locations[0];
                        this.currentLocationId = primary.id;
                        this.currentLocationName = primary.name;
                    }
                }
            } catch (e) { console.error('Failed to load location', e); }
        },

        async loadSession() {
            if (!this.currentLocationId) return;
            try {
                const res = await api(`/api/v1/pos/register/current?location_id=${this.currentLocationId}`);
                if (res.ok) {
                    this.session = await res.json();
                    this.fiscalMode = this.session.fiscal_mode || false;
                }
            } catch (e) { console.error('Failed to load session', e); }
        },

        // ==========================================
        // KEYBOARD
        // ==========================================
        handleKeyboard(e) {
            if (e.key === 'F5') { e.preventDefault(); this.openCashDrawer(); }
            else if (e.key === 'F6') { e.preventDefault(); if (this.items.length > 0) this.openPaymentModal(); }
            else if (e.key === 'F7') { e.preventDefault(); this.editQuantity(); }
            else if (e.key === 'F8') { e.preventDefault(); this.deleteItem(); }
            else if (e.altKey && (e.key === 'p' || e.key === 'P')) { e.preventDefault(); this.applyDiscount(); }
            else if (e.key === 'Escape') {
                if (this.paymentModal) { this.paymentModal = false; }
                else if (this.showArtiklModal) { this.showArtiklModal = false; }
                else if (this.showXReportModal) { this.showXReportModal = false; }
            }
        },

        // ==========================================
        // BARCODE / SEARCH
        // ==========================================
        async onBarcodeEnter() {
            const q = this.searchQuery.trim();
            if (!q) return;

            try {
                const res = await api(`/api/v1/pos/search-items?q=${encodeURIComponent(q)}`);
                if (!res.ok) return;
                const data = await res.json();
                const results = data.items || [];

                if (results.length === 0) {
                    this.showToast('Artikal nije pronadjen: ' + q, 'error');
                    return;
                }

                if (results.length === 1) {
                    this.selectArtikl(results[0]);
                } else {
                    this.artiklResults = results;
                    this.artiklSearchQuery = q;
                    this.showArtiklModal = true;
                }
            } catch (e) {
                this.showToast('Greska pri pretrazi', 'error');
            }
        },

        selectArtikl(a) {
            this.pendingItem = {
                name: a.name,
                price: a.price,
                quantity: 1,
                discount: 0,
                type: a.type,
                id: a.id,
                barcode: a.barcode || '',
                purchase_price: a.purchase_price || 0,
            };
            this.showArtiklModal = false;
            this.searchQuery = '';

            if (this.qtyMode === 'auto') {
                this.confirmPendingItem();
            } else {
                this.$nextTick(() => {
                    if (this.$refs.qtyInput) this.$refs.qtyInput.focus();
                });
            }
        },

        confirmPendingItem() {
            if (!this.pendingItem.name) return;

            const existing = this.items.find(i => i.type === this.pendingItem.type && i.id === this.pendingItem.id && i.id !== null);
            if (existing && this.qtyMode === 'auto') {
                existing.quantity += this.pendingItem.quantity;
            } else {
                this.items.push({ ...this.pendingItem });
            }

            this.pendingItem = { name: '', price: 0, quantity: 1, discount: 0, type: '', id: null, barcode: '', purchase_price: 0 };
            this.searchQuery = '';
            this.selectedIndex = this.items.length - 1;

            this.$nextTick(() => {
                if (this.$refs.barcodeInput) this.$refs.barcodeInput.focus();
            });
        },

        // ==========================================
        // ARTIKL MODAL SEARCH
        // ==========================================
        async searchArtikli() {
            if (this.artiklSearchQuery.length < 2) { this.artiklResults = []; return; }
            try {
                const res = await api(`/api/v1/pos/search-items?q=${encodeURIComponent(this.artiklSearchQuery)}`);
                if (res.ok) {
                    const data = await res.json();
                    this.artiklResults = data.items || [];
                }
            } catch (e) { console.error(e); }
        },

        // ==========================================
        // ITEM OPERATIONS
        // ==========================================
        editQuantity() {
            if (this.selectedIndex < 0 || this.selectedIndex >= this.items.length) {
                this.showToast('Izaberite stavku u tabeli', 'error');
                return;
            }
            const newQty = prompt('Nova kolicina:', this.items[this.selectedIndex].quantity);
            if (newQty !== null && !isNaN(newQty) && parseInt(newQty) > 0) {
                this.items[this.selectedIndex].quantity = parseInt(newQty);
            }
        },

        deleteItem() {
            if (this.selectedIndex < 0 || this.selectedIndex >= this.items.length) {
                this.showToast('Izaberite stavku u tabeli', 'error');
                return;
            }
            this.items.splice(this.selectedIndex, 1);
            if (this.selectedIndex >= this.items.length) this.selectedIndex = this.items.length - 1;
        },

        applyDiscount() {
            if (this.selectedIndex < 0 || this.selectedIndex >= this.items.length) {
                this.showToast('Izaberite stavku u tabeli', 'error');
                return;
            }
            const disc = prompt('Popust (%):', this.items[this.selectedIndex].discount);
            if (disc !== null && !isNaN(disc) && parseFloat(disc) >= 0 && parseFloat(disc) <= 100) {
                this.items[this.selectedIndex].discount = parseFloat(disc);
            }
        },

        openCashDrawer() {
            this.showToast('Fioka otvorena', 'success');
        },

        // ==========================================
        // F6 — PAYMENT MODAL
        // ==========================================
        openPaymentModal() {
            if (this.items.length === 0) return;

            this.payMethod = 'CASH';
            this.pay = { cash: this.total, card: 0, transfer: 0 };
            this.payChange = 0;
            this.receiptDiscount = 0;
            this.receiptNote = '';
            this.showB2B = false;
            this.buyerPib = '';
            this.buyerName = '';
            this.paymentModal = true;

            this.$nextTick(() => {
                if (this.$refs.cashInput) {
                    this.$refs.cashInput.focus();
                    this.$refs.cashInput.select();
                }
            });
        },

        recalcCash() {
            const discountedTotal = this.getDiscountedTotal();
            this.pay.cash = Math.max(0, discountedTotal - (this.pay.card || 0) - (this.pay.transfer || 0));
            this.calcChange();
        },

        calcChange() {
            const discountedTotal = this.getDiscountedTotal();
            const totalPaid = (this.pay.cash || 0) + (this.pay.card || 0) + (this.pay.transfer || 0);
            this.payChange = Math.max(0, totalPaid - discountedTotal);
        },

        getDiscountedTotal() {
            if (this.receiptDiscount > 0) {
                return this.total * (1 - this.receiptDiscount / 100);
            }
            return this.total;
        },

        focusPaymentInput() {
            this.$nextTick(() => {
                if (this.$refs.cashInput) this.$refs.cashInput.focus();
            });
        },

        // ==========================================
        // CONFIRM PAYMENT
        // ==========================================
        async confirmPayment() {
            if (this.issuing || this.items.length === 0) return;
            this.issuing = true;

            let pm = 'CASH';
            if (this.pay.card > 0 && this.pay.cash <= 0 && this.pay.transfer <= 0) pm = 'CARD';
            else if (this.pay.transfer > 0 && this.pay.cash <= 0 && this.pay.card <= 0) pm = 'TRANSFER';
            else if ((this.pay.card > 0 || this.pay.transfer > 0) && this.pay.cash > 0) pm = 'MIXED';

            const body = {
                location_id: this.currentLocationId,
                items: this.items.map(i => ({
                    type: i.type || 'CUSTOM',
                    id: i.id || null,
                    quantity: i.quantity,
                    unit_price: i.price,
                    discount_pct: i.discount || 0,
                    item_name: i.name,
                    purchase_price: i.purchase_price || 0,
                })),
                payment_method: pm,
                idempotency_key: `pos-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`,
            };

            if (this.pay.cash > 0) body.cash_received = this.pay.cash;
            if (this.pay.card > 0) body.card_amount = this.pay.card;
            if (this.pay.transfer > 0) body.transfer_amount = this.pay.transfer;
            if (this.receiptDiscount > 0) body.discount_pct = this.receiptDiscount;
            if (this.showB2B && this.buyerPib) {
                body.buyer_pib = this.buyerPib;
                body.buyer_name = this.buyerName;
            }

            try {
                const res = await api('/api/v1/pos/receipts/quick', 'POST', body);
                if (res.ok) {
                    const data = await res.json();

                    this.lastReceipt = {
                        total: data.total_amount,
                        card: this.pay.card,
                        cash: this.pay.cash,
                        change: data.cash_change || 0,
                        number: data.receipt_number,
                    };

                    this.items = [];
                    this.selectedIndex = -1;
                    this.paymentModal = false;

                    let msg = `Racun ${data.receipt_number} izdat`;
                    if (data.cash_change && data.cash_change > 0) {
                        msg += ` — Povracaj: ${this.fmtPrice(data.cash_change)} RSD`;
                    }
                    this.showToast(msg, 'success');

                    await this.loadSession();

                    this.$nextTick(() => {
                        if (this.$refs.barcodeInput) this.$refs.barcodeInput.focus();
                    });
                } else {
                    const err = await res.json();
                    this.showToast(err.error || 'Greska pri izdavanju', 'error');
                }
            } catch (e) {
                this.showToast('Greska: ' + e.message, 'error');
            } finally {
                this.issuing = false;
            }
        },

        // ==========================================
        // REPORTS
        // ==========================================
        async showXReport() {
            try {
                const res = await api(`/api/v1/pos/reports/x?location_id=${this.currentLocationId}`);
                if (res.ok) {
                    this.xReportData = await res.json();
                    this.showXReportModal = true;
                } else {
                    const err = await res.json();
                    this.showToast(err.error || 'Nema podataka', 'error');
                }
            } catch (e) {
                this.showToast('Greska', 'error');
            }
        },

        async generateZReport() {
            if (!confirm('Generisi dnevni Z izvestaj?')) return;
            try {
                const res = await api('/api/v1/pos/reports/z', 'POST', {
                    location_id: this.currentLocationId
                });
                if (res.ok) {
                    const data = await res.json();
                    this.showToast(`Z izvestaj generisan — Promet: ${this.fmtPrice(data.total_revenue)} RSD`, 'success');
                } else {
                    const err = await res.json();
                    this.showToast(err.error || 'Greska', 'error');
                }
            } catch (e) {
                this.showToast('Greska', 'error');
            }
        },

        // ==========================================
        // HELPERS
        // ==========================================
        fmtPrice(val) {
            if (val == null) return '0,00';
            return Number(val).toLocaleString('sr-RS', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        },

        showToast(message, type) {
            this.toast = { show: true, message, type };
            setTimeout(() => { this.toast.show = false; }, 4000);
        }
    };
}
</script>
{% endblock %}
