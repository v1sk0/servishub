{% extends "layouts/tenant.html" %}

{% block title %}Kasa - ServisHub{% endblock %}

{% block page_content %}
<div x-data="posRegister()" x-init="init()">
    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between mb-8">
        <div class="min-w-0 flex-1">
            <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl">Kasa</h2>
            <p class="mt-1 text-sm text-gray-500">Upravljanje kasom, racunima i dnevnim prometom</p>
        </div>
        <div class="mt-4 flex gap-2 md:ml-4 md:mt-0">
            <a href="/pos/receipts" class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                <svg class="-ml-0.5 mr-1.5 h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                Svi racuni
            </a>
            <a href="/pos/daily-report" class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                <svg class="-ml-0.5 mr-1.5 h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                Dnevni izvestaj
            </a>
        </div>
    </div>

    <!-- Kasa Status -->
    <div class="bg-white shadow rounded-lg mb-6 p-6">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold text-gray-900">Status kase</h3>
                <p class="text-sm text-gray-500 mt-1" x-text="session ? 'Kasa je otvorena od ' + formatTime(session.opened_at) : 'Kasa je zatvorena'"></p>
            </div>
            <div>
                <!-- Otvori kasu -->
                <template x-if="!session">
                    <button @click="showOpenModal = true"
                            class="inline-flex items-center rounded-md bg-green-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500">
                        <svg class="-ml-0.5 mr-1.5 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                        Otvori kasu
                    </button>
                </template>
                <!-- Zatvori kasu -->
                <template x-if="session">
                    <button @click="showCloseModal = true"
                            class="inline-flex items-center rounded-md bg-red-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500">
                        <svg class="-ml-0.5 mr-1.5 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                        Zatvori kasu
                    </button>
                </template>
            </div>
        </div>

        <!-- Quick Stats when open -->
        <template x-if="session">
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-4 mt-6 pt-6 border-t border-gray-200">
                <div>
                    <dt class="text-sm font-medium text-gray-500">Pocetno stanje</dt>
                    <dd class="text-lg font-semibold text-gray-900" x-text="formatPrice(session.opening_cash) + ' RSD'"></dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500">Ukupan promet</dt>
                    <dd class="text-lg font-semibold text-green-600" x-text="formatPrice(session.total_revenue) + ' RSD'"></dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500">Broj racuna</dt>
                    <dd class="text-lg font-semibold text-gray-900" x-text="session.receipt_count"></dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500">Lokacija</dt>
                    <dd class="text-lg font-semibold text-gray-900" x-text="currentLocationName || '-'"></dd>
                </div>
            </div>
        </template>
    </div>

    <!-- Kreiranje racuna (samo kad je kasa otvorena) -->
    <template x-if="session">
        <div class="bg-white shadow rounded-lg mb-6">
            <!-- Novi racun header -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">Novi racun</h3>
                    <template x-if="!activeReceipt">
                        <button @click="createReceipt()"
                                class="inline-flex items-center rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500">
                            <svg class="-ml-0.5 mr-1.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"/></svg>
                            Kreiraj racun
                        </button>
                    </template>
                </div>
            </div>

            <!-- Active Receipt -->
            <template x-if="activeReceipt">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-sm text-gray-500">Racun: <strong x-text="activeReceipt.receipt_number"></strong></span>
                        <span class="inline-flex items-center rounded-full bg-yellow-100 px-2.5 py-0.5 text-xs font-medium text-yellow-800" x-text="activeReceipt.status"></span>
                    </div>

                    <!-- Dodaj stavku forma -->
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-6 mb-4 p-4 bg-gray-50 rounded-lg">
                        <div class="sm:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Tip</label>
                            <select x-model="newItem.item_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                                <option value="SERVICE">Usluga</option>
                                <option value="PHONE">Telefon</option>
                                <option value="SPARE_PART">Deo</option>
                                <option value="CUSTOM">Ostalo</option>
                            </select>
                        </div>
                        <div class="sm:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Naziv</label>
                            <input type="text" x-model="newItem.item_name" placeholder="Naziv stavke"
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Cena (RSD)</label>
                            <input type="number" x-model.number="newItem.unit_price" step="0.01"
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                        </div>
                        <div class="flex items-end">
                            <button @click="addItem()" :disabled="!newItem.item_name || !newItem.unit_price"
                                    class="w-full inline-flex justify-center items-center rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500 disabled:opacity-50">
                                Dodaj
                            </button>
                        </div>
                    </div>

                    <!-- Stavke tabela -->
                    <table class="min-w-full divide-y divide-gray-300" x-show="receiptItems.length > 0">
                        <thead>
                            <tr>
                                <th class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900">Stavka</th>
                                <th class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Tip</th>
                                <th class="px-3 py-3.5 text-right text-sm font-semibold text-gray-900">Kol.</th>
                                <th class="px-3 py-3.5 text-right text-sm font-semibold text-gray-900">Cena</th>
                                <th class="px-3 py-3.5 text-right text-sm font-semibold text-gray-900">Ukupno</th>
                                <th class="relative py-3.5 pl-3 pr-4"><span class="sr-only">Ukloni</span></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            <template x-for="item in receiptItems" :key="item.id">
                                <tr>
                                    <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900" x-text="item.item_name"></td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500" x-text="item.item_type"></td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 text-right" x-text="item.quantity"></td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 text-right" x-text="formatPrice(item.unit_price)"></td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm font-semibold text-gray-900 text-right" x-text="formatPrice(item.line_total)"></td>
                                    <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm">
                                        <button @click="removeItem(item.id)" class="text-red-600 hover:text-red-900">Ukloni</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" class="py-4 pl-4 pr-3 text-sm font-bold text-gray-900 text-right">UKUPNO:</td>
                                <td class="py-4 px-3 text-sm font-bold text-gray-900 text-right" x-text="formatPrice(receiptTotal) + ' RSD'"></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- Izdaj racun -->
                    <div class="mt-6 flex items-center justify-between pt-4 border-t border-gray-200" x-show="receiptItems.length > 0">
                        <div class="flex items-center gap-4">
                            <label class="text-sm font-medium text-gray-700">Nacin placanja:</label>
                            <select x-model="paymentMethod" class="rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                                <option value="CASH">Gotovina</option>
                                <option value="CARD">Kartica</option>
                                <option value="TRANSFER">Transfer</option>
                                <option value="MIXED">Kombinovano</option>
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <button @click="voidReceipt()" class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-red-700 shadow-sm ring-1 ring-inset ring-red-300 hover:bg-red-50">
                                Storniraj
                            </button>
                            <button @click="issueReceipt()" class="inline-flex items-center rounded-md bg-green-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500">
                                <svg class="-ml-0.5 mr-1.5 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                Izdaj racun
                            </button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </template>

    <!-- Poslednji racuni -->
    <div class="bg-white shadow rounded-lg" x-show="recentReceipts.length > 0">
        <div class="p-6 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Poslednji racuni</h3>
        </div>
        <ul class="divide-y divide-gray-200">
            <template x-for="r in recentReceipts" :key="r.id">
                <li class="p-4 flex items-center justify-between">
                    <div>
                        <span class="text-sm font-medium text-gray-900" x-text="r.receipt_number"></span>
                        <span class="ml-2 text-sm text-gray-500" x-text="formatPrice(r.total_amount) + ' RSD'"></span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-xs text-gray-400" x-text="r.payment_method"></span>
                        <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium"
                              :class="{
                                  'bg-green-100 text-green-800': r.status === 'ISSUED',
                                  'bg-red-100 text-red-800': r.status === 'VOIDED',
                                  'bg-yellow-100 text-yellow-800': r.status === 'DRAFT',
                                  'bg-blue-100 text-blue-800': r.status === 'REFUNDED'
                              }"
                              x-text="r.status"></span>
                    </div>
                </li>
            </template>
        </ul>
    </div>

    <!-- Open Modal -->
    <div x-show="showOpenModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" @keydown.escape="showOpenModal = false">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="fixed inset-0 bg-gray-500/75" @click="showOpenModal = false"></div>
            <div class="relative bg-white rounded-xl shadow-xl p-6 w-full max-w-md">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Otvori kasu</h3>
                <div class="mb-4" x-show="locations.length > 1">
                    <label class="block text-sm font-medium text-gray-700">Lokacija</label>
                    <select x-model.number="currentLocationId"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                        <template x-for="loc in locations" :key="loc.id">
                            <option :value="loc.id" x-text="loc.name"></option>
                        </template>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Pocetno stanje gotovine (RSD)</label>
                    <input type="number" x-model.number="openingCash" step="0.01" min="0"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                </div>
                <div class="flex justify-end gap-3">
                    <button @click="showOpenModal = false" class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">Otkazi</button>
                    <button @click="openRegister()" class="rounded-md bg-green-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500">Otvori</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Close Modal -->
    <div x-show="showCloseModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" @keydown.escape="showCloseModal = false">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="fixed inset-0 bg-gray-500/75" @click="showCloseModal = false"></div>
            <div class="relative bg-white rounded-xl shadow-xl p-6 w-full max-w-md">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Zatvori kasu</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Krajnje stanje gotovine (RSD)</label>
                    <input type="number" x-model.number="closingCash" step="0.01" min="0"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                </div>
                <div class="flex justify-end gap-3">
                    <button @click="showCloseModal = false" class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">Otkazi</button>
                    <button @click="closeRegister()" class="rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500">Zatvori</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Void Reason Modal -->
    <div x-show="showVoidModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" @keydown.escape="showVoidModal = false">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="fixed inset-0 bg-gray-500/75" @click="showVoidModal = false"></div>
            <div class="relative bg-white rounded-xl shadow-xl p-6 w-full max-w-md">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Storniraj racun</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Razlog storniranja</label>
                    <textarea x-model="voidReason" rows="3"
                              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"></textarea>
                </div>
                <div class="flex justify-end gap-3">
                    <button @click="showVoidModal = false" class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">Otkazi</button>
                    <button @click="confirmVoid()" :disabled="!voidReason" class="rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 disabled:opacity-50">Storniraj</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div x-show="toast.show" x-cloak
         x-transition:enter="transform ease-out duration-300 transition"
         x-transition:enter-start="translate-y-2 opacity-0"
         x-transition:enter-end="translate-y-0 opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed bottom-4 right-4 z-50 rounded-lg p-4 shadow-lg"
         :class="toast.type === 'success' ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'">
        <span x-text="toast.message"></span>
    </div>
</div>

<script>
function posRegister() {
    return {
        session: null,
        activeReceipt: null,
        receiptItems: [],
        recentReceipts: [],
        currentLocationId: null,
        currentLocationName: '',
        locations: [],
        showOpenModal: false,
        showCloseModal: false,
        showVoidModal: false,
        openingCash: 0,
        closingCash: 0,
        paymentMethod: 'CASH',
        voidReason: '',
        newItem: { item_type: 'SERVICE', item_name: '', unit_price: null, quantity: 1 },
        toast: { show: false, message: '', type: 'success' },

        get receiptTotal() {
            return this.receiptItems.reduce((sum, i) => sum + (i.line_total || 0), 0);
        },

        async init() {
            await this.loadUserLocation();
            await this.checkCurrentRegister();
            await this.loadRecentReceipts();
        },

        async loadUserLocation() {
            try {
                const res = await api('/api/v1/auth/me');
                if (res.ok) {
                    const data = await res.json();
                    this.locations = data.locations || [];
                    if (this.locations.length === 1) {
                        this.currentLocationId = this.locations[0].id;
                        this.currentLocationName = this.locations[0].name;
                    } else if (this.locations.length > 1) {
                        const primary = this.locations.find(l => l.is_primary);
                        if (primary) {
                            this.currentLocationId = primary.id;
                            this.currentLocationName = primary.name;
                        } else {
                            this.currentLocationId = this.locations[0].id;
                            this.currentLocationName = this.locations[0].name;
                        }
                    }
                }
            } catch (e) {
                console.error('Failed to load user location', e);
            }
        },

        async checkCurrentRegister() {
            try {
                const res = await api('/api/v1/pos/register/current');
                if (res.ok) {
                    this.session = await res.json();
                } else {
                    this.session = null;
                }
            } catch (e) {
                this.session = null;
            }
        },

        async openRegister() {
            const res = await api('/api/v1/pos/register/open', 'POST', {
                opening_cash: this.openingCash,
                location_id: this.currentLocationId
            });
            if (res.ok) {
                const data = await res.json();
                this.session = { ...data, total_revenue: 0, receipt_count: 0 };
                this.showOpenModal = false;
                this.showToast('Kasa otvorena', 'success');
            } else {
                const err = await res.json();
                this.showToast(err.error || 'Greska', 'error');
            }
        },

        async closeRegister() {
            const res = await api('/api/v1/pos/register/close', 'POST', {
                session_id: this.session.session_id,
                closing_cash: this.closingCash
            });
            if (res.ok) {
                this.session = null;
                this.activeReceipt = null;
                this.receiptItems = [];
                this.showCloseModal = false;
                this.showToast('Kasa zatvorena', 'success');
            } else {
                const err = await res.json();
                this.showToast(err.error || 'Greska', 'error');
            }
        },

        async createReceipt() {
            const res = await api('/api/v1/pos/receipts', 'POST', { session_id: this.session.session_id });
            if (res.ok) {
                this.activeReceipt = await res.json();
                this.receiptItems = [];
            } else {
                const err = await res.json();
                this.showToast(err.error || 'Greska', 'error');
            }
        },

        async addItem() {
            const res = await api(`/api/v1/pos/receipts/${this.activeReceipt.receipt_id}/items`, 'POST', {
                item_type: this.newItem.item_type,
                item_name: this.newItem.item_name,
                unit_price: this.newItem.unit_price,
                quantity: this.newItem.quantity || 1,
            });
            if (res.ok) {
                await this.refreshReceipt();
                this.newItem = { item_type: 'SERVICE', item_name: '', unit_price: null, quantity: 1 };
            } else {
                const err = await res.json();
                this.showToast(err.error || 'Greska', 'error');
            }
        },

        async removeItem(itemId) {
            const res = await api(`/api/v1/pos/receipts/${this.activeReceipt.receipt_id}/items/${itemId}`, 'DELETE');
            if (res.ok) {
                await this.refreshReceipt();
            }
        },

        async refreshReceipt() {
            const res = await api(`/api/v1/pos/receipts/${this.activeReceipt.receipt_id}`);
            if (res.ok) {
                const data = await res.json();
                this.activeReceipt = data;
                this.receiptItems = data.items || [];
            }
        },

        async issueReceipt() {
            const res = await api(`/api/v1/pos/receipts/${this.activeReceipt.receipt_id}/issue`, 'POST', {
                payment_method: this.paymentMethod,
            });
            if (res.ok) {
                this.showToast('Racun izdat', 'success');
                this.activeReceipt = null;
                this.receiptItems = [];
                await this.checkCurrentRegister();
                await this.loadRecentReceipts();
            } else {
                const err = await res.json();
                this.showToast(err.error || 'Greska', 'error');
            }
        },

        voidReceipt() {
            this.showVoidModal = true;
        },

        async confirmVoid() {
            const res = await api(`/api/v1/pos/receipts/${this.activeReceipt.receipt_id}/void`, 'POST', {
                reason: this.voidReason
            });
            if (res.ok) {
                this.showToast('Racun storniran', 'success');
                this.activeReceipt = null;
                this.receiptItems = [];
                this.showVoidModal = false;
                this.voidReason = '';
                await this.loadRecentReceipts();
            } else {
                const err = await res.json();
                this.showToast(err.error || 'Greska', 'error');
            }
        },

        async loadRecentReceipts() {
            const res = await api('/api/v1/pos/receipts?per_page=10');
            if (res.ok) {
                const data = await res.json();
                this.recentReceipts = data.receipts || [];
            }
        },

        formatPrice(val) {
            if (val == null) return '0';
            return Number(val).toLocaleString('sr-RS', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        },

        formatTime(iso) {
            if (!iso) return '';
            return new Date(iso).toLocaleTimeString('sr-RS', { hour: '2-digit', minute: '2-digit' });
        },

        showToast(message, type) {
            this.toast = { show: true, message, type };
            setTimeout(() => { this.toast.show = false; }, 3000);
        }
    };
}
</script>
{% endblock %}