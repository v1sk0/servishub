{% extends "layouts/tenant.html" %}

{% block title %}Racuni - ServisHub{% endblock %}

{% block page_content %}
<div x-data="receiptsPage()" x-init="loadReceipts()">
    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between mb-8">
        <div class="min-w-0 flex-1">
            <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl">Racuni</h2>
            <p class="mt-1 text-sm text-gray-500">Pregled svih izdatih racuna</p>
        </div>
        <div class="mt-4 flex gap-2 md:ml-4 md:mt-0">
            <a href="/pos/settings" class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                <svg class="-ml-0.5 mr-1.5 h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                Podesavanja
            </a>
            <a href="/pos" class="inline-flex items-center rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500">
                Nazad na kasu
            </a>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white shadow rounded-lg mb-6 p-4">
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
            <div>
                <label class="block text-sm font-medium text-gray-700">Status</label>
                <select x-model="filters.status" @change="loadReceipts()"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                    <option value="">Svi</option>
                    <option value="ISSUED">Izdati</option>
                    <option value="DRAFT">Draft</option>
                    <option value="VOIDED">Stornirani</option>
                    <option value="REFUNDED">Refundirani</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Datum</label>
                <input type="date" x-model="filters.date" @change="loadReceipts()"
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
            </div>
            <div class="flex items-end">
                <button @click="filters = { status: '', date: '' }; loadReceipts()"
                        class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                    Resetuj filtere
                </button>
            </div>
        </div>
    </div>

    <!-- Tabela -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <table class="min-w-full divide-y divide-gray-300">
            <thead class="bg-gray-50">
                <tr>
                    <th class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900">Broj</th>
                    <th class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Tip</th>
                    <th class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Kupac</th>
                    <th class="px-3 py-3.5 text-right text-sm font-semibold text-gray-900">Iznos</th>
                    <th class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Placanje</th>
                    <th class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Status</th>
                    <th class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Datum</th>
                    <th class="px-3 py-3.5 text-right text-sm font-semibold text-gray-900">Akcije</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                <template x-for="r in receipts" :key="r.id">
                    <tr class="hover:bg-gray-50">
                        <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-primary-600" x-text="r.receipt_number"></td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500" x-text="r.receipt_type"></td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500" x-text="r.customer_name || '-'"></td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-900 text-right font-semibold" x-text="formatPrice(r.total_amount) + ' RSD'"></td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500" x-text="r.payment_method || '-'"></td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm">
                            <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium"
                                  :class="{
                                      'bg-green-100 text-green-800': r.status === 'ISSUED',
                                      'bg-red-100 text-red-800': r.status === 'VOIDED',
                                      'bg-yellow-100 text-yellow-800': r.status === 'DRAFT',
                                      'bg-blue-100 text-blue-800': r.status === 'REFUNDED'
                                  }"
                                  x-text="r.status"></span>
                        </td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500" x-text="formatDate(r.issued_at || r.created_at)"></td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-right">
                            <button @click="printReceipt(r.id)" x-show="r.status === 'ISSUED'"
                                    class="text-primary-600 hover:text-primary-500 font-medium" title="Stampaj">
                                <svg class="h-5 w-5 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
                            </button>
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>

        <!-- Empty state -->
        <div x-show="receipts.length === 0 && !loading" class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <p class="mt-2 text-sm text-gray-500">Nema racuna za prikaz</p>
        </div>

        <!-- Pagination -->
        <div class="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6" x-show="totalPages > 1">
            <div class="text-sm text-gray-700">
                Strana <span x-text="page"></span> od <span x-text="totalPages"></span>
                (<span x-text="totalReceipts"></span> racuna ukupno)
            </div>
            <div class="flex gap-2">
                <button @click="page--; loadReceipts()" :disabled="page <= 1"
                        class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 disabled:opacity-50">
                    Prethodna
                </button>
                <button @click="page++; loadReceipts()" :disabled="page >= totalPages"
                        class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 disabled:opacity-50">
                    Sledeca
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function receiptsPage() {
    return {
        receipts: [],
        loading: false,
        page: 1,
        totalPages: 1,
        totalReceipts: 0,
        filters: { status: '', date: '' },

        async loadReceipts() {
            this.loading = true;
            let url = `/api/v1/pos/receipts?page=${this.page}&per_page=20`;
            if (this.filters.status) url += `&status=${this.filters.status}`;
            if (this.filters.date) url += `&date=${this.filters.date}`;

            try {
                const res = await api(url);
                if (res.ok) {
                    const data = await res.json();
                    this.receipts = data.receipts || [];
                    this.totalReceipts = data.total || 0;
                    this.totalPages = data.pages || 1;
                }
            } catch (e) {
                console.error('Failed to load receipts:', e);
            }
            this.loading = false;
        },

        formatPrice(val) {
            if (val == null) return '0';
            return Number(val).toLocaleString('sr-RS', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        },

        formatDate(iso) {
            if (!iso) return '-';
            return new Date(iso).toLocaleDateString('sr-RS', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        },

        printReceipt(id) {
            const _t = sessionStorage.getItem('access_token') || '';
            window.open(`/pos/receipts/print?id=${id}#t=${_t}`, '_blank', 'width=400,height=700');
        }
    };
}
</script>
{% endblock %}