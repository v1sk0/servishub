{% extends "layouts/tenant.html" %}

{% block title %}Import eFaktura{% endblock %}

{% block page_content %}
<div x-data="efakturaImport()" x-init="init()">

    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between mb-6">
        <div>
            <h2 class="text-2xl font-bold text-gray-900">Import eFaktura</h2>
            <p class="mt-1 text-sm text-gray-500">Uvoz robe iz XML fakture</p>
        </div>
        <div class="mt-4 flex gap-2 md:mt-0">
            <a href="/goods" class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">Roba</a>
            <a href="/goods/invoices" class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">Fakture</a>
        </div>
    </div>

    <!-- ==================== PHASE 1: UPLOAD ==================== -->
    <div x-show="phase === 'upload'" x-cloak>
        <div class="bg-white shadow rounded-lg p-8">
            <div class="max-w-xl mx-auto">
                <div class="border-2 border-dashed rounded-lg p-8 text-center transition-colors"
                     :class="dragover ? 'border-primary-500 bg-primary-50' : 'border-gray-300 hover:border-gray-400'"
                     @dragover.prevent="dragover = true"
                     @dragleave.prevent="dragover = false"
                     @drop.prevent="dragover = false; handleDrop($event)">

                    <template x-if="!uploading">
                        <div>
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                            <p class="mt-4 text-sm font-semibold text-gray-900">Prevuci XML fajl ovde</p>
                            <p class="mt-1 text-xs text-gray-500">ili</p>
                            <label class="mt-3 inline-flex items-center rounded-md bg-primary-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500 cursor-pointer">
                                Izaberi fajl
                                <input type="file" accept=".xml" class="hidden" @change="handleFileSelect($event)">
                            </label>
                            <p class="mt-3 text-xs text-gray-400">Samo .xml fajlovi, max 5MB</p>
                        </div>
                    </template>

                    <template x-if="uploading">
                        <div>
                            <svg class="mx-auto h-10 w-10 text-primary-500 animate-spin" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                            </svg>
                            <p class="mt-3 text-sm text-gray-600">Parsiranje fakture...</p>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== PHASE 2: PREVIEW ==================== -->
    <div x-show="phase === 'preview'" x-cloak>

        <!-- Invoice header info -->
        <div class="bg-white shadow rounded-lg p-4 mb-4">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div>
                    <span class="text-gray-500">Dobavljac:</span>
                    <span class="font-semibold ml-1" x-text="supplier.name"></span>
                </div>
                <div>
                    <span class="text-gray-500">PIB:</span>
                    <span class="font-semibold ml-1" x-text="supplier.pib"></span>
                </div>
                <div>
                    <span class="text-gray-500">Br. fakture:</span>
                    <span class="font-semibold ml-1" x-text="invoice.number"></span>
                </div>
                <div>
                    <span class="text-gray-500">Datum:</span>
                    <span class="font-semibold ml-1" x-text="invoice.date"></span>
                </div>
            </div>
        </div>

        <!-- Duplicate warning -->
        <div x-show="duplicateWarning" class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4 text-sm text-yellow-800" x-text="duplicateWarning"></div>

        <!-- Summary cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
            <div class="bg-white shadow rounded-lg p-3 text-center">
                <div class="text-2xl font-bold text-gray-900" x-text="summary.total_items"></div>
                <div class="text-xs text-gray-500">Ukupno stavki</div>
            </div>
            <div class="bg-white shadow rounded-lg p-3 text-center">
                <div class="text-2xl font-bold text-green-600" x-text="summary.new_items"></div>
                <div class="text-xs text-gray-500">Novih</div>
            </div>
            <div class="bg-white shadow rounded-lg p-3 text-center">
                <div class="text-2xl font-bold text-blue-600" x-text="summary.update_items"></div>
                <div class="text-xs text-gray-500">Azuriranje</div>
            </div>
            <div class="bg-white shadow rounded-lg p-3 text-center">
                <div class="text-2xl font-bold text-gray-900" x-text="formatPrice(summary.total_with_vat)"></div>
                <div class="text-xs text-gray-500">Ukupno sa PDV</div>
            </div>
        </div>

        <!-- Bulk margin -->
        <div class="bg-white shadow rounded-lg p-3 mb-4 flex items-center gap-3 flex-wrap">
            <span class="text-sm text-gray-700 font-medium">Primeni marzu na sve NOVO:</span>
            <input type="number" x-model.number="defaultMargin" min="0" max="999" step="5"
                   class="w-20 rounded-md border-gray-300 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500">
            <span class="text-sm text-gray-500">%</span>
            <button @click="applyDefaultMargin()"
                    class="rounded-md bg-primary-600 px-3 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-primary-500">
                Primeni
            </button>
            <button @click="phase = 'upload'; items = []; supplier = {}; invoice = {};"
                    class="ml-auto text-sm text-gray-500 hover:text-gray-700">
                Nova faktura
            </button>
        </div>

        <!-- Items table -->
        <div class="bg-white shadow rounded-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-300 text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="py-2 pl-3 pr-1 text-left font-semibold text-gray-900 w-8">#</th>
                            <th class="px-1 py-2 text-left font-semibold text-gray-900 w-20">Status</th>
                            <th class="px-1 py-2 text-left font-semibold text-gray-900 w-16">Sifra</th>
                            <th class="px-1 py-2 text-left font-semibold text-gray-900">Naziv</th>
                            <th class="px-1 py-2 text-right font-semibold text-gray-900 w-12">Kol.</th>
                            <th class="px-1 py-2 text-right font-semibold text-gray-900 w-24">Nab. bez PDV</th>
                            <th class="px-1 py-2 text-right font-semibold text-gray-900 w-24">Nab. sa PDV</th>
                            <th class="px-2 py-2 text-right font-semibold text-gray-900 w-28">Prodajna sa PDV</th>
                            <th class="px-2 py-2 text-right font-semibold text-gray-900 w-20">Marza %</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        <template x-for="(item, i) in items" :key="i">
                            <tr :class="item.match_status === 'UPDATE' ? 'bg-blue-50/30' : ''">
                                <td class="py-2 pl-3 pr-1 text-gray-500" x-text="i + 1"></td>
                                <td class="px-1 py-2">
                                    <span x-show="item.match_status === 'NEW'"
                                          class="inline-flex items-center rounded-full bg-green-100 px-2 py-0.5 text-xs font-medium text-green-700">NOVO</span>
                                    <span x-show="item.match_status === 'UPDATE'"
                                          class="inline-flex items-center rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-700">AZUR.</span>
                                </td>
                                <td class="px-1 py-2 text-gray-500 font-mono text-xs" x-text="item.supplier_code"></td>
                                <td class="px-1 py-2">
                                    <div class="font-medium text-gray-900" x-text="item.name"></div>
                                    <div x-show="item.existing_item" class="text-xs text-gray-400 mt-0.5">
                                        Na stanju: <span x-text="item.existing_item?.current_stock"></span> kom,
                                        prodajna: <span x-text="formatPrice(item.existing_item?.selling_price)"></span> RSD
                                    </div>
                                </td>
                                <td class="px-1 py-2 text-right" x-text="item.quantity"></td>
                                <td class="px-1 py-2 text-right text-gray-600" x-text="formatPrice(item.purchase_price)"></td>
                                <td class="px-1 py-2 text-right text-gray-600" x-text="formatPrice(item.purchase_price * (1 + item.tax_percent / 100))"></td>
                                <td class="px-2 py-2">
                                    <input type="number" x-model.number="item.selling_price"
                                           @change="updateFromPrice(item)" min="0" step="10"
                                           class="w-full text-right rounded-md border-gray-300 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 py-1 px-2">
                                </td>
                                <td class="px-2 py-2">
                                    <input type="number" x-model.number="item.margin_pct"
                                           @change="updateFromMargin(item)" min="-100" step="5"
                                           class="w-full text-right rounded-md border-gray-300 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 py-1 px-2">
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- Confirm button -->
            <div class="p-4 border-t border-gray-200 flex items-center justify-between">
                <div class="text-sm text-gray-500">
                    <span x-text="items.length"></span> stavki,
                    ukupno nabavna: <span class="font-semibold" x-text="formatPrice(items.reduce((s, i) => s + i.purchase_price * i.quantity, 0))"></span> RSD (bez PDV)
                </div>
                <button @click="confirmImport()" :disabled="confirming"
                        class="inline-flex items-center rounded-md bg-green-600 px-5 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-green-500 disabled:opacity-50 disabled:cursor-not-allowed">
                    <template x-if="!confirming">
                        <span>Uvezi na stanje</span>
                    </template>
                    <template x-if="confirming">
                        <span>Uvozi se...</span>
                    </template>
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== PHASE 3: SUCCESS ==================== -->
    <div x-show="phase === 'success'" x-cloak>
        <div class="bg-white shadow rounded-lg p-8 text-center max-w-lg mx-auto">
            <svg class="mx-auto h-16 w-16 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <h3 class="mt-4 text-lg font-semibold text-gray-900" x-text="result.message"></h3>
            <div class="mt-2 text-sm text-gray-500">
                Faktura <span class="font-medium" x-text="invoice.number"></span> od <span class="font-medium" x-text="supplier.name"></span>
            </div>
            <div class="mt-6 flex justify-center gap-3">
                <a href="/goods" class="rounded-md bg-primary-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500">
                    Pogledaj robu
                </a>
                <button @click="resetAll()"
                        class="rounded-md bg-white px-4 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                    Nova faktura
                </button>
                <a href="/goods/invoices" class="rounded-md bg-white px-4 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                    Sve fakture
                </a>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div x-show="toast.show" x-cloak
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 translate-y-2"
         x-transition:enter-end="opacity-100 translate-y-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 translate-y-0"
         x-transition:leave-end="opacity-0 translate-y-2"
         class="fixed bottom-4 right-4 z-50 rounded-lg px-4 py-3 shadow-lg text-sm font-medium"
         :class="toast.type === 'error' ? 'bg-red-600 text-white' : 'bg-green-600 text-white'"
         x-text="toast.message">
    </div>
</div>

<script>
function efakturaImport() {
    return {
        phase: 'upload',
        uploading: false,
        confirming: false,
        dragover: false,

        supplier: {},
        invoice: {},
        items: [],
        summary: {},
        duplicateWarning: null,
        result: {},

        defaultMargin: 40,
        toast: { show: false, message: '', type: 'success' },

        init() {},

        handleDrop(e) {
            const files = e.dataTransfer?.files;
            if (files && files.length > 0) this.uploadFile(files[0]);
        },

        handleFileSelect(e) {
            const file = e.target.files?.[0];
            if (file) this.uploadFile(file);
            e.target.value = '';
        },

        async uploadFile(file) {
            if (!file.name.toLowerCase().endsWith('.xml')) {
                this.showToast('Samo XML fajlovi su dozvoljeni', 'error');
                return;
            }
            if (file.size > 5 * 1024 * 1024) {
                this.showToast('Fajl je prevelik (max 5MB)', 'error');
                return;
            }

            this.uploading = true;
            try {
                const formData = new FormData();
                formData.append('file', file);

                const token = sessionStorage.getItem('access_token');
                const res = await fetch('/api/v1/goods/invoices/efaktura/parse', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token },
                    body: formData,
                });

                const data = await res.json();
                if (!res.ok) {
                    this.showToast(data.error || 'Greska pri parsiranju', 'error');
                    return;
                }

                this.supplier = data.supplier;
                this.invoice = data.invoice;
                this.summary = data.summary;
                this.duplicateWarning = data.duplicate_warning;

                // Populate items with editable fields
                this.items = data.items.map(item => ({
                    ...item,
                    selling_price: item.suggested_selling_price,
                    margin_pct: item.suggested_margin_pct,
                }));

                this.phase = 'preview';
            } catch (e) {
                this.showToast('Greska: ' + e.message, 'error');
            } finally {
                this.uploading = false;
            }
        },

        updateFromPrice(item) {
            const nabSaPdv = item.purchase_price * (1 + item.tax_percent / 100);
            if (nabSaPdv > 0) {
                item.margin_pct = parseFloat(((item.selling_price - nabSaPdv) / nabSaPdv * 100).toFixed(1));
            }
        },

        updateFromMargin(item) {
            const nabSaPdv = item.purchase_price * (1 + item.tax_percent / 100);
            const raw = nabSaPdv * (1 + item.margin_pct / 100);
            if (raw <= 500) item.selling_price = Math.ceil(raw / 10) * 10;
            else if (raw <= 2000) item.selling_price = Math.ceil(raw / 50) * 50;
            else item.selling_price = Math.ceil(raw / 100) * 100;
        },

        applyDefaultMargin() {
            this.items.forEach(item => {
                if (item.match_status === 'NEW') {
                    item.margin_pct = this.defaultMargin;
                    this.updateFromMargin(item);
                }
            });
            this.showToast('Marza primenjena na ' + this.items.filter(i => i.match_status === 'NEW').length + ' artikala', 'success');
        },

        async confirmImport() {
            this.confirming = true;
            try {
                const payload = {
                    supplier_name: this.supplier.name,
                    supplier_pib: this.supplier.pib,
                    invoice_number: this.invoice.number,
                    invoice_date: this.invoice.date,
                    items: this.items.map(item => ({
                        name: item.name,
                        supplier_code: item.supplier_code,
                        barcode: item.barcode || '',
                        quantity: item.quantity,
                        purchase_price: item.purchase_price,
                        selling_price: item.selling_price,
                        tax_percent: item.tax_percent,
                        existing_item_id: item.existing_item?.id || null,
                        category: item.category || '',
                    })),
                };

                const res = await api('/goods/invoices/efaktura/confirm', 'POST', payload);
                const data = await res.json();

                if (!res.ok) {
                    this.showToast(data.error || 'Greska pri uvozu', 'error');
                    return;
                }

                this.result = data;
                this.phase = 'success';
            } catch (e) {
                this.showToast('Greska: ' + e.message, 'error');
            } finally {
                this.confirming = false;
            }
        },

        resetAll() {
            this.phase = 'upload';
            this.items = [];
            this.supplier = {};
            this.invoice = {};
            this.summary = {};
            this.duplicateWarning = null;
            this.result = {};
        },

        formatPrice(val) {
            if (val == null || isNaN(val)) return '0';
            return parseFloat(val).toLocaleString('sr-RS', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        },

        showToast(message, type = 'success') {
            this.toast = { show: true, message, type };
            setTimeout(() => { this.toast.show = false; }, 4000);
        },
    };
}
</script>
{% endblock %}
