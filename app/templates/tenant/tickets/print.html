<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Servisni nalog</title>
  <style>
    /* Reset */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      font-size: 10.5pt;
      line-height: 1.3;
      color: #1a1a1a;
    }

    /* Page wrapper - A4 */
    .page-wrapper {
      width: 210mm;
      height: 297mm;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
    }

    /* Ticket container - polovina A4 */
    .ticket-container {
      width: 100%;
      height: 140mm;
      padding: 5mm 10mm;
      box-sizing: border-box;
      overflow: hidden;
      position: relative;
    }

    /* Company header */
    .company-header {
      text-align: center;
      margin-bottom: 3mm;
      padding-bottom: 2mm;
      border-bottom: 1.5pt solid #333;
    }

    .company-logo {
      margin-bottom: 1mm;
    }

    .company-logo img {
      display: block;
      margin: 0 auto;
      width: 70px;
      height: auto;
      filter: grayscale(100%);
    }

    .company-logo .logo-text {
      font-size: 16pt;
      font-weight: 700;
      color: #111;
      letter-spacing: 0.5px;
    }

    .company-info p {
      font-size: 8.5pt;
      color: #444;
      margin: 0;
      letter-spacing: 0.2px;
    }

    /* Ticket header */
    .ticket-header {
      text-align: center;
      margin-bottom: 2.5mm;
      padding: 2mm 3mm;
      background: #f0f0f0;
      border: 1pt solid #555;
      border-radius: 1mm;
    }

    .ticket-header p {
      font-weight: 700;
      font-size: 10.5pt;
      margin: 0;
      letter-spacing: 0.3px;
    }

    /* Main data table */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 2mm;
    }

    .data-table th,
    .data-table td {
      border: 0.5pt solid #999;
      padding: 1.5mm 2.5mm;
      font-size: 9.5pt;
      vertical-align: middle;
    }

    .data-table th {
      background: #f7f7f7;
      text-align: left;
      font-weight: 600;
      color: #333;
      white-space: nowrap;
      width: 16%;
    }

    .data-table td {
      color: #111;
    }

    /* Priority badge */
    .priority-badge {
      display: inline-block;
      padding: 0.5mm 2.5mm;
      border-radius: 2px;
      font-size: 8.5pt;
      font-weight: 600;
    }
    .priority-normal { background: #e8e8e8; color: #444; }
    .priority-urgent { background: #fee2e2; color: #b91c1c; border: 0.5pt solid #fca5a5; }
    .priority-high { background: #fef3c7; color: #92400e; border: 0.5pt solid #fcd34d; }
    .priority-low { background: #e8e8e8; color: #666; }

    /* Clause text */
    .clause-text {
      font-size: 7pt;
      color: #333;
      margin: 2mm 0 1mm;
      padding: 1.5mm 3mm;
      border: 0.5pt solid #bbb;
      background: #fafafa;
      line-height: 1.4;
      border-radius: 1mm;
    }

    /* SMS clause */
    .sms-clause {
      font-size: 7.5pt;
      color: #555;
      padding: 1mm 3mm;
      display: flex;
      align-items: center;
      gap: 1mm;
    }

    .sms-clause strong {
      font-weight: 700;
    }

    /* Signatures + QR wrapper */
    .bottom-section {
      display: flex;
      align-items: flex-start;
      gap: 4mm;
      margin-top: 1.5mm;
    }

    /* Signatures */
    .signatures-table {
      flex: 1;
      border-collapse: collapse;
    }

    .signatures-table td {
      border: none;
      width: 50%;
      padding: 0.5mm 1.5mm;
      vertical-align: top;
    }

    .signatures-table small {
      font-size: 8pt;
      color: #555;
    }

    .signature-line {
      border-bottom: 0.5pt solid #333;
      height: 7mm;
      margin-top: 1mm;
      width: 90%;
    }

    /* QR section */
    .qr-section {
      text-align: center;
      flex-shrink: 0;
      padding-top: 1mm;
    }

    .qr-section img,
    .qr-section canvas {
      width: 20mm;
      height: 20mm;
    }

    .qr-section p {
      font-size: 6.5pt;
      color: #888;
      margin-top: 0.5mm;
    }

    /* Footer row: copy label + powered by */
    .ticket-footer {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-top: 1mm;
      padding-top: 1mm;
      border-top: 0.25pt solid #ddd;
    }

    .copy-label {
      font-size: 8pt;
      color: #999;
      font-style: italic;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    .powered-by {
      font-size: 6pt;
      color: #bbb;
    }
    .powered-by span {
      font-size: 6.5pt;
      font-weight: 700;
      color: #888;
    }

    /* Cut line */
    .cut-line {
      height: 12mm;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .cut-line::before {
      content: '';
      position: absolute;
      left: 8mm;
      right: 8mm;
      top: 50%;
      border-top: 1pt dashed #ccc;
    }

    .cut-line span {
      background: #fff;
      padding: 0 4mm;
      position: relative;
      z-index: 1;
      color: #bbb;
      font-size: 7pt;
      letter-spacing: 3px;
      text-transform: uppercase;
    }

    /* Loading state */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-size: 14pt;
      color: #666;
    }

    .loading .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e5e7eb;
      border-top-color: #7c3aed;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 10mm;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Error state */
    .error {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      color: #b91c1c;
      text-align: center;
      padding: 20mm;
    }

    .error h2 {
      margin-bottom: 5mm;
    }

    /* Print styles */
    @media print {
      @page {
        size: A4;
        margin: 5mm;
      }

      html, body {
        width: 210mm;
        height: 297mm;
      }

      body {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      .page-wrapper {
        page-break-after: avoid;
        page-break-inside: avoid;
      }

      .no-print {
        display: none !important;
      }

      .cut-line span {
        background: #fff;
      }
    }

    /* Screen preview */
    @media screen {
      body {
        background: #e2e2e2;
        padding: 10mm;
      }
      .page-wrapper {
        background: #fff;
        box-shadow: 0 2px 20px rgba(0,0,0,0.15);
      }
    }

    /* Print button */
    .print-button {
      position: fixed;
      top: 10mm;
      right: 10mm;
      padding: 10px 20px;
      background: #7c3aed;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 11pt;
      font-weight: 600;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(124, 58, 237, 0.3);
      transition: all 0.15s;
    }

    .print-button:hover {
      background: #6d28d9;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);
    }
  </style>
</head>
<body>
  <!-- Print button (hidden on print) -->
  <button class="print-button no-print" onclick="window.print()">Stampaj</button>

  <!-- Loading state -->
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p>Ucitavam nalog...</p>
  </div>

  <!-- Error state -->
  <div id="error" class="error" style="display: none;">
    <h2>Greska</h2>
    <p id="error-message">Nalog nije pronadjen.</p>
    <button onclick="window.close()" style="margin-top: 10mm; padding: 8px 16px; cursor: pointer;">Zatvori</button>
  </div>

  <!-- Content (hidden until loaded) -->
  <div id="content" class="page-wrapper" style="display: none;">
    <!-- First copy - for service -->
    <div class="ticket-container">
      <header class="company-header">
        <div class="company-logo">
          <img id="logo-img-1" style="display: none;" alt="Logo">
          <span class="logo-text" id="logo-text-1"></span>
        </div>
        <div class="company-info">
          <p id="tenant-info-1"></p>
        </div>
      </header>

      <div class="ticket-header">
        <p>SERVISNI NALOG br: <span id="ticket-number-1"></span> &nbsp;&middot;&nbsp; <span id="ticket-date-1"></span> &nbsp;&middot;&nbsp; <span id="customer-name-1"></span></p>
      </div>

      <table class="data-table">
        <tbody>
          <tr>
            <th>Uredjaj</th>
            <td id="service-section-1"></td>
            <th>Marka / Model</th>
            <td colspan="3" id="brand-model-1"></td>
          </tr>
          <tr>
            <th>Korisnik</th>
            <td id="customer-full-1"></td>
            <th>Telefon</th>
            <td id="customer-phone-1"></td>
            <th>Prioritet</th>
            <td id="priority-1"></td>
          </tr>
          <tr id="company-row-1" style="display: none;">
            <th>Firma</th>
            <td colspan="3" id="company-name-1"></td>
            <th>PIB</th>
            <td id="company-pib-1"></td>
          </tr>
          <tr id="imei-row-1" style="display: none;">
            <th id="imei-label-1">IMEI</th>
            <td colspan="5" id="imei-1"></td>
          </tr>
          <tr>
            <th>Opis kvara</th>
            <td colspan="5" id="problem-1"></td>
          </tr>
          <tr>
            <th>Cena</th>
            <td id="price-1"></td>
            <th>Serviser</th>
            <td id="technician-1"></td>
            <th>Lokacija</th>
            <td id="location-1"></td>
          </tr>
        </tbody>
      </table>

      <div class="clause-text" id="clause-1">
        Opremu ostavljate na servis na sopstvenu odgovornost. Servis ne snosi odgovornost za gubitak podataka.
        Garancija vazi samo uz ovaj nalog. Maksimalno vreme cuvanja opreme je 30 dana od obavestenja o zavrsetku servisa.
      </div>
      <div class="sms-clause" id="sms-clause-1">
        SMS obavestenja: <strong id="sms-status-1">DA</strong>
      </div>

      <div class="bottom-section">
        <table class="signatures-table">
          <tr>
            <td>
              <small>Primio na servis:</small>
              <div class="signature-line"></div>
            </td>
            <td>
              <small>Saglasan sa stanjem:</small>
              <div class="signature-line"></div>
            </td>
          </tr>
          <tr>
            <td>
              <small>Predao uredjaj:</small>
              <div class="signature-line"></div>
            </td>
            <td>
              <small>Preuzeo sa servisa:</small>
              <div class="signature-line"></div>
            </td>
          </tr>
        </table>
        <div class="qr-section">
          <img id="qr-code-1" src="" alt="QR" style="width: 75px; height: 75px;">
          <p>Pracenje naloga</p>
        </div>
      </div>

      <div class="ticket-footer">
        <span class="copy-label">Primerak za servis</span>
        <span class="powered-by">powered by <span>ServisHub</span></span>
      </div>
    </div>

    <!-- Cut line -->
    <div class="cut-line">
      <span>isecite ovde</span>
    </div>

    <!-- Second copy - for customer -->
    <div class="ticket-container">
      <header class="company-header">
        <div class="company-logo">
          <img id="logo-img-2" style="display: none;" alt="Logo">
          <span class="logo-text" id="logo-text-2"></span>
        </div>
        <div class="company-info">
          <p id="tenant-info-2"></p>
        </div>
      </header>

      <div class="ticket-header">
        <p>SERVISNI NALOG br: <span id="ticket-number-2"></span> &nbsp;&middot;&nbsp; <span id="ticket-date-2"></span> &nbsp;&middot;&nbsp; <span id="customer-name-2"></span></p>
      </div>

      <table class="data-table">
        <tbody>
          <tr>
            <th>Uredjaj</th>
            <td id="service-section-2"></td>
            <th>Marka / Model</th>
            <td colspan="3" id="brand-model-2"></td>
          </tr>
          <tr>
            <th>Korisnik</th>
            <td id="customer-full-2"></td>
            <th>Telefon</th>
            <td id="customer-phone-2"></td>
            <th>Prioritet</th>
            <td id="priority-2"></td>
          </tr>
          <tr id="company-row-2" style="display: none;">
            <th>Firma</th>
            <td colspan="3" id="company-name-2"></td>
            <th>PIB</th>
            <td id="company-pib-2"></td>
          </tr>
          <tr id="imei-row-2" style="display: none;">
            <th id="imei-label-2">IMEI</th>
            <td colspan="5" id="imei-2"></td>
          </tr>
          <tr>
            <th>Opis kvara</th>
            <td colspan="5" id="problem-2"></td>
          </tr>
          <tr>
            <th>Cena</th>
            <td id="price-2"></td>
            <th>Serviser</th>
            <td id="technician-2"></td>
            <th>Lokacija</th>
            <td id="location-2"></td>
          </tr>
        </tbody>
      </table>

      <div class="clause-text" id="clause-2">
        Opremu ostavljate na servis na sopstvenu odgovornost. Servis ne snosi odgovornost za gubitak podataka.
        Garancija vazi samo uz ovaj nalog. Maksimalno vreme cuvanja opreme je 30 dana od obavestenja o zavrsetku servisa.
      </div>
      <div class="sms-clause" id="sms-clause-2">
        SMS obavestenja: <strong id="sms-status-2">DA</strong>
      </div>

      <div class="bottom-section">
        <table class="signatures-table">
          <tr>
            <td>
              <small>Primio na servis:</small>
              <div class="signature-line"></div>
            </td>
            <td>
              <small>Saglasan sa stanjem:</small>
              <div class="signature-line"></div>
            </td>
          </tr>
          <tr>
            <td>
              <small>Predao uredjaj:</small>
              <div class="signature-line"></div>
            </td>
            <td>
              <small>Preuzeo sa servisa:</small>
              <div class="signature-line"></div>
            </td>
          </tr>
        </table>
        <div class="qr-section">
          <img id="qr-code-2" src="" alt="QR" style="width: 75px; height: 75px;">
          <p>Pracenje naloga</p>
        </div>
      </div>

      <div class="ticket-footer">
        <span class="copy-label">Primerak za korisnika</span>
        <span class="powered-by">powered by <span>ServisHub</span></span>
      </div>
    </div>
  </div>

  <script>
    // Ticket ID from URL
    const ticketId = {{ ticket_id }};

    // Get tokens from localStorage
    function getAccessToken() {
      const directToken = sessionStorage.getItem('access_token');
      if (directToken) return directToken;

      const tokenData = localStorage.getItem('servishub_token');
      if (tokenData) {
        try {
          const parsed = JSON.parse(tokenData);
          return parsed.access_token;
        } catch (e) {
          return tokenData;
        }
      }
      return null;
    }

    // Format date
    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('sr-RS', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
    }

    // Format priority badge
    function formatPriority(priority) {
      const map = {
        'LOW': '<span class="priority-badge priority-low">Nizak</span>',
        'NORMAL': '<span class="priority-badge priority-normal">Normalan</span>',
        'HIGH': '<span class="priority-badge priority-high">Visok</span>',
        'URGENT': '<span class="priority-badge priority-urgent">Hitan</span>'
      };
      return map[priority] || priority || '-';
    }

    // Show error
    function showError(message) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'flex';
      document.getElementById('error-message').textContent = message;
    }

    // Device type label mapping
    const DEVICE_TYPE_LABELS = {
      'phone': 'Telefon', 'tablet': 'Tablet', 'laptop': 'Laptop',
      'console': 'Konzola', 'scooter': 'Trotinet', 'other': 'Ostalo',
      'PHONE': 'Telefon', 'TABLET': 'Tablet', 'LAPTOP': 'Laptop',
      'COMPUTER': 'Desktop', 'SCOOTER': 'Trotinet', 'OTHER': 'Ostalo'
    };

    // Identifier label per device type
    const IDENTIFIER_LABELS = {
      'phone': 'IMEI', 'tablet': 'IMEI / S/N', 'laptop': 'Serijski broj',
      'console': 'Serijski broj', 'scooter': 'Serijski broj', 'other': 'Serijski broj',
      'PHONE': 'IMEI', 'TABLET': 'IMEI / S/N', 'LAPTOP': 'Serijski broj',
      'COMPUTER': 'Serijski broj', 'SCOOTER': 'Serijski broj', 'OTHER': 'Serijski broj'
    };

    // Fill both copies with data
    function fillTicketData(ticket, tenant, location, qr_code_base64) {
      for (let i = 1; i <= 2; i++) {
        // Tenant logo
        const logoImg = document.getElementById(`logo-img-${i}`);
        const logoText = document.getElementById(`logo-text-${i}`);

        if (tenant?.logo_url) {
          logoImg.src = tenant.logo_url;
          logoImg.style.display = 'block';
          logoText.style.display = 'none';
        } else {
          logoImg.style.display = 'none';
          logoText.style.display = 'block';
          logoText.textContent = tenant?.name || 'Servis';
        }

        // Tenant info line
        document.getElementById(`tenant-info-${i}`).textContent =
          [tenant?.address, tenant?.phone ? `Tel: ${tenant.phone}` : ''].filter(Boolean).join('  |  ') || '';

        // Ticket header
        document.getElementById(`ticket-number-${i}`).textContent = ticket.ticket_number || ticket.id;
        document.getElementById(`ticket-date-${i}`).textContent = formatDate(ticket.created_at);
        document.getElementById(`customer-name-${i}`).textContent = ticket.customer_name || '-';

        // Device type
        const deviceLabel = DEVICE_TYPE_LABELS[ticket.device_type] || ticket.service_section || 'Telefon';
        document.getElementById(`service-section-${i}`).textContent = deviceLabel;

        // Brand / Model
        document.getElementById(`brand-model-${i}`).textContent =
          [ticket.brand, ticket.model].filter(Boolean).join(' ') || '-';

        // Customer
        document.getElementById(`customer-full-${i}`).textContent = ticket.customer_name || '-';
        document.getElementById(`customer-phone-${i}`).textContent = ticket.customer_phone || '-';
        document.getElementById(`priority-${i}`).innerHTML = formatPriority(ticket.priority);

        // Company info (B2B)
        if (ticket.customer_company_name) {
          document.getElementById(`company-row-${i}`).style.display = '';
          document.getElementById(`company-name-${i}`).textContent = ticket.customer_company_name;
          document.getElementById(`company-pib-${i}`).textContent = ticket.customer_pib || '-';
        }

        // IMEI / Serial
        if (ticket.imei) {
          document.getElementById(`imei-row-${i}`).style.display = '';
          document.getElementById(`imei-label-${i}`).textContent = IDENTIFIER_LABELS[ticket.device_type] || 'IMEI';
          document.getElementById(`imei-${i}`).textContent = ticket.imei;
        }

        // Problem and price
        document.getElementById(`problem-${i}`).textContent = ticket.problem_description || '-';
        document.getElementById(`price-${i}`).textContent =
          ticket.estimated_price ? `${ticket.estimated_price} ${ticket.currency || 'RSD'}` : '-';

        // Technician and location
        document.getElementById(`technician-${i}`).textContent = ticket.created_by_name || '-';
        document.getElementById(`location-${i}`).textContent = location?.name || '-';

        // QR code
        if (qr_code_base64) {
          document.getElementById(`qr-code-${i}`).src = `data:image/png;base64,${qr_code_base64}`;
        }

        // Print clause
        if (tenant?.print_clause) {
          document.getElementById(`clause-${i}`).textContent = tenant.print_clause;
        }

        // SMS status
        const smsStatus = ticket.sms_opt_out ? 'NE' : 'DA';
        document.getElementById(`sms-status-${i}`).textContent = smsStatus;
        document.getElementById(`sms-status-${i}`).style.color = ticket.sms_opt_out ? '#dc2626' : '#16a34a';
      }
    }

    // Fetch ticket data
    async function loadTicket() {
      const accessToken = getAccessToken();
      if (!accessToken) {
        showError('Niste prijavljeni. Molimo prijavite se ponovo.');
        return;
      }

      try {
        const response = await fetch(`/api/v1/tickets/${ticketId}/print`, {
          headers: { 'Authorization': `Bearer ${accessToken}` }
        });

        if (!response.ok) {
          if (response.status === 401) {
            showError('Sesija je istekla. Molimo prijavite se ponovo.');
            return;
          }
          if (response.status === 404) {
            showError('Nalog nije pronadjen.');
            return;
          }
          throw new Error('Greska pri ucitavanju naloga');
        }

        const data = await response.json();

        // Fill both copies
        fillTicketData(data.ticket, data.tenant, data.location, data.qr_code_base64);

        // Show content
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'flex';

      } catch (error) {
        console.error('Error loading ticket:', error);
        showError(error.message || 'Greska pri ucitavanju naloga');
      }
    }

    // Load on page ready
    document.addEventListener('DOMContentLoaded', loadTicket);
  </script>
</body>
</html>
