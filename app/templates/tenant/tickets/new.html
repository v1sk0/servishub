{% extends "layouts/tenant.html" %}

{% block title %}Novi nalog - ServisHub{% endblock %}

{% block page_content %}
<div x-data="newTicketPage()" x-init="loadData()">
    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between mb-8">
        <div class="min-w-0 flex-1">
            <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl sm:tracking-tight">
                Novi servisni nalog
            </h2>
            <p class="mt-1 text-sm text-gray-500">
                Popunite podatke o kupcu i ureƒëaju
            </p>
        </div>
        <div class="mt-4 flex md:ml-4 md:mt-0">
            <a href="/tickets"
               class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                <svg class="-ml-0.5 mr-1.5 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M17 10a.75.75 0 01-.75.75H5.612l4.158 3.96a.75.75 0 11-1.04 1.08l-5.5-5.25a.75.75 0 010-1.08l5.5-5.25a.75.75 0 111.04 1.08L5.612 9.25H16.25A.75.75 0 0117 10z" clip-rule="evenodd" />
                </svg>
                Nazad
            </a>
        </div>
    </div>

    <!-- Form -->
    <form @submit.prevent="submitForm()" class="space-y-8">
        <!-- Customer Info -->
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Podaci o kupcu</h3>
            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div>
                    <label for="customer_name" class="block text-sm font-medium text-gray-700">Ime i prezime *</label>
                    <input type="text" id="customer_name" x-model="form.customer_name" required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                </div>
                <!-- Telefon sa Country Selector -->
                <div>
                    <label for="customer_phone" class="block text-sm font-medium text-gray-700">Telefon *</label>
                    <div class="mt-1 flex gap-2">
                        <!-- Country selector dropdown -->
                        <div class="relative" x-data="{ open: false }">
                            <button @click="open = !open" type="button"
                                    class="flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-md bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary-500">
                                <span x-text="selectedCountry.flag" class="text-lg"></span>
                                <span x-text="selectedCountry.code" class="text-sm text-gray-600"></span>
                                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </button>

                            <!-- Dropdown menu -->
                            <div x-show="open" @click.away="open = false"
                                 x-transition:enter="transition ease-out duration-100"
                                 x-transition:enter-start="transform opacity-0 scale-95"
                                 x-transition:enter-end="transform opacity-100 scale-100"
                                 x-transition:leave="transition ease-in duration-75"
                                 x-transition:leave-start="transform opacity-100 scale-100"
                                 x-transition:leave-end="transform opacity-0 scale-95"
                                 class="absolute z-20 mt-1 w-56 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-auto">

                                <!-- Ex-YU Region -->
                                <div class="px-3 py-1.5 text-xs font-medium text-gray-500 bg-gray-50 sticky top-0">Region</div>
                                <template x-for="country in exYuCountries" :key="country.code">
                                    <button @click="selectCountry(country); open = false" type="button"
                                            class="w-full flex items-center gap-3 px-3 py-2 hover:bg-gray-100 text-left"
                                            :class="{'bg-primary-50': selectedCountry.code === country.code}">
                                        <span x-text="country.flag" class="text-lg"></span>
                                        <span x-text="country.name" class="flex-1 text-sm text-gray-700"></span>
                                        <span x-text="country.code" class="text-xs text-gray-400"></span>
                                    </button>
                                </template>

                                <!-- Ostale zemlje -->
                                <div class="px-3 py-1.5 text-xs font-medium text-gray-500 bg-gray-50 sticky top-0">Ostalo</div>
                                <template x-for="country in otherCountries" :key="country.code">
                                    <button @click="selectCountry(country); open = false" type="button"
                                            class="w-full flex items-center gap-3 px-3 py-2 hover:bg-gray-100 text-left"
                                            :class="{'bg-primary-50': selectedCountry.code === country.code}">
                                        <span x-text="country.flag" class="text-lg"></span>
                                        <span x-text="country.name" class="flex-1 text-sm text-gray-700"></span>
                                        <span x-text="country.code" class="text-xs text-gray-400"></span>
                                    </button>
                                </template>
                            </div>
                        </div>

                        <!-- Phone number input -->
                        <input type="tel" id="customer_phone" x-model="phoneNumber"
                               @input="formatPhoneNumber()"
                               placeholder="64 123 4567" required
                               class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                    </div>
                    <p class="mt-1 text-xs text-gray-500">Format: <span x-text="formattedPhonePreview"></span></p>
                </div>
                <div class="sm:col-span-2">
                    <label for="customer_email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="customer_email" x-model="form.customer_email"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                </div>

                <!-- SMS Opt-out checkbox -->
                <div class="sm:col-span-2">
                    <div class="relative flex items-start">
                        <div class="flex h-6 items-center">
                            <input id="sms_opt_out" type="checkbox" x-model="form.sms_opt_out"
                                   class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-600">
                        </div>
                        <div class="ml-3">
                            <label for="sms_opt_out" class="text-sm font-medium text-gray-700">
                                Klijent NE ≈æeli SMS obave≈°tenja
                            </label>
                            <p class="text-xs text-gray-500">
                                Ako je ƒçekirano, klijent neƒáe primati SMS kada nalog bude spreman za preuzimanje
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Device Info -->
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Podaci o ureƒëaju</h3>
            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
                <div>
                    <label for="device_type" class="block text-sm font-medium text-gray-700">Tip ureƒëaja *</label>
                    <select id="device_type" x-model="form.device_type" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                        <option value="">Izaberite...</option>
                        <option value="PHONE">Mobilni telefon</option>
                        <option value="TABLET">Tablet</option>
                        <option value="LAPTOP">Laptop</option>
                        <option value="COMPUTER">Desktop raƒçunar</option>
                        <option value="OTHER">Ostalo</option>
                    </select>
                </div>
                <div>
                    <label for="brand" class="block text-sm font-medium text-gray-700">Marka *</label>
                    <input type="text" id="brand" x-model="form.brand" required list="brands-list"
                           @input="debouncedSearch()"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                    <datalist id="brands-list">
                        <option value="Apple">
                        <option value="Samsung">
                        <option value="Xiaomi">
                        <option value="Huawei">
                        <option value="OnePlus">
                        <option value="Google">
                        <option value="Motorola">
                        <option value="Nokia">
                        <option value="Sony">
                        <option value="LG">
                        <option value="Lenovo">
                        <option value="HP">
                        <option value="Dell">
                        <option value="Asus">
                        <option value="Acer">
                    </datalist>
                </div>
                <div>
                    <label for="model" class="block text-sm font-medium text-gray-700">Model *</label>
                    <input type="text" id="model" x-model="form.model" required
                           @input="debouncedSearch()"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                </div>
                <div>
                    <label for="imei" class="block text-sm font-medium text-gray-700">IMEI / Serijski broj</label>
                    <input type="text" id="imei" x-model="form.imei"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                </div>
                <div>
                    <label for="device_password" class="block text-sm font-medium text-gray-700">Lozinka ureƒëaja</label>
                    <input type="text" id="device_password" x-model="form.device_password"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                </div>
                <div>
                    <label for="device_condition" class="block text-sm font-medium text-gray-700">Stanje ureƒëaja</label>
                    <select id="device_condition" x-model="form.device_condition"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                        <option value="GOOD">Dobro</option>
                        <option value="SCRATCHED">Ogrebano</option>
                        <option value="CRACKED">Napuklo</option>
                        <option value="BROKEN">Polomljeno</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Dostupni delovi od dobavljaca - loading -->
        <div x-show="partOffers.loading" x-cloak class="bg-white shadow rounded-lg p-6">
            <div class="flex items-center gap-3">
                <svg class="animate-spin h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-sm text-gray-500">Pretrazujemo dostupne delove kod dobavljaca...</span>
            </div>
        </div>

        <!-- Dostupni delovi od dobavljaca - rezultati -->
        <div x-show="partOffers.loaded && partOffers.summary.length > 0" x-cloak
             class="bg-white shadow rounded-lg p-6 border-l-4 border-green-500">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900 flex items-center gap-2">
                    <svg class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Dostupni delovi kod dobavljaca
                </h3>
                <span class="text-xs text-gray-500" x-text="partOffers.brand + ' ' + partOffers.model"></span>
            </div>

            <!-- Summary tabela po kategoriji -->
            <template x-for="cat in partOffers.summary" :key="cat.category">
                <div class="mb-5">
                    <h4 class="font-medium text-sm text-gray-700 mb-2" x-text="getCategoryLabel(cat.category)"></h4>
                    <div class="grid grid-cols-2 gap-3">
                        <template x-for="[key, group] in Object.entries(cat.quality_groups)" :key="key">
                            <div class="border rounded-lg p-3 cursor-pointer hover:border-blue-400 transition-colors"
                                 :class="partOffers.expandedKey === cat.category + '_' + key ? 'border-blue-500 bg-blue-50' : 'border-gray-200'"
                                 @click="loadOffers(cat.category, key)">
                                <div class="text-xs font-medium text-gray-500 uppercase" x-text="group.label"></div>
                                <div class="text-lg font-bold text-gray-900"
                                     x-text="group.avg_eur ? ('~' + group.avg_eur.toFixed(0) + ' EUR') : (group.avg_rsd ? ('~' + Math.round(group.avg_rsd) + ' RSD') : 'N/A')">
                                </div>
                                <div class="text-xs text-gray-400"
                                     x-text="group.count + (group.count === 1 ? ' ponuda' : ' ponude') + ' od ' + group.supplier_count + ' dobavljaca'">
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Ponude za izabranu quality grupu -->
                    <div x-show="partOffers.expandedKey && partOffers.expandedKey.startsWith(cat.category + '_')"
                         x-cloak class="mt-3">
                        <!-- Loading -->
                        <div x-show="partOffers.offersLoading" class="text-center py-3">
                            <svg class="animate-spin h-5 w-5 text-blue-500 mx-auto" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                        <!-- Lista ponuda -->
                        <div x-show="!partOffers.offersLoading && partOffers.offers.length > 0" class="space-y-2">
                            <template x-for="(offer, idx) in partOffers.offers" :key="offer.listing_id">
                                <div class="flex items-center justify-between p-3 border rounded-lg transition-colors"
                                     :class="selectedListing === offer.listing_id ? 'border-green-500 bg-green-50' : 'border-gray-100 hover:border-gray-300'">
                                    <div class="flex items-center gap-4 flex-wrap">
                                        <span class="text-sm font-medium text-gray-400" x-text="'#' + (idx + 1)"></span>
                                        <div>
                                            <span class="font-semibold text-gray-900"
                                                  x-text="offer.price_eur ? (offer.price_eur.toFixed(2) + ' EUR') : (offer.price_rsd ? (Math.round(offer.price_rsd) + ' RSD') : 'N/A')">
                                            </span>
                                            <span x-show="offer.price_eur && offer.price_rsd" class="text-xs text-gray-500 ml-1"
                                                  x-text="'(' + Math.round(offer.price_rsd) + ' RSD)'"></span>
                                        </div>
                                        <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium bg-gray-100 text-gray-700"
                                              x-text="getGradeLabel(offer.quality_grade)"></span>
                                        <span class="text-xs"
                                              :class="offer.stock_hint === 'available' ? 'text-green-600' : (offer.stock_hint === 'low' ? 'text-yellow-600' : 'text-red-600')"
                                              x-text="offer.stock_hint === 'available' ? 'Na stanju' : (offer.stock_hint === 'low' ? 'Malo na stanju' : 'Poslednji komad')">
                                        </span>
                                    </div>
                                    <button type="button" @click="selectPart(offer)"
                                            class="text-sm px-3 py-1.5 rounded-md font-medium transition-colors whitespace-nowrap"
                                            :class="selectedListing === offer.listing_id ? 'bg-green-600 text-white' : 'bg-blue-50 text-blue-700 hover:bg-blue-100'">
                                        <span x-text="selectedListing === offer.listing_id ? 'Izabrano' : 'Izaberi'"></span>
                                    </button>
                                </div>
                            </template>
                        </div>
                        <div x-show="!partOffers.offersLoading && partOffers.offers.length === 0" class="text-center py-3 text-sm text-gray-400">
                            Nema ponuda za ovu kvalitetu
                        </div>
                    </div>
                </div>
            </template>

            <!-- Izabrani deo indikator -->
            <div x-show="selectedListing" x-cloak class="mt-2 p-3 bg-green-50 border border-green-200 rounded-lg flex items-center justify-between">
                <span class="text-sm text-green-800">
                    Izabrani deo ce biti automatski narucen nakon kreiranja naloga.
                </span>
                <button type="button" @click="selectedListing = null; selectedOffer = null"
                        class="text-sm text-green-600 hover:text-green-800 underline whitespace-nowrap ml-2">
                    Ponisti izbor
                </button>
            </div>
        </div>

        <!-- Problem Description -->
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Opis problema</h3>
            <div class="space-y-6">
                <div>
                    <label for="problem_description" class="block text-sm font-medium text-gray-700">Opis kvara *</label>
                    <textarea id="problem_description" x-model="form.problem_description" rows="4" required
                              @input="debouncedSearch()"
                              placeholder="Opi≈°ite problem sa ureƒëajem..."
                              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"></textarea>
                </div>
                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                    <div>
                        <label for="priority" class="block text-sm font-medium text-gray-700">Prioritet</label>
                        <select id="priority" x-model="form.priority"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                            <option value="LOW">Nizak</option>
                            <option value="NORMAL" selected>Normalan</option>
                            <option value="HIGH">Visok</option>
                            <option value="URGENT">Hitno</option>
                        </select>
                    </div>
                    <div>
                        <label for="location_id" class="block text-sm font-medium text-gray-700">Lokacija *</label>
                        <select id="location_id" x-model="form.location_id" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                            <option value="">Izaberite lokaciju...</option>
                            <template x-for="location in locations" :key="location.id">
                                <option :value="location.id" x-text="location.name"></option>
                            </template>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pricing -->
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Cena i garancija</h3>
            <div class="grid grid-cols-1 gap-6 sm:grid-cols-3">
                <div>
                    <label for="estimated_price" class="block text-sm font-medium text-gray-700">Procenjena cena</label>
                    <div class="mt-1 relative rounded-md shadow-sm">
                        <input type="number" id="estimated_price" x-model="form.estimated_price" step="0.01" min="0"
                               class="block w-full pr-16 rounded-md border-gray-300 focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                        <div class="absolute inset-y-0 right-0 flex items-center">
                            <select x-model="form.currency" class="h-full rounded-md border-transparent bg-transparent py-0 pl-2 pr-7 text-gray-500 focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                                <option value="RSD">RSD</option>
                                <option value="EUR">EUR</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="warranty_days" class="block text-sm font-medium text-gray-700">Garancija (dana)</label>
                    <input type="number" id="warranty_days" x-model="form.warranty_days" min="0" max="365"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                </div>
                <div>
                    <label for="technician_id" class="block text-sm font-medium text-gray-700">Tehniƒçar</label>
                    <select id="technician_id" x-model="form.technician_id"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                        <option value="">Nije dodeljen</option>
                        <template x-for="user in technicians" :key="user.id">
                            <option :value="user.id" x-text="user.ime + ' ' + user.prezime"></option>
                        </template>
                    </select>
                </div>
            </div>
        </div>

        <!-- Internal Notes -->
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Interne bele≈°ke</h3>
            <div>
                <textarea id="internal_notes" x-model="form.internal_notes" rows="3"
                          placeholder="Bele≈°ke vidljive samo zaposlenima..."
                          class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"></textarea>
            </div>
        </div>

        <!-- Submit -->
        <div class="flex justify-end gap-3">
            <a href="/tickets"
               class="inline-flex items-center rounded-md bg-white px-4 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                Odustani
            </a>
            <button type="submit" :disabled="submitting"
                    class="inline-flex items-center rounded-md bg-primary-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500 disabled:opacity-50">
                <svg x-show="submitting" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Kreiraj nalog
            </button>
        </div>
    </form>
</div>

<script>
function newTicketPage() {
    return {
        locations: [],
        technicians: [],
        submitting: false,

        // ========== COUNTRY SELECTOR ==========
        exYuCountries: [
            { code: '+381', dial: '381', flag: 'üá∑üá∏', name: 'Srbija' },
            { code: '+385', dial: '385', flag: 'üá≠üá∑', name: 'Hrvatska' },
            { code: '+387', dial: '387', flag: 'üáßüá¶', name: 'BiH' },
            { code: '+382', dial: '382', flag: 'üá≤üá™', name: 'Crna Gora' },
            { code: '+386', dial: '386', flag: 'üá∏üáÆ', name: 'Slovenija' },
            { code: '+383', dial: '383', flag: 'üáΩüá∞', name: 'Kosovo' },
            { code: '+389', dial: '389', flag: 'üá≤üá∞', name: 'S. Makedonija' },
        ],
        otherCountries: [
            { code: '+43', dial: '43', flag: 'üá¶üáπ', name: 'Austrija' },
            { code: '+49', dial: '49', flag: 'üá©üá™', name: 'Nemaƒçka' },
            { code: '+41', dial: '41', flag: 'üá®üá≠', name: '≈†vajcarska' },
            { code: '+39', dial: '39', flag: 'üáÆüáπ', name: 'Italija' },
            { code: '+33', dial: '33', flag: 'üá´üá∑', name: 'Francuska' },
            { code: '+44', dial: '44', flag: 'üá¨üáß', name: 'UK' },
        ],
        selectedCountry: { code: '+381', dial: '381', flag: 'üá∑üá∏', name: 'Srbija' },
        phoneNumber: '',

        // ========================================

        form: {
            customer_name: '',
            customer_phone: '',
            customer_email: '',
            sms_opt_out: false,
            device_type: 'PHONE',
            brand: '',
            model: '',
            imei: '',
            device_password: '',
            device_condition: 'GOOD',
            problem_description: '',
            priority: 'NORMAL',
            location_id: '',
            estimated_price: '',
            currency: 'RSD',
            warranty_days: 30,
            technician_id: '',
            internal_notes: ''
        },

        // ========== PART OFFERS ==========
        partOffers: {
            loading: false,
            loaded: false,
            summary: [],
            brand: '',
            model: '',
            expandedKey: null,
            offers: [],
            offersLoading: false,
        },
        selectedListing: null,
        selectedOffer: null,
        _searchTimer: null,
        _lastSearchKey: '',

        categoryLabels: {
            'display': 'Ekran / Display',
            'battery': 'Baterija',
            'charging_port': 'Port za punjenje',
            'camera': 'Kamera',
            'back_cover': 'Zadnja maska',
            'frame': 'Okvir / Ram',
            'speaker': 'Zvucnik',
            'motherboard': 'Maticna ploca',
            'screen_protector': 'Folija za ekran',
            'other': 'Ostalo',
        },

        gradeLabels: {
            'service_pack': 'Service Pack',
            'original': 'Original',
            'oled_hard': 'OLED Hard',
            'oled_soft': 'OLED Soft',
            'oem': 'OEM',
            'tft_incell': 'TFT InCell',
            'aaa': 'AAA',
            'copy': 'Kopija',
        },

        getCategoryLabel(cat) {
            return this.categoryLabels[cat] || cat.charAt(0).toUpperCase() + cat.slice(1);
        },

        getGradeLabel(grade) {
            if (!grade) return '';
            return this.gradeLabels[grade.toLowerCase()] || grade;
        },

        detectCategory(description) {
            if (!description) return null;
            const lower = description.toLowerCase();
            const mapping = [
                ['display', ['ekran', 'display', 'lcd', 'oled', 'staklo', 'touchscreen', 'touch screen', 'crn ekran', 'razbijen']],
                ['battery', ['baterija', 'battery', 'ne puni', 'brzo trosi', 'gasi se']],
                ['charging_port', ['konektor', 'punjac', 'charging', 'port za punjenje', 'usb-c', 'usb c', 'ne puni se']],
                ['camera', ['kamera', 'camera', 'foto', 'slika', 'ne slika']],
                ['back_cover', ['maska', 'poklopac', 'zadnja maska', 'back cover', 'zadnji poklopac']],
                ['speaker', ['zvucnik', 'speaker', 'mikrofon', 'zvuk', 'ne cuje se']],
            ];
            for (const [cat, keywords] of mapping) {
                for (const kw of keywords) {
                    if (lower.includes(kw)) return cat;
                }
            }
            return null;
        },

        // ========== PHONE HELPERS ==========
        selectCountry(country) {
            this.selectedCountry = country;
        },

        formatPhoneNumber() {
            this.phoneNumber = this.phoneNumber.replace(/[^\d\s]/g, '');
        },

        get formattedPhonePreview() {
            if (!this.phoneNumber) return this.selectedCountry.code + ' ...';
            const digits = this.phoneNumber.replace(/\D/g, '');
            const cleanDigits = digits.startsWith('0') ? digits.slice(1) : digits;
            return this.selectedCountry.code + ' ' + cleanDigits;
        },

        get formattedPhoneForApi() {
            const digits = this.phoneNumber.replace(/\D/g, '');
            const cleanDigits = digits.startsWith('0') ? digits.slice(1) : digits;
            return this.selectedCountry.dial + cleanDigits;
        },
        // ===================================

        // ========== PART OFFERS METHODS ==========
        debouncedSearch() {
            clearTimeout(this._searchTimer);
            const brand = this.form.brand?.trim();
            const model = this.form.model?.trim();
            const category = this.detectCategory(this.form.problem_description);

            // Treba brand + (model ILI detektovana kategorija iz opisa kvara)
            const hasEnoughInfo = brand && brand.length >= 2 && (
                (model && model.length >= 1) || category
            );

            if (hasEnoughInfo) {
                const searchKey = brand + '|' + (model || '') + '|' + (category || '');
                if (searchKey === this._lastSearchKey) return;
                this._searchTimer = setTimeout(() => this.checkPartOffers(), 800);
            } else {
                this.partOffers.loaded = false;
                this.partOffers.summary = [];
                this.partOffers.expandedKey = null;
                this.partOffers.offers = [];
                this.selectedListing = null;
                this.selectedOffer = null;
            }
        },

        async checkPartOffers() {
            const brand = this.form.brand?.trim();
            const model = this.form.model?.trim();
            const category = this.detectCategory(this.form.problem_description);

            if (!brand) return;

            this._lastSearchKey = brand + '|' + (model || '') + '|' + (category || '');
            this.partOffers.loading = true;
            this.partOffers.loaded = false;
            this.partOffers.expandedKey = null;
            this.partOffers.offers = [];
            this.selectedListing = null;
            this.selectedOffer = null;

            try {
                let url = '/api/v1/part-offers/search?brand=' + encodeURIComponent(brand);
                if (model) url += '&model=' + encodeURIComponent(model);
                if (category) url += '&category=' + encodeURIComponent(category);
                console.log('[PartOffers] Searching:', url);
                const resp = await api(url);
                if (resp.ok) {
                    const data = await resp.json();
                    console.log('[PartOffers] Results:', data);
                    this.partOffers.summary = data.categories || [];
                    this.partOffers.brand = data.brand || brand;
                    this.partOffers.model = data.model || model || '';
                    this.partOffers.loaded = true;
                }
            } catch (e) {
                console.error('Part offers search failed:', e);
            } finally {
                this.partOffers.loading = false;
            }
        },

        async loadOffers(category, quality) {
            const key = category + '_' + quality;
            if (this.partOffers.expandedKey === key) {
                this.partOffers.expandedKey = null;
                this.partOffers.offers = [];
                return;
            }

            this.partOffers.expandedKey = key;
            this.partOffers.offersLoading = true;
            this.partOffers.offers = [];

            try {
                const brand = this.form.brand?.trim();
                const model = this.form.model?.trim();
                const url = '/api/v1/part-offers/search/offers?brand=' + encodeURIComponent(brand) +
                    '&model=' + encodeURIComponent(model) +
                    '&category=' + encodeURIComponent(category) +
                    '&quality=' + encodeURIComponent(quality);
                const resp = await api(url);
                if (resp.ok) {
                    const data = await resp.json();
                    this.partOffers.offers = data.offers || [];
                }
            } catch (e) {
                console.error('Part offers load failed:', e);
            } finally {
                this.partOffers.offersLoading = false;
            }
        },

        selectPart(offer) {
            if (this.selectedListing === offer.listing_id) {
                this.selectedListing = null;
                this.selectedOffer = null;
            } else {
                this.selectedListing = offer.listing_id;
                this.selectedOffer = offer;
            }
        },
        // =========================================

        async loadData() {
            try {
                // Load locations
                const locResponse = await api('/api/v1/locations');
                if (locResponse.ok) {
                    const data = await locResponse.json();
                    this.locations = data.locations || [];
                    const primary = this.locations.find(l => l.is_primary);
                    if (primary) {
                        this.form.location_id = primary.id;
                    }
                }

                // Load team members (technicians)
                const teamResponse = await api('/api/v1/users');
                if (teamResponse.ok) {
                    const data = await teamResponse.json();
                    this.technicians = (data.users || []).filter(u =>
                        u.role === 'TECHNICIAN' || u.role === 'ADMIN' || u.role === 'OWNER'
                    );
                }
            } catch (e) {
                console.error('Failed to load data:', e);
            }
        },

        async submitForm() {
            this.submitting = true;
            try {
                const payload = {
                    ...this.form,
                    customer_phone: this.formattedPhoneForApi,
                    location_id: parseInt(this.form.location_id),
                    estimated_price: this.form.estimated_price ? parseFloat(this.form.estimated_price) : null,
                    warranty_days: parseInt(this.form.warranty_days),
                    technician_id: this.form.technician_id ? parseInt(this.form.technician_id) : null
                };

                const response = await api('/api/v1/tickets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const data = await response.json();

                    // Auto-narucivanje ako je izabran deo
                    if (this.selectedListing && data.id) {
                        try {
                            await api('/api/v1/part-offers/order', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    listing_id: this.selectedListing,
                                    quantity: 1,
                                    service_ticket_id: data.id
                                })
                            });
                            showToast('Nalog kreiran i deo narucen', 'success');
                        } catch (e) {
                            console.error('Auto-order failed:', e);
                            showToast('Nalog kreiran, ali narucivanje dela nije uspelo', 'warning');
                        }
                    } else {
                        showToast('Nalog uspesno kreiran', 'success');
                    }

                    window.location.href = '/tickets/' + data.id;
                } else {
                    const error = await response.json();
                    showToast(error.message || 'Greska pri kreiranju naloga', 'error');
                }
            } catch (e) {
                console.error('Failed to create ticket:', e);
                showToast('Greska pri kreiranju naloga', 'error');
            } finally {
                this.submitting = false;
            }
        }
    }
}
</script>
{% endblock %}
