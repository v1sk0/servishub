{% extends "layouts/tenant.html" %}

{% block title %}Servisni nalozi - ServisHub{% endblock %}

{% block page_content %}
<style>
    /* ========================================
       LIGHT THEME - Tickets Page
       ======================================== */
    .page-header h2 { color: #1e293b; }
    .page-header p { color: #64748b; }

    .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        border: none;
        cursor: pointer;
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }
    .btn-secondary {
        background: #f1f5f9;
        color: #475569;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 500;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
        border: 1px solid #e2e8f0;
        text-decoration: none;
        cursor: pointer;
    }
    .btn-secondary:hover { background: #e2e8f0; color: #1e293b; }
    .btn-secondary:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Light theme stat cards */
    .stat-card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.25rem;
        position: relative;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    .stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; }
    .stat-card.blue::before { background: linear-gradient(180deg, #3b82f6, #60a5fa); }
    .stat-card.green::before { background: linear-gradient(180deg, #22c55e, #4ade80); }
    .stat-card.purple::before { background: linear-gradient(180deg, #8b5cf6, #a78bfa); }
    .stat-card.yellow::before { background: linear-gradient(180deg, #eab308, #facc15); }
    .stat-card.red::before { background: linear-gradient(180deg, #ef4444, #f87171); }

    .stat-value { color: #1e293b; font-size: 1.75rem; font-weight: 700; }
    .stat-label { color: #64748b; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 0.25rem; }

    /* Light theme search */
    .search-container { position: relative; }
    .search-container svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; width: 18px; height: 18px; }
    .search-input {
        width: 100%;
        padding: 0.625rem 1rem 0.625rem 2.5rem;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        color: #1e293b;
        font-size: 0.875rem;
    }
    .search-input::placeholder { color: #94a3b8; }
    .search-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

    /* Light theme table container */
    .glass-table-container {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .glass-table-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .glass-table-header h3 { color: #1e293b; font-size: 1rem; font-weight: 600; margin: 0; }
    .glass-table-header.pending { background: linear-gradient(135deg, #fef3c7, #fde68a); border-left: 4px solid #f59e0b; }
    .glass-table { width: 100%; }
    .glass-table thead { background: #f8fafc; }
    .glass-table th { padding: 0.75rem 1rem; text-align: center; font-size: 0.75rem; font-weight: 500; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #e2e8f0; }
    .glass-table tbody tr { border-bottom: 1px solid #f1f5f9; transition: background 0.2s; }
    .glass-table tbody tr:hover { background: #f8fafc; }
    .glass-table td { padding: 0.875rem 1rem; font-size: 0.875rem; color: #475569; text-align: center; }
    .cell-primary { color: #1e293b; font-weight: 500; }
    .cell-link { color: #3b82f6; cursor: pointer; transition: color 0.2s; }
    .cell-link:hover { color: #2563eb; }
    .cell-muted { color: #94a3b8; font-size: 0.75rem; }

    /* Light theme status badges */
    .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
    .status-open { background: #dbeafe; color: #1e40af; }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-ready { background: #dcfce7; color: #166534; }
    .status-closed { background: #f3f4f6; color: #374151; }

    /* Grade badge - same for both themes */
    .grade-badge { display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 6px; font-size: 0.875rem; font-weight: 700; }
    .grade-A { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
    .grade-B { background: linear-gradient(135deg, #eab308, #ca8a04); color: #000; }
    .grade-C { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }

    /* SMS Status badge - matches grade-A style */
    .sms-badge-sent {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: white;
        font-weight: 600;
        box-shadow: 0 1px 3px rgba(34, 197, 94, 0.3);
    }

    /* Light theme duration bar - Dolce Vita animated stripes (exact copy) */
    @keyframes stripes-move {
        0% { background-position: 0 0; }
        100% { background-position: 40px 0; }
    }
    .duration-bar {
        position: relative;
        height: 24px;
        background: #e8eaed;
        border-radius: 12px;
        overflow: hidden;
        min-width: 100px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    .duration-fill {
        height: 100%;
        border-radius: 12px;
        transition: width 0.3s ease;
        background-size: 40px 40px !important;
        animation: stripes-move 1.5s linear infinite !important;
        min-width: 10%;
        /* Default stripes (fallback) */
        background-color: #34a853;
        background-image: linear-gradient(
            135deg,
            rgba(255,255,255,0.15) 25%,
            transparent 25%,
            transparent 50%,
            rgba(255,255,255,0.15) 50%,
            rgba(255,255,255,0.15) 75%,
            transparent 75%,
            transparent
        );
    }
    .duration-fill.green {
        background-color: #34a853;
        background-image: linear-gradient(
            135deg,
            rgba(255,255,255,0.15) 25%,
            transparent 25%,
            transparent 50%,
            rgba(255,255,255,0.15) 50%,
            rgba(255,255,255,0.15) 75%,
            transparent 75%,
            transparent
        );
        box-shadow: 0 0 12px rgba(52, 168, 83, 0.5), inset 0 1px 0 rgba(255,255,255,0.3);
    }
    .duration-fill.yellow {
        background-color: #f9ab00;
        background-image: linear-gradient(
            135deg,
            rgba(255,255,255,0.15) 25%,
            transparent 25%,
            transparent 50%,
            rgba(255,255,255,0.15) 50%,
            rgba(255,255,255,0.15) 75%,
            transparent 75%,
            transparent
        );
        box-shadow: 0 0 12px rgba(249, 171, 0, 0.5), inset 0 1px 0 rgba(255,255,255,0.3);
    }
    .duration-fill.red {
        background-color: #ea4335;
        background-image: linear-gradient(
            135deg,
            rgba(255,255,255,0.15) 25%,
            transparent 25%,
            transparent 50%,
            rgba(255,255,255,0.15) 50%,
            rgba(255,255,255,0.15) 75%,
            transparent 75%,
            transparent
        );
        box-shadow: 0 0 12px rgba(234, 67, 53, 0.5), inset 0 1px 0 rgba(255,255,255,0.3);
    }
    .duration-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.75rem; font-weight: 600; color: #202124; white-space: nowrap; text-shadow: 0 0 2px rgba(255,255,255,0.8); }

    /* Light theme action buttons */
    .action-btn { padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.7rem; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; align-items: center; gap: 4px; }
    .action-btn svg { width: 12px; height: 12px; }
    .action-btn.complete { background: #dcfce7; color: #166534; }
    .action-btn.complete:hover { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; box-shadow: 0 0 15px rgba(34, 197, 94, 0.4); transform: translateY(-1px); }
    .action-btn.reject { background: #fee2e2; color: #991b1b; }
    .action-btn.reject:hover { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); transform: translateY(-1px); }
    .action-btn.print { background: #dbeafe; color: #1e40af; }
    .action-btn.print:hover { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); transform: translateY(-1px); }
    .action-btn.collect { background: #f3e8ff; color: #6b21a8; }
    .action-btn.collect:hover { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; box-shadow: 0 0 15px rgba(139, 92, 246, 0.4); transform: translateY(-1px); }
    .action-btn.notify { background: #fef2f2; color: #991b1b; position: relative; }
    .action-btn.notify:hover:not(.disabled) { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); transform: translateY(-1px); }
    .action-btn.notify.disabled { opacity: 0.5; cursor: not-allowed; }
    .action-btn.notify.first-notify { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); } }

    /* Notification badge */
    .notification-badge { position: absolute; top: -6px; right: -6px; min-width: 18px; height: 18px; background: #ef4444; color: white; border-radius: 9px; font-size: 10px; font-weight: 700; display: flex; align-items: center; justify-content: center; padding: 0 4px; box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3); }

    /* Strobe alert */
    @keyframes strobeFlash { 0%, 100% { background: rgba(239, 68, 68, 0.1); } 50% { background: rgba(239, 68, 68, 0.25); } }
    .strobe-alert { animation: strobeFlash 1.5s ease-in-out infinite; }
    .strobe-alert:hover { animation-play-state: paused; }

    .empty-state { padding: 3rem; text-align: center; color: #64748b; }

    /* Light theme modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 50; display: flex; align-items: center; justify-content: center; }
    .modal-content { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); }
    .modal-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { color: #1e293b; font-size: 1.125rem; font-weight: 600; margin: 0; }
    .modal-close { color: #94a3b8; cursor: pointer; padding: 0.5rem; background: transparent; border: none; border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .modal-close:hover { color: #1e293b; background: rgba(0, 0, 0, 0.05); }
    .modal-close svg { width: 20px; height: 20px; }
    .modal-body { padding: 1.5rem; }
    .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 0.75rem; background: #f8fafc; }
    .modal-footer button { position: relative; z-index: 1; }

    /* Notification modal info card */
    .notify-info-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
    .notify-info-row { display: flex; justify-content: space-between; padding: 0.25rem 0; font-size: 0.875rem; }
    .notify-info-row span:first-child { color: #64748b; }
    .notify-info-row span:last-child { color: #1e293b; font-weight: 500; }

    /* Notification history */
    .notify-history { margin: 1rem 0; }
    .notify-history h4 { font-size: 0.75rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
    .notify-history-item { display: flex; justify-content: space-between; padding: 0.5rem; background: #f1f5f9; border-radius: 6px; margin-bottom: 0.5rem; font-size: 0.813rem; }
    .notify-history-item .history-date { color: #64748b; }
    .notify-history-item .history-comment { color: #1e293b; }

    /* Quick reply buttons */
    .quick-reply-section { margin: 1rem 0; }
    .quick-reply-section label { font-size: 0.75rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; display: block; margin-bottom: 0.5rem; }
    .quick-reply-buttons { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .quick-reply-btn { padding: 0.5rem 0.75rem; background: #e0e7ff; color: #3730a3; border: none; border-radius: 6px; font-size: 0.813rem; cursor: pointer; transition: all 0.2s; }
    .quick-reply-btn:hover { background: #6366f1; color: white; }

    /* Danger button for write-off */
    .btn-danger { padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .btn-danger:hover { background: #dc2626; }

    /* Collect modal price section */
    .collect-price-section { margin: 1.5rem 0; }
    .collect-price-section label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem; }
    .price-inputs { display: flex; gap: 0.5rem; }
    .price-inputs input { flex: 1; padding: 0.75rem 1rem; font-size: 1.25rem; font-weight: 600; border: 2px solid #8b5cf6; border-radius: 8px; text-align: right; }
    .price-inputs input:focus { outline: none; border-color: #6d28d9; box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2); }
    .price-inputs select { padding: 0.75rem; font-size: 1rem; border: 2px solid #e2e8f0; border-radius: 8px; background: white; }
    .collect-confirm-text { text-align: center; color: #64748b; font-size: 0.875rem; margin-top: 1rem; }

    /* Light theme form */
    .form-group { margin-bottom: 1rem; }
    .form-label { display: block; color: #64748b; font-size: 0.75rem; font-weight: 500; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em; }
    .form-input { width: 100%; padding: 0.625rem 0.875rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; color: #1e293b; font-size: 0.875rem; }
    .form-input::placeholder { color: #94a3b8; }
    .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

    /* Hide number input spinners */
    .form-input[type="number"]::-webkit-outer-spin-button,
    .form-input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    .form-input[type="number"] {
        -moz-appearance: textfield;
        appearance: textfield;
    }

    /* Form validation states */
    .form-input.invalid {
        border-color: #ef4444;
        background: #fef2f2;
    }
    .form-input.invalid:focus {
        border-color: #ef4444;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }
    .form-error {
        color: #ef4444;
        font-size: 0.75rem;
        margin-top: 0.25rem;
        display: none;
    }
    .form-error.show {
        display: block;
    }

    /* Light theme category selector */
    .category-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; }
    .category-option { padding: 0.75rem 0.5rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .category-option:hover { border-color: #3b82f6; background: #eff6ff; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15); }
    .category-option:hover svg { color: #3b82f6; }
    .category-option:hover span { color: #3b82f6; }
    .category-option.selected { border-color: #3b82f6; background: #dbeafe; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); }
    .category-option svg { width: 24px; height: 24px; margin: 0 auto 0.25rem; color: #64748b; transition: all 0.2s; }
    .category-option.selected svg { color: #2563eb; }
    .category-option span { font-size: 0.7rem; color: #64748b; display: block; transition: all 0.2s; }
    .category-option.selected span { color: #2563eb; font-weight: 600; }

    /* ========================================
       PREMIUM GRADE SELECTOR - World-class design
       Muted when inactive, vibrant when selected
       ======================================== */
    .grade-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; }
    .grade-option {
        padding: 1.25rem 1rem;
        border-radius: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 2px solid #e2e8f0;
        background: #f8fafc;
        position: relative;
        overflow: hidden;
    }
    .grade-option::before {
        content: '';
        position: absolute;
        inset: 0;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .grade-option .grade-letter {
        font-size: 1.75rem;
        font-weight: 800;
        transition: all 0.3s ease;
        position: relative;
        z-index: 1;
    }
    .grade-option .grade-text {
        font-size: 0.7rem;
        margin-top: 0.25rem;
        transition: all 0.3s ease;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        position: relative;
        z-index: 1;
    }

    /* Inactive state - muted colors */
    .grade-option.grade-a { border-color: #d1fae5; }
    .grade-option.grade-a .grade-letter { color: #86efac; }
    .grade-option.grade-a .grade-text { color: #a7f3d0; }
    .grade-option.grade-a::before { background: linear-gradient(135deg, #22c55e, #16a34a); }

    .grade-option.grade-b { border-color: #fef3c7; }
    .grade-option.grade-b .grade-letter { color: #fcd34d; }
    .grade-option.grade-b .grade-text { color: #fde68a; }
    .grade-option.grade-b::before { background: linear-gradient(135deg, #eab308, #ca8a04); }

    .grade-option.grade-c { border-color: #fecaca; }
    .grade-option.grade-c .grade-letter { color: #fca5a5; }
    .grade-option.grade-c .grade-text { color: #fecaca; }
    .grade-option.grade-c::before { background: linear-gradient(135deg, #ef4444, #dc2626); }

    /* Hover state - hint of color */
    .grade-option:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    .grade-option.grade-a:hover { border-color: #86efac; background: #f0fdf4; }
    .grade-option.grade-b:hover { border-color: #fcd34d; background: #fefce8; }
    .grade-option.grade-c:hover { border-color: #fca5a5; background: #fef2f2; }

    /* Selected state - full vibrant color */
    .grade-option.selected {
        border-color: transparent;
        transform: scale(1.02) translateY(-2px);
    }
    .grade-option.selected::before {
        opacity: 1;
    }
    .grade-option.selected .grade-letter,
    .grade-option.grade-a.selected .grade-letter,
    .grade-option.grade-b.selected .grade-letter,
    .grade-option.grade-c.selected .grade-letter {
        color: white !important;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .grade-option.selected .grade-text,
    .grade-option.grade-a.selected .grade-text,
    .grade-option.grade-b.selected .grade-text,
    .grade-option.grade-c.selected .grade-text {
        color: white !important;
    }
    .grade-option.grade-a.selected {
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2), 0 8px 25px rgba(34, 197, 94, 0.35);
    }
    .grade-option.grade-b.selected {
        box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.2), 0 8px 25px rgba(234, 179, 8, 0.35);
    }
    .grade-option.grade-c.selected {
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2), 0 8px 25px rgba(239, 68, 68, 0.35);
    }

    /* Checkmark indicator for selected state */
    .grade-option.selected::after {
        content: '✓';
        position: absolute;
        top: 6px;
        right: 8px;
        font-size: 0.75rem;
        color: white;
        font-weight: 700;
        opacity: 0;
        animation: checkFadeIn 0.3s ease 0.1s forwards;
    }
    @keyframes checkFadeIn {
        to { opacity: 1; }
    }

    /* Light theme problem chips - card style like grades */
    .problem-chips { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.5rem; }
    .problem-chip { padding: 0.625rem 0.5rem; background: #f1f5f9; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.75rem; color: #64748b; cursor: pointer; transition: all 0.2s; font-weight: 500; text-align: center; }
    .problem-chip:hover { background: #eff6ff; border-color: #3b82f6; color: #3b82f6; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15); }
    .problem-chip.selected { background: linear-gradient(135deg, #ef4444, #dc2626); border-color: transparent; color: white; box-shadow: 0 0 0 2px white, 0 4px 15px rgba(239, 68, 68, 0.4); transform: scale(1.02); }

    /* Form section title */
    .form-section-title { font-size: 0.875rem; font-weight: 600; color: #3b82f6; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e2e8f0; }

    /* ========================================
       PART OFFERS - Dostupni delovi
       ======================================== */
    .part-offers-loading {
        margin-top: 1.5rem;
        padding: 0.875rem 1rem;
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .part-offers-loading span {
        font-size: 0.813rem;
        color: #3b82f6;
        font-weight: 500;
    }
    .part-offers-section {
        margin-top: 1.5rem;
        background: #ffffff;
        border: 1px solid #d1fae5;
        border-radius: 10px;
        overflow: hidden;
    }
    .part-offers-header {
        padding: 0.75rem 1rem;
        background: linear-gradient(135deg, #f0fdf4, #dcfce7);
        border-bottom: 1px solid #d1fae5;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .part-offers-header-title {
        font-size: 0.813rem;
        font-weight: 600;
        color: #166534;
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }
    .part-offers-header-title svg {
        width: 16px;
        height: 16px;
        color: #22c55e;
    }
    .part-offers-header-meta {
        font-size: 0.688rem;
        color: #6b7280;
        font-weight: 500;
    }
    .part-offers-body {
        padding: 0.75rem;
    }
    .part-offers-cat-label {
        font-size: 0.688rem;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.375rem;
    }
    .part-offers-quality-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }
    .part-offers-quality-card {
        padding: 0.75rem;
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
    }
    .part-offers-quality-card:hover {
        border-color: #3b82f6;
        background: #eff6ff;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.12);
    }
    .part-offers-quality-card.expanded {
        border-color: #3b82f6;
        background: #dbeafe;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
    }
    .part-offers-quality-label {
        font-size: 0.625rem;
        font-weight: 700;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .part-offers-quality-card.expanded .part-offers-quality-label {
        color: #1e40af;
    }
    .part-offers-quality-price {
        font-size: 1.125rem;
        font-weight: 700;
        color: #1e293b;
        margin-top: 0.125rem;
    }
    .part-offers-quality-card.expanded .part-offers-quality-price {
        color: #1e40af;
    }
    .part-offers-quality-count {
        font-size: 0.625rem;
        color: #94a3b8;
        margin-top: 0.125rem;
    }
    .part-offers-quality-card.expanded .part-offers-quality-count {
        color: #3b82f6;
    }

    /* Offers list */
    .part-offers-list {
        margin-top: 0.5rem;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        overflow: hidden;
        background: #ffffff;
    }
    .part-offer-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.625rem 0.75rem;
        border-bottom: 1px solid #f1f5f9;
        transition: background 0.15s;
    }
    .part-offer-item:last-child {
        border-bottom: none;
    }
    .part-offer-item:hover {
        background: #f8fafc;
    }
    .part-offer-item.selected-offer {
        background: #f0fdf4;
        border-color: #bbf7d0;
    }
    .part-offer-info {
        display: flex;
        align-items: center;
        gap: 0.625rem;
        flex-wrap: wrap;
    }
    .part-offer-rank {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: #f1f5f9;
        color: #64748b;
        font-size: 0.688rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .part-offer-item.selected-offer .part-offer-rank {
        background: #22c55e;
        color: white;
    }
    .part-offer-price {
        font-size: 0.938rem;
        font-weight: 700;
        color: #1e293b;
    }
    .part-offer-quality-tag {
        font-size: 0.625rem;
        padding: 0.125rem 0.5rem;
        border-radius: 4px;
        background: #f1f5f9;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
    }
    .part-offer-stock {
        font-size: 0.688rem;
        font-weight: 600;
    }
    .part-offer-stock.available { color: #16a34a; }
    .part-offer-stock.low { color: #d97706; }
    .part-offer-stock.last { color: #dc2626; }
    .part-offer-select-btn {
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        white-space: nowrap;
        transition: all 0.2s;
    }
    .part-offer-select-btn.default {
        background: #dbeafe;
        color: #2563eb;
    }
    .part-offer-select-btn.default:hover {
        background: #3b82f6;
        color: white;
    }
    .part-offer-select-btn.active {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: white;
        box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
    }

    /* Selected confirmation bar */
    .part-offers-selected-bar {
        margin-top: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .part-offers-selected-text {
        font-size: 0.75rem;
        color: #166534;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }
    .part-offers-selected-text svg {
        width: 14px;
        height: 14px;
        color: #22c55e;
    }
    .part-offers-cancel-btn {
        font-size: 0.75rem;
        color: #6b7280;
        border: none;
        background: none;
        cursor: pointer;
        text-decoration: underline;
    }
    .part-offers-cancel-btn:hover {
        color: #ef4444;
    }
    .part-offers-empty {
        text-align: center;
        padding: 0.75rem;
        font-size: 0.813rem;
        color: #94a3b8;
    }

    /* Glass theme overrides for part offers */
    .glass-theme .part-offers-loading {
        background: rgba(59, 130, 246, 0.1);
        border-color: rgba(59, 130, 246, 0.3);
    }
    .glass-theme .part-offers-loading span { color: #93c5fd; }
    .glass-theme .part-offers-section {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(34, 197, 94, 0.3);
    }
    .glass-theme .part-offers-header {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05));
        border-bottom-color: rgba(34, 197, 94, 0.2);
    }
    .glass-theme .part-offers-header-title { color: #4ade80; }
    .glass-theme .part-offers-header-meta { color: #9ca3af; }
    .glass-theme .part-offers-cat-label { color: #9ca3af; }
    .glass-theme .part-offers-quality-card {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
    }
    .glass-theme .part-offers-quality-card:hover {
        background: rgba(59, 130, 246, 0.1);
        border-color: rgba(59, 130, 246, 0.5);
    }
    .glass-theme .part-offers-quality-card.expanded {
        background: rgba(59, 130, 246, 0.15);
        border-color: rgba(59, 130, 246, 0.5);
    }
    .glass-theme .part-offers-quality-label { color: #9ca3af; }
    .glass-theme .part-offers-quality-card.expanded .part-offers-quality-label { color: #93c5fd; }
    .glass-theme .part-offers-quality-price { color: #ffffff; }
    .glass-theme .part-offers-quality-card.expanded .part-offers-quality-price { color: #ffffff; }
    .glass-theme .part-offers-quality-count { color: #6b7280; }
    .glass-theme .part-offers-quality-card.expanded .part-offers-quality-count { color: #93c5fd; }
    .glass-theme .part-offers-list {
        background: rgba(255, 255, 255, 0.03);
        border-color: rgba(255, 255, 255, 0.1);
    }
    .glass-theme .part-offer-item {
        border-bottom-color: rgba(255, 255, 255, 0.05);
    }
    .glass-theme .part-offer-item:hover { background: rgba(255, 255, 255, 0.05); }
    .glass-theme .part-offer-item.selected-offer { background: rgba(34, 197, 94, 0.1); border-color: rgba(34, 197, 94, 0.3); }
    .glass-theme .part-offer-rank { background: rgba(255, 255, 255, 0.1); color: #d1d5db; }
    .glass-theme .part-offer-item.selected-offer .part-offer-rank { background: #22c55e; color: white; }
    .glass-theme .part-offer-price { color: #ffffff; }
    .glass-theme .part-offer-quality-tag { background: rgba(255, 255, 255, 0.1); color: #d1d5db; }
    .glass-theme .part-offer-select-btn.default { background: rgba(59, 130, 246, 0.2); color: #93c5fd; }
    .glass-theme .part-offer-select-btn.default:hover { background: #3b82f6; color: white; }
    .glass-theme .part-offers-selected-bar {
        background: rgba(34, 197, 94, 0.1);
        border-color: rgba(34, 197, 94, 0.3);
    }
    .glass-theme .part-offers-selected-text { color: #4ade80; }
    .glass-theme .part-offers-empty { color: #6b7280; }

    /* ========================================
       PREMIUM POWER TOGGLE - "Ne pali" button
       ======================================== */
    .power-toggle {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1rem 2.5rem;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 2px solid #fecaca;
        background: #fef2f2;
        position: relative;
        overflow: hidden;
    }
    .power-toggle::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, #ef4444, #dc2626);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .power-toggle .power-icon {
        position: relative;
        z-index: 1;
        transition: all 0.3s ease;
    }
    .power-toggle .power-icon svg {
        width: 32px;
        height: 32px;
        color: #fca5a5;
        transition: all 0.3s ease;
    }
    .power-toggle .power-text {
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-top: 0.5rem;
        color: #fca5a5;
        position: relative;
        z-index: 1;
        transition: all 0.3s ease;
    }
    .power-toggle:hover {
        transform: translateY(-2px);
        border-color: #f87171;
        background: #fee2e2;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.15);
    }
    .power-toggle:hover .power-icon svg { color: #ef4444; }
    .power-toggle:hover .power-text { color: #ef4444; }

    /* Selected state - vibrant */
    .power-toggle.selected {
        border-color: transparent;
        transform: scale(1.02) translateY(-2px);
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2), 0 8px 25px rgba(239, 68, 68, 0.35);
    }
    .power-toggle.selected::before {
        opacity: 1;
    }
    .power-toggle.selected .power-icon svg {
        color: white;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }
    .power-toggle.selected .power-text {
        color: white;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    .power-toggle.selected::after {
        content: '✓';
        position: absolute;
        top: 6px;
        right: 10px;
        font-size: 0.75rem;
        color: white;
        font-weight: 700;
        z-index: 2;
        opacity: 0;
        animation: checkFadeIn 0.3s ease 0.1s forwards;
    }

    /* Light theme filter select */
    .filter-select { padding: 0.5rem 0.75rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; color: #1e293b; font-size: 0.875rem; }

    /* ========================================
       GLASSMORPHIC DARK THEME - Tickets Page
       ======================================== */
    .glass-theme .page-header h2 { color: #f1f5f9; }
    .glass-theme .page-header p { color: #64748b; }
    .glass-theme .btn-secondary { background: rgba(255, 255, 255, 0.1); color: #e2e8f0; border: 1px solid rgba(255, 255, 255, 0.15); }
    .glass-theme .btn-secondary:hover { background: rgba(255, 255, 255, 0.15); color: #fff; }

    /* Glass theme stat cards */
    .glass-theme .stat-card { background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: none; }
    .glass-theme .stat-card:hover { box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); }
    .glass-theme .stat-value { color: #f1f5f9; }
    .glass-theme .stat-label { color: #94a3b8; }

    /* Glass theme search */
    .glass-theme .search-container svg { color: #64748b; }
    .glass-theme .search-input { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.15); color: #f1f5f9; }
    .glass-theme .search-input::placeholder { color: #64748b; }
    .glass-theme .search-input:focus { border-color: rgba(96, 165, 250, 0.5); box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15); }

    /* Glass theme table container */
    .glass-theme .glass-table-container { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: none; }
    .glass-theme .glass-table-header { border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    .glass-theme .glass-table-header h3 { color: #f1f5f9; }
    .glass-theme .glass-table-header.pending { background: linear-gradient(135deg, rgba(217, 119, 6, 0.2), rgba(180, 83, 9, 0.2)); }
    .glass-theme .glass-table thead { background: rgba(255, 255, 255, 0.03); }
    .glass-theme .glass-table th { color: #64748b; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    .glass-theme .glass-table tbody tr { border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
    .glass-theme .glass-table tbody tr:hover { background: rgba(255, 255, 255, 0.05); }
    .glass-theme .glass-table td { color: #cbd5e1; }
    .glass-theme .cell-primary { color: #f1f5f9; }
    .glass-theme .cell-link { color: #60a5fa; }
    .glass-theme .cell-link:hover { color: #93c5fd; }
    .glass-theme .cell-muted { color: #64748b; }

    /* Glass theme status badges */
    .glass-theme .status-open { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .glass-theme .status-pending { background: rgba(234, 179, 8, 0.2); color: #facc15; }
    .glass-theme .status-ready { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .glass-theme .status-closed { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }

    /* Glass theme duration bar */
    .glass-theme .duration-bar { background: rgba(255, 255, 255, 0.1); }
    .glass-theme .duration-text { color: #ffffff; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5); }

    /* Glass theme action buttons */
    .glass-theme .action-btn.complete { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .glass-theme .action-btn.reject { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .glass-theme .action-btn.print { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .glass-theme .action-btn.collect { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
    .glass-theme .action-btn.notify { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .glass-theme .action-btn.notify:hover:not(.disabled) { background: rgba(239, 68, 68, 0.4); }
    .glass-theme .notification-badge { background: #ef4444; box-shadow: 0 0 10px rgba(239, 68, 68, 0.5); }

    /* Glass theme modal */
    .glass-theme .modal-overlay { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); }
    .glass-theme .modal-content { background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5); }
    .glass-theme .modal-header { border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    .glass-theme .modal-header h3 { color: #f1f5f9; }
    .glass-theme .modal-close { color: #64748b; background: transparent; }
    .glass-theme .modal-close:hover { color: #f1f5f9; background: rgba(255, 255, 255, 0.1); }
    .glass-theme .modal-footer { border-top: 1px solid rgba(255, 255, 255, 0.1); background: rgba(15, 23, 42, 0.5); }

    /* Glass theme notification modal */
    .glass-theme .notify-info-card { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); }
    .glass-theme .notify-info-row span:first-child { color: #94a3b8; }
    .glass-theme .notify-info-row span:last-child { color: #f1f5f9; }
    .glass-theme .notify-history h4 { color: #94a3b8; }
    .glass-theme .notify-history-item { background: rgba(255, 255, 255, 0.05); }
    .glass-theme .notify-history-item .history-date { color: #94a3b8; }
    .glass-theme .notify-history-item .history-comment { color: #f1f5f9; }
    .glass-theme .quick-reply-section label { color: #94a3b8; }
    .glass-theme .quick-reply-btn { background: rgba(99, 102, 241, 0.2); color: #a5b4fc; }
    .glass-theme .quick-reply-btn:hover { background: rgba(99, 102, 241, 0.4); color: white; }
    .glass-theme .btn-danger { background: rgba(239, 68, 68, 0.8); }
    .glass-theme .btn-danger:hover { background: #ef4444; }

    /* Glass theme collect modal */
    .glass-theme .collect-price-section label { color: #94a3b8; }
    .glass-theme .price-inputs input { background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(139, 92, 246, 0.5); color: #f1f5f9; }
    .glass-theme .price-inputs input:focus { border-color: rgba(139, 92, 246, 0.8); box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2); }
    .glass-theme .price-inputs select { background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.15); color: #f1f5f9; }
    .glass-theme .collect-confirm-text { color: #94a3b8; }

    /* Glass theme form */
    .glass-theme .form-label { color: #94a3b8; }
    .glass-theme .form-input { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.15); color: #f1f5f9; }
    .glass-theme .form-input::placeholder { color: #64748b; }
    .glass-theme .form-input:focus { border-color: rgba(96, 165, 250, 0.5); box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15); }

    /* Glass theme category selector */
    .glass-theme .category-option { background: rgba(255, 255, 255, 0.03); border: 2px solid rgba(255, 255, 255, 0.1); }
    .glass-theme .category-option:hover { border-color: rgba(96, 165, 250, 0.5); background: rgba(96, 165, 250, 0.1); }
    .glass-theme .category-option.selected { border-color: #60a5fa; background: rgba(96, 165, 250, 0.15); }
    .glass-theme .category-option svg { color: #94a3b8; }
    .glass-theme .category-option.selected svg { color: #60a5fa; }
    .glass-theme .category-option span { color: #94a3b8; }
    .glass-theme .category-option.selected span { color: #60a5fa; }

    /* Glass theme grade selector - premium dark mode */
    .glass-theme .grade-option {
        background: rgba(255, 255, 255, 0.03);
        border-color: rgba(255, 255, 255, 0.1);
    }
    .glass-theme .grade-option.grade-a { border-color: rgba(34, 197, 94, 0.2); }
    .glass-theme .grade-option.grade-a .grade-letter { color: rgba(134, 239, 172, 0.5); }
    .glass-theme .grade-option.grade-a .grade-text { color: rgba(167, 243, 208, 0.5); }
    .glass-theme .grade-option.grade-b { border-color: rgba(234, 179, 8, 0.2); }
    .glass-theme .grade-option.grade-b .grade-letter { color: rgba(252, 211, 77, 0.5); }
    .glass-theme .grade-option.grade-b .grade-text { color: rgba(253, 230, 138, 0.5); }
    .glass-theme .grade-option.grade-c { border-color: rgba(239, 68, 68, 0.2); }
    .glass-theme .grade-option.grade-c .grade-letter { color: rgba(252, 165, 165, 0.5); }
    .glass-theme .grade-option.grade-c .grade-text { color: rgba(254, 202, 202, 0.5); }

    .glass-theme .grade-option:hover {
        background: rgba(255, 255, 255, 0.05);
    }
    .glass-theme .grade-option.grade-a:hover { border-color: rgba(34, 197, 94, 0.4); }
    .glass-theme .grade-option.grade-b:hover { border-color: rgba(234, 179, 8, 0.4); }
    .glass-theme .grade-option.grade-c:hover { border-color: rgba(239, 68, 68, 0.4); }

    .glass-theme .grade-option.selected {
        background: transparent;
    }
    .glass-theme .grade-option.grade-a.selected {
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.3), 0 8px 25px rgba(34, 197, 94, 0.25);
    }
    .glass-theme .grade-option.grade-b.selected {
        box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.3), 0 8px 25px rgba(234, 179, 8, 0.25);
    }
    .glass-theme .grade-option.grade-c.selected {
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.3), 0 8px 25px rgba(239, 68, 68, 0.25);
    }

    /* Glass theme problem chips */
    .glass-theme .problem-chip { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.15); color: #94a3b8; }
    .glass-theme .problem-chip:hover { background: rgba(255, 255, 255, 0.1); color: #f1f5f9; }

    /* Glass theme form section title */
    .glass-theme .form-section-title { color: #60a5fa; border-bottom-color: rgba(255, 255, 255, 0.1); }

    /* Glass theme power toggle */
    .glass-theme .power-toggle {
        background: rgba(255, 255, 255, 0.03);
        border-color: rgba(239, 68, 68, 0.2);
    }
    .glass-theme .power-toggle .power-icon svg { color: rgba(252, 165, 165, 0.5); }
    .glass-theme .power-toggle .power-text { color: rgba(252, 165, 165, 0.5); }
    .glass-theme .power-toggle:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(239, 68, 68, 0.4);
    }
    .glass-theme .power-toggle:hover .power-icon svg { color: rgba(252, 165, 165, 0.8); }
    .glass-theme .power-toggle:hover .power-text { color: rgba(252, 165, 165, 0.8); }
    .glass-theme .power-toggle.selected {
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.3), 0 8px 25px rgba(239, 68, 68, 0.25);
    }

    /* Glass theme filter select */
    .glass-theme .filter-select { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.15); color: #f1f5f9; }
    .glass-theme .filter-select option { background: #1e293b; color: #f1f5f9; }

    /* Loading skeleton */
    .skeleton {
        background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
        background-size: 200% 100%;
        animation: skeleton-loading 1.5s infinite;
        border-radius: 4px;
    }
    .glass-theme .skeleton {
        background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
        background-size: 200% 100%;
    }
    @keyframes skeleton-loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    .skeleton-row td { padding: 0.875rem 1rem; }
    .skeleton-cell { height: 1rem; border-radius: 4px; }
    .skeleton-cell.w-16 { width: 4rem; }
    .skeleton-cell.w-24 { width: 6rem; }
    .skeleton-cell.w-32 { width: 8rem; }
    .skeleton-cell.w-20 { width: 5rem; }

    /* ========================================
       MODAL ANIMATIONS (like register page)
       ======================================== */

    /* Modal overlay fade in */
    .modal-overlay {
        animation: overlayFadeIn 0.3s ease-out;
    }
    @keyframes overlayFadeIn {
        0% { opacity: 0; }
        100% { opacity: 1; }
    }

    /* Modal content entrance animation */
    .modal-content {
        animation: modalEntrance 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes modalEntrance {
        0% {
            opacity: 0;
            transform: translateY(30px) scale(0.95);
        }
        100% {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    /* Staggered fade in for form elements */
    .modal-body .form-section-title,
    .modal-body .form-group,
    .modal-body .grid {
        animation: staggerFadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) backwards;
    }
    .modal-body > *:nth-child(1) { animation-delay: 0.05s; }
    .modal-body > *:nth-child(2) { animation-delay: 0.1s; }
    .modal-body > *:nth-child(3) { animation-delay: 0.15s; }
    .modal-body > *:nth-child(4) { animation-delay: 0.2s; }
    .modal-body > *:nth-child(5) { animation-delay: 0.25s; }
    .modal-body > *:nth-child(6) { animation-delay: 0.3s; }
    .modal-body > *:nth-child(7) { animation-delay: 0.35s; }
    .modal-body > *:nth-child(8) { animation-delay: 0.4s; }
    .modal-body > *:nth-child(9) { animation-delay: 0.45s; }
    .modal-body > *:nth-child(10) { animation-delay: 0.5s; }
    .modal-body > *:nth-child(11) { animation-delay: 0.55s; }
    .modal-body > *:nth-child(12) { animation-delay: 0.6s; }

    @keyframes staggerFadeIn {
        0% {
            opacity: 0;
            transform: translateY(10px);
        }
        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Input focus glow animation */
    .form-input:focus {
        animation: inputGlow 0.3s ease-out;
    }
    @keyframes inputGlow {
        0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        50% { box-shadow: 0 0 0 6px rgba(59, 130, 246, 0.2); }
        100% { box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    }
    .glass-theme .form-input:focus {
        animation: inputGlowDark 0.3s ease-out;
    }
    @keyframes inputGlowDark {
        0% { box-shadow: 0 0 0 0 rgba(96, 165, 250, 0); }
        50% { box-shadow: 0 0 0 6px rgba(96, 165, 250, 0.2); }
        100% { box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15); }
    }

    /* Selection bounce for category and grade options */
    .category-option.selected,
    .grade-option.selected,
    .problem-chip.selected {
        animation: selectionBounce 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes selectionBounce {
        0% { transform: scale(0.95); }
        50% { transform: scale(1.08); }
        100% { transform: scale(1.02); }
    }
    .grade-option.selected {
        animation: selectionBounce 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes gradeSelectionBounce {
        0% { transform: scale(0.95); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1.05); }
    }

    /* Modal header gradient animation */
    .modal-header {
        background-size: 200% 200%;
        animation: gradientShift 3s ease infinite;
    }
    @keyframes gradientShift {
        0%, 100% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
    }

    /* Button hover pulse */
    .btn-primary:hover {
        animation: buttonPulse 0.3s ease-out;
    }
    @keyframes buttonPulse {
        0% { box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); }
        50% { box-shadow: 0 6px 25px rgba(59, 130, 246, 0.5); }
        100% { box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4); }
    }

    /* ========================================
       TICKET DETAIL MODAL
       ======================================== */
    .detail-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        z-index: 60;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .detail-modal-content {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        width: 95%;
        max-width: 700px;
        max-height: 90vh;
        overflow: hidden;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        display: flex;
        flex-direction: column;
    }
    .detail-modal-header {
        padding: 1.25rem 1.5rem;
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        border-radius: 16px 16px 0 0;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }
    .detail-modal-header .ticket-nr {
        font-size: 1.75rem;
        font-weight: 700;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    .detail-modal-header .ticket-device {
        font-size: 1.125rem;
        font-weight: 500;
        opacity: 0.9;
        margin-top: 0.25rem;
    }
    .detail-modal-close {
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.25);
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        font-size: 1.25rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    .detail-modal-close:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: rotate(90deg);
    }
    .detail-modal-body {
        padding: 1.5rem;
        overflow-y: auto;
        flex: 1;
    }
    .detail-section {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 1rem 1.25rem;
        margin-bottom: 1rem;
    }
    .detail-section:last-child { margin-bottom: 0; }
    .detail-section-title {
        font-size: 0.75rem;
        font-weight: 600;
        color: #3b82f6;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .detail-section-title svg { width: 16px; height: 16px; opacity: 0.7; }
    .detail-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem 1.5rem;
    }
    .detail-item {
        display: flex;
        flex-direction: column;
        gap: 0.125rem;
    }
    .detail-item.full-width { grid-column: span 2; }
    .detail-label {
        font-size: 0.7rem;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }
    .detail-value {
        font-size: 0.875rem;
        color: #1e293b;
        font-weight: 500;
    }
    .detail-value.large { font-size: 1.125rem; font-weight: 600; }
    .detail-value.price { color: #22c55e; }

    /* Inline edit styles */
    .editable-field {
        position: relative;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0.5rem;
        margin: -0.25rem -0.5rem;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s;
    }
    .editable-field:hover { background: rgba(59, 130, 246, 0.08); }
    .editable-field .edit-icon {
        opacity: 0;
        color: #3b82f6;
        width: 14px;
        height: 14px;
        flex-shrink: 0;
        transition: opacity 0.15s;
    }
    .editable-field:hover .edit-icon { opacity: 1; }
    .editable-field .field-value { flex: 1; }
    .editable-field.editing { background: transparent; cursor: default; }
    .editable-field.editing:hover { background: transparent; }
    .editable-field.editing .edit-icon { display: none; }
    .inline-input {
        width: 100%;
        padding: 0.375rem 0.5rem;
        border: 2px solid #3b82f6;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        color: #1e293b;
        background: white;
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
    }
    .inline-input:focus { border-color: #2563eb; }
    .inline-input.large { font-size: 1.125rem; font-weight: 600; }
    .inline-textarea {
        width: 100%;
        padding: 0.5rem;
        border: 2px solid #3b82f6;
        border-radius: 6px;
        font-size: 0.875rem;
        color: #1e293b;
        background: white;
        outline: none;
        resize: vertical;
        min-height: 60px;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
    }
    .save-indicator {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        color: #22c55e;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        opacity: 0;
        transition: opacity 0.3s;
    }
    .save-indicator.show { opacity: 1; }

    /* Glass theme inline edit */
    .glass-theme .editable-field:hover { background: rgba(255, 255, 255, 0.05); }
    .glass-theme .editable-field .edit-icon { color: #60a5fa; }
    .glass-theme .inline-input {
        background: rgba(255, 255, 255, 0.05);
        border-color: #60a5fa;
        color: #f1f5f9;
    }
    .glass-theme .inline-textarea {
        background: rgba(255, 255, 255, 0.05);
        border-color: #60a5fa;
        color: #f1f5f9;
    }
    .detail-comment-box {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        color: #475569;
        line-height: 1.5;
    }
    .detail-modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.75rem;
    }
    .detail-modal-footer .btn-group { display: flex; gap: 0.5rem; }
    .detail-status-badge {
        padding: 0.375rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    .detail-status-badge.received { background: #dbeafe; color: #1e40af; }
    .detail-status-badge.in_progress { background: #fef3c7; color: #92400e; }
    .detail-status-badge.ready { background: #dcfce7; color: #166534; }
    .detail-status-badge.delivered { background: #f3f4f6; color: #374151; }
    .detail-status-badge.rejected { background: #fee2e2; color: #991b1b; }

    /* Glass theme detail modal */
    .glass-theme .detail-modal-overlay { background: rgba(0, 0, 0, 0.7); }
    .glass-theme .detail-modal-content {
        background: linear-gradient(145deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
    }
    .glass-theme .detail-modal-header {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(139, 92, 246, 0.2));
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .glass-theme .detail-modal-body { color: #f1f5f9; }
    .glass-theme .detail-section {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(10px);
    }
    .glass-theme .detail-section:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(59, 130, 246, 0.3);
    }
    .glass-theme .detail-section-title {
        color: #60a5fa;
        border-bottom-color: rgba(96, 165, 250, 0.3);
    }
    .glass-theme .detail-label { color: rgba(255, 255, 255, 0.5); }
    .glass-theme .detail-value { color: #f1f5f9; }
    .glass-theme .detail-value.price { color: #4ade80; }
    .glass-theme .detail-comment-box {
        background: rgba(255, 255, 255, 0.03);
        border-color: rgba(255, 255, 255, 0.1);
        color: #cbd5e1;
    }
    .glass-theme .detail-modal-footer { border-top-color: rgba(255, 255, 255, 0.1); }
    .glass-theme .detail-status-badge.received { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .glass-theme .detail-status-badge.in_progress { background: rgba(234, 179, 8, 0.2); color: #facc15; }
    .glass-theme .detail-status-badge.ready { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .glass-theme .detail-status-badge.delivered { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }
    .glass-theme .detail-status-badge.rejected { background: rgba(239, 68, 68, 0.2); color: #f87171; }

    /* History section styles */
    .history-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: transparent;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.875rem;
        color: #6b7280;
        transition: all 0.2s;
    }
    .history-toggle:hover { background: #f3f4f6; border-color: #d1d5db; }
    .history-toggle svg { width: 16px; height: 16px; }
    .history-list { margin-top: 12px; }
    .history-item {
        padding: 12px;
        background: #f9fafb;
        border-radius: 8px;
        margin-bottom: 8px;
        border-left: 3px solid #3b82f6;
    }
    .history-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        font-size: 0.75rem;
        color: #6b7280;
    }
    .history-item-action {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.65rem;
        padding: 2px 6px;
        background: #dbeafe;
        color: #1e40af;
        border-radius: 4px;
    }
    .history-change {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        font-size: 0.8rem;
        margin-top: 4px;
    }
    .history-field { font-weight: 600; color: #374151; }
    .history-old { color: #ef4444; text-decoration: line-through; }
    .history-arrow { color: #9ca3af; margin: 0 4px; }
    .history-new { color: #22c55e; }
    .glass-theme .history-toggle { border-color: rgba(255,255,255,0.2); color: #94a3b8; }
    .glass-theme .history-toggle:hover { background: rgba(255,255,255,0.05); }
    .glass-theme .history-item { background: rgba(255,255,255,0.03); border-left-color: #60a5fa; }
    .glass-theme .history-item-header { color: #94a3b8; }
    .glass-theme .history-item-action { background: rgba(59,130,246,0.2); color: #60a5fa; }
    .glass-theme .history-field { color: #f1f5f9; }

    @media (max-width: 640px) {
        .detail-grid { grid-template-columns: 1fr; }
        .detail-item.full-width { grid-column: span 1; }
    }
</style>

<div x-data="ticketsPage()" x-init="init()">
    <!-- Header -->
    <div class="page-header flex flex-wrap items-center justify-between gap-4 mb-6">
        <div>
            <h2 class="text-2xl font-bold">Servisni nalozi</h2>
            <p class="mt-1 text-sm">Upravljanje servisnim nalozima</p>
        </div>
        <div class="flex gap-3">
            <a href="/tickets/warranties" class="btn-secondary">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                </svg>
                Arhiva / Garancije
            </a>
            <button @click="showAddModal = true" class="btn-primary">
                <svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                </svg>
                Novi nalog
            </button>
        </div>
    </div>

    <!-- Stats cards -->
    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
        <div class="stat-card blue" @click="setFilter('open')">
            <div class="stat-value" x-text="stats.open_tickets || 0"></div>
            <div class="stat-label">Otvoreni</div>
            <template x-if="canViewRevenue && (stats.open_rsd > 0 || stats.open_eur > 0)">
                <div class="stat-revenue" style="margin-top: 0.5rem; font-size: 0.7rem; color: #64748b; border-top: 1px solid #e2e8f0; padding-top: 0.5rem;">
                    <div x-show="stats.open_rsd > 0"><span x-text="stats.open_rsd?.toLocaleString('sr-RS')"></span> RSD</div>
                    <div x-show="stats.open_eur > 0"><span x-text="stats.open_eur?.toLocaleString('sr-RS')"></span> EUR</div>
                </div>
            </template>
        </div>
        <div class="stat-card green" @click="setFilter('closed')">
            <div class="stat-value" x-text="stats.closed_tickets || 0"></div>
            <div class="stat-label">Završeni</div>
        </div>
        <div class="stat-card yellow" @click="setFilter('ready')">
            <div class="stat-value" x-text="stats.ready_tickets || 0"></div>
            <div class="stat-label">Za naplatu</div>
            <template x-if="canViewRevenue && (stats.ready_rsd > 0 || stats.ready_eur > 0)">
                <div class="stat-revenue" style="margin-top: 0.5rem; font-size: 0.7rem; color: #64748b; border-top: 1px solid #e2e8f0; padding-top: 0.5rem;">
                    <div x-show="stats.ready_rsd > 0"><span x-text="stats.ready_rsd?.toLocaleString('sr-RS')"></span> RSD</div>
                    <div x-show="stats.ready_eur > 0"><span x-text="stats.ready_eur?.toLocaleString('sr-RS')"></span> EUR</div>
                </div>
            </template>
        </div>
        <div class="stat-card purple" @click="window.location.href='/tickets/warranties'">
            <div class="stat-value" x-text="stats.active_warranties || 0"></div>
            <div class="stat-label">Aktivne garancije</div>
        </div>
        <div class="stat-card red" @click="setFilter('today')">
            <div class="stat-value" x-text="stats.today_tickets || 0"></div>
            <div class="stat-label">Danas</div>
        </div>
    </div>

    <!-- Search and filters -->
    <div class="flex flex-wrap gap-4 mb-6">
        <div class="search-container flex-1 min-w-[200px] max-w-md">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <input type="text" class="search-input" x-model="filters.search" @input.debounce.300ms="loadAllTickets()"
                   placeholder="Pretrazi po broju, kupcu, IMEI...">
        </div>
        <select x-model="filters.location_id" @change="loadAllTickets()" class="filter-select">
            <option value="">Sve lokacije</option>
            <template x-for="loc in locations" :key="loc.id">
                <option :value="loc.id" x-text="loc.name"></option>
            </template>
        </select>
    </div>

    <!-- Open tickets table -->
    <div class="glass-table-container">
        <div class="glass-table-header">
            <h3>Otvoreni nalozi (<span x-text="openTickets.length"></span>)</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="glass-table">
                <thead>
                    <tr>
                        <th>Br.</th>
                        <th>Datum</th>
                        <th>Klijent</th>
                        <th>Uredjaj</th>
                        <th>Opis kvara</th>
                        <th>Stanje</th>
                        <th>Cena</th>
                        <th>Trajanje popravke</th>
                        <th>Akcije</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Loading skeleton rows -->
                    <template x-if="loading">
                        <template x-for="i in 5" :key="'skeleton-'+i">
                            <tr class="skeleton-row">
                                <td><div class="skeleton skeleton-cell w-16"></div></td>
                                <td><div class="skeleton skeleton-cell w-20"></div></td>
                                <td><div class="skeleton skeleton-cell w-32"></div></td>
                                <td><div class="skeleton skeleton-cell w-32"></div></td>
                                <td><div class="skeleton skeleton-cell w-24"></div></td>
                                <td><div class="skeleton skeleton-cell w-16"></div></td>
                                <td><div class="skeleton skeleton-cell w-20"></div></td>
                                <td><div class="skeleton skeleton-cell w-24"></div></td>
                                <td><div class="skeleton skeleton-cell w-20"></div></td>
                            </tr>
                        </template>
                    </template>
                    <!-- Actual data rows -->
                    <template x-for="ticket in openTickets" :key="ticket.id">
                        <tr x-show="!loading" :class="{'strobe-alert': getDaysOpen(ticket) > 20}">
                            <td>
                                <span class="cell-link" @click="viewTicket(ticket)" x-text="'#' + ticket.ticket_number_formatted"></span>
                            </td>
                            <td x-text="formatDate(ticket.created_at)"></td>
                            <td>
                                <div class="cell-primary" x-text="ticket.customer_name"></div>
                                <div class="cell-muted" x-text="ticket.customer_phone || '-'"></div>
                            </td>
                            <td>
                                <div x-text="ticket.brand + ' ' + ticket.model"></div>
                                <div class="cell-muted" x-text="ticket.service_section || ticket.device_type || '-'"></div>
                            </td>
                            <td style="max-width: 150px;">
                                <span x-text="(ticket.problem_description || '-').substring(0, 40) + (ticket.problem_description && ticket.problem_description.length > 40 ? '...' : '')"></span>
                            </td>
                            <td>
                                <template x-if="ticket.device_condition_grade">
                                    <span class="grade-badge" :class="'grade-' + ticket.device_condition_grade" x-text="ticket.device_condition_grade"></span>
                                </template>
                                <template x-if="!ticket.device_condition_grade">
                                    <span>-</span>
                                </template>
                            </td>
                            <td>
                                <span class="cell-primary" x-text="formatPrice(ticket.estimated_price)"></span>
                                <span class="cell-muted" x-text="ticket.currency || 'RSD'"></span>
                            </td>
                            <td>
                                <div class="duration-bar">
                                    <div class="duration-fill" :class="getDurationClass(ticket)" :style="'width: ' + getDurationPercent(ticket) + '%'"></div>
                                    <span class="duration-text" x-text="getDaysOpen(ticket) + 'd'"></span>
                                </div>
                            </td>
                            <td>
                                <div class="flex gap-1">
                                    <button @click.stop="openFinishModal(ticket)" class="action-btn complete">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                        Završi
                                    </button>
                                    <button @click.stop="openRejectModal(ticket)" class="action-btn reject">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                        Odbij
                                    </button>
                                    <button @click.stop="printTicket(ticket)" class="action-btn print">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
            <div x-show="!loading && openTickets.length === 0" class="empty-state">
                Nema otvorenih naloga
            </div>
        </div>
    </div>

    <!-- Pending payment tickets table -->
    <div class="glass-table-container">
        <div class="glass-table-header pending">
            <h3>Čeka preuzimanje (<span x-text="pendingTickets.length"></span>)</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="glass-table">
                <thead>
                    <tr>
                        <th>Br.</th>
                        <th>Datum</th>
                        <th>Klijent</th>
                        <th>Uredjaj</th>
                        <th>Opis kvara</th>
                        <th>Stanje</th>
                        <th>Cena</th>
                        <th>Čeka preuz.</th>
                        <th>SMS</th>
                        <th>Akcije</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="ticket in pendingTickets" :key="ticket.id">
                        <tr>
                            <td>
                                <span class="cell-link" @click="viewTicket(ticket)" x-text="'#' + ticket.ticket_number_formatted"></span>
                            </td>
                            <td x-text="formatDate(ticket.ready_at || ticket.created_at)"></td>
                            <td>
                                <div class="cell-primary" x-text="ticket.customer_name"></div>
                                <div class="cell-muted" x-text="ticket.customer_phone || '-'"></div>
                            </td>
                            <td x-text="ticket.brand + ' ' + ticket.model"></td>
                            <td style="max-width: 150px;">
                                <span x-text="(ticket.problem_description || '-').substring(0, 40) + (ticket.problem_description && ticket.problem_description.length > 40 ? '...' : '')"></span>
                            </td>
                            <td>
                                <template x-if="ticket.device_condition_grade">
                                    <span class="grade-badge" :class="'grade-' + ticket.device_condition_grade" x-text="ticket.device_condition_grade"></span>
                                </template>
                                <template x-if="!ticket.device_condition_grade">
                                    <span>-</span>
                                </template>
                            </td>
                            <td>
                                <span class="cell-primary" x-text="formatPrice(ticket.final_price || ticket.estimated_price)"></span>
                                <span class="cell-muted" x-text="ticket.currency || 'RSD'"></span>
                            </td>
                            <td>
                                <div class="duration-bar">
                                    <div class="duration-fill"
                                         :class="getWaitingDurationClass(ticket)"
                                         :style="'width: ' + getWaitingDurationPercent(ticket) + '%'">
                                    </div>
                                    <span class="duration-text" x-text="getDaysWaiting(ticket) + 'd'"></span>
                                </div>
                            </td>
                            <!-- SMS Status kolona -->
                            <td>
                                <template x-if="ticket.sms_notification_completed">
                                    <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs sms-badge-sent">
                                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                        </svg>
                                        Poslato
                                    </span>
                                </template>
                                <template x-if="!ticket.sms_notification_completed && ticket.sms_opt_out">
                                    <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium bg-gray-100 text-gray-500">
                                        Odbijeno
                                    </span>
                                </template>
                                <template x-if="!ticket.sms_notification_completed && !ticket.sms_opt_out && !ticket.customer_phone">
                                    <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium bg-gray-100 text-gray-400">
                                        Nema tel.
                                    </span>
                                </template>
                                <template x-if="!ticket.sms_notification_completed && !ticket.sms_opt_out && ticket.customer_phone">
                                    <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium bg-yellow-100 text-yellow-700">
                                        Čeka
                                    </span>
                                </template>
                            </td>
                            <td>
                                <div class="flex gap-1">
                                    <button @click.stop="openNotifyModal(ticket)"
                                            class="action-btn notify"
                                            :class="{'first-notify': (ticket.notification_count || 0) === 0, 'disabled': !ticket.can_notify}"
                                            :disabled="!ticket.can_notify">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                                        Obavesti
                                        <span x-show="ticket.notification_count > 0" class="notification-badge" x-text="ticket.notification_count"></span>
                                    </button>
                                    <button @click.stop="collectTicket(ticket)" class="action-btn collect">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                                        Naplati
                                    </button>
                                    <button @click.stop="printTicket(ticket)" class="action-btn print">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
            <div x-show="!loading && pendingTickets.length === 0" class="empty-state">
                Nema naloga za naplatu
            </div>
        </div>
    </div>

    <!-- Add Ticket Modal -->
    <div x-show="showAddModal" x-cloak class="modal-overlay" @click.self="showAddModal = false">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Novi servisni nalog</h3>
                <button class="modal-close" @click="showAddModal = false">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Section: Podaci o korisniku -->
                <div class="form-section-title">Podaci o korisniku</div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Ime i prezime *</label>
                        <input type="text" class="form-input" :class="{'invalid': validationErrors.customer_name}" x-model="newTicket.customer_name" placeholder="Ime i prezime" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telefon *</label>
                        <div class="flex gap-2">
                            <!-- Country selector -->
                            <div class="relative" x-data="{ open: false }">
                                <button @click="open = !open" type="button"
                                        class="flex items-center gap-1 px-2 py-2 border border-gray-600 rounded-lg bg-gray-700 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 h-[42px]">
                                    <span x-text="selectedCountry.flag" class="text-lg"></span>
                                    <span x-text="selectedCountry.code" class="text-xs text-gray-300"></span>
                                    <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                    </svg>
                                </button>
                                <div x-show="open" @click.away="open = false"
                                     x-transition class="absolute z-50 mt-1 w-48 bg-gray-700 border border-gray-600 rounded-lg shadow-lg max-h-60 overflow-auto">
                                    <div class="px-2 py-1 text-xs font-medium text-gray-400 bg-gray-800 sticky top-0">Region</div>
                                    <template x-for="country in exYuCountries" :key="country.code">
                                        <button @click="selectCountry(country); open = false" type="button"
                                                class="w-full flex items-center gap-2 px-2 py-1.5 hover:bg-gray-600 text-left"
                                                :class="{'bg-blue-600/30': selectedCountry.code === country.code}">
                                            <span x-text="country.flag" class="text-base"></span>
                                            <span x-text="country.name" class="flex-1 text-sm text-gray-200"></span>
                                            <span x-text="country.code" class="text-xs text-gray-400"></span>
                                        </button>
                                    </template>
                                    <div class="px-2 py-1 text-xs font-medium text-gray-400 bg-gray-800 sticky top-0">Ostalo</div>
                                    <template x-for="country in otherCountries" :key="country.code">
                                        <button @click="selectCountry(country); open = false" type="button"
                                                class="w-full flex items-center gap-2 px-2 py-1.5 hover:bg-gray-600 text-left"
                                                :class="{'bg-blue-600/30': selectedCountry.code === country.code}">
                                            <span x-text="country.flag" class="text-base"></span>
                                            <span x-text="country.name" class="flex-1 text-sm text-gray-200"></span>
                                            <span x-text="country.code" class="text-xs text-gray-400"></span>
                                        </button>
                                    </template>
                                </div>
                            </div>
                            <!-- Phone input -->
                            <input type="tel" class="form-input flex-1" :class="{'invalid': validationErrors.customer_phone}"
                                   x-model="phoneNumber" @input="formatPhoneInput()" placeholder="64 123 4567" required>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Čuva se kao: <span x-text="displayPhoneFormat" class="text-gray-400"></span></p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" x-model="newTicket.customer_email" placeholder="email@primer.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ime firme</label>
                        <input type="text" class="form-input" x-model="newTicket.customer_company_name" placeholder="Naziv firme">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">PIB firme</label>
                        <input type="text" class="form-input" x-model="newTicket.customer_pib" placeholder="9 cifara" maxlength="15">
                    </div>
                    <div class="form-group flex items-center" style="padding-top: 1.5rem;">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" x-model="newTicket.sms_opt_out" class="w-4 h-4 rounded border-gray-300 text-red-600 focus:ring-red-500">
                            <span class="text-sm text-gray-600">Klijent NE želi SMS</span>
                        </label>
                    </div>
                </div>

                <!-- Section: Podaci o uredaju -->
                <div class="form-section-title" style="margin-top: 1.5rem;">Podaci o uredaju</div>
                <div class="form-group">
                    <label class="form-label">Kategorija *</label>
                    <div class="category-grid" style="grid-template-columns: repeat(5, 1fr);">
                        <div class="category-option" :class="{'selected': newTicket.device_type === 'phone'}" @click="setDeviceType('phone')">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                            <span>Telefon</span>
                        </div>
                        <div class="category-option" :class="{'selected': newTicket.device_type === 'tablet'}" @click="setDeviceType('tablet')">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                            <span>Tablet</span>
                        </div>
                        <div class="category-option" :class="{'selected': newTicket.device_type === 'laptop'}" @click="setDeviceType('laptop')">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                            <span>Laptop</span>
                        </div>
                        <div class="category-option" :class="{'selected': newTicket.device_type === 'console'}" @click="setDeviceType('console')">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/></svg>
                            <span>Konzola</span>
                        </div>
                        <div class="category-option" :class="{'selected': newTicket.device_type === 'other'}" @click="setDeviceType('other')">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                            <span>Drugo</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Marka *</label>
                        <input type="text" class="form-input" :class="{'invalid': validationErrors.brand}" x-model="newTicket.brand" list="brandList" placeholder="Samsung, Apple..." autocomplete="off" @input="debouncedPartSearch()" required>
                        <datalist id="brandList">
                            <option value="Apple">
                            <option value="Samsung">
                            <option value="Xiaomi">
                            <option value="Huawei">
                            <option value="OnePlus">
                            <option value="Google">
                            <option value="Motorola">
                            <option value="LG">
                            <option value="Sony">
                            <option value="Nokia">
                            <option value="Lenovo">
                            <option value="Asus">
                            <option value="HP">
                            <option value="Dell">
                            <option value="PlayStation">
                            <option value="Xbox">
                            <option value="Nintendo">
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Model *</label>
                        <input type="text" class="form-input" :class="{'invalid': validationErrors.model}" x-model="newTicket.model" placeholder="Galaxy S21, iPhone 13..." @input="debouncedPartSearch()" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">IMEI / Serijski broj</label>
                    <input type="text" class="form-input" x-model="newTicket.imei" placeholder="IMEI ili serijski broj">
                </div>

                <!-- Section: Opis problema -->
                <div class="form-section-title" style="margin-top: 1.5rem;">Opis problema</div>
                <div class="form-group">
                    <label class="form-label">Brzi izbor problema</label>
                    <div class="problem-chips">
                        <template x-for="prob in currentProblems" :key="prob.id">
                            <span class="problem-chip"
                                  :class="{'selected': selectedProblems.includes(prob.id)}"
                                  @click="toggleProblem(prob.id)"
                                  x-text="prob.label"></span>
                        </template>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Opis kvara <span x-show="selectedProblems.length === 0">*</span></label>
                    <textarea class="form-input" :class="{'invalid': validationErrors.problem_description}" rows="2" x-model="newTicket.problem_description" @input="syncSelectedProblems(); debouncedPartSearch()" placeholder="Opišite problem..."></textarea>
                </div>

                <!-- Section: Dostupni delovi kod dobavljaca -->
                <div x-show="partOffers.loading" x-cloak class="part-offers-loading">
                    <svg class="animate-spin" style="width:18px;height:18px;color:#3b82f6;" fill="none" viewBox="0 0 24 24">
                        <circle style="opacity:0.25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path style="opacity:0.75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Pretrazujemo dostupne delove...</span>
                </div>

                <div x-show="partOffers.loaded && partOffers.summary.length > 0" x-cloak class="part-offers-section">
                    <div class="part-offers-header">
                        <span class="part-offers-header-title">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Dostupni delovi kod dobavljaca
                        </span>
                        <span class="part-offers-header-meta" x-text="partOffers.brand + ' ' + partOffers.model"></span>
                    </div>

                    <div class="part-offers-body">
                        <template x-for="cat in partOffers.summary" :key="cat.category">
                            <div style="margin-bottom:0.5rem;">
                                <div class="part-offers-cat-label" x-text="getCatLabel(cat.category)"></div>
                                <div class="part-offers-quality-grid">
                                    <template x-for="[key, group] in Object.entries(cat.quality_groups)" :key="key">
                                        <div class="part-offers-quality-card"
                                             :class="{'expanded': partOffers.expandedKey === cat.category + '_' + key}"
                                             @click="loadPartOffers(cat.category, key)">
                                            <div class="part-offers-quality-label" x-text="group.label"></div>
                                            <div class="part-offers-quality-price"
                                                 x-text="group.avg_eur ? ('~' + group.avg_eur.toFixed(0) + ' EUR') : (group.avg_rsd ? ('~' + Math.round(group.avg_rsd) + ' RSD') : 'N/A')">
                                            </div>
                                            <div class="part-offers-quality-count"
                                                 x-text="group.count + (group.count === 1 ? ' ponuda' : ' ponude')"></div>
                                        </div>
                                    </template>
                                </div>

                                <!-- Ponude za izabranu grupu -->
                                <div x-show="partOffers.expandedKey && partOffers.expandedKey.startsWith(cat.category + '_')" x-cloak>
                                    <div x-show="partOffers.offersLoading" style="text-align:center;padding:0.75rem;">
                                        <svg class="animate-spin" style="width:18px;height:18px;color:#3b82f6;margin:0 auto;" fill="none" viewBox="0 0 24 24">
                                            <circle style="opacity:0.25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path style="opacity:0.75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                    </div>
                                    <div x-show="!partOffers.offersLoading && partOffers.offers.length > 0" class="part-offers-list">
                                        <template x-for="(offer, idx) in partOffers.offers" :key="offer.listing_id">
                                            <div class="part-offer-item"
                                                 :class="{'selected-offer': selectedListing === offer.listing_id}">
                                                <div class="part-offer-info">
                                                    <span class="part-offer-rank" x-text="idx + 1"></span>
                                                    <span class="part-offer-price"
                                                          x-text="offer.price_eur ? (offer.price_eur.toFixed(2) + ' EUR') : (offer.price_rsd ? (Math.round(offer.price_rsd) + ' RSD') : 'N/A')"></span>
                                                    <span class="part-offer-quality-tag" x-text="getGrLabel(offer.quality_grade)"></span>
                                                    <span class="part-offer-stock"
                                                          :class="offer.stock_hint === 'available' ? 'available' : (offer.stock_hint === 'low' ? 'low' : 'last')"
                                                          x-text="offer.stock_hint === 'available' ? 'Na stanju' : (offer.stock_hint === 'low' ? 'Malo' : 'Poslednji')"></span>
                                                </div>
                                                <button type="button" @click="selectPartOffer(offer)"
                                                        class="part-offer-select-btn"
                                                        :class="selectedListing === offer.listing_id ? 'active' : 'default'"
                                                        x-text="selectedListing === offer.listing_id ? 'Izabrano ✓' : 'Izaberi'"></button>
                                            </div>
                                        </template>
                                    </div>
                                    <div x-show="!partOffers.offersLoading && partOffers.offers.length === 0" class="part-offers-empty">
                                        Nema ponuda
                                    </div>
                                </div>
                            </div>
                        </template>

                        <!-- Izabrani deo -->
                        <div x-show="selectedListing" x-cloak class="part-offers-selected-bar">
                            <span class="part-offers-selected-text">
                                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                Deo ce biti narucen nakon kreiranja naloga
                            </span>
                            <button type="button" @click="selectedListing = null; selectedOffer = null" class="part-offers-cancel-btn">
                                Ponisti
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Section: Stanje uredaja -->
                <div class="form-section-title" style="margin-top: 1.5rem;">Stanje uredaja pri prijemu</div>
                <div class="form-group">
                    <label class="form-label">Vizuelno stanje</label>
                    <div class="grade-grid">
                        <div class="grade-option grade-a" :class="{'selected': newTicket.device_condition_grade === 'A'}" @click="newTicket.device_condition_grade = 'A'">
                            <div class="grade-letter">A</div>
                            <div class="grade-text">Odlicno</div>
                        </div>
                        <div class="grade-option grade-b" :class="{'selected': newTicket.device_condition_grade === 'B'}" @click="newTicket.device_condition_grade = 'B'">
                            <div class="grade-letter">B</div>
                            <div class="grade-text">Dobro</div>
                        </div>
                        <div class="grade-option grade-c" :class="{'selected': newTicket.device_condition_grade === 'C'}" @click="newTicket.device_condition_grade = 'C'">
                            <div class="grade-letter">C</div>
                            <div class="grade-text">Ostecen</div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Napomena o stanju</label>
                    <textarea class="form-input" rows="2" x-model="newTicket.device_condition_notes" placeholder="Ogrebotine, ostecenja..."></textarea>
                </div>
                <div class="form-group" style="display: flex; justify-content: center; margin-top: 1rem;">
                    <div class="power-toggle"
                         :class="{'selected': newTicket.device_not_working}"
                         @click="newTicket.device_not_working = !newTicket.device_not_working">
                        <div class="power-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M18.36 6.64a9 9 0 1 1-12.73 0"/>
                                <line x1="12" y1="2" x2="12" y2="12"/>
                            </svg>
                        </div>
                        <div class="power-text">Ne pali</div>
                    </div>
                </div>

                <!-- Section: Servisne informacije -->
                <div class="form-section-title" style="margin-top: 1.5rem;">Servisne informacije</div>
                <div class="grid grid-cols-3 gap-4">
                    <div class="form-group">
                        <label class="form-label">Okvirna cena *</label>
                        <input type="number" class="form-input" :class="{'invalid': validationErrors.estimated_price}" x-model="newTicket.estimated_price" placeholder="0" min="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Valuta</label>
                        <select class="form-input" x-model="newTicket.currency">
                            <option value="RSD">RSD</option>
                            <option value="EUR">EUR</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Prioritet</label>
                        <select class="form-input" x-model="newTicket.priority">
                            <option value="NORMAL">Normalan</option>
                            <option value="URGENT">Hitan</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Lokacija *</label>
                    <select class="form-input" :class="{'invalid': validationErrors.location_id}" x-model="newTicket.location_id" required>
                        <option value="">Izaberi lokaciju</option>
                        <template x-for="loc in locations" :key="loc.id">
                            <option :value="loc.id" x-text="loc.name"></option>
                        </template>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" @click="showAddModal = false">Otkaži</button>
                <button class="btn-primary" @click="saveTicket()" :disabled="saving">
                    <span x-show="!saving">Sačuvaj nalog</span>
                    <span x-show="saving">Čuvanje...</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div x-show="showNotifyModal" x-cloak class="modal-overlay" @click.self="showNotifyModal = false">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                <h3 style="color: white;">Obaveštenje kupca</h3>
                <button class="modal-close" @click="showNotifyModal = false" style="color: rgba(255,255,255,0.7);">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Ticket info card -->
                <div class="notify-info-card">
                    <div class="notify-info-row">
                        <span>Broj naloga:</span>
                        <span x-text="'#' + notifyTicket?.ticket_number_formatted"></span>
                    </div>
                    <div class="notify-info-row">
                        <span>Klijent:</span>
                        <span x-text="notifyTicket?.customer_name"></span>
                    </div>
                    <div class="notify-info-row">
                        <span>Kontakt:</span>
                        <span x-text="notifyTicket?.customer_phone || '-'"></span>
                    </div>
                    <div class="notify-info-row">
                        <span>Uređaj:</span>
                        <span x-text="(notifyTicket?.brand || '') + ' ' + (notifyTicket?.model || '')"></span>
                    </div>
                    <div class="notify-info-row">
                        <span>Broj obaveštenja:</span>
                        <span x-text="notifyTicket?.notification_count || 0"></span>
                    </div>
                </div>

                <!-- Notification history -->
                <div x-show="notificationHistory.length > 0" class="notify-history">
                    <h4>Istorija obaveštenja</h4>
                    <template x-for="n in notificationHistory" :key="n.id">
                        <div class="notify-history-item">
                            <span class="history-date" x-text="formatDate(n.timestamp)"></span>
                            <span class="history-comment" x-text="n.comment || '-'"></span>
                        </div>
                    </template>
                </div>

                <!-- Quick reply buttons -->
                <div class="quick-reply-section">
                    <label>Brzi odgovor:</label>
                    <div class="quick-reply-buttons">
                        <button type="button" class="quick-reply-btn" @click="notifyComment = 'Klijent rekao da će doći'">
                            Klijent će doći
                        </button>
                        <button type="button" class="quick-reply-btn" @click="notifyComment = 'Klijent se ne javlja na telefon'">
                            Ne javlja se
                        </button>
                        <button type="button" class="quick-reply-btn" @click="notifyComment = 'Ostavljena poruka'">
                            Ostavljena poruka
                        </button>
                    </div>
                </div>

                <!-- Comment input -->
                <div class="form-group">
                    <label class="form-label">Komentar:</label>
                    <textarea x-model="notifyComment" rows="2" class="form-input" placeholder="Šta je kupac rekao..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" @click="showNotifyModal = false">Otkaži</button>
                <button x-show="notifyTicket?.can_write_off" class="btn-danger" @click="writeOffTicket()">
                    Otpiši nalog
                </button>
                <button class="btn-primary" @click="confirmNotify()">
                    Potvrdi obaveštenje
                </button>
            </div>
        </div>
    </div>

    <!-- Collect Modal (POS Integrated) - Premium Glassmorphism Design -->
    <div x-show="showCollectModal" x-cloak class="collect-modal-overlay" @click.self="showCollectModal = false">
        <div class="collect-modal-container">
            <!-- Header with gradient accent -->
            <div class="collect-modal-header">
                <div class="collect-modal-header-content">
                    <div class="collect-modal-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="collect-modal-title">Naplata i preuzimanje</h3>
                        <p class="collect-modal-subtitle" x-text="'Nalog #' + collectTicketData?.ticket_number_formatted"></p>
                    </div>
                </div>
                <button class="collect-modal-close" @click="showCollectModal = false">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Body -->
            <div class="collect-modal-body">
                <!-- Device & Customer info card -->
                <div class="collect-info-card">
                    <div class="collect-info-main">
                        <p class="collect-info-device" x-text="(collectTicketData?.brand || '') + ' ' + (collectTicketData?.model || '')"></p>
                        <p class="collect-info-customer" x-text="collectTicketData?.customer_name"></p>
                    </div>
                    <span class="collect-status-badge">Spremno</span>
                </div>

                <!-- Currency conversion (if EUR) -->
                <div x-show="collectCurrency && collectCurrency !== 'RSD'" class="collect-currency-card">
                    <div class="collect-currency-header">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                        </svg>
                        <span>Konverzija valute</span>
                    </div>
                    <div class="collect-currency-row">
                        <span class="collect-currency-label">Originalno:</span>
                        <span class="collect-currency-value" x-text="collectOriginalPrice + ' ' + collectCurrency"></span>
                    </div>
                    <div class="collect-currency-inputs">
                        <span class="collect-currency-label">Kurs:</span>
                        <input type="number" x-model.number="collectExchangeRate"
                               @input="collectPrice = Math.round(collectOriginalPrice * collectExchangeRate)"
                               step="0.01" min="1" class="collect-input-small">
                        <span class="collect-currency-arrow">→</span>
                        <input type="number" x-model.number="collectPrice"
                               @input="if(collectOriginalPrice > 0) collectExchangeRate = (collectPrice / collectOriginalPrice).toFixed(2)"
                               step="100" min="0" class="collect-input-medium">
                        <span class="collect-currency-label">RSD</span>
                    </div>
                </div>

                <!-- Price input (RSD only) -->
                <div x-show="!collectCurrency || collectCurrency === 'RSD'" class="collect-field">
                    <label class="collect-label">Iznos za naplatu</label>
                    <div class="collect-input-wrapper">
                        <input type="number" x-model.number="collectPrice" placeholder="0" min="0" class="collect-input-price">
                        <span class="collect-input-suffix">RSD</span>
                    </div>
                </div>

                <!-- Parts/Cost Entry Section -->
                <div class="collect-parts-section">
                    <button type="button" @click="collectShowParts = !collectShowParts" class="collect-parts-toggle">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="collect-parts-icon">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
                        </svg>
                        <span>Utrošeni delovi / Troškovi</span>
                        <svg :class="{'rotate-180': collectShowParts}" class="collect-parts-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>

                    <div x-show="collectShowParts" x-transition class="collect-parts-content">
                        <!-- Existing parts from ticket -->
                        <template x-if="collectTicketData?.parts_cost > 0">
                            <div class="collect-parts-existing">
                                <span class="collect-parts-existing-label">Već evidentirano:</span>
                                <span class="collect-parts-existing-value" x-text="Number(collectTicketData.parts_cost).toLocaleString('sr-RS') + ' RSD'"></span>
                            </div>
                        </template>

                        <!-- Added parts list -->
                        <template x-for="(part, index) in collectParts" :key="index">
                            <div class="collect-part-item">
                                <div class="collect-part-info">
                                    <span class="collect-part-name" x-text="part.name"></span>
                                    <span class="collect-part-supplier" x-show="part.supplier" x-text="'(' + part.supplier + ')'"></span>
                                </div>
                                <div class="collect-part-price">
                                    <span x-text="Number(part.priceRsd).toLocaleString('sr-RS') + ' RSD'"></span>
                                    <button type="button" @click="collectParts.splice(index, 1)" class="collect-part-remove">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </template>

                        <!-- Add new part form -->
                        <div class="collect-part-add">
                            <div class="collect-part-row">
                                <input type="text" x-model="collectNewPart.name" placeholder="Naziv dela (npr. Ekran Samsung)" class="collect-part-input-name">
                            </div>
                            <div class="collect-part-row">
                                <input type="text" x-model="collectNewPart.supplier" placeholder="Dobavljač (opciono)" class="collect-part-input-supplier">
                            </div>
                            <div class="collect-part-row collect-part-price-row">
                                <input type="number" x-model.number="collectNewPart.price" placeholder="Nab. cena" min="0" class="collect-part-input-price"
                                       @input="collectNewPart.priceRsd = collectNewPart.currency === 'EUR' ? Math.round(collectNewPart.price * collectPartsExchangeRate) : collectNewPart.price">
                                <select x-model="collectNewPart.currency" class="collect-part-select-currency"
                                        @change="collectNewPart.priceRsd = collectNewPart.currency === 'EUR' ? Math.round(collectNewPart.price * collectPartsExchangeRate) : collectNewPart.price">
                                    <option value="RSD">RSD</option>
                                    <option value="EUR">EUR</option>
                                </select>
                                <template x-if="collectNewPart.currency === 'EUR'">
                                    <div class="collect-part-conversion">
                                        <span class="collect-part-conversion-label">×</span>
                                        <input type="number" x-model.number="collectPartsExchangeRate" step="0.01" min="1" class="collect-part-input-rate"
                                               @input="collectNewPart.priceRsd = Math.round(collectNewPart.price * collectPartsExchangeRate)">
                                        <span class="collect-part-conversion-label">=</span>
                                        <span class="collect-part-conversion-result" x-text="Number(collectNewPart.priceRsd).toLocaleString('sr-RS') + ' RSD'"></span>
                                    </div>
                                </template>
                                <button type="button" @click="addCollectPart()" :disabled="!collectNewPart.name || collectNewPart.price <= 0" class="collect-part-add-btn">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Parts total -->
                        <div x-show="collectParts.length > 0 || collectTicketData?.parts_cost > 0" class="collect-parts-total">
                            <span>Ukupan trošak delova:</span>
                            <span class="collect-parts-total-value" x-text="Number(collectTotalPartsCost).toLocaleString('sr-RS') + ' RSD'"></span>
                        </div>

                        <!-- Profit preview -->
                        <div x-show="collectPrice > 0 && (collectParts.length > 0 || collectTicketData?.parts_cost > 0)" class="collect-profit-preview">
                            <span>Profit:</span>
                            <span :class="collectProfit >= 0 ? 'profit-positive' : 'profit-negative'"
                                  x-text="Number(collectProfit).toLocaleString('sr-RS') + ' RSD'"></span>
                        </div>
                    </div>
                </div>

                <!-- Owner collect -->
                <div class="collect-field">
                    <label class="collect-label">Preuzima uređaj</label>
                    <input type="text" x-model="collectOwner" :placeholder="collectTicketData?.customer_name" class="collect-input">
                </div>

                <!-- Payment method selection -->
                <div class="collect-field">
                    <label class="collect-label">Način plaćanja</label>
                    <div class="collect-payment-grid">
                        <button type="button" @click="collectPaymentMethod = 'CASH'"
                                :class="{'active': collectPaymentMethod === 'CASH'}"
                                class="collect-payment-btn collect-payment-cash">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                            <span>Gotovina</span>
                        </button>
                        <button type="button" @click="collectPaymentMethod = 'CARD'"
                                :class="{'active': collectPaymentMethod === 'CARD'}"
                                class="collect-payment-btn collect-payment-card">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                            </svg>
                            <span>Kartica</span>
                        </button>
                        <button type="button" @click="collectPaymentMethod = 'TRANSFER'"
                                :class="{'active': collectPaymentMethod === 'TRANSFER'}"
                                class="collect-payment-btn collect-payment-transfer">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"/>
                            </svg>
                            <span>Prenos</span>
                        </button>
                    </div>
                </div>

                <!-- Cash received (for cash payments) -->
                <div x-show="collectPaymentMethod === 'CASH'" x-transition class="collect-cash-card">
                    <label class="collect-cash-label">Primljeni iznos</label>
                    <input type="number" x-model.number="collectCashReceived" :placeholder="collectPrice" class="collect-cash-input">
                    <div x-show="collectCashReceived > 0" class="collect-cash-change">
                        <span>Kusur:</span>
                        <span :class="(collectCashReceived - collectPrice) >= 0 ? 'positive' : 'negative'"
                              x-text="(collectCashReceived - collectPrice).toLocaleString('sr-RS') + ' RSD'"></span>
                    </div>
                </div>

                <!-- Total display -->
                <div class="collect-total-card">
                    <span class="collect-total-label">UKUPNO ZA NAPLATU</span>
                    <span class="collect-total-amount" x-text="Number(collectPrice).toLocaleString('sr-RS') + ' RSD'"></span>
                </div>
            </div>

            <!-- Footer -->
            <div class="collect-modal-footer">
                <button class="collect-btn-cancel" @click="showCollectModal = false">Otkaži</button>
                <button class="collect-btn-confirm" @click="confirmCollect()"
                        :disabled="!collectPaymentMethod || collectPrice <= 0 || collecting"
                        :class="{'disabled': !collectPaymentMethod || collectPrice <= 0 || collecting}">
                    <svg x-show="!collecting" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                    </svg>
                    <svg x-show="collecting" class="animate-spin" viewBox="0 0 24 24" fill="none">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                    <span x-text="collecting ? 'Obrada...' : 'Potvrdi naplatu'"></span>
                </button>
            </div>
        </div>
    </div>

    <style>
        /* ========================================
           COLLECT MODAL - Premium Glassmorphism
           ======================================== */

        /* Overlay with blur */
        .collect-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            animation: collectOverlayIn 0.2s ease-out;
        }

        @keyframes collectOverlayIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Modal container - Glassmorphism */
        .collect-modal-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            width: 100%;
            max-width: 420px;
            box-shadow:
                0 0 0 1px rgba(255, 255, 255, 0.1),
                0 20px 50px -10px rgba(0, 0, 0, 0.25),
                0 0 100px -20px rgba(124, 58, 237, 0.15);
            overflow: hidden;
            animation: collectModalIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes collectModalIn {
            from { opacity: 0; transform: scale(0.95) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* Header */
        .collect-modal-header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
            padding: 20px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }

        .collect-modal-header::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .collect-modal-header-content {
            display: flex;
            align-items: center;
            gap: 14px;
            position: relative;
            z-index: 1;
        }

        .collect-modal-icon {
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .collect-modal-icon svg {
            width: 24px;
            height: 24px;
            color: white;
        }

        .collect-modal-title {
            color: white;
            font-size: 17px;
            font-weight: 600;
            margin: 0;
            letter-spacing: -0.02em;
        }

        .collect-modal-subtitle {
            color: rgba(255, 255, 255, 0.75);
            font-size: 13px;
            margin: 3px 0 0 0;
        }

        .collect-modal-close {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: none;
            background: rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: relative;
            z-index: 1;
        }

        .collect-modal-close:hover {
            background: rgba(255, 255, 255, 0.25);
            color: white;
        }

        .collect-modal-close svg {
            width: 18px;
            height: 18px;
        }

        /* Body */
        .collect-modal-body {
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        /* Info card */
        .collect-info-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            padding: 16px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collect-info-device {
            font-size: 15px;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }

        .collect-info-customer {
            font-size: 13px;
            color: #64748b;
            margin: 4px 0 0 0;
        }

        .collect-status-badge {
            background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%);
            color: #6d28d9;
            font-size: 11px;
            font-weight: 600;
            padding: 5px 12px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Currency card */
        .collect-currency-card {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #fbbf24;
            border-radius: 14px;
            padding: 16px 18px;
        }

        .collect-currency-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 14px;
        }

        .collect-currency-header svg {
            width: 18px;
            height: 18px;
            color: #b45309;
        }

        .collect-currency-header span {
            font-size: 13px;
            font-weight: 600;
            color: #92400e;
        }

        .collect-currency-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .collect-currency-label {
            font-size: 13px;
            color: #78716c;
        }

        .collect-currency-value {
            font-family: 'SF Mono', 'Monaco', monospace;
            font-weight: 600;
            color: #1e293b;
        }

        .collect-currency-inputs {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .collect-currency-arrow {
            color: #a3a3a3;
            font-size: 14px;
        }

        .collect-input-small {
            width: 70px;
            padding: 8px 10px;
            border: 1px solid #fbbf24;
            border-radius: 8px;
            font-size: 13px;
            background: white;
            color: #1e293b;
            text-align: center;
        }

        .collect-input-medium {
            width: 100px;
            padding: 8px 10px;
            border: 1px solid #fbbf24;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            background: white;
            color: #1e293b;
            text-align: center;
        }

        /* Form fields */
        .collect-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .collect-label {
            font-size: 13px;
            font-weight: 500;
            color: #64748b;
        }

        .collect-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 14px;
            color: #1e293b;
            background: #fafafa;
            transition: all 0.2s;
        }

        .collect-input:focus {
            outline: none;
            border-color: #8b5cf6;
            background: white;
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
        }

        .collect-input-wrapper {
            position: relative;
        }

        .collect-input-price {
            width: 100%;
            padding: 14px 60px 14px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
            background: #fafafa;
            transition: all 0.2s;
        }

        .collect-input-price:focus {
            outline: none;
            border-color: #8b5cf6;
            background: white;
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
        }

        .collect-input-suffix {
            position: absolute;
            right: 18px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            font-weight: 500;
            color: #94a3b8;
        }

        /* Payment method grid */
        .collect-payment-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .collect-payment-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 14px 8px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: #fafafa;
            color: #64748b;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .collect-payment-btn svg {
            width: 22px;
            height: 22px;
        }

        .collect-payment-btn:hover {
            border-color: #cbd5e1;
            background: white;
        }

        .collect-payment-cash.active {
            border-color: #22c55e;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            color: #16a34a;
        }

        .collect-payment-card.active {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            color: #2563eb;
        }

        .collect-payment-transfer.active {
            border-color: #8b5cf6;
            background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
            color: #7c3aed;
        }

        /* Cash card */
        .collect-cash-card {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 1px solid #86efac;
            border-radius: 14px;
            padding: 16px 18px;
        }

        .collect-cash-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #166534;
            margin-bottom: 10px;
        }

        .collect-cash-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #86efac;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            background: white;
            color: #166534;
            transition: all 0.2s;
        }

        .collect-cash-input:focus {
            outline: none;
            border-color: #22c55e;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.15);
        }

        .collect-cash-change {
            margin-top: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: #166534;
        }

        .collect-cash-change span:last-child {
            font-size: 18px;
            font-weight: 700;
        }

        .collect-cash-change .positive { color: #16a34a; }
        .collect-cash-change .negative { color: #dc2626; }

        /* Total card */
        .collect-total-card {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
            border-radius: 14px;
            padding: 18px 22px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .collect-total-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, transparent 50%);
            pointer-events: none;
        }

        .collect-total-label {
            font-size: 12px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            letter-spacing: 0.5px;
            position: relative;
            z-index: 1;
        }

        .collect-total-amount {
            font-size: 26px;
            font-weight: 700;
            color: white;
            letter-spacing: -0.02em;
            position: relative;
            z-index: 1;
        }

        /* Parts Section */
        .collect-parts-section {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            background: #f8fafc;
        }

        .collect-parts-toggle {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 16px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #475569;
            transition: all 0.2s;
        }

        .collect-parts-toggle:hover {
            background: #f1f5f9;
            color: #334155;
        }

        .collect-parts-icon {
            width: 20px;
            height: 20px;
            color: #8b5cf6;
        }

        .collect-parts-chevron {
            width: 18px;
            height: 18px;
            margin-left: auto;
            transition: transform 0.2s;
            color: #94a3b8;
        }

        .collect-parts-chevron.rotate-180 {
            transform: rotate(180deg);
        }

        .collect-parts-content {
            padding: 16px;
            border-top: 1px solid #e2e8f0;
            background: white;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .collect-parts-existing {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: #f1f5f9;
            border-radius: 8px;
            font-size: 13px;
        }

        .collect-parts-existing-label { color: #64748b; }
        .collect-parts-existing-value { font-weight: 600; color: #334155; }

        .collect-part-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: #faf5ff;
            border: 1px solid #e9d5ff;
            border-radius: 8px;
        }

        .collect-part-info {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .collect-part-name {
            font-size: 13px;
            font-weight: 500;
            color: #334155;
        }

        .collect-part-supplier {
            font-size: 12px;
            color: #94a3b8;
        }

        .collect-part-price {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            font-weight: 600;
            color: #7c3aed;
        }

        .collect-part-remove {
            width: 24px;
            height: 24px;
            padding: 4px;
            border: none;
            background: transparent;
            cursor: pointer;
            color: #94a3b8;
            border-radius: 4px;
            transition: all 0.15s;
        }

        .collect-part-remove:hover {
            background: #fecaca;
            color: #dc2626;
        }

        .collect-part-remove svg {
            width: 100%;
            height: 100%;
        }

        .collect-part-add {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 12px;
            background: #f8fafc;
            border: 1px dashed #cbd5e1;
            border-radius: 8px;
        }

        .collect-part-row {
            display: flex;
            gap: 8px;
        }

        .collect-part-input-name {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 13px;
            background: white;
        }

        .collect-part-input-supplier {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 13px;
            background: white;
        }

        .collect-part-price-row {
            flex-wrap: wrap;
            align-items: center;
        }

        .collect-part-input-price {
            width: 100px;
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 13px;
            background: white;
        }

        .collect-part-select-currency {
            width: 70px;
            padding: 10px 8px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 13px;
            background: white;
            cursor: pointer;
        }

        .collect-part-conversion {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            min-width: 200px;
        }

        .collect-part-conversion-label {
            font-size: 12px;
            color: #94a3b8;
        }

        .collect-part-input-rate {
            width: 70px;
            padding: 8px 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 12px;
            background: white;
            text-align: center;
        }

        .collect-part-conversion-result {
            font-size: 13px;
            font-weight: 600;
            color: #7c3aed;
        }

        .collect-part-add-btn {
            width: 40px;
            height: 40px;
            padding: 10px;
            border: none;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            flex-shrink: 0;
        }

        .collect-part-add-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .collect-part-add-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .collect-part-add-btn svg {
            width: 100%;
            height: 100%;
        }

        .collect-parts-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 14px;
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            border: 1px solid #e9d5ff;
            border-radius: 10px;
            font-size: 13px;
            color: #6b21a8;
        }

        .collect-parts-total-value {
            font-weight: 700;
            font-size: 15px;
        }

        .collect-profit-preview {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            font-size: 13px;
            color: #166534;
        }

        .collect-profit-preview .profit-positive {
            font-weight: 700;
            font-size: 15px;
            color: #16a34a;
        }

        .collect-profit-preview .profit-negative {
            font-weight: 700;
            font-size: 15px;
            color: #dc2626;
        }

        /* Dark theme support for parts section */
        .glass-theme .collect-parts-section {
            background: rgba(30, 41, 59, 0.5);
            border-color: rgba(148, 163, 184, 0.2);
        }

        .glass-theme .collect-parts-toggle {
            color: #e2e8f0;
        }

        .glass-theme .collect-parts-toggle:hover {
            background: rgba(148, 163, 184, 0.1);
        }

        .glass-theme .collect-parts-content {
            background: rgba(30, 41, 59, 0.6);
            border-color: rgba(148, 163, 184, 0.2);
        }

        .glass-theme .collect-parts-existing {
            background: rgba(51, 65, 85, 0.5);
        }

        .glass-theme .collect-parts-existing-value { color: #e2e8f0; }

        .glass-theme .collect-part-item {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.3);
        }

        .glass-theme .collect-part-name { color: #e2e8f0; }

        .glass-theme .collect-part-add {
            background: rgba(51, 65, 85, 0.4);
            border-color: rgba(148, 163, 184, 0.3);
        }

        .glass-theme .collect-part-input-name,
        .glass-theme .collect-part-input-supplier,
        .glass-theme .collect-part-input-price,
        .glass-theme .collect-part-select-currency,
        .glass-theme .collect-part-input-rate {
            background: rgba(30, 41, 59, 0.8);
            border-color: rgba(148, 163, 184, 0.3);
            color: #e2e8f0;
        }

        .glass-theme .collect-parts-total {
            background: rgba(139, 92, 246, 0.15);
            border-color: rgba(139, 92, 246, 0.3);
            color: #c4b5fd;
        }

        .glass-theme .collect-profit-preview {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
            color: #86efac;
        }

        /* Footer */
        .collect-modal-footer {
            padding: 18px 24px;
            background: linear-gradient(to top, #f8fafc, rgba(248, 250, 252, 0.9));
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 12px;
        }

        .collect-btn-cancel {
            flex: 1;
            padding: 14px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            color: #64748b;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .collect-btn-cancel:hover {
            border-color: #cbd5e1;
            color: #475569;
            background: #f8fafc;
        }

        .collect-btn-confirm {
            flex: 1.5;
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }

        .collect-btn-confirm:hover:not(.disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
        }

        .collect-btn-confirm.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }

        .collect-btn-confirm svg {
            width: 18px;
            height: 18px;
        }

        .animate-spin {
            animation: collectSpin 1s linear infinite;
        }

        @keyframes collectSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* ========================================
           DARK THEME SUPPORT (Glass Theme)
           ======================================== */
        .glass-theme .collect-modal-overlay {
            background: rgba(0, 0, 0, 0.7);
        }

        .glass-theme .collect-modal-container {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow:
                0 0 0 1px rgba(255, 255, 255, 0.05),
                0 20px 50px -10px rgba(0, 0, 0, 0.5),
                0 0 100px -20px rgba(139, 92, 246, 0.2);
        }

        .glass-theme .collect-info-card {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .glass-theme .collect-info-device { color: #f1f5f9; }
        .glass-theme .collect-info-customer { color: #94a3b8; }

        .glass-theme .collect-status-badge {
            background: rgba(139, 92, 246, 0.2);
            color: #c4b5fd;
        }

        .glass-theme .collect-label { color: #94a3b8; }

        .glass-theme .collect-input,
        .glass-theme .collect-input-price {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
            color: #f1f5f9;
        }

        .glass-theme .collect-input:focus,
        .glass-theme .collect-input-price:focus {
            border-color: #8b5cf6;
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.2);
        }

        .glass-theme .collect-input-suffix { color: #64748b; }

        .glass-theme .collect-payment-btn {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
            color: #94a3b8;
        }

        .glass-theme .collect-payment-btn:hover {
            border-color: rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.08);
        }

        .glass-theme .collect-payment-cash.active {
            background: rgba(34, 197, 94, 0.15);
            border-color: #22c55e;
            color: #4ade80;
        }

        .glass-theme .collect-payment-card.active {
            background: rgba(59, 130, 246, 0.15);
            border-color: #3b82f6;
            color: #60a5fa;
        }

        .glass-theme .collect-payment-transfer.active {
            background: rgba(139, 92, 246, 0.15);
            border-color: #8b5cf6;
            color: #a78bfa;
        }

        .glass-theme .collect-cash-card {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
        }

        .glass-theme .collect-cash-label { color: #4ade80; }

        .glass-theme .collect-cash-input {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(34, 197, 94, 0.3);
            color: #4ade80;
        }

        .glass-theme .collect-cash-change { color: #4ade80; }
        .glass-theme .collect-cash-change .positive { color: #4ade80; }
        .glass-theme .collect-cash-change .negative { color: #f87171; }

        .glass-theme .collect-currency-card {
            background: rgba(251, 191, 36, 0.1);
            border-color: rgba(251, 191, 36, 0.3);
        }

        .glass-theme .collect-currency-header svg { color: #fbbf24; }
        .glass-theme .collect-currency-header span { color: #fcd34d; }
        .glass-theme .collect-currency-label { color: #a3a3a3; }
        .glass-theme .collect-currency-value { color: #f1f5f9; }

        .glass-theme .collect-input-small,
        .glass-theme .collect-input-medium {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(251, 191, 36, 0.3);
            color: #f1f5f9;
        }

        .glass-theme .collect-modal-footer {
            background: rgba(15, 23, 42, 0.5);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .glass-theme .collect-btn-cancel {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
            color: #94a3b8;
        }

        .glass-theme .collect-btn-cancel:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.15);
            color: #f1f5f9;
        }
    </style>

    <!-- Reject Modal -->
    <div x-show="showRejectModal" x-cloak class="modal-overlay" @click.self="showRejectModal = false">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                <h3 style="color: white;">Odbijanje naloga</h3>
                <button class="modal-close" @click="showRejectModal = false" style="color: rgba(255,255,255,0.7);">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Ticket info card -->
                <div class="notify-info-card">
                    <div class="notify-info-row">
                        <span>Broj naloga:</span>
                        <span x-text="'#' + rejectTicket?.ticket_number_formatted"></span>
                    </div>
                    <div class="notify-info-row">
                        <span>Klijent:</span>
                        <span x-text="rejectTicket?.customer_name"></span>
                    </div>
                    <div class="notify-info-row">
                        <span>Kontakt:</span>
                        <span x-text="rejectTicket?.customer_phone || '-'"></span>
                    </div>
                    <div class="notify-info-row">
                        <span>Uređaj:</span>
                        <span x-text="(rejectTicket?.brand || '') + ' ' + (rejectTicket?.model || '')"></span>
                    </div>
                    <div class="notify-info-row">
                        <span>Problem:</span>
                        <span x-text="rejectTicket?.problem_description || '-'"></span>
                    </div>
                </div>

                <!-- Quick reject reasons -->
                <div class="quick-reply-section">
                    <label>Razlog odbijanja:</label>
                    <div class="quick-reply-buttons">
                        <button type="button" class="quick-reply-btn" @click="rejectComment = 'Neisplativa popravka'">
                            Neisplativa popravka
                        </button>
                        <button type="button" class="quick-reply-btn" @click="rejectComment = 'Nema delova'">
                            Nema delova
                        </button>
                        <button type="button" class="quick-reply-btn" @click="rejectComment = 'Kupac odustao'">
                            Kupac odustao
                        </button>
                        <button type="button" class="quick-reply-btn" @click="rejectComment = 'Nije moguće popraviti'">
                            Nije moguće popraviti
                        </button>
                    </div>
                </div>

                <!-- Comment input -->
                <div class="form-group">
                    <label class="form-label">Komentar (obavezno):</label>
                    <textarea x-model="rejectComment" rows="3" class="form-input" placeholder="Unesite razlog odbijanja..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" @click="showRejectModal = false">Otkaži</button>
                <button class="btn-danger" @click="confirmReject()" :disabled="!rejectComment.trim()">
                    Potvrdi odbijanje
                </button>
            </div>
        </div>
    </div>

    <!-- Finish Modal -->
    <div x-show="showFinishModal" x-cloak class="modal-overlay" @click.self="showFinishModal = false">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                <h3 style="color: white;">Završavanje naloga</h3>
                <button class="modal-close" @click="showFinishModal = false" style="color: rgba(255,255,255,0.7);">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Ticket info card -->
                <div class="notify-info-card">
                    <div class="notify-info-row">
                        <span>Broj naloga:</span>
                        <span x-text="'#' + finishTicket?.ticket_number_formatted"></span>
                    </div>
                    <div class="notify-info-row">
                        <span>Klijent:</span>
                        <span x-text="finishTicket?.customer_name"></span>
                    </div>
                    <div class="notify-info-row">
                        <span>Kontakt:</span>
                        <span x-text="finishTicket?.customer_phone || '-'"></span>
                    </div>
                    <div class="notify-info-row">
                        <span>Uređaj:</span>
                        <span x-text="(finishTicket?.brand || '') + ' ' + (finishTicket?.model || '')"></span>
                    </div>
                    <div class="notify-info-row">
                        <span>Problem:</span>
                        <span x-text="finishTicket?.problem_description || '-'"></span>
                    </div>
                </div>

                <!-- Quick finish reasons -->
                <div class="quick-reply-section">
                    <label>Opis popravke:</label>
                    <div class="quick-reply-buttons">
                        <button type="button" class="quick-reply-btn" style="background: #dcfce7; color: #166534;" @click="finishResolution = 'Uređaj popravljen'">
                            Uređaj popravljen
                        </button>
                        <button type="button" class="quick-reply-btn" style="background: #dcfce7; color: #166534;" @click="finishResolution = 'Zamenjeni delovi'">
                            Zamenjeni delovi
                        </button>
                        <button type="button" class="quick-reply-btn" style="background: #dcfce7; color: #166534;" @click="finishResolution = 'Softverska intervencija'">
                            Softverska intervencija
                        </button>
                    </div>
                </div>

                <!-- Resolution input -->
                <div class="form-group">
                    <label class="form-label">Detalji popravke (opciono):</label>
                    <textarea x-model="finishResolution" rows="3" class="form-input" placeholder="Opišite šta je urađeno..."></textarea>
                </div>

                <p class="collect-confirm-text">
                    Da li želite da označite ovaj nalog kao završen i spreman za preuzimanje?
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" @click="showFinishModal = false">Otkaži</button>
                <button class="btn-primary" @click="confirmFinish()" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                    Potvrdi završetak
                </button>
            </div>
        </div>
    </div>

    <!-- Ticket Detail Modal -->
    <div x-show="showDetailModal" x-cloak class="detail-modal-overlay" @click.self="showDetailModal = false">
        <div class="detail-modal-content" @click.stop>
            <div class="detail-modal-header">
                <div>
                    <div class="ticket-nr" x-text="'#' + detailTicket?.ticket_number_formatted"></div>
                    <div class="ticket-device" x-text="(detailTicket?.brand || '') + ' ' + (detailTicket?.model || '')"></div>
                </div>
                <button class="detail-modal-close" @click="showDetailModal = false">&times;</button>
            </div>
            <div class="detail-modal-body">
                <!-- Customer Section -->
                <div class="detail-section">
                    <div class="detail-section-title">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                        Podaci o korisniku
                    </div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">Ime i prezime</span>
                            <div class="editable-field" :class="{ editing: editingField === 'customer_name' }" @click="startEdit('customer_name')">
                                <template x-if="editingField !== 'customer_name'">
                                    <span class="field-value detail-value" x-text="detailTicket?.customer_name || '-'"></span>
                                </template>
                                <template x-if="editingField === 'customer_name'">
                                    <input type="text" class="inline-input" x-model="inlineEditValue" @blur="saveInlineEdit('customer_name')" @keydown.enter="saveInlineEdit('customer_name')" @keydown.escape="cancelEdit()" x-ref="inlineInput">
                                </template>
                                <svg class="edit-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                            </div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Kontakt</span>
                            <div class="editable-field" :class="{ editing: editingField === 'customer_phone' }" @click="startEdit('customer_phone')">
                                <template x-if="editingField !== 'customer_phone'">
                                    <span class="field-value detail-value" x-text="detailTicket?.customer_phone || '-'"></span>
                                </template>
                                <template x-if="editingField === 'customer_phone'">
                                    <input type="tel" class="inline-input" x-model="inlineEditValue" @blur="saveInlineEdit('customer_phone')" @keydown.enter="saveInlineEdit('customer_phone')" @keydown.escape="cancelEdit()">
                                </template>
                                <svg class="edit-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                            </div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Email</span>
                            <div class="editable-field" :class="{ editing: editingField === 'customer_email' }" @click="startEdit('customer_email')">
                                <template x-if="editingField !== 'customer_email'">
                                    <span class="field-value detail-value" x-text="detailTicket?.customer_email || '-'"></span>
                                </template>
                                <template x-if="editingField === 'customer_email'">
                                    <input type="email" class="inline-input" x-model="inlineEditValue" @blur="saveInlineEdit('customer_email')" @keydown.enter="saveInlineEdit('customer_email')" @keydown.escape="cancelEdit()">
                                </template>
                                <svg class="edit-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Device Section -->
                <div class="detail-section">
                    <div class="detail-section-title">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                        Podaci o uređaju
                    </div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">Marka</span>
                            <div class="editable-field" :class="{ editing: editingField === 'brand' }" @click="startEdit('brand')">
                                <template x-if="editingField !== 'brand'">
                                    <span class="field-value detail-value" x-text="detailTicket?.brand || '-'"></span>
                                </template>
                                <template x-if="editingField === 'brand'">
                                    <input type="text" class="inline-input" x-model="inlineEditValue" @blur="saveInlineEdit('brand')" @keydown.enter="saveInlineEdit('brand')" @keydown.escape="cancelEdit()">
                                </template>
                                <svg class="edit-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                            </div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Model</span>
                            <div class="editable-field" :class="{ editing: editingField === 'model' }" @click="startEdit('model')">
                                <template x-if="editingField !== 'model'">
                                    <span class="field-value detail-value" x-text="detailTicket?.model || '-'"></span>
                                </template>
                                <template x-if="editingField === 'model'">
                                    <input type="text" class="inline-input" x-model="inlineEditValue" @blur="saveInlineEdit('model')" @keydown.enter="saveInlineEdit('model')" @keydown.escape="cancelEdit()">
                                </template>
                                <svg class="edit-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                            </div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">IMEI / Serijski</span>
                            <div class="editable-field" :class="{ editing: editingField === 'imei' }" @click="startEdit('imei')">
                                <template x-if="editingField !== 'imei'">
                                    <span class="field-value detail-value" x-text="detailTicket?.imei || '-'"></span>
                                </template>
                                <template x-if="editingField === 'imei'">
                                    <input type="text" class="inline-input" x-model="inlineEditValue" @blur="saveInlineEdit('imei')" @keydown.enter="saveInlineEdit('imei')" @keydown.escape="cancelEdit()">
                                </template>
                                <svg class="edit-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                            </div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Stanje pri prijemu</span>
                            <span class="detail-value" x-text="getGradeLabel(detailTicket?.device_condition_grade)"></span>
                        </div>
                    </div>
                </div>

                <!-- Problem Section -->
                <div class="detail-section">
                    <div class="detail-section-title">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                        Opis problema
                    </div>
                    <div class="editable-field" :class="{ editing: editingField === 'problem_description' }" @click="startEdit('problem_description')" style="margin: 0;">
                        <template x-if="editingField !== 'problem_description'">
                            <div class="detail-comment-box field-value" x-text="detailTicket?.problem_description || '-'" style="flex: 1;"></div>
                        </template>
                        <template x-if="editingField === 'problem_description'">
                            <textarea class="inline-textarea" x-model="inlineEditValue" @blur="saveInlineEdit('problem_description')" @keydown.escape="cancelEdit()" rows="3"></textarea>
                        </template>
                        <svg class="edit-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="align-self: flex-start; margin-top: 0.75rem;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                    </div>
                </div>

                <!-- Service Section -->
                <div class="detail-section">
                    <div class="detail-section-title">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                        Servisne informacije
                    </div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">Cena</span>
                            <div class="editable-field" :class="{ editing: editingField === 'final_price' }" @click="startEdit('final_price')">
                                <template x-if="editingField !== 'final_price'">
                                    <span class="field-value detail-value large price" x-text="formatPriceDisplay(detailTicket?.final_price || detailTicket?.estimated_price, detailTicket?.currency)"></span>
                                </template>
                                <template x-if="editingField === 'final_price'">
                                    <input type="number" class="inline-input large" x-model="inlineEditValue" @blur="saveInlineEdit('final_price')" @keydown.enter="saveInlineEdit('final_price')" @keydown.escape="cancelEdit()" step="1" min="0">
                                </template>
                                <svg class="edit-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                            </div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Status</span>
                            <span class="detail-status-badge" :class="getStatusClass(detailTicket?.status)" x-text="getStatusLabel(detailTicket?.status)"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Serviser</span>
                            <span class="detail-value" x-text="detailTicket?.assigned_technician_name || '-'"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Lokacija</span>
                            <span class="detail-value" x-text="detailTicket?.location_name || '-'"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Kreiran</span>
                            <span class="detail-value" x-text="formatDateTime(detailTicket?.created_at)"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Završen</span>
                            <span class="detail-value" x-text="detailTicket?.closed_at ? formatDateTime(detailTicket.closed_at) : '-'"></span>
                        </div>
                    </div>
                </div>

                <!-- Notes Section (if has notes) -->
                <div class="detail-section" x-show="detailTicket?.ticket_notes">
                    <div class="detail-section-title">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                        Napomene
                    </div>
                    <div class="detail-comment-box" x-text="detailTicket?.ticket_notes || '-'"></div>
                </div>

                <!-- Warranty Section (if closed) -->
                <div class="detail-section" x-show="detailTicket?.closed_at && detailTicket?.warranty_days">
                    <div class="detail-section-title">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                        Garancija
                    </div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">Trajanje garancije</span>
                            <span class="detail-value" x-text="(detailTicket?.warranty_days || 0) + ' dana'"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Preostalo dana</span>
                            <span class="detail-value" x-text="getWarrantyRemaining(detailTicket)"></span>
                        </div>
                    </div>
                </div>

                <!-- History Section -->
                <div class="detail-section">
                    <button class="history-toggle" @click="toggleHistory(detailTicket?.id)">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <span x-text="showHistory ? 'Sakrij istoriju promena' : 'Prikaži istoriju promena'"></span>
                        <svg x-show="loadingHistory" class="animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                    <div class="history-list" x-show="showHistory && ticketHistory.length > 0">
                        <template x-for="item in ticketHistory" :key="item.id">
                            <div class="history-item">
                                <div class="history-item-header">
                                    <span class="history-item-action" x-text="item.action"></span>
                                    <span x-text="(item.user_name || item.user_email) + ' • ' + formatDateTime(item.created_at)"></span>
                                </div>
                                <template x-for="(change, field) in item.changes" :key="field">
                                    <div class="history-change" x-show="field !== 'updated_at'">
                                        <span class="history-field" x-text="getFieldLabel(field) + ':'"></span>
                                        <span class="history-old" x-text="change.old || '(prazno)'"></span>
                                        <span class="history-arrow">→</span>
                                        <span class="history-new" x-text="change.new || '(prazno)'"></span>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                    <div x-show="showHistory && ticketHistory.length === 0 && !loadingHistory" class="text-center text-gray-500 text-sm py-4">
                        Nema zabeleženih promena
                    </div>
                </div>
            </div>
            <div class="detail-modal-footer">
                <div class="btn-group">
                    <button class="btn-secondary" @click="showDetailModal = false">Zatvori</button>
                </div>
                <div class="btn-group">
                    <button class="btn-secondary" @click="printTicket(detailTicket)">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
                        Štampaj
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Confirmation Modal -->
    <div x-show="showEditConfirmModal" x-cloak class="modal-overlay" @click.self="cancelEditConfirm()" style="z-index: 1100;">
        <div class="modal-content" style="max-width: 380px;" @click.stop>
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6, #6366f1); padding: 1rem 1.25rem;">
                <h3 style="color: white; font-size: 1rem; margin: 0;">Potvrda izmene</h3>
                <button class="modal-close" @click="cancelEditConfirm()" style="color: rgba(255,255,255,0.8);">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="modal-body" style="padding: 1.25rem;">
                <!-- Change info -->
                <div style="background: #f8fafc; border-radius: 8px; padding: 0.875rem; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e2e8f0;">
                        <span style="color: #64748b; font-size: 0.75rem;">Polje</span>
                        <span style="color: #1e293b; font-weight: 600; font-size: 0.875rem;" x-text="getFieldLabel(editConfirmField)"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="color: #ef4444; font-size: 0.75rem;">Staro</span>
                        <span style="color: #991b1b; font-size: 0.875rem; text-decoration: line-through;" x-text="formatEditValue(editConfirmField, editConfirmOldValue)"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #22c55e; font-size: 0.75rem;">Novo</span>
                        <span style="color: #166534; font-weight: 600; font-size: 0.875rem;" x-text="formatEditValue(editConfirmField, editConfirmNewValue)"></span>
                    </div>
                </div>

                <!-- User info -->
                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.625rem; background: #fffbeb; border: 1px solid #fde68a; border-radius: 6px; margin-bottom: 1rem;">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 16px; height: 16px; color: #d97706; flex-shrink: 0;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <span style="color: #92400e; font-size: 0.75rem;">Izmena će biti evidentirana: <strong x-text="currentUserName"></strong></span>
                </div>

                <p style="text-align: center; color: #64748b; font-size: 0.813rem; margin: 0;">
                    Da li ste sigurni?
                </p>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 0.5rem; padding: 0.875rem 1.25rem; background: linear-gradient(135deg, #eef2ff, #e0e7ff); border-top: 1px solid #c7d2fe;">
                <button @click="cancelEditConfirm()" style="padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; font-weight: 500; background: white; color: #4f46e5; border: 1px solid #a5b4fc; cursor: pointer; transition: all 0.15s;">Otkaži</button>
                <button @click="confirmEditSave()" style="padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; font-weight: 500; background: linear-gradient(135deg, #4f46e5, #6366f1); color: white; border: none; cursor: pointer; display: flex; align-items: center; gap: 0.375rem; transition: all 0.15s;">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 14px; height: 14px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                    Sačuvaj
                </button>
            </div>
        </div>
    </div>

</div>

<script>
// Problem categories by device type
const PROBLEM_CATEGORIES = {
    phone: [
        { id: "dijagnostika", label: "Dijagnostika" },
        { id: "zamena_ekrana", label: "Zamena ekrana" },
        { id: "zamena_baterije", label: "Zamena baterije" },
        { id: "zamena_punjenja", label: "Zamena punjenja" },
        { id: "zamena_kamere", label: "Zamena kamere" },
        { id: "zamena_zvucnika", label: "Zamena zvučnika" },
        { id: "zamena_mikrofona", label: "Zamena mikrofona" },
        { id: "signal_wifi", label: "Signal/WiFi" },
        { id: "softver", label: "Softver/OS" },
        { id: "voda_tecnost", label: "Voda/tečnost" },
        { id: "ostalo", label: "Ostalo" }
    ],
    tablet: [
        { id: "dijagnostika", label: "Dijagnostika" },
        { id: "zamena_ekrana", label: "Zamena ekrana" },
        { id: "zamena_baterije", label: "Zamena baterije" },
        { id: "zamena_punjenja", label: "Zamena punjenja" },
        { id: "softver", label: "Softver/OS" },
        { id: "ostalo", label: "Ostalo" }
    ],
    laptop: [
        { id: "dijagnostika", label: "Dijagnostika" },
        { id: "zamena_ekrana", label: "Zamena ekrana" },
        { id: "zamena_baterije", label: "Zamena baterije" },
        { id: "zamena_tastature", label: "Zamena tastature" },
        { id: "zamena_punjaca", label: "Zamena punjača" },
        { id: "zamena_hdd_ssd", label: "Zamena HDD/SSD" },
        { id: "zamena_rama", label: "Zamena RAM-a" },
        { id: "ciscenje_hladjenje", label: "Čišćenje/hlađenje" },
        { id: "softver", label: "Reinstalacija OS" },
        { id: "ostalo", label: "Ostalo" }
    ],
    console: [
        { id: "dijagnostika", label: "Dijagnostika" },
        { id: "hdmi_port", label: "HDMI port" },
        { id: "blu_ray", label: "Blu-ray drive" },
        { id: "hdd_zamena", label: "HDD zamena" },
        { id: "ciscenje", label: "Čišćenje" },
        { id: "napajanje", label: "Napajanje" },
        { id: "kontroler", label: "Kontroler" },
        { id: "ostalo", label: "Ostalo" }
    ],
    other: [
        { id: "dijagnostika", label: "Dijagnostika" },
        { id: "popravka", label: "Popravka" },
        { id: "ostalo", label: "Ostalo" }
    ]
};

function ticketsPage() {
    return {
        loading: true,
        saving: false,
        showAddModal: false,
        validationErrors: {},
        openTickets: [],
        pendingTickets: [],
        stats: {},
        locations: [],
        currentUserName: '',
        canViewRevenue: false,
        filters: {
            search: '',
            location_id: ''
        },
        // ========== COUNTRY SELECTOR ==========
        exYuCountries: [
            { code: '+381', dial: '381', flag: '🇷🇸', name: 'Srbija' },
            { code: '+385', dial: '385', flag: '🇭🇷', name: 'Hrvatska' },
            { code: '+387', dial: '387', flag: '🇧🇦', name: 'BiH' },
            { code: '+382', dial: '382', flag: '🇲🇪', name: 'Crna Gora' },
            { code: '+386', dial: '386', flag: '🇸🇮', name: 'Slovenija' },
            { code: '+383', dial: '383', flag: '🇽🇰', name: 'Kosovo' },
            { code: '+389', dial: '389', flag: '🇲🇰', name: 'S. Makedonija' },
        ],
        otherCountries: [
            { code: '+43', dial: '43', flag: '🇦🇹', name: 'Austrija' },
            { code: '+49', dial: '49', flag: '🇩🇪', name: 'Nemačka' },
            { code: '+41', dial: '41', flag: '🇨🇭', name: 'Švajcarska' },
            { code: '+39', dial: '39', flag: '🇮🇹', name: 'Italija' },
            { code: '+33', dial: '33', flag: '🇫🇷', name: 'Francuska' },
            { code: '+44', dial: '44', flag: '🇬🇧', name: 'UK' },
        ],
        selectedCountry: { code: '+381', dial: '381', flag: '🇷🇸', name: 'Srbija' },
        phoneNumber: '',
        // ======================================
        newTicket: {
            customer_name: '',
            customer_phone: '',
            customer_email: '',
            customer_company_name: '',
            customer_pib: '',
            sms_opt_out: false,
            device_type: 'phone',
            brand: '',
            model: '',
            imei: '',
            device_condition_grade: '',
            device_condition_notes: '',
            device_not_working: false,
            problem_description: '',
            problem_areas: [],
            estimated_price: '',
            currency: 'RSD',
            priority: 'NORMAL',
            location_id: ''
        },
        selectedProblems: [],
        currentProblems: PROBLEM_CATEGORIES['phone'] || [],

        // Part offers state
        partOffers: {
            loading: false, loaded: false, summary: [], brand: '', model: '',
            expandedKey: null, offers: [], offersLoading: false,
        },
        selectedListing: null,
        selectedOffer: null,
        _partSearchTimer: null,
        _lastPartSearchKey: '',

        // Notification modal state
        showNotifyModal: false,
        notifyTicket: null,
        notifyComment: '',
        notificationHistory: [],

        // Collect modal state
        showCollectModal: false,
        collectTicketData: null,
        collectPrice: 0,
        collectOriginalPrice: 0,
        collectCurrency: 'RSD',
        collectExchangeRate: 117,
        collectOwner: '',
        collectPaymentMethod: 'CASH',
        collectCashReceived: 0,
        collecting: false,
        // Parts entry in collect modal
        collectShowParts: false,
        collectParts: [],
        collectNewPart: {
            name: '',
            supplier: '',
            price: 0,
            currency: 'RSD',
            priceRsd: 0
        },
        collectPartsExchangeRate: 117,

        // Reject modal state
        showRejectModal: false,
        rejectTicket: null,
        rejectComment: '',

        // Finish modal state
        showFinishModal: false,
        finishTicket: null,
        finishResolution: '',

        // Detail modal state
        showDetailModal: false,
        detailTicket: null,

        // Edit confirmation modal state
        showEditConfirmModal: false,
        editConfirmField: null,
        editConfirmOldValue: null,
        editConfirmNewValue: null,

        // History state
        showHistory: false,
        loadingHistory: false,
        ticketHistory: [],

        // Inline edit state
        editingField: null,
        inlineEditValue: '',
        savingInline: false,

        async init() {
            await this.loadCurrentUser();
            await this.loadLocations();
            await this.loadAllTickets();

            // Check if we should open the add modal (from dashboard link)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('openModal') === 'true') {
                this.showAddModal = true;
                // Clean up URL
                window.history.replaceState({}, '', window.location.pathname);
            }
        },

        async loadCurrentUser() {
            try {
                const r = await api('/api/v1/auth/me');
                if (r.ok) {
                    const data = await r.json();
                    this.currentUserName = data.user?.full_name || data.user?.email || '';
                    this.canViewRevenue = data.user?.can_view_revenue || false;
                }
            } catch (e) {
                console.error('Failed to load user info:', e);
            }
        },

        async loadLocations() {
            try {
                const r = await api('/api/v1/locations');
                if (r.ok) {
                    const data = await r.json();
                    this.locations = data.locations || [];
                    // Set default location to primary location
                    const primary = this.locations.find(l => l.is_primary);
                    if (primary) {
                        this.newTicket.location_id = primary.id;
                    } else if (this.locations.length > 0) {
                        // Fallback to first location if no primary
                        this.newTicket.location_id = this.locations[0].id;
                    }
                }
            } catch (e) {
                console.error('Failed to load locations:', e);
            }
        },

        async loadAllTickets() {
            this.loading = true;
            try {
                let url = '/api/v1/tickets?per_page=100';
                if (this.filters.search) url += '&search=' + encodeURIComponent(this.filters.search);
                if (this.filters.location_id) url += '&location_id=' + this.filters.location_id;

                const r = await api(url);
                if (r.ok) {
                    const data = await r.json();
                    const tickets = data.items || [];  // API returns 'items' not 'tickets'

                    this.openTickets = tickets.filter(t => t.status === 'RECEIVED' || t.status === 'IN_PROGRESS' || t.status === 'DIAGNOSED');
                    this.pendingTickets = tickets.filter(t => t.status === 'READY');

                    // Calculate totals by currency for open tickets
                    const openRSD = this.openTickets.filter(t => (t.currency || 'RSD') === 'RSD')
                        .reduce((sum, t) => sum + (t.final_price || t.estimated_price || 0), 0);
                    const openEUR = this.openTickets.filter(t => t.currency === 'EUR')
                        .reduce((sum, t) => sum + (t.final_price || t.estimated_price || 0), 0);

                    // Calculate totals by currency for ready/pending tickets
                    const readyRSD = this.pendingTickets.filter(t => (t.currency || 'RSD') === 'RSD')
                        .reduce((sum, t) => sum + (t.final_price || t.estimated_price || 0), 0);
                    const readyEUR = this.pendingTickets.filter(t => t.currency === 'EUR')
                        .reduce((sum, t) => sum + (t.final_price || t.estimated_price || 0), 0);

                    this.stats = {
                        open_tickets: this.openTickets.length,
                        closed_tickets: tickets.filter(t => t.status === 'DELIVERED').length,
                        ready_tickets: this.pendingTickets.length,
                        active_warranties: data.active_warranties || 0,
                        today_tickets: tickets.filter(t => {
                            const today = new Date().toDateString();
                            return new Date(t.created_at).toDateString() === today;
                        }).length,
                        open_rsd: openRSD,
                        open_eur: openEUR,
                        ready_rsd: readyRSD,
                        ready_eur: readyEUR
                    };
                }
            } catch (e) {
                console.error('Failed to load tickets:', e);
            } finally {
                this.loading = false;
            }
        },

        setFilter(filter) {
            // Handle filter clicks
            console.log('Filter:', filter);
        },

        viewTicket(ticket) {
            this.detailTicket = ticket;
            this.showHistory = false;
            this.ticketHistory = [];
            this.editingField = null;
            this.showDetailModal = true;
        },

        startEdit(field) {
            if (this.editingField === field) return;
            if (this.savingInline) return;

            this.editingField = field;
            this.inlineEditValue = this.detailTicket?.[field] || '';

            // Focus input after Alpine updates DOM
            this.$nextTick(() => {
                const input = this.$el.querySelector('.inline-input, .inline-textarea');
                if (input) input.focus();
            });
        },

        cancelEdit() {
            this.editingField = null;
            this.inlineEditValue = '';
        },

        async saveInlineEdit(field) {
            if (!this.detailTicket || this.savingInline) return;

            // For price field, use final_price || estimated_price as old value
            let oldValue = this.detailTicket[field];
            if (field === 'final_price' && !oldValue) {
                oldValue = this.detailTicket.estimated_price;
            }
            const newValue = this.inlineEditValue;

            // If value hasn't changed, just cancel
            if (oldValue == newValue || (!oldValue && !newValue)) {
                this.cancelEdit();
                return;
            }

            // Show confirmation modal
            this.editConfirmField = field;
            this.editConfirmOldValue = oldValue;
            this.editConfirmNewValue = newValue;
            this.showEditConfirmModal = true;
        },

        formatEditValue(field, value) {
            if (value === null || value === undefined || value === '') return '-';

            // Format price fields
            if (field === 'final_price' || field === 'estimated_price') {
                return this.formatPrice(value) + ' ' + (this.detailTicket?.currency || 'RSD');
            }

            return String(value);
        },

        cancelEditConfirm() {
            this.showEditConfirmModal = false;
            this.editConfirmField = null;
            this.editConfirmOldValue = null;
            this.editConfirmNewValue = null;
            this.cancelEdit();
        },

        async confirmEditSave() {
            if (!this.detailTicket || this.savingInline) return;

            const field = this.editConfirmField;
            const newValue = this.editConfirmNewValue;

            this.showEditConfirmModal = false;
            this.savingInline = true;
            try {
                const r = await api('/api/v1/tickets/' + this.detailTicket.id, {
                    method: 'PUT',
                    body: JSON.stringify({ [field]: newValue })
                });

                if (r.ok) {
                    // Update local ticket data
                    this.detailTicket[field] = newValue;

                    // Also update in the tickets lists
                    const updateInList = (list) => {
                        const idx = list.findIndex(t => t.id === this.detailTicket.id);
                        if (idx !== -1) list[idx][field] = newValue;
                    };
                    updateInList(this.openTickets);
                    updateInList(this.pendingTickets);

                    showToast('Sačuvano', 'success');
                } else {
                    const err = await r.json();
                    showToast(err.message || 'Greška pri čuvanju', 'error');
                }
            } catch (e) {
                console.error('Failed to save:', e);
                showToast('Greška pri čuvanju', 'error');
            } finally {
                this.savingInline = false;
                this.editingField = null;
                this.inlineEditValue = '';
            }
        },

        async toggleHistory(ticketId) {
            if (this.showHistory) {
                this.showHistory = false;
                return;
            }

            this.loadingHistory = true;
            try {
                const r = await api('/api/v1/tickets/' + ticketId + '/history');
                if (r.ok) {
                    const data = await r.json();
                    this.ticketHistory = data.items || [];
                }
            } catch (e) {
                console.error('Failed to load history:', e);
            } finally {
                this.loadingHistory = false;
                this.showHistory = true;
            }
        },

        getFieldLabel(field) {
            const labels = {
                'customer_name': 'Ime',
                'customer_phone': 'Telefon',
                'customer_email': 'Email',
                'brand': 'Marka',
                'model': 'Model',
                'imei': 'IMEI',
                'device_type': 'Tip uređaja',
                'device_condition_grade': 'Ocena stanja',
                'device_condition_notes': 'Napomena o stanju',
                'device_not_working': 'Ne radi',
                'problem_description': 'Opis problema',
                'ticket_notes': 'Napomene',
                'estimated_price': 'Procenjena cena',
                'final_price': 'Konačna cena',
                'currency': 'Valuta',
                'warranty_days': 'Garancija',
                'status': 'Status',
                'priority': 'Prioritet'
            };
            return labels[field] || field;
        },

        getGradeLabel(grade) {
            const labels = {
                'A': 'A - Odlično',
                'B': 'B - Dobro',
                'C': 'C - Loše'
            };
            return labels[grade] || grade || '-';
        },

        getStatusClass(status) {
            const classes = {
                'RECEIVED': 'received',
                'DIAGNOSED': 'in_progress',
                'IN_PROGRESS': 'in_progress',
                'WAITING_PARTS': 'in_progress',
                'READY': 'ready',
                'DELIVERED': 'delivered',
                'REJECTED': 'rejected',
                'CANCELLED': 'rejected'
            };
            return classes[status] || 'received';
        },

        getStatusLabel(status) {
            const labels = {
                'RECEIVED': 'Primljeno',
                'DIAGNOSED': 'Dijagnostifikovano',
                'IN_PROGRESS': 'U obradi',
                'WAITING_PARTS': 'Čeka delove',
                'READY': 'Spremno',
                'DELIVERED': 'Preuzeto',
                'REJECTED': 'Odbijeno',
                'CANCELLED': 'Otkazano'
            };
            return labels[status] || status || '-';
        },

        formatPriceDisplay(price, currency) {
            if (!price) return '-';
            return parseFloat(price).toLocaleString('sr-RS') + ' ' + (currency || 'RSD');
        },

        formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('sr-RS') + ' ' + d.toLocaleTimeString('sr-RS', {hour: '2-digit', minute: '2-digit'});
        },

        getWarrantyRemaining(ticket) {
            if (!ticket?.closed_at || !ticket?.warranty_days) return '-';
            const closedDate = new Date(ticket.closed_at);
            const expiryDate = new Date(closedDate);
            expiryDate.setDate(expiryDate.getDate() + ticket.warranty_days);
            const now = new Date();
            const daysRemaining = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
            if (daysRemaining <= 0) return 'Istekla';
            return daysRemaining + ' dana';
        },

        // =============================================
        // FINISH MODAL SYSTEM
        // =============================================
        openFinishModal(ticket) {
            this.finishTicket = ticket;
            this.finishResolution = ticket.resolution || '';
            this.showFinishModal = true;
        },

        async confirmFinish() {
            if (!this.finishTicket) return;

            try {
                // First update resolution if provided
                if (this.finishResolution.trim()) {
                    await api('/api/v1/tickets/' + this.finishTicket.id, {
                        method: 'PATCH',
                        body: JSON.stringify({ resolution: this.finishResolution.trim() })
                    });
                }

                // Then change status to READY
                const r = await api('/api/v1/tickets/' + this.finishTicket.id + '/status', {
                    method: 'PATCH',
                    body: JSON.stringify({ status: 'READY' })
                });
                if (r.ok) {
                    this.showFinishModal = false;
                    await this.loadAllTickets();
                } else {
                    const err = await r.json();
                    alert(err.message || 'Greška pri završavanju naloga');
                }
            } catch (e) {
                console.error('Failed to finish ticket:', e);
                alert('Greška pri završavanju naloga');
            }
        },

        // =============================================
        // COLLECT MODAL SYSTEM (POS Integrated)
        // =============================================
        collectTicket(ticket) {
            // Initialize collect data from ticket
            const price = ticket.final_price || ticket.estimated_price || 0;
            const currency = ticket.currency || 'RSD';

            this.collectTicketData = ticket;
            this.collectOriginalPrice = price;
            this.collectCurrency = currency;
            this.collectExchangeRate = 117; // Default EUR→RSD
            this.collectOwner = ticket.customer_name || '';
            this.collectPaymentMethod = 'CASH';
            this.collectCashReceived = 0;

            // Reset parts entry
            this.collectShowParts = false;
            this.collectParts = [];
            this.collectNewPart = { name: '', supplier: '', price: 0, currency: 'RSD', priceRsd: 0 };
            this.collectPartsExchangeRate = 117;

            // If currency is not RSD, convert to RSD
            if (currency !== 'RSD') {
                this.collectPrice = Math.round(price * this.collectExchangeRate);
            } else {
                this.collectPrice = price;
            }

            this.showCollectModal = true;
        },

        // Parts helper methods
        get collectTotalPartsCost() {
            const existingCost = this.collectTicketData?.parts_cost || 0;
            const newCost = this.collectParts.reduce((sum, p) => sum + (p.priceRsd || 0), 0);
            return existingCost + newCost;
        },

        get collectProfit() {
            return this.collectPrice - this.collectTotalPartsCost;
        },

        addCollectPart() {
            if (!this.collectNewPart.name || this.collectNewPart.price <= 0) return;

            // Calculate RSD price if in EUR
            const priceRsd = this.collectNewPart.currency === 'EUR'
                ? Math.round(this.collectNewPart.price * this.collectPartsExchangeRate)
                : this.collectNewPart.price;

            this.collectParts.push({
                name: this.collectNewPart.name,
                supplier: this.collectNewPart.supplier,
                price: this.collectNewPart.price,
                currency: this.collectNewPart.currency,
                priceRsd: priceRsd
            });

            // Reset form
            this.collectNewPart = { name: '', supplier: '', price: 0, currency: 'RSD', priceRsd: 0 };
        },

        async confirmCollect() {
            if (!this.collectTicketData) return;
            if (!this.collectPaymentMethod) {
                showToast('Izaberite način plaćanja', 'error');
                return;
            }
            if (this.collectPrice <= 0) {
                showToast('Unesite cenu', 'error');
                return;
            }

            this.collecting = true;
            try {
                const payload = {
                    final_price: parseFloat(this.collectPrice),
                    currency: 'RSD',  // Always RSD - price in modal is already converted
                    owner_collect: this.collectOwner || this.collectTicketData.customer_name,
                    payment_method: this.collectPaymentMethod
                };

                // Add cash_received only for cash payments
                if (this.collectPaymentMethod === 'CASH' && this.collectCashReceived > 0) {
                    payload.cash_received = parseFloat(this.collectCashReceived);
                }

                // Add parts/costs if any were entered
                if (this.collectParts.length > 0) {
                    payload.parts = this.collectParts.map(p => ({
                        name: p.name,
                        supplier: p.supplier,
                        purchase_price: p.priceRsd,  // Always in RSD
                        original_price: p.price,
                        original_currency: p.currency
                    }));
                }

                const r = await api('/api/v1/tickets/' + this.collectTicketData.id + '/collect', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                if (r.ok) {
                    const data = await r.json();
                    this.showCollectModal = false;

                    // Show success message with receipt number if available
                    if (data.receipt?.receipt_number) {
                        showToast(`Naplaćeno! Račun #${data.receipt.receipt_number}`, 'success');
                    } else {
                        showToast('Uređaj uspešno preuzet i naplaćen', 'success');
                    }

                    await this.loadAllTickets();
                } else {
                    const err = await r.json();
                    showToast(err.message || err.error || 'Greška pri naplati', 'error');
                }
            } catch (e) {
                console.error('Failed to collect ticket:', e);
                showToast('Greška pri naplati: ' + e.message, 'error');
            } finally {
                this.collecting = false;
            }
        },

        // =============================================
        // NOTIFICATION SYSTEM
        // =============================================
        async openNotifyModal(ticket) {
            this.notifyTicket = ticket;
            this.notifyComment = '';
            this.notificationHistory = [];

            // Load notification history
            try {
                const r = await api('/api/v1/tickets/' + ticket.id + '/notifications');
                if (r.ok) {
                    const data = await r.json();
                    this.notificationHistory = data.notifications || [];
                }
            } catch (e) {
                console.error('Failed to load notifications:', e);
            }

            this.showNotifyModal = true;
        },

        async confirmNotify() {
            if (!this.notifyTicket) return;

            try {
                const r = await api('/api/v1/tickets/' + this.notifyTicket.id + '/notify', {
                    method: 'POST',
                    body: JSON.stringify({ comment: this.notifyComment })
                });
                if (r.ok) {
                    this.showNotifyModal = false;
                    await this.loadAllTickets();
                } else {
                    const err = await r.json();
                    alert(err.message || 'Greška pri slanju obaveštenja');
                }
            } catch (e) {
                console.error('Failed to send notification:', e);
                alert('Greška pri slanju obaveštenja');
            }
        },

        async writeOffTicket() {
            if (!this.notifyTicket) return;
            if (!confirm('Da li ste sigurni da želite da otpišete ovaj nalog? Ova akcija se ne može poništiti.')) return;

            try {
                const r = await api('/api/v1/tickets/' + this.notifyTicket.id + '/write-off', {
                    method: 'POST'
                });
                if (r.ok) {
                    this.showNotifyModal = false;
                    await this.loadAllTickets();
                } else {
                    const err = await r.json();
                    alert(err.message || 'Greška pri otpisu naloga');
                }
            } catch (e) {
                console.error('Failed to write off ticket:', e);
                alert('Greška pri otpisu naloga');
            }
        },

        // =============================================
        // REJECT SYSTEM
        // =============================================
        openRejectModal(ticket) {
            this.rejectTicket = ticket;
            this.rejectComment = '';
            this.showRejectModal = true;
        },

        async confirmReject() {
            if (!this.rejectTicket || !this.rejectComment.trim()) return;

            try {
                const r = await api('/api/v1/tickets/' + this.rejectTicket.id + '/status', {
                    method: 'PATCH',
                    body: JSON.stringify({
                        status: 'REJECTED',
                        rejection_reason: this.rejectComment.trim()
                    })
                });
                if (r.ok) {
                    this.showRejectModal = false;
                    await this.loadAllTickets();
                } else {
                    const err = await r.json();
                    alert(err.message || 'Greška pri odbijanju naloga');
                }
            } catch (e) {
                console.error('Failed to reject ticket:', e);
                alert('Greška pri odbijanju naloga');
            }
        },

        printTicket(ticket) {
            window.open('/tickets/' + ticket.id + '/print', '_blank');
        },

        async saveTicket() {
            // Clear previous validation errors
            this.validationErrors = {};

            // Validate required fields
            const errors = [];

            if (!this.newTicket.customer_name?.trim()) {
                errors.push('Ime i prezime');
                this.validationErrors.customer_name = true;
            }
            if (!this.phoneNumber?.trim()) {
                errors.push('Telefon');
                this.validationErrors.customer_phone = true;
            }
            if (!this.newTicket.brand?.trim()) {
                errors.push('Marka');
                this.validationErrors.brand = true;
            }
            if (!this.newTicket.model?.trim()) {
                errors.push('Model');
                this.validationErrors.model = true;
            }

            const hasProblem = this.newTicket.problem_description?.trim() || this.selectedProblems.length > 0;
            if (!hasProblem) {
                errors.push('Opis problema');
                this.validationErrors.problem_description = true;
            }

            if (!this.newTicket.estimated_price || parseFloat(this.newTicket.estimated_price) <= 0) {
                errors.push('Okvirna cena');
                this.validationErrors.estimated_price = true;
            }

            if (!this.newTicket.location_id) {
                errors.push('Lokacija');
                this.validationErrors.location_id = true;
            }

            if (errors.length > 0) {
                alert('Popunite obavezna polja: ' + errors.join(', '));
                return;
            }

            this.saving = true;
            try {
                // Set formatted phone before sending
                this.newTicket.customer_phone = this.getPhoneForStorage();

                const r = await api('/api/v1/tickets', {
                    method: 'POST',
                    body: JSON.stringify(this.newTicket)
                });
                if (r.ok) {
                    const ticketData = await r.json();
                    // Auto-narucivanje dela ako je izabran
                    if (this.selectedListing && ticketData.id) {
                        try {
                            await api('/api/v1/part-offers/order', {
                                method: 'POST',
                                body: JSON.stringify({
                                    listing_id: this.selectedListing,
                                    quantity: 1,
                                    service_ticket_id: ticketData.id
                                })
                            });
                        } catch (e) {
                            console.error('Auto-order failed:', e);
                        }
                    }
                    this.showAddModal = false;
                    this.resetNewTicket();
                    await this.loadAllTickets();
                } else {
                    const err = await r.json();
                    alert(err.message || 'Greška pri čuvanju');
                }
            } catch (e) {
                console.error(e);
                alert('Greška pri čuvanju');
            } finally {
                this.saving = false;
            }
        },

        resetNewTicket() {
            this.newTicket = {
                customer_name: '',
                customer_phone: '',
                customer_email: '',
                customer_company_name: '',
                customer_pib: '',
                sms_opt_out: false,
                device_type: 'phone',
                brand: '',
                model: '',
                imei: '',
                device_condition_grade: '',
                device_condition_notes: '',
                device_not_working: false,
                problem_description: '',
                problem_areas: [],
                estimated_price: '',
                currency: 'RSD',
                priority: 'NORMAL',
                location_id: ''
            };
            this.selectedProblems = [];
            this.currentProblems = PROBLEM_CATEGORIES['phone'] || [];
            this.validationErrors = {};
            // Reset phone
            this.phoneNumber = '';
            this.selectedCountry = { code: '+381', dial: '381', flag: '🇷🇸', name: 'Srbija' };
            // Reset part offers
            this.partOffers = { loading: false, loaded: false, summary: [], brand: '', model: '', expandedKey: null, offers: [], offersLoading: false };
            this.selectedListing = null;
            this.selectedOffer = null;
            this._lastPartSearchKey = '';
        },

        // ========== PART OFFERS METHODS ==========
        _categoryKeywords: [
            ['display', ['ekran', 'display', 'lcd', 'oled', 'staklo', 'touchscreen', 'touch screen', 'crn ekran', 'razbijen']],
            ['battery', ['baterija', 'battery', 'ne puni', 'brzo trosi', 'gasi se']],
            ['charging_port', ['konektor', 'punjac', 'charging', 'port za punjenje', 'usb-c', 'usb c', 'ne puni se']],
            ['camera', ['kamera', 'camera', 'foto', 'slika', 'ne slika']],
            ['back_cover', ['maska', 'poklopac', 'zadnja maska', 'back cover', 'zadnji poklopac']],
            ['speaker', ['zvucnik', 'speaker', 'mikrofon', 'zvuk', 'ne cuje se']],
        ],
        _catLabels: {
            'display': 'Ekran / Display', 'battery': 'Baterija', 'charging_port': 'Port za punjenje',
            'charging': 'Port za punjenje', 'camera': 'Kamera', 'back_cover': 'Zadnja maska',
            'frame': 'Okvir', 'speaker': 'Zvucnik', 'motherboard': 'Maticna ploca', 'other': 'Ostalo',
        },
        _gradeLabels: {
            'service_pack': 'Service Pack', 'original': 'Original', 'oled_hard': 'OLED Hard',
            'oled_soft': 'OLED Soft', 'oem': 'OEM', 'tft_incell': 'TFT InCell', 'aaa': 'AAA', 'copy': 'Kopija',
        },

        detectPartCategory(desc) {
            if (!desc) return null;
            const lower = desc.toLowerCase();
            for (const [cat, keywords] of this._categoryKeywords) {
                for (const kw of keywords) {
                    if (lower.includes(kw)) return cat;
                }
            }
            return null;
        },

        getCatLabel(cat) { return this._catLabels[cat] || (cat ? cat.charAt(0).toUpperCase() + cat.slice(1) : ''); },
        getGrLabel(grade) { return (grade && this._gradeLabels[grade.toLowerCase()]) || grade || ''; },

        debouncedPartSearch() {
            clearTimeout(this._partSearchTimer);
            const brand = this.newTicket.brand?.trim();
            const model = this.newTicket.model?.trim();
            const category = this.detectPartCategory(this.newTicket.problem_description);

            const hasEnoughInfo = brand && brand.length >= 2 && (
                (model && model.length >= 1) || category
            );

            if (hasEnoughInfo) {
                const searchKey = brand + '|' + (model || '') + '|' + (category || '');
                if (searchKey === this._lastPartSearchKey) return;
                this._partSearchTimer = setTimeout(() => this.checkPartOffers(), 800);
            } else {
                this.partOffers.loaded = false;
                this.partOffers.summary = [];
                this.partOffers.expandedKey = null;
                this.partOffers.offers = [];
                this.selectedListing = null;
                this.selectedOffer = null;
            }
        },

        async checkPartOffers() {
            const brand = this.newTicket.brand?.trim();
            const model = this.newTicket.model?.trim();
            const category = this.detectPartCategory(this.newTicket.problem_description);
            if (!brand) return;

            this._lastPartSearchKey = brand + '|' + (model || '') + '|' + (category || '');
            this.partOffers.loading = true;
            this.partOffers.loaded = false;
            this.partOffers.expandedKey = null;
            this.partOffers.offers = [];
            this.selectedListing = null;
            this.selectedOffer = null;

            try {
                let url = '/api/v1/part-offers/search?brand=' + encodeURIComponent(brand);
                if (model) url += '&model=' + encodeURIComponent(model);
                if (category) url += '&category=' + encodeURIComponent(category);
                console.log('[PartOffers] Searching:', url);
                const resp = await api(url);
                if (resp.ok) {
                    const data = await resp.json();
                    console.log('[PartOffers] Results:', data);
                    this.partOffers.summary = data.categories || [];
                    this.partOffers.brand = data.brand || brand;
                    this.partOffers.model = data.model || model || '';
                    this.partOffers.loaded = true;
                }
            } catch (e) {
                console.error('Part offers search failed:', e);
            } finally {
                this.partOffers.loading = false;
            }
        },

        async loadPartOffers(category, quality) {
            const key = category + '_' + quality;
            if (this.partOffers.expandedKey === key) {
                this.partOffers.expandedKey = null;
                this.partOffers.offers = [];
                return;
            }
            this.partOffers.expandedKey = key;
            this.partOffers.offersLoading = true;
            this.partOffers.offers = [];
            try {
                const brand = this.newTicket.brand?.trim();
                const model = this.newTicket.model?.trim();
                let url = '/api/v1/part-offers/search/offers?brand=' + encodeURIComponent(brand) +
                    '&category=' + encodeURIComponent(category) +
                    '&quality=' + encodeURIComponent(quality);
                if (model) url += '&model=' + encodeURIComponent(model);
                const resp = await api(url);
                if (resp.ok) {
                    const data = await resp.json();
                    this.partOffers.offers = data.offers || [];
                }
            } catch (e) {
                console.error('Part offers load failed:', e);
            } finally {
                this.partOffers.offersLoading = false;
            }
        },

        selectPartOffer(offer) {
            if (this.selectedListing === offer.listing_id) {
                this.selectedListing = null;
                this.selectedOffer = null;
            } else {
                this.selectedListing = offer.listing_id;
                this.selectedOffer = offer;
            }
        },
        // =========================================

        // ========== PHONE HELPERS ==========
        selectCountry(country) {
            this.selectedCountry = country;
        },

        formatPhoneInput() {
            // Dozvoli samo cifre
            this.phoneNumber = this.phoneNumber.replace(/[^\d]/g, '');
        },

        get displayPhoneFormat() {
            // Format za prikaz/čuvanje: 0641234567 (sa vodećom nulom za Srbiju)
            if (!this.phoneNumber) return '0XX...';
            const digits = this.phoneNumber.replace(/\D/g, '');
            // Ukloni vodecu nulu ako je korisnik uneo
            const cleanDigits = digits.startsWith('0') ? digits.slice(1) : digits;
            // Za srpske brojeve, dodaj vodecu nulu
            if (this.selectedCountry.dial === '381') {
                return '0' + cleanDigits;
            }
            // Za ostale zemlje, prikazi sa country kodom
            return this.selectedCountry.code + cleanDigits;
        },

        getPhoneForStorage() {
            // Telefon za čuvanje u bazi - SA vodećom nulom za srpske brojeve
            const digits = this.phoneNumber.replace(/\D/g, '');
            const cleanDigits = digits.startsWith('0') ? digits.slice(1) : digits;
            if (this.selectedCountry.dial === '381') {
                return '0' + cleanDigits;  // 0641234567
            }
            // Za ostale zemlje, čuvaj pun međunarodni format
            return '+' + this.selectedCountry.dial + cleanDigits;
        },
        // ===================================

        setDeviceType(type) {
            this.newTicket.device_type = type;
            this.currentProblems = PROBLEM_CATEGORIES[type] || [];
            this.selectedProblems = [];
            this.newTicket.problem_areas = [];
            // Don't clear problem_description, user might have typed custom text
        },

        toggleProblem(id) {
            const idx = this.selectedProblems.indexOf(id);
            if (idx > -1) {
                this.selectedProblems.splice(idx, 1);
            } else {
                this.selectedProblems.push(id);
            }
            this.updateProblemDescription();
        },

        updateProblemDescription() {
            const labels = this.selectedProblems.map(id => {
                const prob = this.currentProblems.find(p => p.id === id);
                return prob ? prob.label : '';
            }).filter(Boolean);
            this.newTicket.problem_description = labels.join(', ');
            this.newTicket.problem_areas = [...this.selectedProblems];
        },

        syncSelectedProblems() {
            // Bidirectional sync: select chips matching text, deselect chips not in text
            const desc = (this.newTicket.problem_description || '').toLowerCase();

            // Build new selection based on what's in the description
            const newSelection = [];
            for (const prob of this.currentProblems) {
                if (desc.includes(prob.label.toLowerCase())) {
                    newSelection.push(prob.id);
                }
            }

            this.selectedProblems = newSelection;
            this.newTicket.problem_areas = [...this.selectedProblems];
        },

        getDaysOpen(ticket) {
            if (!ticket.created_at) return 0;
            const created = new Date(ticket.created_at);
            const now = new Date();
            return Math.floor((now - created) / (1000 * 60 * 60 * 24));
        },

        getDurationClass(ticket) {
            const days = this.getDaysOpen(ticket);
            if (days <= 10) return 'green';
            if (days <= 18) return 'yellow';
            return 'red';
        },

        getDurationPercent(ticket) {
            const days = this.getDaysOpen(ticket);
            // Min 10% to always show animated bar (like Dolce Vita)
            return Math.max(10, Math.min(100, (days / 30) * 100));
        },

        // Pending tickets - days waiting for pickup
        getDaysWaiting(ticket) {
            // Use ready_at (when status changed to READY)
            // Fallback to created_at for old tickets without ready_at
            const waitingSince = ticket.ready_at || ticket.created_at;
            if (!waitingSince) return 0;
            const startDate = new Date(waitingSince);
            const now = new Date();
            return Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
        },

        getWaitingDurationClass(ticket) {
            const days = this.getDaysWaiting(ticket);
            if (days <= 7) return 'green';
            if (days <= 15) return 'yellow';
            return 'red';
        },

        getWaitingDurationPercent(ticket) {
            const days = this.getDaysWaiting(ticket);
            // Min 10% to always show animated bar (like Dolce Vita)
            return Math.max(10, Math.min(100, (days / 30) * 100));
        },

        formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('sr-Latn-RS');
        },

        formatPrice(price) {
            if (!price) return '0';
            return new Intl.NumberFormat('sr-RS').format(price);
        }
    }
}
</script>
{% endblock %}
