{% extends "layouts/tenant.html" %}

{% block title %}Servisni nalozi - ServisHub{% endblock %}

{% block head %}
<style>
    /* Dolce Vita glassmorphic style */
    .glass-card {
        background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
    }

    .kpi-card {
        position: relative;
        overflow: hidden;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    }
    .kpi-card::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
    }
    .kpi-card.blue::before { background: linear-gradient(180deg, #3b82f6, #1d4ed8); }
    .kpi-card.green::before { background: linear-gradient(180deg, #22c55e, #16a34a); }
    .kpi-card.yellow::before { background: linear-gradient(180deg, #eab308, #ca8a04); }
    .kpi-card.red::before { background: linear-gradient(180deg, #ef4444, #dc2626); }
    .kpi-card.purple::before { background: linear-gradient(180deg, #a855f7, #9333ea); }

    /* Duration progress bar */
    .duration-bar {
        height: 4px;
        border-radius: 2px;
        background: #e5e7eb;
        overflow: hidden;
    }
    .duration-bar-fill {
        height: 100%;
        border-radius: 2px;
        transition: width 0.3s ease;
    }
    .duration-bar-fill.green { background: linear-gradient(90deg, #22c55e, #16a34a); }
    .duration-bar-fill.yellow { background: linear-gradient(90deg, #eab308, #f59e0b); }
    .duration-bar-fill.red { background: linear-gradient(90deg, #ef4444, #dc2626); }

    /* Strobe animation for overdue */
    @keyframes strobe {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    .strobe-alert {
        animation: strobe 1s ease-in-out infinite;
    }

    /* Action buttons */
    .action-btn {
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 500;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }
    .action-btn:hover {
        transform: scale(1.05);
    }
    .action-btn-primary { background: #3b82f6; color: white; }
    .action-btn-success { background: #22c55e; color: white; }
    .action-btn-warning { background: #f59e0b; color: white; }
    .action-btn-danger { background: #ef4444; color: white; }
    .action-btn-purple { background: #9333ea; color: white; }
    .action-btn-outline {
        background: transparent;
        border: 1px solid #d1d5db;
        color: #374151;
    }
    .action-btn-outline:hover {
        background: #f3f4f6;
    }

    /* Written off badge */
    .written-off-badge {
        background: linear-gradient(135deg, #fee2e2, #fecaca);
        color: #991b1b;
        padding: 0.125rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    /* Table section header */
    .table-section-header {
        background: linear-gradient(135deg, #1e3a5f 0%, #0f1f2e 100%);
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem 0.5rem 0 0;
        font-weight: 600;
    }

    /* ===== MODAL STYLES - DOLCE VITA ===== */

    /* Modal container */
    .ticket-modal .modal-content {
        border: none;
        border-radius: 12px;
        box-shadow: 0 24px 48px rgba(60, 64, 67, 0.3);
    }

    .ticket-modal .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e8eaed;
        background: white;
        border-radius: 12px 12px 0 0;
    }

    .ticket-modal .modal-title {
        font-size: 18px;
        font-weight: 500;
        color: #202124;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .ticket-modal .modal-title svg {
        color: #1a73e8;
    }

    .ticket-modal .modal-body {
        padding: 24px;
        max-height: 70vh;
        overflow-y: auto;
        background: white;
    }

    .ticket-modal .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid #e8eaed;
        background: white;
        border-radius: 0 0 12px 12px;
    }

    /* Form sections */
    .form-section {
        margin-bottom: 24px;
        background: transparent;
        padding: 0;
    }

    .form-section-title {
        font-size: 12px;
        font-weight: 600;
        color: #5f6368;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e8eaed;
    }

    /* Form inputs - Google Material style */
    .form-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #dadce0;
        border-radius: 6px;
        font-size: 14px;
        color: #202124;
        transition: border-color 0.2s, box-shadow 0.2s;
        background: white;
    }

    .form-input:focus {
        outline: none;
        border-color: #1a73e8;
        box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
    }

    .form-input::placeholder {
        color: #9aa0a6;
    }

    .form-label {
        display: block;
        font-size: 12px;
        font-weight: 500;
        color: #5f6368;
        margin-bottom: 6px;
    }

    /* Category selector */
    .category-selector {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .category-option {
        flex: 1;
        min-width: 70px;
    }

    .category-option input[type="radio"] {
        display: none;
    }

    .category-option label {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 12px 8px;
        border: 2px solid #e8eaed;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
        background: #f8f9fa;
    }

    .category-option label svg {
        width: 22px;
        height: 22px;
        margin-bottom: 4px;
        color: #5f6368;
    }

    .category-option label span {
        font-size: 11px;
        color: #5f6368;
    }

    .category-option label:hover {
        border-color: #1a73e8;
        background: #e8f0fe;
    }

    .category-option input[type="radio"]:checked + label {
        border-color: #1a73e8;
        background: #e8f0fe;
    }

    .category-option input[type="radio"]:checked + label svg,
    .category-option input[type="radio"]:checked + label span {
        color: #1a73e8;
    }

    /* Grade selector - ABC */
    .grade-selector {
        display: flex;
        gap: 12px;
        justify-content: center;
    }

    .grade-option {
        flex: 1;
        max-width: 100px;
    }

    .grade-option input[type="radio"] {
        display: none;
    }

    .grade-option label {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 14px 10px;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #f8f9fa;
        border: 2px solid #e8eaed;
    }

    .grade-option label:hover {
        transform: translateY(-2px);
    }

    .grade-letter {
        font-size: 26px;
        font-weight: 700;
        line-height: 1;
    }

    .grade-text {
        font-size: 10px;
        margin-top: 4px;
        opacity: 0.7;
        color: #5f6368;
    }

    /* Grade A - Green */
    .grade-option.grade-a label:hover {
        border-color: #34a853;
        background: rgba(52, 168, 83, 0.1);
    }

    .grade-option.grade-a input:checked + label {
        background: linear-gradient(135deg, #34a853 0%, #1e8e3e 100%);
        border-color: #34a853;
        color: white;
        box-shadow: 0 0 20px rgba(52, 168, 83, 0.4);
        transform: translateY(-2px);
    }

    .grade-option.grade-a input:checked + label .grade-text {
        color: white;
        opacity: 0.9;
    }

    /* Grade B - Yellow */
    .grade-option.grade-b label:hover {
        border-color: #f9ab00;
        background: rgba(249, 171, 0, 0.1);
    }

    .grade-option.grade-b input:checked + label {
        background: linear-gradient(135deg, #f9ab00 0%, #e37400 100%);
        border-color: #f9ab00;
        color: #000;
        box-shadow: 0 0 20px rgba(249, 171, 0, 0.4);
        transform: translateY(-2px);
    }

    .grade-option.grade-b input:checked + label .grade-text {
        color: #000;
        opacity: 0.8;
    }

    /* Grade C - Red */
    .grade-option.grade-c label:hover {
        border-color: #ea4335;
        background: rgba(234, 67, 53, 0.1);
    }

    .grade-option.grade-c input:checked + label {
        background: linear-gradient(135deg, #ea4335 0%, #c5221f 100%);
        border-color: #ea4335;
        color: white;
        box-shadow: 0 0 20px rgba(234, 67, 53, 0.4);
        transform: translateY(-2px);
    }

    .grade-option.grade-c input:checked + label .grade-text {
        color: white;
        opacity: 0.9;
    }

    /* Problem buttons */
    .problem-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }

    .problem-btn {
        font-size: 11px;
        padding: 6px 12px;
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid #dadce0;
        background: #fff;
        color: #5f6368;
    }

    .problem-btn:hover {
        background: #f1f3f4;
        border-color: #5f6368;
    }

    .problem-btn.selected {
        background: #ea4335;
        color: white;
        border-color: #ea4335;
    }

    /* Not working checkbox */
    .not-working-selector {
        display: flex;
        justify-content: center;
        margin-top: 12px;
    }

    .not-working-option {
        width: 150px;
    }

    .not-working-option input[type="checkbox"] {
        display: none;
    }

    .not-working-option label {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 14px 20px;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #f8f9fa;
        border: 2px solid #e8eaed;
        text-align: center;
    }

    .not-working-option label svg {
        width: 24px;
        height: 24px;
        margin-bottom: 6px;
        color: #999;
    }

    .not-working-option label .not-working-text {
        font-size: 14px;
        font-weight: 700;
        color: #666;
    }

    .not-working-option label .not-working-subtext {
        font-size: 10px;
        color: #999;
        margin-top: 2px;
    }

    .not-working-option label:hover {
        border-color: #ea4335;
        background: rgba(234, 67, 53, 0.1);
    }

    .not-working-option label:hover svg,
    .not-working-option label:hover .not-working-text {
        color: #ea4335;
    }

    .not-working-option input:checked + label {
        background: linear-gradient(135deg, #ea4335 0%, #c5221f 100%);
        border-color: #ea4335;
        color: white;
        box-shadow: 0 0 25px rgba(234, 67, 53, 0.5);
        transform: translateY(-2px);
    }

    .not-working-option input:checked + label svg,
    .not-working-option input:checked + label .not-working-text,
    .not-working-option input:checked + label .not-working-subtext {
        color: white;
    }

    /* Modal buttons */
    .btn-cancel {
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        background: #f1f3f4;
        border: none;
        color: #5f6368;
    }

    .btn-cancel:hover {
        background: #e8eaed;
    }

    .btn-submit {
        padding: 10px 24px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        background: #1a73e8;
        border: none;
        color: white;
    }

    .btn-submit:hover {
        background: #1557b0;
        box-shadow: 0 2px 8px rgba(26, 115, 232, 0.3);
    }
</style>
{% endblock %}

{% block page_content %}
<div x-data="ticketsPage()" x-init="init()">
    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between mb-6">
        <div class="min-w-0 flex-1">
            <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl sm:tracking-tight">
                Servisni nalozi
            </h2>
        </div>
        <div class="mt-4 flex gap-2 md:ml-4 md:mt-0">
            <a href="/tickets/warranties"
               class="inline-flex items-center rounded-md bg-purple-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-purple-500">
                <svg class="-ml-0.5 mr-1.5 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
                Garancije
            </a>
            <button @click="showAddModal = true"
                    class="inline-flex items-center rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500">
                <svg class="-ml-0.5 mr-1.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                </svg>
                Novi nalog
            </button>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-2 gap-4 sm:grid-cols-3 lg:grid-cols-5 mb-6">
        <!-- Otvoreni nalozi -->
        <div class="kpi-card blue bg-white rounded-lg shadow p-4 cursor-pointer" @click="setFilter('open')">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Otvoreni</p>
                    <p class="mt-1 text-2xl font-bold text-gray-900" x-text="stats.open_tickets || 0"></p>
                </div>
                <div class="p-2 bg-blue-100 rounded-lg">
                    <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                </div>
            </div>
        </div>

        <!-- Zavrseni (ovaj mesec) -->
        <div class="kpi-card green bg-white rounded-lg shadow p-4 cursor-pointer" @click="setFilter('closed')">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Zavrseni</p>
                    <p class="mt-1 text-2xl font-bold text-gray-900" x-text="stats.closed_tickets || 0"></p>
                </div>
                <div class="p-2 bg-green-100 rounded-lg">
                    <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
            </div>
        </div>

        <!-- Za naplatu -->
        <div class="kpi-card yellow bg-white rounded-lg shadow p-4 cursor-pointer" @click="setFilter('ready')">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Za naplatu</p>
                    <p class="mt-1 text-2xl font-bold text-gray-900" x-text="stats.ready_tickets || 0"></p>
                </div>
                <div class="p-2 bg-yellow-100 rounded-lg">
                    <svg class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                </div>
            </div>
        </div>

        <!-- Aktivne garancije -->
        <div class="kpi-card purple bg-white rounded-lg shadow p-4 cursor-pointer" @click="window.location.href='/tickets/warranties'">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Garancije</p>
                    <p class="mt-1 text-2xl font-bold text-gray-900" x-text="stats.active_warranties || 0"></p>
                </div>
                <div class="p-2 bg-purple-100 rounded-lg">
                    <svg class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                </div>
            </div>
        </div>

        <!-- Danas -->
        <div class="kpi-card red bg-white rounded-lg shadow p-4 cursor-pointer" @click="setFilter('today')">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Danas</p>
                    <p class="mt-1 text-2xl font-bold text-gray-900" x-text="stats.today_tickets || 0"></p>
                </div>
                <div class="p-2 bg-red-100 rounded-lg">
                    <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Search/Filter Bar -->
    <div class="bg-white shadow rounded-lg mb-6 p-4">
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
            <!-- Search -->
            <div class="lg:col-span-2">
                <input type="text" x-model="filters.search" @input.debounce.300ms="loadAllTickets()"
                       placeholder="Pretrazi po broju, kupcu, IMEI..."
                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
            </div>

            <!-- Location filter -->
            <div>
                <select x-model="filters.location_id" @change="loadAllTickets()"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                    <option value="">Sve lokacije</option>
                    <template x-for="loc in locations" :key="loc.id">
                        <option :value="loc.id" x-text="loc.name"></option>
                    </template>
                </select>
            </div>

            <!-- Show written off toggle -->
            <div class="flex items-center">
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" x-model="showWrittenOff" @change="loadAllTickets()"
                           class="rounded border-gray-300 text-primary-600 shadow-sm focus:border-primary-300 focus:ring focus:ring-primary-200 focus:ring-opacity-50">
                    <span class="ml-2 text-sm text-gray-600">Prikazi otpisane</span>
                </label>
            </div>
        </div>
    </div>

    <!-- TABLE 1: Otvoreni nalozi -->
    <div class="mb-8">
        <div class="table-section-header flex items-center justify-between">
            <span>Otvoreni nalozi (<span x-text="openTickets.length"></span>)</span>
        </div>
        <div class="bg-white shadow rounded-b-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">#</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kupac</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Uredjaj</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Opis</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Stanje</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cena</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trajanje</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Akcije</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="ticket in openTickets" :key="ticket.id">
                            <tr class="hover:bg-gray-50">
                                <!-- Broj naloga -->
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <div class="text-sm font-bold text-primary-600 cursor-pointer"
                                         @click="viewTicket(ticket)"
                                         x-text="ticket.ticket_number_formatted"></div>
                                    <div class="text-xs text-gray-500" x-text="formatDate(ticket.created_at)"></div>
                                </td>

                                <!-- Kupac -->
                                <td class="px-4 py-3">
                                    <div class="text-sm font-medium text-gray-900" x-text="ticket.customer_name"></div>
                                    <div class="text-xs text-gray-500" x-text="ticket.customer_phone || '-'"></div>
                                </td>

                                <!-- Uredjaj -->
                                <td class="px-4 py-3">
                                    <div class="text-sm text-gray-900">
                                        <span x-text="ticket.brand"></span> <span x-text="ticket.model"></span>
                                    </div>
                                    <div class="text-xs text-gray-500" x-text="ticket.service_section || ticket.device_type || '-'"></div>
                                </td>

                                <!-- Opis -->
                                <td class="px-4 py-3" style="max-width: 200px;">
                                    <div class="text-sm text-gray-700 truncate" x-text="ticket.problem_description || '-'"></div>
                                </td>

                                <!-- Stanje -->
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <template x-if="ticket.device_condition_grade">
                                        <span class="px-2 py-1 rounded text-xs font-medium"
                                              :class="{
                                                  'bg-green-100 text-green-800': ticket.device_condition_grade === 'A',
                                                  'bg-yellow-100 text-yellow-800': ticket.device_condition_grade === 'B',
                                                  'bg-red-100 text-red-800': ticket.device_condition_grade === 'C'
                                              }"
                                              x-text="ticket.device_condition_grade"></span>
                                    </template>
                                    <template x-if="!ticket.device_condition_grade">
                                        <span class="text-gray-400">-</span>
                                    </template>
                                </td>

                                <!-- Cena -->
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900">
                                        <span x-text="formatPrice(ticket.estimated_price)"></span>
                                        <span class="text-gray-500 text-xs" x-text="ticket.currency || 'RSD'"></span>
                                    </div>
                                </td>

                                <!-- Trajanje -->
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <div class="text-sm text-gray-900" x-text="ticket.duration_display || '-'"></div>
                                    <div class="duration-bar mt-1" style="width: 60px;">
                                        <div class="duration-bar-fill"
                                             :class="getDurationClass(ticket)"
                                             :style="'width: ' + getDurationPercent(ticket) + '%'"></div>
                                    </div>
                                </td>

                                <!-- Akcije -->
                                <td class="px-4 py-3 whitespace-nowrap text-right">
                                    <div class="flex justify-end gap-1 flex-wrap">
                                        <!-- Zavrsi -->
                                        <button @click.stop="finishTicket(ticket)"
                                                class="action-btn action-btn-success" title="Zavrsi">
                                            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                            </svg>
                                            Zavrsi
                                        </button>

                                        <!-- Odbij -->
                                        <button @click.stop="rejectTicket(ticket)"
                                                class="action-btn action-btn-danger" title="Odbij">
                                            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </button>

                                        <!-- Stampaj -->
                                        <button @click.stop="printTicket(ticket)"
                                                class="action-btn action-btn-outline" title="Stampaj">
                                            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>

                        <!-- Empty state -->
                        <tr x-show="!loading && openTickets.length === 0">
                            <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                                <p class="text-sm">Nema otvorenih naloga</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- TABLE 2: Ceka naplatu -->
    <div class="mb-8">
        <div class="table-section-header flex items-center justify-between" style="background: linear-gradient(135deg, #78350f 0%, #451a03 100%);">
            <span>Ceka naplatu (<span x-text="pendingTickets.length"></span>)</span>
        </div>
        <div class="bg-white shadow rounded-b-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">#</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kupac</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Uredjaj</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Opis</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cena</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Na cekanju</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Akcije</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="ticket in pendingTickets" :key="ticket.id">
                            <tr class="hover:bg-gray-50" :class="{'bg-red-50': ticket.is_written_off}">
                                <!-- Broj naloga -->
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <div class="text-sm font-bold text-primary-600 cursor-pointer"
                                         @click="viewTicket(ticket)"
                                         x-text="ticket.ticket_number_formatted"></div>
                                    <div class="text-xs text-gray-500" x-text="formatDate(ticket.created_at)"></div>
                                </td>

                                <!-- Kupac -->
                                <td class="px-4 py-3">
                                    <div class="text-sm font-medium text-gray-900" x-text="ticket.customer_name"></div>
                                    <div class="text-xs text-gray-500" x-text="ticket.customer_phone || '-'"></div>
                                    <template x-if="ticket.notification_count > 0">
                                        <div class="text-xs text-orange-600 mt-1 font-medium">
                                            Pozivi: <span x-text="ticket.notification_count"></span>
                                        </div>
                                    </template>
                                </td>

                                <!-- Uredjaj -->
                                <td class="px-4 py-3">
                                    <div class="text-sm text-gray-900">
                                        <span x-text="ticket.brand"></span> <span x-text="ticket.model"></span>
                                    </div>
                                </td>

                                <!-- Opis -->
                                <td class="px-4 py-3" style="max-width: 200px;">
                                    <div class="text-sm text-gray-700 truncate" x-text="ticket.problem_description || '-'"></div>
                                </td>

                                <!-- Cena -->
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900">
                                        <span x-text="formatPrice(ticket.final_price || ticket.estimated_price)"></span>
                                        <span class="text-gray-500 text-xs" x-text="ticket.currency || 'RSD'"></span>
                                    </div>
                                </td>

                                <!-- Na cekanju -->
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <template x-if="ticket.is_written_off">
                                        <span class="written-off-badge">Otpisano</span>
                                    </template>
                                    <template x-if="!ticket.is_written_off">
                                        <div>
                                            <div class="text-sm text-gray-900" x-text="ticket.waiting_days + ' dana'"></div>
                                            <div class="duration-bar mt-1" style="width: 60px;">
                                                <div class="duration-bar-fill"
                                                     :class="getWaitingClass(ticket)"
                                                     :style="'width: ' + getWaitingPercent(ticket) + '%'"></div>
                                            </div>
                                        </div>
                                    </template>
                                </td>

                                <!-- Akcije -->
                                <td class="px-4 py-3 whitespace-nowrap text-right">
                                    <div class="flex justify-end gap-1 flex-wrap">
                                        <template x-if="!ticket.is_written_off">
                                            <!-- Obavesti -->
                                            <button @click.stop="openNotifyModal(ticket)"
                                                    class="action-btn action-btn-purple"
                                                    :class="{'strobe-alert': ticket.notification_count >= 3}"
                                                    title="Obavesti kupca">
                                                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                                </svg>
                                                <span x-show="ticket.notification_count > 0" x-text="ticket.notification_count" class="text-xs"></span>
                                            </button>

                                            <!-- Naplati -->
                                            <button @click.stop="openCollectModal(ticket)"
                                                    class="action-btn action-btn-warning" title="Naplati">
                                                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                                                </svg>
                                                Naplati
                                            </button>
                                        </template>

                                        <!-- Stampaj -->
                                        <button @click.stop="printTicket(ticket)"
                                                class="action-btn action-btn-outline" title="Stampaj">
                                            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>

                        <!-- Empty state -->
                        <tr x-show="!loading && pendingTickets.length === 0">
                            <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                                <p class="text-sm">Nema naloga koji cekaju naplatu</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Loading indicator -->
    <div x-show="loading" class="fixed inset-0 bg-black/30 flex items-center justify-center z-40">
        <div class="bg-white rounded-lg p-6 shadow-xl">
            <svg class="animate-spin mx-auto h-8 w-8 text-primary-600" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2 text-gray-600">Ucitavanje...</p>
        </div>
    </div>

    <!-- Add Ticket Modal -->
    <div x-show="showAddModal" x-cloak
         class="ticket-modal fixed inset-0 z-50 overflow-y-auto"
         @keydown.escape.window="showAddModal = false">
        <div class="flex min-h-screen items-start justify-center p-4 pt-16">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="showAddModal = false"></div>
            <div class="relative modal-content bg-white rounded-lg shadow-xl max-w-2xl w-full">
                <!-- Header -->
                <div class="modal-header">
                    <div class="flex items-center justify-between">
                        <h3 class="modal-title">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            Novi Servisni Nalog
                        </h3>
                        <button @click="showAddModal = false" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Form -->
                <form @submit.prevent="submitNewTicket()" class="modal-body">
                    <!-- Podaci o korisniku -->
                    <div class="form-section">
                        <div class="form-section-title">Podaci o korisniku</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">Ime i prezime *</label>
                                <input type="text" x-model="newTicket.customer_name" required
                                       class="form-input">
                            </div>
                            <div>
                                <label class="form-label">Kontakt telefon *</label>
                                <input type="text" x-model="newTicket.customer_phone" required
                                       class="form-input">
                            </div>
                            <div>
                                <label class="form-label">Email</label>
                                <input type="email" x-model="newTicket.customer_email"
                                       class="form-input">
                            </div>
                            <div>
                                <label class="form-label">Ime firme</label>
                                <input type="text" x-model="newTicket.customer_company_name"
                                       class="form-input">
                            </div>
                        </div>
                    </div>

                    <!-- Podaci o uredaju -->
                    <div class="form-section">
                        <div class="form-section-title">Podaci o uredaju</div>

                        <!-- Kategorija -->
                        <div class="mb-4">
                            <label class="form-label">Kategorija *</label>
                            <div class="category-selector" @change="onCategoryChange()">
                                <div class="category-option">
                                    <input type="radio" name="service_section" value="Telefoni" id="cat_tel" x-model="newTicket.service_section" checked>
                                    <label for="cat_tel">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                        </svg>
                                        <span>Telefon</span>
                                    </label>
                                </div>
                                <div class="category-option">
                                    <input type="radio" name="service_section" value="Tableti" id="cat_tab" x-model="newTicket.service_section">
                                    <label for="cat_tab">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                        </svg>
                                        <span>Tablet</span>
                                    </label>
                                </div>
                                <div class="category-option">
                                    <input type="radio" name="service_section" value="Racunari" id="cat_pc" x-model="newTicket.service_section">
                                    <label for="cat_pc">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                        </svg>
                                        <span>Racunar</span>
                                    </label>
                                </div>
                                <div class="category-option">
                                    <input type="radio" name="service_section" value="Konzole" id="cat_con" x-model="newTicket.service_section">
                                    <label for="cat_con">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        <span>Konzola</span>
                                    </label>
                                </div>
                                <div class="category-option">
                                    <input type="radio" name="service_section" value="Ostalo" id="cat_oth" x-model="newTicket.service_section">
                                    <label for="cat_oth">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                        <span>Ostalo</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">Brand *</label>
                                <input type="text" x-model="newTicket.brand" required list="brandList"
                                       class="form-input">
                                <datalist id="brandList">
                                    <option value="Apple">
                                    <option value="Samsung">
                                    <option value="Xiaomi">
                                    <option value="Huawei">
                                    <option value="OnePlus">
                                    <option value="Google">
                                    <option value="Motorola">
                                    <option value="LG">
                                    <option value="Sony">
                                    <option value="Nokia">
                                    <option value="Lenovo">
                                    <option value="Asus">
                                    <option value="HP">
                                    <option value="Dell">
                                    <option value="PlayStation">
                                    <option value="Xbox">
                                    <option value="Nintendo">
                                </datalist>
                            </div>
                            <div>
                                <label class="form-label">Model *</label>
                                <input type="text" x-model="newTicket.model" required
                                       class="form-input">
                            </div>
                        </div>

                        <div class="mt-4">
                            <label class="form-label">IMEI / Serijski broj</label>
                            <input type="text" x-model="newTicket.imei"
                                   class="form-input">
                        </div>
                    </div>

                    <!-- Opis problema -->
                    <div class="form-section">
                        <div class="form-section-title">Opis problema</div>
                        <div class="mb-4">
                            <label class="form-label">Opis kvara <span class="text-gray-400 text-xs">(ili izaberite brzi izbor)</span></label>
                            <textarea x-model="newTicket.problem_description" rows="2"
                                      placeholder="Opisi problem..."
                                      class="form-input"></textarea>
                        </div>

                        <!-- Brzi izbor problema - Dolce Vita style -->
                        <div>
                            <label class="form-label" style="margin-bottom: 8px;">Brzi izbor problema</label>
                            <div class="problem-buttons">
                                <template x-for="problem in currentProblems" :key="problem.id">
                                    <button type="button"
                                            class="problem-btn"
                                            :class="{'selected': selectedProblems.includes(problem.id)}"
                                            @click="toggleProblem(problem.id)">
                                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" :d="problem.icon" />
                                        </svg>
                                        <span x-text="problem.label"></span>
                                    </button>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Stanje uredaja -->
                    <div class="form-section">
                        <div class="form-section-title">Stanje uredaja pri prijemu</div>

                        <!-- Grade selector -->
                        <div class="mb-4">
                            <label class="form-label" style="margin-bottom: 12px; text-align: center;">Vizuelno stanje</label>
                            <div class="grade-selector">
                                <div class="grade-option grade-a">
                                    <input type="radio" name="device_condition_grade" value="A" id="gradeA" x-model="newTicket.device_condition_grade">
                                    <label for="gradeA">
                                        <span class="grade-letter">A</span>
                                        <span class="grade-text">Odlicno</span>
                                    </label>
                                </div>
                                <div class="grade-option grade-b">
                                    <input type="radio" name="device_condition_grade" value="B" id="gradeB" x-model="newTicket.device_condition_grade">
                                    <label for="gradeB">
                                        <span class="grade-letter">B</span>
                                        <span class="grade-text">Dobro</span>
                                    </label>
                                </div>
                                <div class="grade-option grade-c">
                                    <input type="radio" name="device_condition_grade" value="C" id="gradeC" x-model="newTicket.device_condition_grade">
                                    <label for="gradeC">
                                        <span class="grade-letter">C</span>
                                        <span class="grade-text">Ostecen</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Napomena o stanju</label>
                            <textarea x-model="newTicket.device_condition_notes" rows="2"
                                      placeholder="Ogrebotine, ostecenja..."
                                      class="form-input"></textarea>
                        </div>

                        <!-- Not working checkbox - centered -->
                        <div class="not-working-selector">
                            <div class="not-working-option">
                                <input type="checkbox" id="notWorkingCheck" x-model="newTicket.device_not_working">
                                <label for="notWorkingCheck">
                                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                                    </svg>
                                    <span class="not-working-text">NE RADI</span>
                                    <span class="not-working-subtext">Uredaj se ne pali</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Servisne informacije -->
                    <div class="form-section">
                        <div class="form-section-title">Servisne informacije</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">Okvirna cena *</label>
                                <input type="number" x-model="newTicket.estimated_price" required
                                       class="form-input">
                            </div>
                            <div>
                                <label class="form-label">Valuta</label>
                                <select x-model="newTicket.currency"
                                        class="form-input">
                                    <option value="RSD">RSD</option>
                                    <option value="EUR">EUR</option>
                                    <option value="USD">USD</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Lokacija *</label>
                                <select x-model="newTicket.location_id" required
                                        class="form-input">
                                    <template x-for="loc in locations" :key="loc.id">
                                        <option :value="loc.id" x-text="loc.name"></option>
                                    </template>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Prioritet</label>
                                <select x-model="newTicket.priority"
                                        class="form-input">
                                    <option value="normal">Normalan</option>
                                    <option value="urgent">Hitan</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Footer -->
                <div class="modal-footer flex justify-end gap-3">
                    <button type="button" @click="showAddModal = false" class="btn-cancel">
                        Otkazi
                    </button>
                    <button type="submit" @click="submitNewTicket()" class="btn-submit">
                        Sacuvaj nalog
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Collect Modal -->
    <div x-show="showCollectModal" x-cloak
         class="fixed inset-0 z-50 overflow-y-auto"
         @keydown.escape.window="showCollectModal = false">
        <div class="flex min-h-screen items-center justify-center p-4">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="showCollectModal = false"></div>
            <div class="relative bg-gradient-to-br from-purple-900 to-purple-950 rounded-lg shadow-xl max-w-md w-full p-6 text-white">
                <h3 class="text-lg font-bold mb-4">Naplata naloga</h3>

                <template x-if="selectedTicket">
                    <div>
                        <div class="bg-white/10 rounded-lg p-3 mb-4">
                            <div class="text-sm opacity-80">Nalog</div>
                            <div class="font-bold" x-text="selectedTicket.ticket_number_formatted"></div>
                            <div class="text-sm mt-1" x-text="selectedTicket.customer_name"></div>
                            <div class="text-sm opacity-80" x-text="selectedTicket.brand + ' ' + selectedTicket.model"></div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-1">Konacna cena</label>
                            <div class="flex gap-2">
                                <input type="number" x-model="collectData.final_price"
                                       class="flex-1 rounded-md bg-white/10 border-white/20 text-white placeholder-white/50">
                                <select x-model="collectData.currency"
                                        class="w-24 rounded-md bg-white/10 border-white/20 text-white">
                                    <option value="RSD">RSD</option>
                                    <option value="EUR">EUR</option>
                                    <option value="USD">USD</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-1">Nacin placanja</label>
                            <select x-model="collectData.payment_method"
                                    class="w-full rounded-md bg-white/10 border-white/20 text-white">
                                <option value="CASH">Gotovina</option>
                                <option value="CARD">Kartica</option>
                                <option value="TRANSFER">Transfer</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-1">Preuzeo</label>
                            <input type="text" x-model="collectData.owner_collect"
                                   :placeholder="selectedTicket.customer_name"
                                   class="w-full rounded-md bg-white/10 border-white/20 text-white placeholder-white/50">
                        </div>

                        <div class="flex justify-end gap-2 mt-6">
                            <button @click="showCollectModal = false"
                                    class="px-4 py-2 rounded-md bg-white/10 hover:bg-white/20">
                                Otkazi
                            </button>
                            <button @click="collectTicket()"
                                    class="px-4 py-2 rounded-md bg-green-600 hover:bg-green-700 font-medium">
                                Naplati
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- Notify Modal -->
    <div x-show="showNotifyModal" x-cloak
         class="fixed inset-0 z-50 overflow-y-auto"
         @keydown.escape.window="showNotifyModal = false">
        <div class="flex min-h-screen items-center justify-center p-4">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="showNotifyModal = false"></div>
            <div class="relative bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Obavesti kupca</h3>

                <template x-if="selectedTicket">
                    <div>
                        <div class="bg-gray-50 rounded-lg p-3 mb-4">
                            <div class="text-sm text-gray-500">Nalog</div>
                            <div class="font-bold text-gray-900" x-text="selectedTicket.ticket_number_formatted"></div>
                            <div class="text-sm text-gray-700" x-text="selectedTicket.customer_name"></div>
                            <div class="text-sm text-gray-500" x-text="selectedTicket.customer_phone"></div>
                        </div>

                        <template x-if="selectedTicket.notification_count > 0">
                            <div class="bg-orange-50 border border-orange-200 rounded-lg p-3 mb-4">
                                <div class="flex items-center gap-2">
                                    <svg class="w-5 h-5 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                    </svg>
                                    <span class="text-sm text-orange-700">
                                        Vec <span x-text="selectedTicket.notification_count" class="font-bold"></span> pokusaja kontakta
                                    </span>
                                </div>
                                <template x-if="selectedTicket.notification_count >= 4">
                                    <p class="text-xs text-orange-600 mt-2">
                                        Moze se otpisati nakon ovog poziva.
                                    </p>
                                </template>
                            </div>
                        </template>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Napomena o pozivu</label>
                            <textarea x-model="notifyData.comment" rows="3"
                                      placeholder="Sta je kupac rekao..."
                                      class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"></textarea>
                        </div>

                        <div class="mb-4">
                            <label class="flex items-center">
                                <input type="checkbox" x-model="notifyData.contact_successful"
                                       class="rounded border-gray-300 text-primary-600">
                                <span class="ml-2 text-sm text-gray-700">Uspesan kontakt</span>
                            </label>
                        </div>

                        <div class="flex justify-end gap-2 mt-6">
                            <button @click="showNotifyModal = false"
                                    class="px-4 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50">
                                Otkazi
                            </button>
                            <template x-if="selectedTicket.notification_count >= 4">
                                <button @click="writeOffTicket()"
                                        class="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700">
                                    Otpisi
                                </button>
                            </template>
                            <button @click="notifyCustomer()"
                                    class="px-4 py-2 rounded-md bg-purple-600 text-white hover:bg-purple-700">
                                Ubelezi poziv
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>

<script>
function ticketsPage() {
    return {
        openTickets: [],
        pendingTickets: [],
        locations: [],
        stats: {},
        loading: true,
        showWrittenOff: false,

        filters: {
            search: '',
            location_id: ''
        },

        statusLabels: {
            'RECEIVED': 'Primljeno',
            'DIAGNOSED': 'Dijagnostifikovano',
            'IN_PROGRESS': 'U obradi',
            'WAITING_PARTS': 'Ceka delove',
            'READY': 'Spremno',
            'DELIVERED': 'Isporuceno',
            'CANCELLED': 'Otkazano'
        },

        // Modals
        showAddModal: false,
        showCollectModal: false,
        showNotifyModal: false,
        selectedTicket: null,

        // New ticket form
        newTicket: {
            customer_name: '',
            customer_phone: '',
            customer_email: '',
            customer_company_name: '',
            service_section: 'Telefoni',
            brand: '',
            model: '',
            imei: '',
            problem_description: '',
            device_condition_grade: '',
            device_condition_notes: '',
            device_not_working: false,
            estimated_price: '',
            currency: 'RSD',
            location_id: '',
            priority: 'normal'
        },

        // Category-specific problem options (Dolce Vita style)
        PROBLEM_CATEGORIES: {
            Telefoni: [
                { id: 'zamena_ekrana', label: 'Zamena ekrana', icon: 'M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z' },
                { id: 'zamena_baterije', label: 'Zamena baterije', icon: 'M17 6h-2V5a1 1 0 00-1-1H10a1 1 0 00-1 1v1H7a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V8a2 2 0 00-2-2z' },
                { id: 'zamena_punjenja', label: 'Zamena punjenja', icon: 'M13 10V3L4 14h7v7l9-11h-7z' },
                { id: 'zamena_zvucnika', label: 'Zamena zvucnika', icon: 'M15.536 8.464a5 5 0 010 7.072M12 6.5v11M18.364 5.636a9 9 0 010 12.728M9.586 9.586L6.707 6.707A1 1 0 005 7.414V16.586a1 1 0 001.707.707l2.879-2.879' },
                { id: 'zamena_slusalice', label: 'Zamena slusalice', icon: 'M3 18v-6a9 9 0 0118 0v6M21 19a2 2 0 01-2 2h-1a2 2 0 01-2-2v-3a2 2 0 012-2h3zM3 19a2 2 0 002 2h1a2 2 0 002-2v-3a2 2 0 00-2-2H3z' },
                { id: 'zamena_mikrofona', label: 'Zamena mikrofona', icon: 'M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z' },
                { id: 'zamena_kamere_zadnje', label: 'Zadnja kamera', icon: 'M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z M15 13a3 3 0 11-6 0 3 3 0 016 0z' },
                { id: 'zamena_kamere_prednje', label: 'Prednja kamera', icon: 'M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z M15 13a3 3 0 11-6 0 3 3 0 016 0z' },
                { id: 'zamena_konektora', label: 'Zamena konektora', icon: 'M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101' },
                { id: 'zamena_vibro', label: 'Vibro motor', icon: 'M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9' },
                { id: 'zamena_dugmadi', label: 'Zamena dugmadi', icon: 'M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122' },
                { id: 'otkljucavanje', label: 'Otkljucavanje', icon: 'M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z' },
                { id: 'prebacivanje', label: 'Prebacivanje podataka', icon: 'M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4' },
                { id: 'prebacivanje_broken', label: 'Iz polomljenog', icon: 'M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636' },
                { id: 'ciscenje_vode', label: 'Ciscenje od vode', icon: 'M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z' },
                { id: 'ciscenje_virusa', label: 'Ciscenje virusa', icon: 'M12 14l9-5-9-5-9 5 9 5zm0 7l9-5-9-5-9 5 9 5z' },
                { id: 'dijagnostika', label: 'Dijagnostika', icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' }
            ],
            Tableti: [
                { id: 'zamena_ekrana', label: 'Zamena ekrana', icon: 'M12 18h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z' },
                { id: 'zamena_baterije', label: 'Zamena baterije', icon: 'M17 6h-2V5a1 1 0 00-1-1H10a1 1 0 00-1 1v1H7a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V8a2 2 0 00-2-2z' },
                { id: 'zamena_punjenja', label: 'Zamena punjenja', icon: 'M13 10V3L4 14h7v7l9-11h-7z' },
                { id: 'zamena_zvucnika', label: 'Zamena zvucnika', icon: 'M15.536 8.464a5 5 0 010 7.072M12 6.5v11' },
                { id: 'otkljucavanje', label: 'Otkljucavanje', icon: 'M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z' },
                { id: 'prebacivanje', label: 'Prebacivanje podataka', icon: 'M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4' },
                { id: 'ciscenje_virusa', label: 'Ciscenje virusa', icon: 'M12 14l9-5-9-5-9 5 9 5zm0 7l9-5-9-5-9 5 9 5z' },
                { id: 'dijagnostika', label: 'Dijagnostika', icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' }
            ],
            Racunari: [
                { id: 'zamena_laptop_ekrana', label: 'Zamena ekrana', icon: 'M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z' },
                { id: 'zamena_laptop_baterije', label: 'Zamena baterije', icon: 'M17 6h-2V5a1 1 0 00-1-1H10a1 1 0 00-1 1v1H7a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V8a2 2 0 00-2-2z' },
                { id: 'zamena_tastature', label: 'Zamena tastature', icon: 'M4 6h16M4 10h16M4 14h16M4 18h16' },
                { id: 'zamena_diska', label: 'SSD/HDD', icon: 'M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4' },
                { id: 'zamena_rama', label: 'RAM', icon: 'M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2z' },
                { id: 'zamena_napajanja', label: 'Napajanje', icon: 'M13 10V3L4 14h7v7l9-11h-7z' },
                { id: 'reinstalacija_sistema', label: 'Reinstalacija', icon: 'M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15' },
                { id: 'ciscenje_virusa', label: 'Ciscenje virusa', icon: 'M12 14l9-5-9-5-9 5 9 5zm0 7l9-5-9-5-9 5 9 5z' },
                { id: 'prebacivanje', label: 'Prebacivanje', icon: 'M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4' },
                { id: 'dijagnostika', label: 'Dijagnostika', icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' }
            ],
            Konzole: [
                { id: 'zamena_lasera', label: 'Zamena lasera', icon: 'M15 12a3 3 0 11-6 0 3 3 0 016 0z' },
                { id: 'zamena_hdmi', label: 'HDMI port', icon: 'M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z' },
                { id: 'zamena_punjenja', label: 'Punjenje', icon: 'M13 10V3L4 14h7v7l9-11h-7z' },
                { id: 'ciscenje', label: 'Ciscenje/Servis', icon: 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z' },
                { id: 'dijagnostika', label: 'Dijagnostika', icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' }
            ],
            Ostalo: [
                { id: 'dijagnostika', label: 'Dijagnostika', icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' },
                { id: 'ostalo', label: 'Ostalo', icon: 'M12 6v6m0 0v6m0-6h6m-6 0H6' }
            ]
        },
        selectedProblems: [],
        lastAutoGeneratedComment: '',

        collectData: {
            final_price: 0,
            currency: 'RSD',
            payment_method: 'CASH',
            owner_collect: ''
        },

        notifyData: {
            comment: '',
            contact_successful: false
        },

        // Get problems for current category
        get currentProblems() {
            return this.PROBLEM_CATEGORIES[this.newTicket.service_section] || this.PROBLEM_CATEGORIES['Ostalo'];
        },

        // Toggle problem selection and auto-fill description
        toggleProblem(problemId) {
            const idx = this.selectedProblems.indexOf(problemId);
            if (idx > -1) {
                this.selectedProblems.splice(idx, 1);
            } else {
                this.selectedProblems.push(problemId);
            }
            this.updateProblemDescription();
        },

        // Auto-fill problem description based on selected problems
        updateProblemDescription() {
            const selectedLabels = this.selectedProblems.map(id => {
                const problem = this.currentProblems.find(p => p.id === id);
                return problem ? problem.label : '';
            }).filter(Boolean);

            const newAutoComment = selectedLabels.join(', ');

            // Only update if field is empty or contains previous auto-generated text
            if (this.newTicket.problem_description === '' ||
                this.newTicket.problem_description === this.lastAutoGeneratedComment) {
                this.newTicket.problem_description = newAutoComment;
                this.lastAutoGeneratedComment = newAutoComment;
            }
        },

        // Reset problems when category changes
        onCategoryChange() {
            this.selectedProblems = [];
            this.lastAutoGeneratedComment = '';
            if (this.newTicket.problem_description === this.lastAutoGeneratedComment) {
                this.newTicket.problem_description = '';
            }
        },

        async init() {
            await Promise.all([
                this.loadStats(),
                this.loadAllTickets(),
                this.loadLocations()
            ]);
        },

        async loadStats() {
            try {
                const response = await api('/api/v1/tickets/stats');
                if (response.ok) {
                    this.stats = await response.json();
                }
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        },

        async loadLocations() {
            try {
                const response = await api('/api/v1/auth/me');
                if (response.ok) {
                    const data = await response.json();
                    this.locations = data.locations || [];
                    if (this.locations.length > 0 && !this.newTicket.location_id) {
                        this.newTicket.location_id = this.locations[0].id;
                    }
                }
            } catch (e) {
                console.error('Failed to load locations:', e);
            }
        },

        async loadAllTickets() {
            this.loading = true;
            try {
                const params = new URLSearchParams({ per_page: 100 });
                if (this.filters.search) params.append('search', this.filters.search);
                if (this.filters.location_id) params.append('location_id', this.filters.location_id);

                const response = await api('/api/v1/tickets?' + params.toString());
                if (response.ok) {
                    const data = await response.json();
                    let tickets = data.items || [];

                    // Split into two categories
                    // Open tickets: not READY, not DELIVERED, not CANCELLED, not written off
                    this.openTickets = tickets.filter(t =>
                        !['READY', 'DELIVERED', 'CANCELLED'].includes(t.status) &&
                        !t.is_written_off
                    );

                    // Pending payment: READY, not collected, optionally show written off
                    this.pendingTickets = tickets.filter(t =>
                        t.status === 'READY' &&
                        !t.is_paid &&
                        (this.showWrittenOff || !t.is_written_off)
                    );

                    // Calculate waiting days for pending tickets
                    this.pendingTickets.forEach(t => {
                        if (t.closed_at) {
                            const closedDate = new Date(t.closed_at);
                            const now = new Date();
                            t.waiting_days = Math.floor((now - closedDate) / (1000 * 60 * 60 * 24));
                        } else {
                            t.waiting_days = 0;
                        }
                    });
                }
            } catch (e) {
                console.error('Failed to load tickets:', e);
                showToast('Greska pri ucitavanju naloga', 'error');
            } finally {
                this.loading = false;
            }
        },

        setFilter(type) {
            // This is for KPI card clicks - can add specific behavior if needed
            if (type === 'ready') {
                // Scroll to pending table
                document.querySelector('.table-section-header[style*="78350f"]')?.scrollIntoView({ behavior: 'smooth' });
            }
        },

        toggleProblem(problemId) {
            const idx = this.selectedProblems.indexOf(problemId);
            if (idx > -1) {
                this.selectedProblems.splice(idx, 1);
            } else {
                this.selectedProblems.push(problemId);
            }
        },

        getDurationClass(ticket) {
            if (!ticket.duration_display) return 'green';
            const match = ticket.duration_display.match(/(\d+)d/);
            if (match) {
                const days = parseInt(match[1]);
                if (days > 7) return 'red';
                if (days > 3) return 'yellow';
            }
            return 'green';
        },

        getDurationPercent(ticket) {
            if (!ticket.duration_display) return 10;
            const match = ticket.duration_display.match(/(\d+)d/);
            if (match) {
                const days = parseInt(match[1]);
                return Math.min(100, days * 10);
            }
            return 20;
        },

        getWaitingClass(ticket) {
            const days = ticket.waiting_days || 0;
            if (days > 15) return 'red';
            if (days > 7) return 'yellow';
            return 'green';
        },

        getWaitingPercent(ticket) {
            const days = ticket.waiting_days || 0;
            return Math.min(100, (days / 30) * 100);
        },

        formatPrice(price) {
            if (!price) return '-';
            return new Intl.NumberFormat('sr-RS').format(price);
        },

        formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('sr-Latn-RS');
        },

        viewTicket(ticket) {
            window.location.href = `/tickets/${ticket.id}`;
        },

        async submitNewTicket() {
            try {
                const payload = {
                    ...this.newTicket,
                    problem_areas: this.selectedProblems.join(',')
                };

                const response = await api('/api/v1/tickets', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    showToast('Nalog uspesno kreiran', 'success');
                    this.showAddModal = false;
                    this.resetNewTicket();
                    this.loadAllTickets();
                    this.loadStats();
                } else {
                    const data = await response.json();
                    showToast(data.message || 'Greska pri kreiranju naloga', 'error');
                }
            } catch (e) {
                console.error('Failed to create ticket:', e);
                showToast('Greska pri kreiranju naloga', 'error');
            }
        },

        resetNewTicket() {
            this.newTicket = {
                customer_name: '',
                customer_phone: '',
                customer_email: '',
                customer_company_name: '',
                service_section: 'Telefoni',
                brand: '',
                model: '',
                imei: '',
                problem_description: '',
                device_condition_grade: '',
                device_condition_notes: '',
                device_not_working: false,
                estimated_price: '',
                currency: 'RSD',
                location_id: this.locations.length > 0 ? this.locations[0].id : '',
                priority: 'normal'
            };
            this.selectedProblems = [];
        },

        async finishTicket(ticket) {
            if (!confirm('Zavrsi nalog i oznaci kao SPREMNO?')) return;

            try {
                const response = await api(`/api/v1/tickets/${ticket.id}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ status: 'READY' })
                });

                if (response.ok) {
                    showToast('Nalog oznacen kao spreman', 'success');
                    this.loadAllTickets();
                    this.loadStats();
                }
            } catch (e) {
                showToast('Greska pri azuriranju naloga', 'error');
            }
        },

        async rejectTicket(ticket) {
            if (!confirm('Da li ste sigurni da zelite da odbijete ovaj nalog?')) return;

            try {
                const response = await api(`/api/v1/tickets/${ticket.id}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ status: 'CANCELLED' })
                });

                if (response.ok) {
                    showToast('Nalog odbijen', 'success');
                    this.loadAllTickets();
                    this.loadStats();
                }
            } catch (e) {
                showToast('Greska pri odbijanju naloga', 'error');
            }
        },

        openCollectModal(ticket) {
            this.selectedTicket = ticket;
            this.collectData = {
                final_price: ticket.final_price || ticket.estimated_price || 0,
                currency: ticket.currency || 'RSD',
                payment_method: 'CASH',
                owner_collect: ''
            };
            this.showCollectModal = true;
        },

        async collectTicket() {
            try {
                const response = await api(`/api/v1/tickets/${this.selectedTicket.id}/collect`, {
                    method: 'POST',
                    body: JSON.stringify(this.collectData)
                });

                if (response.ok) {
                    showToast('Nalog uspesno naplacen', 'success');
                    this.showCollectModal = false;
                    this.loadAllTickets();
                    this.loadStats();
                } else {
                    const data = await response.json();
                    showToast(data.message || 'Greska', 'error');
                }
            } catch (e) {
                showToast('Greska pri naplati', 'error');
            }
        },

        openNotifyModal(ticket) {
            this.selectedTicket = ticket;
            this.notifyData = {
                comment: '',
                contact_successful: false
            };
            this.showNotifyModal = true;
        },

        async notifyCustomer() {
            try {
                const response = await api(`/api/v1/tickets/${this.selectedTicket.id}/notify`, {
                    method: 'POST',
                    body: JSON.stringify(this.notifyData)
                });

                if (response.ok) {
                    showToast('Poziv ubelezen', 'success');
                    this.showNotifyModal = false;
                    this.loadAllTickets();
                } else {
                    const data = await response.json();
                    showToast(data.message || 'Greska', 'error');
                }
            } catch (e) {
                showToast('Greska pri belezenju poziva', 'error');
            }
        },

        async writeOffTicket() {
            if (!confirm('Da li ste sigurni da zelite da otpisete ovaj nalog?')) return;

            try {
                const response = await api(`/api/v1/tickets/${this.selectedTicket.id}/write-off`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showToast('Nalog otpisan', 'success');
                    this.showNotifyModal = false;
                    this.loadAllTickets();
                    this.loadStats();
                } else {
                    const data = await response.json();
                    showToast(data.message || 'Greska', 'error');
                }
            } catch (e) {
                showToast('Greska pri otpisu', 'error');
            }
        },

        async printTicket(ticket) {
            window.open(`/tickets/${ticket.id}/print`, '_blank');
        }
    }
}
</script>
{% endblock %}
