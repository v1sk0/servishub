{% extends "layouts/tenant.html" %}

{% block title %}Servisni nalozi - ServisHub{% endblock %}

{% block head %}
<style>
    /* Dolce Vita glassmorphic style */
    .glass-card {
        background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
    }

    .kpi-card {
        position: relative;
        overflow: hidden;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    }
    .kpi-card::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
    }
    .kpi-card.blue::before { background: linear-gradient(180deg, #3b82f6, #1d4ed8); }
    .kpi-card.green::before { background: linear-gradient(180deg, #22c55e, #16a34a); }
    .kpi-card.yellow::before { background: linear-gradient(180deg, #eab308, #ca8a04); }
    .kpi-card.red::before { background: linear-gradient(180deg, #ef4444, #dc2626); }
    .kpi-card.purple::before { background: linear-gradient(180deg, #a855f7, #9333ea); }

    /* Duration progress bar */
    .duration-bar {
        height: 4px;
        border-radius: 2px;
        background: #e5e7eb;
        overflow: hidden;
    }
    .duration-bar-fill {
        height: 100%;
        border-radius: 2px;
        transition: width 0.3s ease;
    }
    .duration-bar-fill.green { background: linear-gradient(90deg, #22c55e, #16a34a); }
    .duration-bar-fill.yellow { background: linear-gradient(90deg, #eab308, #f59e0b); }
    .duration-bar-fill.red { background: linear-gradient(90deg, #ef4444, #dc2626); }

    /* Strobe animation for overdue */
    @keyframes strobe {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    .strobe-alert {
        animation: strobe 1s ease-in-out infinite;
    }

    /* Action buttons */
    .action-btn {
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 500;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }
    .action-btn:hover {
        transform: scale(1.05);
    }
    .action-btn-primary { background: #3b82f6; color: white; }
    .action-btn-success { background: #22c55e; color: white; }
    .action-btn-warning { background: #f59e0b; color: white; }
    .action-btn-danger { background: #ef4444; color: white; }
    .action-btn-purple { background: #9333ea; color: white; }
    .action-btn-outline {
        background: transparent;
        border: 1px solid #d1d5db;
        color: #374151;
    }
    .action-btn-outline:hover {
        background: #f3f4f6;
    }

    /* Written off badge */
    .written-off-badge {
        background: linear-gradient(135deg, #fee2e2, #fecaca);
        color: #991b1b;
        padding: 0.125rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
    }
</style>
{% endblock %}

{% block page_content %}
<div x-data="ticketsPage()" x-init="init()">
    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between mb-6">
        <div class="min-w-0 flex-1">
            <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl sm:tracking-tight">
                Servisni nalozi
            </h2>
        </div>
        <div class="mt-4 flex gap-2 md:ml-4 md:mt-0">
            <a href="/tickets/warranties"
               class="inline-flex items-center rounded-md bg-purple-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-purple-500">
                <svg class="-ml-0.5 mr-1.5 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
                Garancije
            </a>
            <button @click="showAddModal = true"
                    class="inline-flex items-center rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500">
                <svg class="-ml-0.5 mr-1.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                </svg>
                Novi nalog
            </button>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-2 gap-4 sm:grid-cols-3 lg:grid-cols-5 mb-6">
        <!-- Otvoreni nalozi -->
        <div class="kpi-card blue bg-white rounded-lg shadow p-4 cursor-pointer" @click="setFilter('open')">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Otvoreni</p>
                    <p class="mt-1 text-2xl font-bold text-gray-900" x-text="stats.open_tickets || 0"></p>
                </div>
                <div class="p-2 bg-blue-100 rounded-lg">
                    <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                </div>
            </div>
        </div>

        <!-- Zavrseni (ovaj mesec) -->
        <div class="kpi-card green bg-white rounded-lg shadow p-4 cursor-pointer" @click="setFilter('closed')">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Zavrseni</p>
                    <p class="mt-1 text-2xl font-bold text-gray-900" x-text="stats.closed_tickets || 0"></p>
                </div>
                <div class="p-2 bg-green-100 rounded-lg">
                    <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
            </div>
        </div>

        <!-- Za naplatu -->
        <div class="kpi-card yellow bg-white rounded-lg shadow p-4 cursor-pointer" @click="setFilter('ready')">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Za naplatu</p>
                    <p class="mt-1 text-2xl font-bold text-gray-900" x-text="stats.ready_tickets || 0"></p>
                </div>
                <div class="p-2 bg-yellow-100 rounded-lg">
                    <svg class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                </div>
            </div>
        </div>

        <!-- Aktivne garancije -->
        <div class="kpi-card purple bg-white rounded-lg shadow p-4 cursor-pointer" @click="window.location.href='/tickets/warranties'">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Garancije</p>
                    <p class="mt-1 text-2xl font-bold text-gray-900" x-text="stats.active_warranties || 0"></p>
                </div>
                <div class="p-2 bg-purple-100 rounded-lg">
                    <svg class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                </div>
            </div>
        </div>

        <!-- Danas -->
        <div class="kpi-card red bg-white rounded-lg shadow p-4 cursor-pointer" @click="setFilter('today')">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Danas</p>
                    <p class="mt-1 text-2xl font-bold text-gray-900" x-text="stats.today_tickets || 0"></p>
                </div>
                <div class="p-2 bg-red-100 rounded-lg">
                    <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white shadow rounded-lg mb-6 p-4">
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-5">
            <!-- Search -->
            <div class="lg:col-span-2">
                <input type="text" x-model="filters.search" @input.debounce.300ms="loadTickets()"
                       placeholder="Pretrazi po broju, kupcu, IMEI..."
                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
            </div>

            <!-- Status filter -->
            <div>
                <select x-model="filters.status" @change="loadTickets()"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                    <option value="">Svi statusi</option>
                    <option value="RECEIVED">Primljeno</option>
                    <option value="DIAGNOSED">Dijagnostifikovano</option>
                    <option value="IN_PROGRESS">U obradi</option>
                    <option value="WAITING_PARTS">Ceka delove</option>
                    <option value="READY">Spremno</option>
                    <option value="DELIVERED">Isporuceno</option>
                </select>
            </div>

            <!-- Location filter -->
            <div>
                <select x-model="filters.location_id" @change="loadTickets()"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                    <option value="">Sve lokacije</option>
                    <template x-for="loc in locations" :key="loc.id">
                        <option :value="loc.id" x-text="loc.name"></option>
                    </template>
                </select>
            </div>

            <!-- Show written off toggle -->
            <div class="flex items-center">
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" x-model="showWrittenOff" @change="loadTickets()"
                           class="rounded border-gray-300 text-primary-600 shadow-sm focus:border-primary-300 focus:ring focus:ring-primary-200 focus:ring-opacity-50">
                    <span class="ml-2 text-sm text-gray-600">Prikazi otpisane</span>
                </label>
            </div>
        </div>
    </div>

    <!-- Tickets Table -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">#</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kupac</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Uredjaj</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trajanje</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cena</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Akcije</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="ticket in tickets" :key="ticket.id">
                        <tr class="hover:bg-gray-50" :class="{'bg-red-50': ticket.is_written_off}">
                            <!-- Broj naloga -->
                            <td class="px-4 py-3 whitespace-nowrap">
                                <div class="text-sm font-bold text-primary-600" x-text="ticket.ticket_number_formatted"></div>
                                <div class="text-xs text-gray-500" x-text="formatDate(ticket.created_at)"></div>
                            </td>

                            <!-- Kupac -->
                            <td class="px-4 py-3">
                                <div class="text-sm font-medium text-gray-900" x-text="ticket.customer_name"></div>
                                <div class="text-xs text-gray-500" x-text="ticket.customer_phone || '-'"></div>
                                <template x-if="ticket.notification_count > 0">
                                    <div class="text-xs text-orange-600 mt-1">
                                        <span x-text="'Pozivi: ' + ticket.notification_count"></span>
                                    </div>
                                </template>
                            </td>

                            <!-- Uredjaj -->
                            <td class="px-4 py-3">
                                <div class="text-sm text-gray-900">
                                    <span x-text="ticket.brand"></span> <span x-text="ticket.model"></span>
                                </div>
                                <div class="text-xs text-gray-500">
                                    <span x-text="ticket.service_section || ticket.device_type || '-'"></span>
                                    <template x-if="ticket.device_condition_grade">
                                        <span class="ml-1 px-1 rounded text-xs"
                                              :class="{
                                                  'bg-green-100 text-green-800': ticket.device_condition_grade === 'A',
                                                  'bg-yellow-100 text-yellow-800': ticket.device_condition_grade === 'B',
                                                  'bg-red-100 text-red-800': ticket.device_condition_grade === 'C'
                                              }"
                                              x-text="ticket.device_condition_grade"></span>
                                    </template>
                                </div>
                            </td>

                            <!-- Status -->
                            <td class="px-4 py-3 whitespace-nowrap">
                                <template x-if="ticket.is_written_off">
                                    <span class="written-off-badge">Otpisano</span>
                                </template>
                                <template x-if="!ticket.is_written_off">
                                    <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full"
                                          :class="getStatusClass(ticket.status)"
                                          x-text="statusLabels[ticket.status]"></span>
                                </template>
                                <template x-if="ticket.is_paid && !ticket.is_written_off">
                                    <span class="block text-xs text-green-600 mt-1">Naplaceno</span>
                                </template>
                            </td>

                            <!-- Trajanje -->
                            <td class="px-4 py-3 whitespace-nowrap">
                                <div class="text-sm text-gray-900" x-text="ticket.duration_display || '-'"></div>
                                <div class="duration-bar mt-1" style="width: 60px;">
                                    <div class="duration-bar-fill"
                                         :class="getDurationClass(ticket)"
                                         :style="'width: ' + getDurationPercent(ticket) + '%'"></div>
                                </div>
                            </td>

                            <!-- Cena -->
                            <td class="px-4 py-3 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">
                                    <span x-text="formatPrice(ticket.final_price || ticket.estimated_price)"></span>
                                    <span class="text-gray-500 text-xs" x-text="ticket.currency || 'RSD'"></span>
                                </div>
                            </td>

                            <!-- Akcije -->
                            <td class="px-4 py-3 whitespace-nowrap text-right">
                                <div class="flex justify-end gap-1 flex-wrap">
                                    <!-- Zavrsi (ako nije READY/DELIVERED) -->
                                    <template x-if="!['READY', 'DELIVERED', 'CANCELLED'].includes(ticket.status) && !ticket.is_written_off">
                                        <button @click.stop="finishTicket(ticket)"
                                                class="action-btn action-btn-success" title="Zavrsi">
                                            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                            </svg>
                                        </button>
                                    </template>

                                    <!-- Naplati (ako je READY i nije naplaceno) -->
                                    <template x-if="ticket.status === 'READY' && !ticket.is_paid && !ticket.is_written_off">
                                        <button @click.stop="openCollectModal(ticket)"
                                                class="action-btn action-btn-warning" title="Naplati">
                                            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                                            </svg>
                                        </button>
                                    </template>

                                    <!-- Obavesti (ako je READY i nije preuzeto) -->
                                    <template x-if="ticket.status === 'READY' && !ticket.is_collected && !ticket.is_written_off">
                                        <button @click.stop="openNotifyModal(ticket)"
                                                class="action-btn action-btn-purple"
                                                :class="{'strobe-alert': ticket.notification_count >= 3}"
                                                title="Obavesti kupca">
                                            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                            </svg>
                                            <span x-show="ticket.notification_count > 0" x-text="ticket.notification_count" class="text-xs"></span>
                                        </button>
                                    </template>

                                    <!-- Stampaj -->
                                    <button @click.stop="printTicket(ticket)"
                                            class="action-btn action-btn-outline" title="Stampaj">
                                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                                        </svg>
                                    </button>

                                    <!-- Detalji -->
                                    <a :href="'/tickets/' + ticket.id"
                                       class="action-btn action-btn-primary" title="Detalji">
                                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                        </svg>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    </template>

                    <!-- Empty state -->
                    <tr x-show="!loading && tickets.length === 0">
                        <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">Nema naloga</h3>
                            <p class="mt-1 text-sm text-gray-500">Kreirajte prvi servisni nalog.</p>
                        </td>
                    </tr>

                    <!-- Loading -->
                    <tr x-show="loading">
                        <td colspan="7" class="px-6 py-12 text-center">
                            <svg class="animate-spin mx-auto h-8 w-8 text-primary-600" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200" x-show="totalPages > 1">
            <div class="text-sm text-gray-700">
                Prikazano <span class="font-medium" x-text="(currentPage - 1) * perPage + 1"></span> -
                <span class="font-medium" x-text="Math.min(currentPage * perPage, total)"></span> od
                <span class="font-medium" x-text="total"></span>
            </div>
            <div class="flex gap-1">
                <button @click="prevPage()" :disabled="currentPage === 1"
                        class="px-3 py-1 border rounded text-sm disabled:opacity-50">Prethodna</button>
                <span class="px-3 py-1 text-sm" x-text="currentPage + ' / ' + totalPages"></span>
                <button @click="nextPage()" :disabled="currentPage === totalPages"
                        class="px-3 py-1 border rounded text-sm disabled:opacity-50">Sledeca</button>
            </div>
        </div>
    </div>

    <!-- Collect Modal -->
    <div x-show="showCollectModal" x-cloak
         class="fixed inset-0 z-50 overflow-y-auto"
         @keydown.escape.window="showCollectModal = false">
        <div class="flex min-h-screen items-center justify-center p-4">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="showCollectModal = false"></div>
            <div class="relative bg-gradient-to-br from-purple-900 to-purple-950 rounded-lg shadow-xl max-w-md w-full p-6 text-white">
                <h3 class="text-lg font-bold mb-4">Naplata naloga</h3>

                <template x-if="selectedTicket">
                    <div>
                        <div class="bg-white/10 rounded-lg p-3 mb-4">
                            <div class="text-sm opacity-80">Nalog</div>
                            <div class="font-bold" x-text="selectedTicket.ticket_number_formatted"></div>
                            <div class="text-sm mt-1" x-text="selectedTicket.customer_name"></div>
                            <div class="text-sm opacity-80" x-text="selectedTicket.brand + ' ' + selectedTicket.model"></div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-1">Konacna cena</label>
                            <div class="flex gap-2">
                                <input type="number" x-model="collectData.final_price"
                                       class="flex-1 rounded-md bg-white/10 border-white/20 text-white placeholder-white/50">
                                <select x-model="collectData.currency"
                                        class="w-24 rounded-md bg-white/10 border-white/20 text-white">
                                    <option value="RSD">RSD</option>
                                    <option value="EUR">EUR</option>
                                    <option value="USD">USD</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-1">Nacin placanja</label>
                            <select x-model="collectData.payment_method"
                                    class="w-full rounded-md bg-white/10 border-white/20 text-white">
                                <option value="CASH">Gotovina</option>
                                <option value="CARD">Kartica</option>
                                <option value="TRANSFER">Transfer</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-1">Preuzeo</label>
                            <input type="text" x-model="collectData.owner_collect"
                                   :placeholder="selectedTicket.customer_name"
                                   class="w-full rounded-md bg-white/10 border-white/20 text-white placeholder-white/50">
                        </div>

                        <div class="flex justify-end gap-2 mt-6">
                            <button @click="showCollectModal = false"
                                    class="px-4 py-2 rounded-md bg-white/10 hover:bg-white/20">
                                Otkazi
                            </button>
                            <button @click="collectTicket()"
                                    class="px-4 py-2 rounded-md bg-green-600 hover:bg-green-700 font-medium">
                                Naplati
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- Notify Modal -->
    <div x-show="showNotifyModal" x-cloak
         class="fixed inset-0 z-50 overflow-y-auto"
         @keydown.escape.window="showNotifyModal = false">
        <div class="flex min-h-screen items-center justify-center p-4">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="showNotifyModal = false"></div>
            <div class="relative bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Obavesti kupca</h3>

                <template x-if="selectedTicket">
                    <div>
                        <div class="bg-gray-50 rounded-lg p-3 mb-4">
                            <div class="text-sm text-gray-500">Nalog</div>
                            <div class="font-bold text-gray-900" x-text="selectedTicket.ticket_number_formatted"></div>
                            <div class="text-sm text-gray-700" x-text="selectedTicket.customer_name"></div>
                            <div class="text-sm text-gray-500" x-text="selectedTicket.customer_phone"></div>
                        </div>

                        <template x-if="selectedTicket.notification_count > 0">
                            <div class="bg-orange-50 border border-orange-200 rounded-lg p-3 mb-4">
                                <div class="flex items-center gap-2">
                                    <svg class="w-5 h-5 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                    </svg>
                                    <span class="text-sm text-orange-700">
                                        Vec <span x-text="selectedTicket.notification_count" class="font-bold"></span> pokusaja kontakta
                                    </span>
                                </div>
                                <template x-if="selectedTicket.can_write_off">
                                    <p class="text-xs text-orange-600 mt-2">
                                        Moze se otpisati nakon ovog poziva.
                                    </p>
                                </template>
                            </div>
                        </template>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Napomena o pozivu</label>
                            <textarea x-model="notifyData.comment" rows="3"
                                      placeholder="Sta je kupac rekao..."
                                      class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"></textarea>
                        </div>

                        <div class="mb-4">
                            <label class="flex items-center">
                                <input type="checkbox" x-model="notifyData.contact_successful"
                                       class="rounded border-gray-300 text-primary-600">
                                <span class="ml-2 text-sm text-gray-700">Uspesan kontakt</span>
                            </label>
                        </div>

                        <div class="flex justify-end gap-2 mt-6">
                            <button @click="showNotifyModal = false"
                                    class="px-4 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50">
                                Otkazi
                            </button>
                            <template x-if="selectedTicket.notification_count >= 4">
                                <button @click="writeOffTicket()"
                                        class="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700">
                                    Otpisi
                                </button>
                            </template>
                            <button @click="notifyCustomer()"
                                    class="px-4 py-2 rounded-md bg-purple-600 text-white hover:bg-purple-700">
                                Ubelezi poziv
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>

<script>
function ticketsPage() {
    return {
        tickets: [],
        locations: [],
        stats: {},
        loading: true,
        currentPage: 1,
        perPage: 20,
        total: 0,
        totalPages: 1,
        showWrittenOff: false,

        filters: {
            search: '',
            status: '',
            location_id: ''
        },

        statusLabels: {
            'RECEIVED': 'Primljeno',
            'DIAGNOSED': 'Dijagnostifikovano',
            'IN_PROGRESS': 'U obradi',
            'WAITING_PARTS': 'Ceka delove',
            'READY': 'Spremno',
            'DELIVERED': 'Isporuceno',
            'CANCELLED': 'Otkazano'
        },

        // Modals
        showAddModal: false,
        showCollectModal: false,
        showNotifyModal: false,
        selectedTicket: null,

        collectData: {
            final_price: 0,
            currency: 'RSD',
            payment_method: 'CASH',
            owner_collect: ''
        },

        notifyData: {
            comment: '',
            contact_successful: false
        },

        async init() {
            await Promise.all([
                this.loadStats(),
                this.loadTickets(),
                this.loadLocations()
            ]);
        },

        async loadStats() {
            try {
                const response = await api('/api/v1/tickets/stats');
                if (response.ok) {
                    this.stats = await response.json();
                }
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        },

        async loadLocations() {
            try {
                const response = await api('/api/v1/auth/me');
                if (response.ok) {
                    const data = await response.json();
                    this.locations = data.locations || [];
                }
            } catch (e) {
                console.error('Failed to load locations:', e);
            }
        },

        async loadTickets() {
            this.loading = true;
            try {
                const params = new URLSearchParams({
                    page: this.currentPage,
                    per_page: this.perPage
                });

                if (this.filters.search) params.append('search', this.filters.search);
                if (this.filters.status) params.append('status', this.filters.status);
                if (this.filters.location_id) params.append('location_id', this.filters.location_id);

                const response = await api('/api/v1/tickets?' + params.toString());
                if (response.ok) {
                    const data = await response.json();
                    let tickets = data.items || [];

                    // Filter written off
                    if (!this.showWrittenOff) {
                        tickets = tickets.filter(t => !t.is_written_off);
                    }

                    this.tickets = tickets;
                    this.total = data.total || 0;
                    this.totalPages = data.pages || 1;
                }
            } catch (e) {
                console.error('Failed to load tickets:', e);
                showToast('Greska pri ucitavanju naloga', 'error');
            } finally {
                this.loading = false;
            }
        },

        setFilter(type) {
            this.filters.status = '';
            if (type === 'open') {
                this.filters.status = '';
                // Will filter to non-delivered in backend
            } else if (type === 'closed') {
                this.filters.status = 'DELIVERED';
            } else if (type === 'ready') {
                this.filters.status = 'READY';
            } else if (type === 'today') {
                // Today filter
            }
            this.currentPage = 1;
            this.loadTickets();
        },

        getStatusClass(status) {
            const classes = {
                'RECEIVED': 'bg-yellow-100 text-yellow-800',
                'DIAGNOSED': 'bg-blue-100 text-blue-800',
                'IN_PROGRESS': 'bg-blue-100 text-blue-800',
                'WAITING_PARTS': 'bg-purple-100 text-purple-800',
                'READY': 'bg-green-100 text-green-800',
                'DELIVERED': 'bg-gray-100 text-gray-800',
                'CANCELLED': 'bg-red-100 text-red-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        },

        getDurationClass(ticket) {
            if (!ticket.duration_display) return 'green';
            const match = ticket.duration_display.match(/(\d+)d/);
            if (match) {
                const days = parseInt(match[1]);
                if (days > 7) return 'red';
                if (days > 3) return 'yellow';
            }
            return 'green';
        },

        getDurationPercent(ticket) {
            if (!ticket.duration_display) return 10;
            const match = ticket.duration_display.match(/(\d+)d/);
            if (match) {
                const days = parseInt(match[1]);
                return Math.min(100, days * 10);
            }
            return 20;
        },

        formatPrice(price) {
            if (!price) return '-';
            return new Intl.NumberFormat('sr-RS').format(price);
        },

        formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('sr-Latn-RS');
        },

        async finishTicket(ticket) {
            if (!confirm('Zavrsi nalog i oznaci kao SPREMNO?')) return;

            try {
                const response = await api(`/api/v1/tickets/${ticket.id}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ status: 'READY' })
                });

                if (response.ok) {
                    showToast('Nalog oznacen kao spreman', 'success');
                    this.loadTickets();
                    this.loadStats();
                }
            } catch (e) {
                showToast('Greska pri azuriranju naloga', 'error');
            }
        },

        openCollectModal(ticket) {
            this.selectedTicket = ticket;
            this.collectData = {
                final_price: ticket.final_price || ticket.estimated_price || 0,
                currency: ticket.currency || 'RSD',
                payment_method: 'CASH',
                owner_collect: ''
            };
            this.showCollectModal = true;
        },

        async collectTicket() {
            try {
                const response = await api(`/api/v1/tickets/${this.selectedTicket.id}/collect`, {
                    method: 'POST',
                    body: JSON.stringify(this.collectData)
                });

                if (response.ok) {
                    showToast('Nalog uspesno naplacen', 'success');
                    this.showCollectModal = false;
                    this.loadTickets();
                    this.loadStats();
                } else {
                    const data = await response.json();
                    showToast(data.message || 'Greska', 'error');
                }
            } catch (e) {
                showToast('Greska pri naplati', 'error');
            }
        },

        openNotifyModal(ticket) {
            this.selectedTicket = ticket;
            this.notifyData = {
                comment: '',
                contact_successful: false
            };
            this.showNotifyModal = true;
        },

        async notifyCustomer() {
            try {
                const response = await api(`/api/v1/tickets/${this.selectedTicket.id}/notify`, {
                    method: 'POST',
                    body: JSON.stringify(this.notifyData)
                });

                if (response.ok) {
                    const data = await response.json();
                    showToast('Poziv ubelezen', 'success');
                    this.showNotifyModal = false;
                    this.loadTickets();
                } else {
                    const data = await response.json();
                    showToast(data.message || 'Greska', 'error');
                }
            } catch (e) {
                showToast('Greska pri belezenju poziva', 'error');
            }
        },

        async writeOffTicket() {
            if (!confirm('Da li ste sigurni da zelite da otpisete ovaj nalog?')) return;

            try {
                const response = await api(`/api/v1/tickets/${this.selectedTicket.id}/write-off`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showToast('Nalog otpisan', 'success');
                    this.showNotifyModal = false;
                    this.loadTickets();
                    this.loadStats();
                } else {
                    const data = await response.json();
                    showToast(data.message || 'Greska', 'error');
                }
            } catch (e) {
                showToast('Greska pri otpisu', 'error');
            }
        },

        async printTicket(ticket) {
            window.open(`/tickets/${ticket.id}/print`, '_blank');
        },

        prevPage() {
            if (this.currentPage > 1) {
                this.currentPage--;
                this.loadTickets();
            }
        },

        nextPage() {
            if (this.currentPage < this.totalPages) {
                this.currentPage++;
                this.loadTickets();
            }
        }
    }
}
</script>
{% endblock %}
