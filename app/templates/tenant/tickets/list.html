{% extends "layouts/tenant.html" %}

{% block title %}Servisni nalozi - ServisHub{% endblock %}

{% block page_content %}
<style>
    /* ========================================
       LIGHT THEME - Tickets Page
       ======================================== */
    .page-header h2 { color: #1e293b; }
    .page-header p { color: #64748b; }

    .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        border: none;
        cursor: pointer;
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }
    .btn-secondary {
        background: #f1f5f9;
        color: #475569;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 500;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
        border: 1px solid #e2e8f0;
        text-decoration: none;
    }
    .btn-secondary:hover { background: #e2e8f0; color: #1e293b; }

    /* Light theme stat cards */
    .stat-card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.25rem;
        position: relative;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    .stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; }
    .stat-card.blue::before { background: linear-gradient(180deg, #3b82f6, #60a5fa); }
    .stat-card.green::before { background: linear-gradient(180deg, #22c55e, #4ade80); }
    .stat-card.purple::before { background: linear-gradient(180deg, #8b5cf6, #a78bfa); }
    .stat-card.yellow::before { background: linear-gradient(180deg, #eab308, #facc15); }
    .stat-card.red::before { background: linear-gradient(180deg, #ef4444, #f87171); }

    .stat-value { color: #1e293b; font-size: 1.75rem; font-weight: 700; }
    .stat-label { color: #64748b; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 0.25rem; }

    /* Light theme search */
    .search-container { position: relative; }
    .search-container svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; width: 18px; height: 18px; }
    .search-input {
        width: 100%;
        padding: 0.625rem 1rem 0.625rem 2.5rem;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        color: #1e293b;
        font-size: 0.875rem;
    }
    .search-input::placeholder { color: #94a3b8; }
    .search-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

    /* Light theme table container */
    .glass-table-container {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .glass-table-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .glass-table-header h3 { color: #1e293b; font-size: 1rem; font-weight: 600; margin: 0; }
    .glass-table-header.pending { background: linear-gradient(135deg, #fef3c7, #fde68a); border-left: 4px solid #f59e0b; }
    .glass-table { width: 100%; }
    .glass-table thead { background: #f8fafc; }
    .glass-table th { padding: 0.75rem 1rem; text-align: left; font-size: 0.75rem; font-weight: 500; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #e2e8f0; }
    .glass-table tbody tr { border-bottom: 1px solid #f1f5f9; transition: background 0.2s; }
    .glass-table tbody tr:hover { background: #f8fafc; }
    .glass-table td { padding: 0.875rem 1rem; font-size: 0.875rem; color: #475569; }
    .cell-primary { color: #1e293b; font-weight: 500; }
    .cell-link { color: #3b82f6; cursor: pointer; transition: color 0.2s; }
    .cell-link:hover { color: #2563eb; }
    .cell-muted { color: #94a3b8; font-size: 0.75rem; }

    /* Light theme status badges */
    .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
    .status-open { background: #dbeafe; color: #1e40af; }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-ready { background: #dcfce7; color: #166534; }
    .status-closed { background: #f3f4f6; color: #374151; }

    /* Grade badge - same for both themes */
    .grade-badge { display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 6px; font-size: 0.875rem; font-weight: 700; }
    .grade-A { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
    .grade-B { background: linear-gradient(135deg, #eab308, #ca8a04); color: #000; }
    .grade-C { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }

    /* Light theme duration bar */
    .duration-bar { position: relative; height: 24px; background: #e2e8f0; border-radius: 12px; overflow: hidden; min-width: 100px; }
    .duration-fill { height: 100%; border-radius: 12px; transition: width 0.3s ease; }
    .duration-fill.green { background: linear-gradient(90deg, #22c55e, #4ade80); }
    .duration-fill.yellow { background: linear-gradient(90deg, #eab308, #facc15); }
    .duration-fill.red { background: linear-gradient(90deg, #ef4444, #f87171); }
    .duration-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.75rem; font-weight: 600; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }

    /* Light theme action buttons */
    .action-btn { padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.7rem; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; align-items: center; gap: 4px; }
    .action-btn svg { width: 12px; height: 12px; }
    .action-btn.complete { background: #dcfce7; color: #166534; }
    .action-btn.complete:hover { background: #22c55e; color: white; }
    .action-btn.reject { background: #fee2e2; color: #991b1b; }
    .action-btn.reject:hover { background: #ef4444; color: white; }
    .action-btn.print { background: #dbeafe; color: #1e40af; }
    .action-btn.print:hover { background: #3b82f6; color: white; }
    .action-btn.collect { background: #f3e8ff; color: #6b21a8; }
    .action-btn.collect:hover { background: #8b5cf6; color: white; }

    /* Strobe alert */
    @keyframes strobeFlash { 0%, 100% { background: rgba(239, 68, 68, 0.1); } 50% { background: rgba(239, 68, 68, 0.25); } }
    .strobe-alert { animation: strobeFlash 1.5s ease-in-out infinite; }
    .strobe-alert:hover { animation-play-state: paused; }

    .empty-state { padding: 3rem; text-align: center; color: #64748b; }

    /* Light theme modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 50; display: flex; align-items: center; justify-content: center; }
    .modal-content { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); }
    .modal-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { color: #1e293b; font-size: 1.125rem; font-weight: 600; margin: 0; }
    .modal-close { color: #94a3b8; cursor: pointer; padding: 0.25rem; }
    .modal-close:hover { color: #1e293b; }
    .modal-body { padding: 1.5rem; }
    .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 0.75rem; }

    /* Light theme form */
    .form-group { margin-bottom: 1rem; }
    .form-label { display: block; color: #64748b; font-size: 0.75rem; font-weight: 500; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em; }
    .form-input { width: 100%; padding: 0.625rem 0.875rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; color: #1e293b; font-size: 0.875rem; }
    .form-input::placeholder { color: #94a3b8; }
    .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

    /* Light theme category selector */
    .category-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; }
    .category-option { padding: 0.75rem 0.5rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .category-option:hover { border-color: #3b82f6; background: #eff6ff; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15); }
    .category-option:hover svg { color: #3b82f6; }
    .category-option:hover span { color: #3b82f6; }
    .category-option.selected { border-color: #3b82f6; background: #dbeafe; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); }
    .category-option svg { width: 24px; height: 24px; margin: 0 auto 0.25rem; color: #64748b; transition: all 0.2s; }
    .category-option.selected svg { color: #2563eb; }
    .category-option span { font-size: 0.7rem; color: #64748b; display: block; transition: all 0.2s; }
    .category-option.selected span { color: #2563eb; font-weight: 600; }

    /* Light theme grade selector - always colored */
    .grade-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; }
    .grade-option { padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer; transition: all 0.2s; border: 3px solid transparent; }
    .grade-option .grade-letter { font-size: 1.5rem; font-weight: 700; color: white; transition: all 0.2s; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .grade-option .grade-text { font-size: 0.625rem; color: rgba(255,255,255,0.9); margin-top: 0.25rem; transition: all 0.2s; font-weight: 500; }
    .grade-option.grade-a { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .grade-option.grade-b { background: linear-gradient(135deg, #eab308, #ca8a04); }
    .grade-option.grade-c { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .grade-option:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2); }
    .grade-option.selected { border-color: #1e293b; box-shadow: 0 0 0 2px white, 0 6px 20px rgba(0, 0, 0, 0.3); transform: scale(1.05); }

    /* Light theme problem chips - card style like grades */
    .problem-chips { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.5rem; }
    .problem-chip { padding: 0.625rem 0.5rem; background: #f1f5f9; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.75rem; color: #64748b; cursor: pointer; transition: all 0.2s; font-weight: 500; text-align: center; }
    .problem-chip:hover { background: #eff6ff; border-color: #3b82f6; color: #3b82f6; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15); }
    .problem-chip.selected { background: linear-gradient(135deg, #ef4444, #dc2626); border-color: transparent; color: white; box-shadow: 0 0 0 2px white, 0 4px 15px rgba(239, 68, 68, 0.4); transform: scale(1.02); }

    /* Form section title */
    .form-section-title { font-size: 0.875rem; font-weight: 600; color: #3b82f6; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e2e8f0; }

    /* Not working option - styled like grade buttons */
    .not-working-option { padding: 1rem 2rem; border-radius: 10px; text-align: center; cursor: pointer; transition: all 0.2s; border: 3px solid transparent; background: linear-gradient(135deg, #fecaca, #fca5a5); }
    .not-working-option .not-working-icon { font-size: 1.5rem; font-weight: 700; color: #dc2626; transition: all 0.2s; }
    .not-working-option .not-working-text { font-size: 0.625rem; color: #991b1b; margin-top: 0.25rem; transition: all 0.2s; font-weight: 500; }
    .not-working-option:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3); }
    .not-working-option.selected { background: linear-gradient(135deg, #ef4444, #dc2626); border-color: #1e293b; box-shadow: 0 0 0 2px white, 0 6px 20px rgba(239, 68, 68, 0.4); transform: scale(1.05); }
    .not-working-option.selected .not-working-icon { color: white; }
    .not-working-option.selected .not-working-text { color: rgba(255,255,255,0.9); }

    /* Light theme filter select */
    .filter-select { padding: 0.5rem 0.75rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; color: #1e293b; font-size: 0.875rem; }

    /* ========================================
       GLASSMORPHIC DARK THEME - Tickets Page
       ======================================== */
    .glass-theme .page-header h2 { color: #f1f5f9; }
    .glass-theme .page-header p { color: #64748b; }
    .glass-theme .btn-secondary { background: rgba(255, 255, 255, 0.1); color: #e2e8f0; border: 1px solid rgba(255, 255, 255, 0.15); }
    .glass-theme .btn-secondary:hover { background: rgba(255, 255, 255, 0.15); color: #fff; }

    /* Glass theme stat cards */
    .glass-theme .stat-card { background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: none; }
    .glass-theme .stat-card:hover { box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); }
    .glass-theme .stat-value { color: #f1f5f9; }
    .glass-theme .stat-label { color: #94a3b8; }

    /* Glass theme search */
    .glass-theme .search-container svg { color: #64748b; }
    .glass-theme .search-input { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.15); color: #f1f5f9; }
    .glass-theme .search-input::placeholder { color: #64748b; }
    .glass-theme .search-input:focus { border-color: rgba(96, 165, 250, 0.5); box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15); }

    /* Glass theme table container */
    .glass-theme .glass-table-container { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: none; }
    .glass-theme .glass-table-header { border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    .glass-theme .glass-table-header h3 { color: #f1f5f9; }
    .glass-theme .glass-table-header.pending { background: linear-gradient(135deg, rgba(217, 119, 6, 0.2), rgba(180, 83, 9, 0.2)); }
    .glass-theme .glass-table thead { background: rgba(255, 255, 255, 0.03); }
    .glass-theme .glass-table th { color: #64748b; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    .glass-theme .glass-table tbody tr { border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
    .glass-theme .glass-table tbody tr:hover { background: rgba(255, 255, 255, 0.05); }
    .glass-theme .glass-table td { color: #cbd5e1; }
    .glass-theme .cell-primary { color: #f1f5f9; }
    .glass-theme .cell-link { color: #60a5fa; }
    .glass-theme .cell-link:hover { color: #93c5fd; }
    .glass-theme .cell-muted { color: #64748b; }

    /* Glass theme status badges */
    .glass-theme .status-open { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .glass-theme .status-pending { background: rgba(234, 179, 8, 0.2); color: #facc15; }
    .glass-theme .status-ready { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .glass-theme .status-closed { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }

    /* Glass theme duration bar */
    .glass-theme .duration-bar { background: rgba(255, 255, 255, 0.1); }

    /* Glass theme action buttons */
    .glass-theme .action-btn.complete { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .glass-theme .action-btn.reject { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .glass-theme .action-btn.print { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .glass-theme .action-btn.collect { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }

    /* Glass theme modal */
    .glass-theme .modal-overlay { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); }
    .glass-theme .modal-content { background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5); }
    .glass-theme .modal-header { border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    .glass-theme .modal-header h3 { color: #f1f5f9; }
    .glass-theme .modal-close { color: #64748b; }
    .glass-theme .modal-close:hover { color: #f1f5f9; }
    .glass-theme .modal-footer { border-top: 1px solid rgba(255, 255, 255, 0.1); }

    /* Glass theme form */
    .glass-theme .form-label { color: #94a3b8; }
    .glass-theme .form-input { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.15); color: #f1f5f9; }
    .glass-theme .form-input::placeholder { color: #64748b; }
    .glass-theme .form-input:focus { border-color: rgba(96, 165, 250, 0.5); box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15); }

    /* Glass theme category selector */
    .glass-theme .category-option { background: rgba(255, 255, 255, 0.03); border: 2px solid rgba(255, 255, 255, 0.1); }
    .glass-theme .category-option:hover { border-color: rgba(96, 165, 250, 0.5); background: rgba(96, 165, 250, 0.1); }
    .glass-theme .category-option.selected { border-color: #60a5fa; background: rgba(96, 165, 250, 0.15); }
    .glass-theme .category-option svg { color: #94a3b8; }
    .glass-theme .category-option.selected svg { color: #60a5fa; }
    .glass-theme .category-option span { color: #94a3b8; }
    .glass-theme .category-option.selected span { color: #60a5fa; }

    /* Glass theme grade selector - keep colored backgrounds, adjust selected state */
    .glass-theme .grade-option.selected { border-color: #f1f5f9; box-shadow: 0 0 0 2px rgba(30, 41, 59, 0.8), 0 6px 20px rgba(0, 0, 0, 0.4); }

    /* Glass theme problem chips */
    .glass-theme .problem-chip { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.15); color: #94a3b8; }
    .glass-theme .problem-chip:hover { background: rgba(255, 255, 255, 0.1); color: #f1f5f9; }

    /* Glass theme form section title */
    .glass-theme .form-section-title { color: #60a5fa; border-bottom-color: rgba(255, 255, 255, 0.1); }

    /* Glass theme not working option */
    .glass-theme .not-working-option { background: linear-gradient(135deg, rgba(254, 202, 202, 0.3), rgba(252, 165, 165, 0.3)); }
    .glass-theme .not-working-option .not-working-icon { color: #f87171; }
    .glass-theme .not-working-option .not-working-text { color: #fca5a5; }
    .glass-theme .not-working-option.selected { background: linear-gradient(135deg, #ef4444, #dc2626); border-color: #f1f5f9; }
    .glass-theme .not-working-option.selected .not-working-icon { color: white; }
    .glass-theme .not-working-option.selected .not-working-text { color: rgba(255,255,255,0.9); }

    /* Glass theme filter select */
    .glass-theme .filter-select { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.15); color: #f1f5f9; }
    .glass-theme .filter-select option { background: #1e293b; color: #f1f5f9; }

    /* Loading skeleton */
    .skeleton {
        background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
        background-size: 200% 100%;
        animation: skeleton-loading 1.5s infinite;
        border-radius: 4px;
    }
    .glass-theme .skeleton {
        background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
        background-size: 200% 100%;
    }
    @keyframes skeleton-loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    .skeleton-row td { padding: 0.875rem 1rem; }
    .skeleton-cell { height: 1rem; border-radius: 4px; }
    .skeleton-cell.w-16 { width: 4rem; }
    .skeleton-cell.w-24 { width: 6rem; }
    .skeleton-cell.w-32 { width: 8rem; }
    .skeleton-cell.w-20 { width: 5rem; }
</style>

<div x-data="ticketsPage()" x-init="init()">
    <!-- Header -->
    <div class="page-header flex flex-wrap items-center justify-between gap-4 mb-6">
        <div>
            <h2 class="text-2xl font-bold">Servisni nalozi</h2>
            <p class="mt-1 text-sm">Upravljanje servisnim nalozima</p>
        </div>
        <div class="flex gap-3">
            <a href="/tickets/warranties" class="btn-secondary">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
                Garancije
            </a>
            <button @click="showAddModal = true" class="btn-primary">
                <svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                </svg>
                Novi nalog
            </button>
        </div>
    </div>

    <!-- Stats cards -->
    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
        <div class="stat-card blue" @click="setFilter('open')">
            <div class="stat-value" x-text="stats.open_tickets || 0"></div>
            <div class="stat-label">Otvoreni</div>
        </div>
        <div class="stat-card green" @click="setFilter('closed')">
            <div class="stat-value" x-text="stats.closed_tickets || 0"></div>
            <div class="stat-label">Završeni</div>
        </div>
        <div class="stat-card yellow" @click="setFilter('ready')">
            <div class="stat-value" x-text="stats.ready_tickets || 0"></div>
            <div class="stat-label">Za naplatu</div>
        </div>
        <div class="stat-card purple" @click="window.location.href='/tickets/warranties'">
            <div class="stat-value" x-text="stats.active_warranties || 0"></div>
            <div class="stat-label">Garancije</div>
        </div>
        <div class="stat-card red" @click="setFilter('today')">
            <div class="stat-value" x-text="stats.today_tickets || 0"></div>
            <div class="stat-label">Danas</div>
        </div>
    </div>

    <!-- Search and filters -->
    <div class="flex flex-wrap gap-4 mb-6">
        <div class="search-container flex-1 min-w-[200px] max-w-md">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <input type="text" class="search-input" x-model="filters.search" @input.debounce.300ms="loadAllTickets()"
                   placeholder="Pretrazi po broju, kupcu, IMEI...">
        </div>
        <select x-model="filters.location_id" @change="loadAllTickets()" class="filter-select">
            <option value="">Sve lokacije</option>
            <template x-for="loc in locations" :key="loc.id">
                <option :value="loc.id" x-text="loc.name"></option>
            </template>
        </select>
    </div>

    <!-- Open tickets table -->
    <div class="glass-table-container">
        <div class="glass-table-header">
            <h3>Otvoreni nalozi (<span x-text="openTickets.length"></span>)</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="glass-table">
                <thead>
                    <tr>
                        <th>Br.</th>
                        <th>Datum</th>
                        <th>Klijent</th>
                        <th>Uredjaj</th>
                        <th>Opis</th>
                        <th>Stanje</th>
                        <th>Cena</th>
                        <th>Trajanje</th>
                        <th>Akcije</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Loading skeleton rows -->
                    <template x-if="loading">
                        <template x-for="i in 5" :key="'skeleton-'+i">
                            <tr class="skeleton-row">
                                <td><div class="skeleton skeleton-cell w-16"></div></td>
                                <td><div class="skeleton skeleton-cell w-20"></div></td>
                                <td><div class="skeleton skeleton-cell w-32"></div></td>
                                <td><div class="skeleton skeleton-cell w-32"></div></td>
                                <td><div class="skeleton skeleton-cell w-24"></div></td>
                                <td><div class="skeleton skeleton-cell w-16"></div></td>
                                <td><div class="skeleton skeleton-cell w-20"></div></td>
                                <td><div class="skeleton skeleton-cell w-24"></div></td>
                                <td><div class="skeleton skeleton-cell w-20"></div></td>
                            </tr>
                        </template>
                    </template>
                    <!-- Actual data rows -->
                    <template x-for="ticket in openTickets" :key="ticket.id">
                        <tr x-show="!loading" :class="{'strobe-alert': getDaysOpen(ticket) > 20}">
                            <td>
                                <span class="cell-link" @click="viewTicket(ticket)" x-text="'#' + ticket.ticket_number_formatted"></span>
                            </td>
                            <td x-text="formatDate(ticket.created_at)"></td>
                            <td>
                                <div class="cell-primary" x-text="ticket.customer_name"></div>
                                <div class="cell-muted" x-text="ticket.customer_phone || '-'"></div>
                            </td>
                            <td>
                                <div x-text="ticket.brand + ' ' + ticket.model"></div>
                                <div class="cell-muted" x-text="ticket.service_section || ticket.device_type || '-'"></div>
                            </td>
                            <td style="max-width: 150px;">
                                <span x-text="(ticket.problem_description || '-').substring(0, 40) + (ticket.problem_description && ticket.problem_description.length > 40 ? '...' : '')"></span>
                            </td>
                            <td>
                                <template x-if="ticket.device_condition_grade">
                                    <span class="grade-badge" :class="'grade-' + ticket.device_condition_grade" x-text="ticket.device_condition_grade"></span>
                                </template>
                                <template x-if="!ticket.device_condition_grade">
                                    <span>-</span>
                                </template>
                            </td>
                            <td>
                                <span class="cell-primary" x-text="formatPrice(ticket.estimated_price)"></span>
                                <span class="cell-muted" x-text="ticket.currency || 'RSD'"></span>
                            </td>
                            <td>
                                <div class="duration-bar">
                                    <div class="duration-fill" :class="getDurationClass(ticket)" :style="'width: ' + getDurationPercent(ticket) + '%'"></div>
                                    <span class="duration-text" x-text="getDaysOpen(ticket) + 'd'"></span>
                                </div>
                            </td>
                            <td>
                                <div class="flex gap-1">
                                    <button @click.stop="finishTicket(ticket)" class="action-btn complete">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                        Završi
                                    </button>
                                    <button @click.stop="printTicket(ticket)" class="action-btn print">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
            <div x-show="!loading && openTickets.length === 0" class="empty-state">
                Nema otvorenih naloga
            </div>
        </div>
    </div>

    <!-- Pending payment tickets table -->
    <div class="glass-table-container">
        <div class="glass-table-header pending">
            <h3>Čeka naplatu (<span x-text="pendingTickets.length"></span>)</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="glass-table">
                <thead>
                    <tr>
                        <th>Br.</th>
                        <th>Datum</th>
                        <th>Klijent</th>
                        <th>Uredjaj</th>
                        <th>Cena</th>
                        <th>Akcije</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="ticket in pendingTickets" :key="ticket.id">
                        <tr>
                            <td>
                                <span class="cell-link" @click="viewTicket(ticket)" x-text="'#' + ticket.ticket_number_formatted"></span>
                            </td>
                            <td x-text="formatDate(ticket.created_at)"></td>
                            <td>
                                <div class="cell-primary" x-text="ticket.customer_name"></div>
                                <div class="cell-muted" x-text="ticket.customer_phone || '-'"></div>
                            </td>
                            <td x-text="ticket.brand + ' ' + ticket.model"></td>
                            <td>
                                <span class="cell-primary" x-text="formatPrice(ticket.final_price || ticket.estimated_price)"></span>
                                <span class="cell-muted" x-text="ticket.currency || 'RSD'"></span>
                            </td>
                            <td>
                                <div class="flex gap-1">
                                    <button @click.stop="collectTicket(ticket)" class="action-btn collect">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                                        Naplati
                                    </button>
                                    <button @click.stop="printTicket(ticket)" class="action-btn print">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
            <div x-show="!loading && pendingTickets.length === 0" class="empty-state">
                Nema naloga za naplatu
            </div>
        </div>
    </div>

    <!-- Add Ticket Modal -->
    <div x-show="showAddModal" x-cloak class="modal-overlay" @click.self="showAddModal = false">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Novi servisni nalog</h3>
                <button class="modal-close" @click="showAddModal = false">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Section: Podaci o korisniku -->
                <div class="form-section-title">Podaci o korisniku</div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Ime i prezime *</label>
                        <input type="text" class="form-input" x-model="newTicket.customer_name" placeholder="Ime i prezime" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telefon *</label>
                        <input type="text" class="form-input" x-model="newTicket.customer_phone" placeholder="06X...">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" x-model="newTicket.customer_email" placeholder="email@primer.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ime firme</label>
                        <input type="text" class="form-input" x-model="newTicket.customer_company_name" placeholder="Naziv firme">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">PIB firme</label>
                        <input type="text" class="form-input" x-model="newTicket.customer_pib" placeholder="9 cifara" maxlength="15">
                    </div>
                    <div class="form-group"></div>
                </div>

                <!-- Section: Podaci o uredaju -->
                <div class="form-section-title" style="margin-top: 1.5rem;">Podaci o uredaju</div>
                <div class="form-group">
                    <label class="form-label">Kategorija *</label>
                    <div class="category-grid" style="grid-template-columns: repeat(5, 1fr);">
                        <div class="category-option" :class="{'selected': newTicket.device_type === 'phone'}" @click="setDeviceType('phone')">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                            <span>Telefon</span>
                        </div>
                        <div class="category-option" :class="{'selected': newTicket.device_type === 'tablet'}" @click="setDeviceType('tablet')">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                            <span>Tablet</span>
                        </div>
                        <div class="category-option" :class="{'selected': newTicket.device_type === 'laptop'}" @click="setDeviceType('laptop')">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                            <span>Laptop</span>
                        </div>
                        <div class="category-option" :class="{'selected': newTicket.device_type === 'console'}" @click="setDeviceType('console')">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/></svg>
                            <span>Konzola</span>
                        </div>
                        <div class="category-option" :class="{'selected': newTicket.device_type === 'other'}" @click="setDeviceType('other')">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                            <span>Drugo</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Marka *</label>
                        <input type="text" class="form-input" x-model="newTicket.brand" list="brandList" placeholder="Samsung, Apple..." autocomplete="off">
                        <datalist id="brandList">
                            <option value="Apple">
                            <option value="Samsung">
                            <option value="Xiaomi">
                            <option value="Huawei">
                            <option value="OnePlus">
                            <option value="Google">
                            <option value="Motorola">
                            <option value="LG">
                            <option value="Sony">
                            <option value="Nokia">
                            <option value="Lenovo">
                            <option value="Asus">
                            <option value="HP">
                            <option value="Dell">
                            <option value="PlayStation">
                            <option value="Xbox">
                            <option value="Nintendo">
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Model *</label>
                        <input type="text" class="form-input" x-model="newTicket.model" placeholder="Galaxy S21, iPhone 13...">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">IMEI / Serijski broj</label>
                    <input type="text" class="form-input" x-model="newTicket.imei" placeholder="IMEI ili serijski broj">
                </div>

                <!-- Section: Opis problema -->
                <div class="form-section-title" style="margin-top: 1.5rem;">Opis problema</div>
                <div class="form-group">
                    <label class="form-label">Brzi izbor problema</label>
                    <div class="problem-chips">
                        <template x-for="prob in currentProblems" :key="prob.id">
                            <span class="problem-chip"
                                  :class="{'selected': selectedProblems.includes(prob.id)}"
                                  @click="toggleProblem(prob.id)"
                                  x-text="prob.label"></span>
                        </template>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Opis kvara <span x-show="selectedProblems.length === 0">*</span></label>
                    <textarea class="form-input" rows="2" x-model="newTicket.problem_description" @input="syncSelectedProblems()" placeholder="Opišite problem..."></textarea>
                </div>

                <!-- Section: Stanje uredaja -->
                <div class="form-section-title" style="margin-top: 1.5rem;">Stanje uredaja pri prijemu</div>
                <div class="form-group">
                    <label class="form-label">Vizuelno stanje</label>
                    <div class="grade-grid">
                        <div class="grade-option grade-a" :class="{'selected': newTicket.device_condition_grade === 'A'}" @click="newTicket.device_condition_grade = 'A'">
                            <div class="grade-letter">A</div>
                            <div class="grade-text">Odlicno</div>
                        </div>
                        <div class="grade-option grade-b" :class="{'selected': newTicket.device_condition_grade === 'B'}" @click="newTicket.device_condition_grade = 'B'">
                            <div class="grade-letter">B</div>
                            <div class="grade-text">Dobro</div>
                        </div>
                        <div class="grade-option grade-c" :class="{'selected': newTicket.device_condition_grade === 'C'}" @click="newTicket.device_condition_grade = 'C'">
                            <div class="grade-letter">C</div>
                            <div class="grade-text">Ostecen</div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Napomena o stanju</label>
                    <textarea class="form-input" rows="2" x-model="newTicket.device_condition_notes" placeholder="Ogrebotine, ostecenja..."></textarea>
                </div>
                <div class="form-group" style="display: flex; justify-content: center;">
                    <label class="not-working-option" :class="{'selected': newTicket.device_not_working}" @click="newTicket.device_not_working = !newTicket.device_not_working">
                        <input type="checkbox" x-model="newTicket.device_not_working" style="display: none;">
                        <div class="not-working-icon">✕</div>
                        <div class="not-working-text">Ne pali</div>
                    </label>
                </div>

                <!-- Section: Servisne informacije -->
                <div class="form-section-title" style="margin-top: 1.5rem;">Servisne informacije</div>
                <div class="grid grid-cols-3 gap-4">
                    <div class="form-group">
                        <label class="form-label">Okvirna cena *</label>
                        <input type="number" class="form-input" x-model="newTicket.estimated_price" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Valuta</label>
                        <select class="form-input" x-model="newTicket.currency">
                            <option value="RSD">RSD</option>
                            <option value="EUR">EUR</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Prioritet</label>
                        <select class="form-input" x-model="newTicket.priority">
                            <option value="NORMAL">Normalan</option>
                            <option value="URGENT">Hitan</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Lokacija *</label>
                    <select class="form-input" x-model="newTicket.location_id">
                        <option value="">Izaberi lokaciju</option>
                        <template x-for="loc in locations" :key="loc.id">
                            <option :value="loc.id" x-text="loc.name"></option>
                        </template>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" @click="showAddModal = false">Otkaži</button>
                <button class="btn-primary" @click="saveTicket()" :disabled="saving">
                    <span x-show="!saving">Sačuvaj nalog</span>
                    <span x-show="saving">Čuvanje...</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Problem categories by device type
const PROBLEM_CATEGORIES = {
    phone: [
        { id: "zamena_ekrana", label: "Zamena ekrana" },
        { id: "zamena_baterije", label: "Zamena baterije" },
        { id: "zamena_punjenja", label: "Zamena punjenja" },
        { id: "zamena_kamere", label: "Zamena kamere" },
        { id: "zamena_zvucnika", label: "Zamena zvučnika" },
        { id: "zamena_mikrofona", label: "Zamena mikrofona" },
        { id: "signal_wifi", label: "Signal/WiFi" },
        { id: "softver", label: "Softver/OS" },
        { id: "voda_tecnost", label: "Voda/tečnost" },
        { id: "ostalo", label: "Ostalo" }
    ],
    tablet: [
        { id: "zamena_ekrana", label: "Zamena ekrana" },
        { id: "zamena_baterije", label: "Zamena baterije" },
        { id: "zamena_punjenja", label: "Zamena punjenja" },
        { id: "softver", label: "Softver/OS" },
        { id: "ostalo", label: "Ostalo" }
    ],
    laptop: [
        { id: "zamena_ekrana", label: "Zamena ekrana" },
        { id: "zamena_baterije", label: "Zamena baterije" },
        { id: "zamena_tastature", label: "Zamena tastature" },
        { id: "zamena_punjaca", label: "Zamena punjača" },
        { id: "zamena_hdd_ssd", label: "Zamena HDD/SSD" },
        { id: "zamena_rama", label: "Zamena RAM-a" },
        { id: "ciscenje_hladjenje", label: "Čišćenje/hlađenje" },
        { id: "softver", label: "Reinstalacija OS" },
        { id: "ostalo", label: "Ostalo" }
    ],
    console: [
        { id: "hdmi_port", label: "HDMI port" },
        { id: "blu_ray", label: "Blu-ray drive" },
        { id: "hdd_zamena", label: "HDD zamena" },
        { id: "ciscenje", label: "Čišćenje" },
        { id: "napajanje", label: "Napajanje" },
        { id: "kontroler", label: "Kontroler" },
        { id: "ostalo", label: "Ostalo" }
    ],
    other: [
        { id: "dijagnostika", label: "Dijagnostika" },
        { id: "popravka", label: "Popravka" },
        { id: "ostalo", label: "Ostalo" }
    ]
};

function ticketsPage() {
    return {
        loading: true,
        saving: false,
        showAddModal: false,
        openTickets: [],
        pendingTickets: [],
        stats: {},
        locations: [],
        filters: {
            search: '',
            location_id: ''
        },
        newTicket: {
            customer_name: '',
            customer_phone: '',
            customer_email: '',
            customer_company_name: '',
            customer_pib: '',
            device_type: 'phone',
            brand: '',
            model: '',
            imei: '',
            device_condition_grade: '',
            device_condition_notes: '',
            device_not_working: false,
            problem_description: '',
            problem_areas: [],
            estimated_price: '',
            currency: 'RSD',
            priority: 'NORMAL',
            location_id: ''
        },
        selectedProblems: [],
        currentProblems: PROBLEM_CATEGORIES['phone'] || [],

        async init() {
            await this.loadLocations();
            await this.loadAllTickets();

            // Check if we should open the add modal (from dashboard link)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('openModal') === 'true') {
                this.showAddModal = true;
                // Clean up URL
                window.history.replaceState({}, '', window.location.pathname);
            }
        },

        async loadLocations() {
            try {
                const r = await api('/api/v1/locations');
                if (r.ok) {
                    const data = await r.json();
                    this.locations = data.locations || [];
                }
            } catch (e) {
                console.error('Failed to load locations:', e);
            }
        },

        async loadAllTickets() {
            this.loading = true;
            try {
                let url = '/api/v1/tickets?per_page=100';
                if (this.filters.search) url += '&search=' + encodeURIComponent(this.filters.search);
                if (this.filters.location_id) url += '&location_id=' + this.filters.location_id;

                const r = await api(url);
                if (r.ok) {
                    const data = await r.json();
                    const tickets = data.items || [];  // API returns 'items' not 'tickets'

                    this.openTickets = tickets.filter(t => t.status === 'RECEIVED' || t.status === 'IN_PROGRESS' || t.status === 'DIAGNOSED');
                    this.pendingTickets = tickets.filter(t => t.status === 'READY');

                    this.stats = {
                        open_tickets: this.openTickets.length,
                        closed_tickets: tickets.filter(t => t.status === 'DELIVERED').length,
                        ready_tickets: this.pendingTickets.length,
                        active_warranties: data.active_warranties || 0,
                        today_tickets: tickets.filter(t => {
                            const today = new Date().toDateString();
                            return new Date(t.created_at).toDateString() === today;
                        }).length
                    };
                }
            } catch (e) {
                console.error('Failed to load tickets:', e);
            } finally {
                this.loading = false;
            }
        },

        setFilter(filter) {
            // Handle filter clicks
            console.log('Filter:', filter);
        },

        viewTicket(ticket) {
            window.location.href = '/tickets/' + ticket.id;
        },

        async finishTicket(ticket) {
            if (!confirm('Završiti nalog #' + ticket.ticket_number_formatted + '?')) return;
            try {
                const r = await api('/api/v1/tickets/' + ticket.id + '/status', {
                    method: 'PATCH',
                    body: JSON.stringify({ status: 'READY' })
                });
                if (r.ok) await this.loadAllTickets();
            } catch (e) {
                console.error(e);
            }
        },

        async collectTicket(ticket) {
            if (!confirm('Naplatiti nalog #' + ticket.ticket_number_formatted + '?')) return;
            try {
                const r = await api('/api/v1/tickets/' + ticket.id + '/status', {
                    method: 'PATCH',
                    body: JSON.stringify({ status: 'DELIVERED' })
                });
                if (r.ok) await this.loadAllTickets();
            } catch (e) {
                console.error(e);
            }
        },

        printTicket(ticket) {
            window.open('/tickets/' + ticket.id + '/print', '_blank');
        },

        async saveTicket() {
            const hasProblem = this.newTicket.problem_description || this.selectedProblems.length > 0;
            if (!this.newTicket.customer_name || !this.newTicket.brand || !this.newTicket.model || !hasProblem) {
                alert('Popunite obavezna polja: ime, marka, model i opis problema');
                return;
            }
            this.saving = true;
            try {
                const r = await api('/api/v1/tickets', {
                    method: 'POST',
                    body: JSON.stringify(this.newTicket)
                });
                if (r.ok) {
                    this.showAddModal = false;
                    this.resetNewTicket();
                    await this.loadAllTickets();
                } else {
                    const err = await r.json();
                    alert(err.message || 'Greška pri čuvanju');
                }
            } catch (e) {
                console.error(e);
                alert('Greška pri čuvanju');
            } finally {
                this.saving = false;
            }
        },

        resetNewTicket() {
            this.newTicket = {
                customer_name: '',
                customer_phone: '',
                customer_email: '',
                customer_company_name: '',
                customer_pib: '',
                device_type: 'phone',
                brand: '',
                model: '',
                imei: '',
                device_condition_grade: '',
                device_condition_notes: '',
                device_not_working: false,
                problem_description: '',
                problem_areas: [],
                estimated_price: '',
                currency: 'RSD',
                priority: 'NORMAL',
                location_id: ''
            };
            this.selectedProblems = [];
            this.currentProblems = PROBLEM_CATEGORIES['phone'] || [];
        },

        setDeviceType(type) {
            this.newTicket.device_type = type;
            this.currentProblems = PROBLEM_CATEGORIES[type] || [];
            this.selectedProblems = [];
            this.newTicket.problem_areas = [];
            // Don't clear problem_description, user might have typed custom text
        },

        toggleProblem(id) {
            const idx = this.selectedProblems.indexOf(id);
            if (idx > -1) {
                this.selectedProblems.splice(idx, 1);
            } else {
                this.selectedProblems.push(id);
            }
            this.updateProblemDescription();
        },

        updateProblemDescription() {
            const labels = this.selectedProblems.map(id => {
                const prob = this.currentProblems.find(p => p.id === id);
                return prob ? prob.label : '';
            }).filter(Boolean);
            this.newTicket.problem_description = labels.join(', ');
            this.newTicket.problem_areas = [...this.selectedProblems];
        },

        syncSelectedProblems() {
            // Bidirectional sync: select chips matching text, deselect chips not in text
            const desc = (this.newTicket.problem_description || '').toLowerCase();

            // Build new selection based on what's in the description
            const newSelection = [];
            for (const prob of this.currentProblems) {
                if (desc.includes(prob.label.toLowerCase())) {
                    newSelection.push(prob.id);
                }
            }

            this.selectedProblems = newSelection;
            this.newTicket.problem_areas = [...this.selectedProblems];
        },

        getDaysOpen(ticket) {
            if (!ticket.created_at) return 0;
            const created = new Date(ticket.created_at);
            const now = new Date();
            return Math.floor((now - created) / (1000 * 60 * 60 * 24));
        },

        getDurationClass(ticket) {
            const days = this.getDaysOpen(ticket);
            if (days <= 3) return 'green';
            if (days <= 7) return 'yellow';
            return 'red';
        },

        getDurationPercent(ticket) {
            const days = this.getDaysOpen(ticket);
            return Math.min(100, (days / 14) * 100);
        },

        formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('sr-Latn-RS');
        },

        formatPrice(price) {
            if (!price) return '0';
            return new Intl.NumberFormat('sr-RS').format(price);
        }
    }
}
</script>
{% endblock %}
