{% extends "layouts/tenant.html" %}

{% block title %}Servisni nalozi - ServisHub{% endblock %}

{% block page_content %}
<style>
    /* Tickets Page - Dark Glassmorphic Theme (matching dashboard) */
    .page-header h2 {
        color: #f1f5f9;
    }
    .page-header p {
        color: #64748b;
    }
    .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        border: none;
        cursor: pointer;
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }
    .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        color: #e2e8f0;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 500;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
        border: 1px solid rgba(255, 255, 255, 0.15);
        text-decoration: none;
    }
    .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
    }

    /* Glassmorphic stat cards */
    .stat-card {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 1.25rem;
        position: relative;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
    }
    .stat-card.blue::before { background: linear-gradient(180deg, #3b82f6, #60a5fa); }
    .stat-card.green::before { background: linear-gradient(180deg, #22c55e, #4ade80); }
    .stat-card.purple::before { background: linear-gradient(180deg, #8b5cf6, #a78bfa); }
    .stat-card.yellow::before { background: linear-gradient(180deg, #eab308, #facc15); }
    .stat-card.red::before { background: linear-gradient(180deg, #ef4444, #f87171); }

    .stat-value {
        color: #f1f5f9;
        font-size: 1.75rem;
        font-weight: 700;
    }
    .stat-label {
        color: #94a3b8;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-top: 0.25rem;
    }

    /* Search and filters */
    .search-container {
        position: relative;
    }
    .search-container svg {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #64748b;
        width: 18px;
        height: 18px;
    }
    .search-input {
        width: 100%;
        padding: 0.625rem 1rem 0.625rem 2.5rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 0.5rem;
        color: #f1f5f9;
        font-size: 0.875rem;
    }
    .search-input::placeholder {
        color: #64748b;
    }
    .search-input:focus {
        outline: none;
        border-color: rgba(96, 165, 250, 0.5);
        box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15);
    }

    /* Glassmorphic table container */
    .glass-table-container {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 1.5rem;
    }
    .glass-table-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .glass-table-header h3 {
        color: #f1f5f9;
        font-size: 1rem;
        font-weight: 600;
        margin: 0;
    }
    .glass-table-header.pending {
        background: linear-gradient(135deg, rgba(217, 119, 6, 0.2), rgba(180, 83, 9, 0.2));
        border-left: 4px solid #f59e0b;
    }
    .glass-table {
        width: 100%;
    }
    .glass-table thead {
        background: rgba(255, 255, 255, 0.03);
    }
    .glass-table th {
        padding: 0.75rem 1rem;
        text-align: left;
        font-size: 0.75rem;
        font-weight: 500;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .glass-table tbody tr {
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        transition: background 0.2s;
    }
    .glass-table tbody tr:hover {
        background: rgba(255, 255, 255, 0.05);
    }
    .glass-table td {
        padding: 0.875rem 1rem;
        font-size: 0.875rem;
        color: #cbd5e1;
    }
    .cell-primary {
        color: #f1f5f9;
        font-weight: 500;
    }
    .cell-link {
        color: #60a5fa;
        cursor: pointer;
        transition: color 0.2s;
    }
    .cell-link:hover {
        color: #93c5fd;
    }
    .cell-muted {
        color: #64748b;
        font-size: 0.75rem;
    }

    /* Status badges */
    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
    }
    .status-open { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .status-pending { background: rgba(234, 179, 8, 0.2); color: #facc15; }
    .status-ready { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .status-closed { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }

    /* Grade badge */
    .grade-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 700;
    }
    .grade-A { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
    .grade-B { background: linear-gradient(135deg, #eab308, #ca8a04); color: #000; }
    .grade-C { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }

    /* Duration bar */
    .duration-bar {
        position: relative;
        height: 24px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        overflow: hidden;
        min-width: 100px;
    }
    .duration-fill {
        height: 100%;
        border-radius: 12px;
        transition: width 0.3s ease;
    }
    .duration-fill.green { background: linear-gradient(90deg, #22c55e, #4ade80); }
    .duration-fill.yellow { background: linear-gradient(90deg, #eab308, #facc15); }
    .duration-fill.red { background: linear-gradient(90deg, #ef4444, #f87171); }
    .duration-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 0.75rem;
        font-weight: 600;
        color: #fff;
        text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }

    /* Action buttons */
    .action-btn {
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    .action-btn svg { width: 12px; height: 12px; }
    .action-btn.complete { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .action-btn.complete:hover { background: #22c55e; color: white; }
    .action-btn.reject { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .action-btn.reject:hover { background: #ef4444; color: white; }
    .action-btn.print { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .action-btn.print:hover { background: #3b82f6; color: white; }
    .action-btn.collect { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
    .action-btn.collect:hover { background: #8b5cf6; color: white; }

    /* Strobe alert for overdue */
    @keyframes strobeFlash {
        0%, 100% { background: rgba(239, 68, 68, 0.1); }
        50% { background: rgba(239, 68, 68, 0.25); }
    }
    .strobe-alert { animation: strobeFlash 1.5s ease-in-out infinite; }
    .strobe-alert:hover { animation-play-state: paused; }

    .empty-state {
        padding: 3rem;
        text-align: center;
        color: #64748b;
    }

    /* Modal styles */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        z-index: 50;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .modal-content {
        background: rgba(30, 41, 59, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }
    .modal-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .modal-header h3 {
        color: #f1f5f9;
        font-size: 1.125rem;
        font-weight: 600;
        margin: 0;
    }
    .modal-close {
        color: #64748b;
        cursor: pointer;
        padding: 0.25rem;
    }
    .modal-close:hover { color: #f1f5f9; }
    .modal-body {
        padding: 1.5rem;
    }
    .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
    }

    /* Form styles */
    .form-group { margin-bottom: 1rem; }
    .form-label {
        display: block;
        color: #94a3b8;
        font-size: 0.75rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .form-input {
        width: 100%;
        padding: 0.625rem 0.875rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 0.5rem;
        color: #f1f5f9;
        font-size: 0.875rem;
    }
    .form-input::placeholder { color: #64748b; }
    .form-input:focus {
        outline: none;
        border-color: rgba(96, 165, 250, 0.5);
        box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15);
    }

    /* Category selector */
    .category-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
    }
    .category-option {
        padding: 0.75rem 0.5rem;
        background: rgba(255, 255, 255, 0.03);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    .category-option:hover {
        border-color: rgba(96, 165, 250, 0.5);
        background: rgba(96, 165, 250, 0.1);
    }
    .category-option.selected {
        border-color: #60a5fa;
        background: rgba(96, 165, 250, 0.15);
    }
    .category-option svg { width: 24px; height: 24px; margin: 0 auto 0.25rem; color: #94a3b8; }
    .category-option.selected svg { color: #60a5fa; }
    .category-option span { font-size: 0.7rem; color: #94a3b8; display: block; }
    .category-option.selected span { color: #60a5fa; }

    /* Grade selector */
    .grade-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.75rem;
    }
    .grade-option {
        padding: 1rem;
        background: rgba(255, 255, 255, 0.03);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    .grade-option:hover { transform: translateY(-2px); }
    .grade-option .grade-letter {
        font-size: 1.5rem;
        font-weight: 700;
        color: #f1f5f9;
    }
    .grade-option .grade-text {
        font-size: 0.625rem;
        color: #64748b;
        margin-top: 0.25rem;
    }
    .grade-option.selected.grade-a {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        border-color: #22c55e;
    }
    .grade-option.selected.grade-b {
        background: linear-gradient(135deg, #eab308, #ca8a04);
        border-color: #eab308;
    }
    .grade-option.selected.grade-c {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        border-color: #ef4444;
    }
    .grade-option.selected .grade-letter,
    .grade-option.selected .grade-text { color: white; }
    .grade-option.selected.grade-b .grade-letter,
    .grade-option.selected.grade-b .grade-text { color: #000; }

    /* Problem chips */
    .problem-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    .problem-chip {
        padding: 0.375rem 0.75rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 9999px;
        font-size: 0.75rem;
        color: #94a3b8;
        cursor: pointer;
        transition: all 0.2s;
    }
    .problem-chip:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #f1f5f9;
    }
    .problem-chip.selected {
        background: #ef4444;
        border-color: #ef4444;
        color: white;
    }

    /* Filter select */
    .filter-select {
        padding: 0.5rem 0.75rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 0.5rem;
        color: #f1f5f9;
        font-size: 0.875rem;
    }
    .filter-select option {
        background: #1e293b;
        color: #f1f5f9;
    }
</style>

<div x-data="ticketsPage()" x-init="init()">
    <!-- Header -->
    <div class="page-header flex flex-wrap items-center justify-between gap-4 mb-6">
        <div>
            <h2 class="text-2xl font-bold">Servisni nalozi</h2>
            <p class="mt-1 text-sm">Upravljanje servisnim nalozima</p>
        </div>
        <div class="flex gap-3">
            <a href="/tickets/warranties" class="btn-secondary">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
                Garancije
            </a>
            <button @click="showAddModal = true" class="btn-primary">
                <svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                </svg>
                Novi nalog
            </button>
        </div>
    </div>

    <!-- Stats cards -->
    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
        <div class="stat-card blue" @click="setFilter('open')">
            <div class="stat-value" x-text="stats.open_tickets || 0"></div>
            <div class="stat-label">Otvoreni</div>
        </div>
        <div class="stat-card green" @click="setFilter('closed')">
            <div class="stat-value" x-text="stats.closed_tickets || 0"></div>
            <div class="stat-label">Završeni</div>
        </div>
        <div class="stat-card yellow" @click="setFilter('ready')">
            <div class="stat-value" x-text="stats.ready_tickets || 0"></div>
            <div class="stat-label">Za naplatu</div>
        </div>
        <div class="stat-card purple" @click="window.location.href='/tickets/warranties'">
            <div class="stat-value" x-text="stats.active_warranties || 0"></div>
            <div class="stat-label">Garancije</div>
        </div>
        <div class="stat-card red" @click="setFilter('today')">
            <div class="stat-value" x-text="stats.today_tickets || 0"></div>
            <div class="stat-label">Danas</div>
        </div>
    </div>

    <!-- Search and filters -->
    <div class="flex flex-wrap gap-4 mb-6">
        <div class="search-container flex-1 min-w-[200px] max-w-md">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <input type="text" class="search-input" x-model="filters.search" @input.debounce.300ms="loadAllTickets()"
                   placeholder="Pretrazi po broju, kupcu, IMEI...">
        </div>
        <select x-model="filters.location_id" @change="loadAllTickets()" class="filter-select">
            <option value="">Sve lokacije</option>
            <template x-for="loc in locations" :key="loc.id">
                <option :value="loc.id" x-text="loc.name"></option>
            </template>
        </select>
    </div>

    <!-- Open tickets table -->
    <div class="glass-table-container">
        <div class="glass-table-header">
            <h3>Otvoreni nalozi (<span x-text="openTickets.length"></span>)</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="glass-table">
                <thead>
                    <tr>
                        <th>Br.</th>
                        <th>Datum</th>
                        <th>Klijent</th>
                        <th>Uredjaj</th>
                        <th>Opis</th>
                        <th>Stanje</th>
                        <th>Cena</th>
                        <th>Trajanje</th>
                        <th>Akcije</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="ticket in openTickets" :key="ticket.id">
                        <tr :class="{'strobe-alert': getDaysOpen(ticket) > 20}">
                            <td>
                                <span class="cell-link" @click="viewTicket(ticket)" x-text="'#' + ticket.ticket_number_formatted"></span>
                            </td>
                            <td x-text="formatDate(ticket.created_at)"></td>
                            <td>
                                <div class="cell-primary" x-text="ticket.customer_name"></div>
                                <div class="cell-muted" x-text="ticket.customer_phone || '-'"></div>
                            </td>
                            <td>
                                <div x-text="ticket.brand + ' ' + ticket.model"></div>
                                <div class="cell-muted" x-text="ticket.service_section || ticket.device_type || '-'"></div>
                            </td>
                            <td style="max-width: 150px;">
                                <span x-text="(ticket.problem_description || '-').substring(0, 40) + (ticket.problem_description && ticket.problem_description.length > 40 ? '...' : '')"></span>
                            </td>
                            <td>
                                <template x-if="ticket.device_condition_grade">
                                    <span class="grade-badge" :class="'grade-' + ticket.device_condition_grade" x-text="ticket.device_condition_grade"></span>
                                </template>
                                <template x-if="!ticket.device_condition_grade">
                                    <span>-</span>
                                </template>
                            </td>
                            <td>
                                <span class="cell-primary" x-text="formatPrice(ticket.estimated_price)"></span>
                                <span class="cell-muted" x-text="ticket.currency || 'RSD'"></span>
                            </td>
                            <td>
                                <div class="duration-bar">
                                    <div class="duration-fill" :class="getDurationClass(ticket)" :style="'width: ' + getDurationPercent(ticket) + '%'"></div>
                                    <span class="duration-text" x-text="getDaysOpen(ticket) + 'd'"></span>
                                </div>
                            </td>
                            <td>
                                <div class="flex gap-1">
                                    <button @click.stop="finishTicket(ticket)" class="action-btn complete">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                        Završi
                                    </button>
                                    <button @click.stop="printTicket(ticket)" class="action-btn print">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
            <div x-show="!loading && openTickets.length === 0" class="empty-state">
                Nema otvorenih naloga
            </div>
        </div>
    </div>

    <!-- Pending payment tickets table -->
    <div class="glass-table-container">
        <div class="glass-table-header pending">
            <h3>Čeka naplatu (<span x-text="pendingTickets.length"></span>)</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="glass-table">
                <thead>
                    <tr>
                        <th>Br.</th>
                        <th>Datum</th>
                        <th>Klijent</th>
                        <th>Uredjaj</th>
                        <th>Cena</th>
                        <th>Akcije</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="ticket in pendingTickets" :key="ticket.id">
                        <tr>
                            <td>
                                <span class="cell-link" @click="viewTicket(ticket)" x-text="'#' + ticket.ticket_number_formatted"></span>
                            </td>
                            <td x-text="formatDate(ticket.created_at)"></td>
                            <td>
                                <div class="cell-primary" x-text="ticket.customer_name"></div>
                                <div class="cell-muted" x-text="ticket.customer_phone || '-'"></div>
                            </td>
                            <td x-text="ticket.brand + ' ' + ticket.model"></td>
                            <td>
                                <span class="cell-primary" x-text="formatPrice(ticket.final_price || ticket.estimated_price)"></span>
                                <span class="cell-muted" x-text="ticket.currency || 'RSD'"></span>
                            </td>
                            <td>
                                <div class="flex gap-1">
                                    <button @click.stop="collectTicket(ticket)" class="action-btn collect">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                                        Naplati
                                    </button>
                                    <button @click.stop="printTicket(ticket)" class="action-btn print">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
            <div x-show="!loading && pendingTickets.length === 0" class="empty-state">
                Nema naloga za naplatu
            </div>
        </div>
    </div>

    <!-- Add Ticket Modal -->
    <div x-show="showAddModal" x-cloak class="modal-overlay" @click.self="showAddModal = false">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Novi servisni nalog</h3>
                <button class="modal-close" @click="showAddModal = false">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Customer info -->
                <div class="form-group">
                    <label class="form-label">Ime kupca *</label>
                    <input type="text" class="form-input" x-model="newTicket.customer_name" placeholder="Ime i prezime">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Telefon</label>
                        <input type="text" class="form-input" x-model="newTicket.customer_phone" placeholder="06X...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" x-model="newTicket.customer_email" placeholder="email@primer.com">
                    </div>
                </div>

                <!-- Device info -->
                <div class="form-group">
                    <label class="form-label">Kategorija</label>
                    <div class="category-grid">
                        <div class="category-option" :class="{'selected': newTicket.device_type === 'phone'}" @click="newTicket.device_type = 'phone'">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                            <span>Telefon</span>
                        </div>
                        <div class="category-option" :class="{'selected': newTicket.device_type === 'tablet'}" @click="newTicket.device_type = 'tablet'">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                            <span>Tablet</span>
                        </div>
                        <div class="category-option" :class="{'selected': newTicket.device_type === 'laptop'}" @click="newTicket.device_type = 'laptop'">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                            <span>Laptop</span>
                        </div>
                        <div class="category-option" :class="{'selected': newTicket.device_type === 'other'}" @click="newTicket.device_type = 'other'">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                            <span>Drugo</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Marka *</label>
                        <input type="text" class="form-input" x-model="newTicket.brand" placeholder="Samsung, Apple...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Model *</label>
                        <input type="text" class="form-input" x-model="newTicket.model" placeholder="Galaxy S21, iPhone 13...">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">IMEI / Serijski broj</label>
                    <input type="text" class="form-input" x-model="newTicket.imei" placeholder="IMEI ili serijski broj">
                </div>

                <!-- Condition grade -->
                <div class="form-group">
                    <label class="form-label">Stanje uredjaja</label>
                    <div class="grade-grid">
                        <div class="grade-option grade-a" :class="{'selected': newTicket.device_condition_grade === 'A'}" @click="newTicket.device_condition_grade = 'A'">
                            <div class="grade-letter">A</div>
                            <div class="grade-text">Odlično</div>
                        </div>
                        <div class="grade-option grade-b" :class="{'selected': newTicket.device_condition_grade === 'B'}" @click="newTicket.device_condition_grade = 'B'">
                            <div class="grade-letter">B</div>
                            <div class="grade-text">Dobro</div>
                        </div>
                        <div class="grade-option grade-c" :class="{'selected': newTicket.device_condition_grade === 'C'}" @click="newTicket.device_condition_grade = 'C'">
                            <div class="grade-letter">C</div>
                            <div class="grade-text">Loše</div>
                        </div>
                    </div>
                </div>

                <!-- Problem description -->
                <div class="form-group">
                    <label class="form-label">Opis problema *</label>
                    <textarea class="form-input" rows="3" x-model="newTicket.problem_description" placeholder="Opišite problem..."></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Procenjena cena</label>
                        <input type="number" class="form-input" x-model="newTicket.estimated_price" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Lokacija</label>
                        <select class="form-input" x-model="newTicket.location_id">
                            <option value="">Izaberi lokaciju</option>
                            <template x-for="loc in locations" :key="loc.id">
                                <option :value="loc.id" x-text="loc.name"></option>
                            </template>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" @click="showAddModal = false">Otkaži</button>
                <button class="btn-primary" @click="saveTicket()" :disabled="saving">
                    <span x-show="!saving">Sačuvaj nalog</span>
                    <span x-show="saving">Čuvanje...</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function ticketsPage() {
    return {
        loading: true,
        saving: false,
        showAddModal: false,
        openTickets: [],
        pendingTickets: [],
        stats: {},
        locations: [],
        filters: {
            search: '',
            location_id: ''
        },
        newTicket: {
            customer_name: '',
            customer_phone: '',
            customer_email: '',
            device_type: 'phone',
            brand: '',
            model: '',
            imei: '',
            device_condition_grade: '',
            problem_description: '',
            estimated_price: '',
            location_id: ''
        },

        async init() {
            await this.loadLocations();
            await this.loadAllTickets();
        },

        async loadLocations() {
            try {
                const r = await api('/api/v1/locations');
                if (r.ok) {
                    const data = await r.json();
                    this.locations = data.locations || [];
                }
            } catch (e) {
                console.error('Failed to load locations:', e);
            }
        },

        async loadAllTickets() {
            this.loading = true;
            try {
                let url = '/api/v1/tickets?per_page=100';
                if (this.filters.search) url += '&search=' + encodeURIComponent(this.filters.search);
                if (this.filters.location_id) url += '&location_id=' + this.filters.location_id;

                const r = await api(url);
                if (r.ok) {
                    const data = await r.json();
                    const tickets = data.tickets || [];

                    this.openTickets = tickets.filter(t => t.status === 'RECEIVED' || t.status === 'IN_PROGRESS' || t.status === 'DIAGNOSED');
                    this.pendingTickets = tickets.filter(t => t.status === 'READY');

                    this.stats = {
                        open_tickets: this.openTickets.length,
                        closed_tickets: tickets.filter(t => t.status === 'DELIVERED').length,
                        ready_tickets: this.pendingTickets.length,
                        active_warranties: data.active_warranties || 0,
                        today_tickets: tickets.filter(t => {
                            const today = new Date().toDateString();
                            return new Date(t.created_at).toDateString() === today;
                        }).length
                    };
                }
            } catch (e) {
                console.error('Failed to load tickets:', e);
            } finally {
                this.loading = false;
            }
        },

        setFilter(filter) {
            // Handle filter clicks
            console.log('Filter:', filter);
        },

        viewTicket(ticket) {
            window.location.href = '/tickets/' + ticket.id;
        },

        async finishTicket(ticket) {
            if (!confirm('Završiti nalog #' + ticket.ticket_number_formatted + '?')) return;
            try {
                const r = await api('/api/v1/tickets/' + ticket.id + '/status', {
                    method: 'PATCH',
                    body: JSON.stringify({ status: 'READY' })
                });
                if (r.ok) await this.loadAllTickets();
            } catch (e) {
                console.error(e);
            }
        },

        async collectTicket(ticket) {
            if (!confirm('Naplatiti nalog #' + ticket.ticket_number_formatted + '?')) return;
            try {
                const r = await api('/api/v1/tickets/' + ticket.id + '/status', {
                    method: 'PATCH',
                    body: JSON.stringify({ status: 'DELIVERED' })
                });
                if (r.ok) await this.loadAllTickets();
            } catch (e) {
                console.error(e);
            }
        },

        printTicket(ticket) {
            window.open('/tickets/' + ticket.id + '/print', '_blank');
        },

        async saveTicket() {
            if (!this.newTicket.customer_name || !this.newTicket.brand || !this.newTicket.model || !this.newTicket.problem_description) {
                alert('Popunite obavezna polja');
                return;
            }
            this.saving = true;
            try {
                const r = await api('/api/v1/tickets', {
                    method: 'POST',
                    body: JSON.stringify(this.newTicket)
                });
                if (r.ok) {
                    this.showAddModal = false;
                    this.resetNewTicket();
                    await this.loadAllTickets();
                } else {
                    const err = await r.json();
                    alert(err.message || 'Greška pri čuvanju');
                }
            } catch (e) {
                console.error(e);
                alert('Greška pri čuvanju');
            } finally {
                this.saving = false;
            }
        },

        resetNewTicket() {
            this.newTicket = {
                customer_name: '',
                customer_phone: '',
                customer_email: '',
                device_type: 'phone',
                brand: '',
                model: '',
                imei: '',
                device_condition_grade: '',
                problem_description: '',
                estimated_price: '',
                location_id: ''
            };
        },

        getDaysOpen(ticket) {
            if (!ticket.created_at) return 0;
            const created = new Date(ticket.created_at);
            const now = new Date();
            return Math.floor((now - created) / (1000 * 60 * 60 * 24));
        },

        getDurationClass(ticket) {
            const days = this.getDaysOpen(ticket);
            if (days <= 3) return 'green';
            if (days <= 7) return 'yellow';
            return 'red';
        },

        getDurationPercent(ticket) {
            const days = this.getDaysOpen(ticket);
            return Math.min(100, (days / 14) * 100);
        },

        formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('sr-Latn-RS');
        },

        formatPrice(price) {
            if (!price) return '0';
            return new Intl.NumberFormat('sr-RS').format(price);
        }
    }
}
</script>
{% endblock %}
