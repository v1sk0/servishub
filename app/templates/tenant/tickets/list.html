{% extends "layouts/tenant.html" %}

{% block title %}Servisni nalozi - ServisHub{% endblock %}

{% block page_content %}
<style>
    /* ========================================
       LIGHT THEME - Tickets Page
       ======================================== */
    .page-header h2 { color: #1e293b; }
    .page-header p { color: #64748b; }

    .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        border: none;
        cursor: pointer;
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }
    .btn-secondary {
        background: #f1f5f9;
        color: #475569;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 500;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
        border: 1px solid #e2e8f0;
        text-decoration: none;
    }
    .btn-secondary:hover { background: #e2e8f0; color: #1e293b; }

    /* Light theme stat cards */
    .stat-card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.25rem;
        position: relative;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    .stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; }
    .stat-card.blue::before { background: linear-gradient(180deg, #3b82f6, #60a5fa); }
    .stat-card.green::before { background: linear-gradient(180deg, #22c55e, #4ade80); }
    .stat-card.purple::before { background: linear-gradient(180deg, #8b5cf6, #a78bfa); }
    .stat-card.yellow::before { background: linear-gradient(180deg, #eab308, #facc15); }
    .stat-card.red::before { background: linear-gradient(180deg, #ef4444, #f87171); }

    .stat-value { color: #1e293b; font-size: 1.75rem; font-weight: 700; }
    .stat-label { color: #64748b; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 0.25rem; }

    /* Light theme search */
    .search-container { position: relative; }
    .search-container svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; width: 18px; height: 18px; }
    .search-input {
        width: 100%;
        padding: 0.625rem 1rem 0.625rem 2.5rem;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        color: #1e293b;
        font-size: 0.875rem;
    }
    .search-input::placeholder { color: #94a3b8; }
    .search-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

    /* Light theme table container */
    .glass-table-container {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .glass-table-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .glass-table-header h3 { color: #1e293b; font-size: 1rem; font-weight: 600; margin: 0; }
    .glass-table-header.pending { background: linear-gradient(135deg, #fef3c7, #fde68a); border-left: 4px solid #f59e0b; }
    .glass-table { width: 100%; }
    .glass-table thead { background: #f8fafc; }
    .glass-table th { padding: 0.75rem 1rem; text-align: left; font-size: 0.75rem; font-weight: 500; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #e2e8f0; }
    .glass-table tbody tr { border-bottom: 1px solid #f1f5f9; transition: background 0.2s; }
    .glass-table tbody tr:hover { background: #f8fafc; }
    .glass-table td { padding: 0.875rem 1rem; font-size: 0.875rem; color: #475569; }
    .cell-primary { color: #1e293b; font-weight: 500; }
    .cell-link { color: #3b82f6; cursor: pointer; transition: color 0.2s; }
    .cell-link:hover { color: #2563eb; }
    .cell-muted { color: #94a3b8; font-size: 0.75rem; }

    /* Light theme status badges */
    .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
    .status-open { background: #dbeafe; color: #1e40af; }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-ready { background: #dcfce7; color: #166534; }
    .status-closed { background: #f3f4f6; color: #374151; }

    /* Grade badge - same for both themes */
    .grade-badge { display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 6px; font-size: 0.875rem; font-weight: 700; }
    .grade-A { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
    .grade-B { background: linear-gradient(135deg, #eab308, #ca8a04); color: #000; }
    .grade-C { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }

    /* Light theme duration bar - Dolce Vita animated stripes (exact copy) */
    @keyframes stripes-move {
        0% { background-position: 0 0; }
        100% { background-position: 40px 0; }
    }
    .duration-bar {
        position: relative;
        height: 24px;
        background: #e8eaed;
        border-radius: 12px;
        overflow: hidden;
        min-width: 100px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    .duration-fill {
        height: 100%;
        border-radius: 12px;
        transition: width 0.3s ease;
        background-size: 40px 40px;
        animation: stripes-move 1.5s linear infinite;
    }
    .duration-fill.green {
        background-color: #34a853;
        background-image: linear-gradient(
            135deg,
            rgba(255,255,255,0.15) 25%,
            transparent 25%,
            transparent 50%,
            rgba(255,255,255,0.15) 50%,
            rgba(255,255,255,0.15) 75%,
            transparent 75%,
            transparent
        );
        box-shadow: 0 0 12px rgba(52, 168, 83, 0.5), inset 0 1px 0 rgba(255,255,255,0.3);
    }
    .duration-fill.yellow {
        background-color: #f9ab00;
        background-image: linear-gradient(
            135deg,
            rgba(255,255,255,0.15) 25%,
            transparent 25%,
            transparent 50%,
            rgba(255,255,255,0.15) 50%,
            rgba(255,255,255,0.15) 75%,
            transparent 75%,
            transparent
        );
        box-shadow: 0 0 12px rgba(249, 171, 0, 0.5), inset 0 1px 0 rgba(255,255,255,0.3);
    }
    .duration-fill.red {
        background-color: #ea4335;
        background-image: linear-gradient(
            135deg,
            rgba(255,255,255,0.15) 25%,
            transparent 25%,
            transparent 50%,
            rgba(255,255,255,0.15) 50%,
            rgba(255,255,255,0.15) 75%,
            transparent 75%,
            transparent
        );
        box-shadow: 0 0 12px rgba(234, 67, 53, 0.5), inset 0 1px 0 rgba(255,255,255,0.3);
    }
    .duration-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.75rem; font-weight: 600; color: #202124; white-space: nowrap; text-shadow: 0 0 2px rgba(255,255,255,0.8); }

    /* Light theme action buttons */
    .action-btn { padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.7rem; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; align-items: center; gap: 4px; }
    .action-btn svg { width: 12px; height: 12px; }
    .action-btn.complete { background: #dcfce7; color: #166534; }
    .action-btn.complete:hover { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; box-shadow: 0 0 15px rgba(34, 197, 94, 0.4); transform: translateY(-1px); }
    .action-btn.reject { background: #fee2e2; color: #991b1b; }
    .action-btn.reject:hover { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); transform: translateY(-1px); }
    .action-btn.print { background: #dbeafe; color: #1e40af; }
    .action-btn.print:hover { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); transform: translateY(-1px); }
    .action-btn.collect { background: #f3e8ff; color: #6b21a8; }
    .action-btn.collect:hover { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; box-shadow: 0 0 15px rgba(139, 92, 246, 0.4); transform: translateY(-1px); }
    .action-btn.notify { background: #fef2f2; color: #991b1b; position: relative; }
    .action-btn.notify:hover:not(.disabled) { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); transform: translateY(-1px); }
    .action-btn.notify.disabled { opacity: 0.5; cursor: not-allowed; }
    .action-btn.notify.first-notify { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); } }

    /* Notification badge */
    .notification-badge { position: absolute; top: -6px; right: -6px; min-width: 18px; height: 18px; background: #ef4444; color: white; border-radius: 9px; font-size: 10px; font-weight: 700; display: flex; align-items: center; justify-content: center; padding: 0 4px; box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3); }

    /* Strobe alert */
    @keyframes strobeFlash { 0%, 100% { background: rgba(239, 68, 68, 0.1); } 50% { background: rgba(239, 68, 68, 0.25); } }
    .strobe-alert { animation: strobeFlash 1.5s ease-in-out infinite; }
    .strobe-alert:hover { animation-play-state: paused; }

    .empty-state { padding: 3rem; text-align: center; color: #64748b; }

    /* Light theme modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 50; display: flex; align-items: center; justify-content: center; }
    .modal-content { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); }
    .modal-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { color: #1e293b; font-size: 1.125rem; font-weight: 600; margin: 0; }
    .modal-close { color: #94a3b8; cursor: pointer; padding: 0.25rem; }
    .modal-close:hover { color: #1e293b; }
    .modal-body { padding: 1.5rem; }
    .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 0.75rem; }

    /* Notification modal info card */
    .notify-info-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
    .notify-info-row { display: flex; justify-content: space-between; padding: 0.25rem 0; font-size: 0.875rem; }
    .notify-info-row span:first-child { color: #64748b; }
    .notify-info-row span:last-child { color: #1e293b; font-weight: 500; }

    /* Notification history */
    .notify-history { margin: 1rem 0; }
    .notify-history h4 { font-size: 0.75rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
    .notify-history-item { display: flex; justify-content: space-between; padding: 0.5rem; background: #f1f5f9; border-radius: 6px; margin-bottom: 0.5rem; font-size: 0.813rem; }
    .notify-history-item .history-date { color: #64748b; }
    .notify-history-item .history-comment { color: #1e293b; }

    /* Quick reply buttons */
    .quick-reply-section { margin: 1rem 0; }
    .quick-reply-section label { font-size: 0.75rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; display: block; margin-bottom: 0.5rem; }
    .quick-reply-buttons { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .quick-reply-btn { padding: 0.5rem 0.75rem; background: #e0e7ff; color: #3730a3; border: none; border-radius: 6px; font-size: 0.813rem; cursor: pointer; transition: all 0.2s; }
    .quick-reply-btn:hover { background: #6366f1; color: white; }

    /* Danger button for write-off */
    .btn-danger { padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .btn-danger:hover { background: #dc2626; }

    /* Collect modal price section */
    .collect-price-section { margin: 1.5rem 0; }
    .collect-price-section label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem; }
    .price-inputs { display: flex; gap: 0.5rem; }
    .price-inputs input { flex: 1; padding: 0.75rem 1rem; font-size: 1.25rem; font-weight: 600; border: 2px solid #8b5cf6; border-radius: 8px; text-align: right; }
    .price-inputs input:focus { outline: none; border-color: #6d28d9; box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2); }
    .price-inputs select { padding: 0.75rem; font-size: 1rem; border: 2px solid #e2e8f0; border-radius: 8px; background: white; }
    .collect-confirm-text { text-align: center; color: #64748b; font-size: 0.875rem; margin-top: 1rem; }

    /* Light theme form */
    .form-group { margin-bottom: 1rem; }
    .form-label { display: block; color: #64748b; font-size: 0.75rem; font-weight: 500; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em; }
    .form-input { width: 100%; padding: 0.625rem 0.875rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; color: #1e293b; font-size: 0.875rem; }
    .form-input::placeholder { color: #94a3b8; }
    .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

    /* Light theme category selector */
    .category-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; }
    .category-option { padding: 0.75rem 0.5rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .category-option:hover { border-color: #3b82f6; background: #eff6ff; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15); }
    .category-option:hover svg { color: #3b82f6; }
    .category-option:hover span { color: #3b82f6; }
    .category-option.selected { border-color: #3b82f6; background: #dbeafe; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); }
    .category-option svg { width: 24px; height: 24px; margin: 0 auto 0.25rem; color: #64748b; transition: all 0.2s; }
    .category-option.selected svg { color: #2563eb; }
    .category-option span { font-size: 0.7rem; color: #64748b; display: block; transition: all 0.2s; }
    .category-option.selected span { color: #2563eb; font-weight: 600; }

    /* Light theme grade selector - always colored */
    .grade-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; }
    .grade-option { padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer; transition: all 0.2s; border: 3px solid transparent; }
    .grade-option .grade-letter { font-size: 1.5rem; font-weight: 700; color: white; transition: all 0.2s; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .grade-option .grade-text { font-size: 0.625rem; color: rgba(255,255,255,0.9); margin-top: 0.25rem; transition: all 0.2s; font-weight: 500; }
    .grade-option.grade-a { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .grade-option.grade-b { background: linear-gradient(135deg, #eab308, #ca8a04); }
    .grade-option.grade-c { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .grade-option:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2); }
    .grade-option.selected { border-color: #1e293b; box-shadow: 0 0 0 2px white, 0 6px 20px rgba(0, 0, 0, 0.3); transform: scale(1.05); }

    /* Light theme problem chips - card style like grades */
    .problem-chips { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.5rem; }
    .problem-chip { padding: 0.625rem 0.5rem; background: #f1f5f9; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.75rem; color: #64748b; cursor: pointer; transition: all 0.2s; font-weight: 500; text-align: center; }
    .problem-chip:hover { background: #eff6ff; border-color: #3b82f6; color: #3b82f6; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15); }
    .problem-chip.selected { background: linear-gradient(135deg, #ef4444, #dc2626); border-color: transparent; color: white; box-shadow: 0 0 0 2px white, 0 4px 15px rgba(239, 68, 68, 0.4); transform: scale(1.02); }

    /* Form section title */
    .form-section-title { font-size: 0.875rem; font-weight: 600; color: #3b82f6; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e2e8f0; }

    /* Not working option - styled like grade buttons */
    .not-working-option { padding: 1rem 2rem; border-radius: 10px; text-align: center; cursor: pointer; transition: all 0.2s; border: 3px solid transparent; background: linear-gradient(135deg, #fecaca, #fca5a5); }
    .not-working-option .not-working-icon { font-size: 1.5rem; font-weight: 700; color: #dc2626; transition: all 0.2s; }
    .not-working-option .not-working-text { font-size: 0.625rem; color: #991b1b; margin-top: 0.25rem; transition: all 0.2s; font-weight: 500; }
    .not-working-option:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3); }
    .not-working-option.selected { background: linear-gradient(135deg, #ef4444, #dc2626); border-color: #1e293b; box-shadow: 0 0 0 2px white, 0 6px 20px rgba(239, 68, 68, 0.4); transform: scale(1.05); }
    .not-working-option.selected .not-working-icon { color: white; }
    .not-working-option.selected .not-working-text { color: rgba(255,255,255,0.9); }

    /* Light theme filter select */
    .filter-select { padding: 0.5rem 0.75rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; color: #1e293b; font-size: 0.875rem; }

    /* ========================================
       GLASSMORPHIC DARK THEME - Tickets Page
       ======================================== */
    .glass-theme .page-header h2 { color: #f1f5f9; }
    .glass-theme .page-header p { color: #64748b; }
    .glass-theme .btn-secondary { background: rgba(255, 255, 255, 0.1); color: #e2e8f0; border: 1px solid rgba(255, 255, 255, 0.15); }
    .glass-theme .btn-secondary:hover { background: rgba(255, 255, 255, 0.15); color: #fff; }

    /* Glass theme stat cards */
    .glass-theme .stat-card { background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: none; }
    .glass-theme .stat-card:hover { box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); }
    .glass-theme .stat-value { color: #f1f5f9; }
    .glass-theme .stat-label { color: #94a3b8; }

    /* Glass theme search */
    .glass-theme .search-container svg { color: #64748b; }
    .glass-theme .search-input { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.15); color: #f1f5f9; }
    .glass-theme .search-input::placeholder { color: #64748b; }
    .glass-theme .search-input:focus { border-color: rgba(96, 165, 250, 0.5); box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15); }

    /* Glass theme table container */
    .glass-theme .glass-table-container { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: none; }
    .glass-theme .glass-table-header { border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    .glass-theme .glass-table-header h3 { color: #f1f5f9; }
    .glass-theme .glass-table-header.pending { background: linear-gradient(135deg, rgba(217, 119, 6, 0.2), rgba(180, 83, 9, 0.2)); }
    .glass-theme .glass-table thead { background: rgba(255, 255, 255, 0.03); }
    .glass-theme .glass-table th { color: #64748b; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    .glass-theme .glass-table tbody tr { border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
    .glass-theme .glass-table tbody tr:hover { background: rgba(255, 255, 255, 0.05); }
    .glass-theme .glass-table td { color: #cbd5e1; }
    .glass-theme .cell-primary { color: #f1f5f9; }
    .glass-theme .cell-link { color: #60a5fa; }
    .glass-theme .cell-link:hover { color: #93c5fd; }
    .glass-theme .cell-muted { color: #64748b; }

    /* Glass theme status badges */
    .glass-theme .status-open { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .glass-theme .status-pending { background: rgba(234, 179, 8, 0.2); color: #facc15; }
    .glass-theme .status-ready { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .glass-theme .status-closed { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }

    /* Glass theme duration bar */
    .glass-theme .duration-bar { background: rgba(255, 255, 255, 0.1); }
    .glass-theme .duration-text { color: #ffffff; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5); }

    /* Glass theme action buttons */
    .glass-theme .action-btn.complete { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .glass-theme .action-btn.reject { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .glass-theme .action-btn.print { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .glass-theme .action-btn.collect { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
    .glass-theme .action-btn.notify { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .glass-theme .action-btn.notify:hover:not(.disabled) { background: rgba(239, 68, 68, 0.4); }
    .glass-theme .notification-badge { background: #ef4444; box-shadow: 0 0 10px rgba(239, 68, 68, 0.5); }

    /* Glass theme modal */
    .glass-theme .modal-overlay { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); }
    .glass-theme .modal-content { background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5); }
    .glass-theme .modal-header { border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    .glass-theme .modal-header h3 { color: #f1f5f9; }
    .glass-theme .modal-close { color: #64748b; }
    .glass-theme .modal-close:hover { color: #f1f5f9; }
    .glass-theme .modal-footer { border-top: 1px solid rgba(255, 255, 255, 0.1); }

    /* Glass theme notification modal */
    .glass-theme .notify-info-card { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); }
    .glass-theme .notify-info-row span:first-child { color: #94a3b8; }
    .glass-theme .notify-info-row span:last-child { color: #f1f5f9; }
    .glass-theme .notify-history h4 { color: #94a3b8; }
    .glass-theme .notify-history-item { background: rgba(255, 255, 255, 0.05); }
    .glass-theme .notify-history-item .history-date { color: #94a3b8; }
    .glass-theme .notify-history-item .history-comment { color: #f1f5f9; }
    .glass-theme .quick-reply-section label { color: #94a3b8; }
    .glass-theme .quick-reply-btn { background: rgba(99, 102, 241, 0.2); color: #a5b4fc; }
    .glass-theme .quick-reply-btn:hover { background: rgba(99, 102, 241, 0.4); color: white; }
    .glass-theme .btn-danger { background: rgba(239, 68, 68, 0.8); }
    .glass-theme .btn-danger:hover { background: #ef4444; }

    /* Glass theme collect modal */
    .glass-theme .collect-price-section label { color: #94a3b8; }
    .glass-theme .price-inputs input { background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(139, 92, 246, 0.5); color: #f1f5f9; }
    .glass-theme .price-inputs input:focus { border-color: rgba(139, 92, 246, 0.8); box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2); }
    .glass-theme .price-inputs select { background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.15); color: #f1f5f9; }
    .glass-theme .collect-confirm-text { color: #94a3b8; }

    /* Glass theme form */
    .glass-theme .form-label { color: #94a3b8; }
    .glass-theme .form-input { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.15); color: #f1f5f9; }
    .glass-theme .form-input::placeholder { color: #64748b; }
    .glass-theme .form-input:focus { border-color: rgba(96, 165, 250, 0.5); box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15); }

    /* Glass theme category selector */
    .glass-theme .category-option { background: rgba(255, 255, 255, 0.03); border: 2px solid rgba(255, 255, 255, 0.1); }
    .glass-theme .category-option:hover { border-color: rgba(96, 165, 250, 0.5); background: rgba(96, 165, 250, 0.1); }
    .glass-theme .category-option.selected { border-color: #60a5fa; background: rgba(96, 165, 250, 0.15); }
    .glass-theme .category-option svg { color: #94a3b8; }
    .glass-theme .category-option.selected svg { color: #60a5fa; }
    .glass-theme .category-option span { color: #94a3b8; }
    .glass-theme .category-option.selected span { color: #60a5fa; }

    /* Glass theme grade selector - keep colored backgrounds, adjust selected state */
    .glass-theme .grade-option.selected { border-color: #f1f5f9; box-shadow: 0 0 0 2px rgba(30, 41, 59, 0.8), 0 6px 20px rgba(0, 0, 0, 0.4); }

    /* Glass theme problem chips */
    .glass-theme .problem-chip { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.15); color: #94a3b8; }
    .glass-theme .problem-chip:hover { background: rgba(255, 255, 255, 0.1); color: #f1f5f9; }

    /* Glass theme form section title */
    .glass-theme .form-section-title { color: #60a5fa; border-bottom-color: rgba(255, 255, 255, 0.1); }

    /* Glass theme not working option */
    .glass-theme .not-working-option { background: linear-gradient(135deg, rgba(254, 202, 202, 0.3), rgba(252, 165, 165, 0.3)); }
    .glass-theme .not-working-option .not-working-icon { color: #f87171; }
    .glass-theme .not-working-option .not-working-text { color: #fca5a5; }
    .glass-theme .not-working-option.selected { background: linear-gradient(135deg, #ef4444, #dc2626); border-color: #f1f5f9; }
    .glass-theme .not-working-option.selected .not-working-icon { color: white; }
    .glass-theme .not-working-option.selected .not-working-text { color: rgba(255,255,255,0.9); }

    /* Glass theme filter select */
    .glass-theme .filter-select { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.15); color: #f1f5f9; }
    .glass-theme .filter-select option { background: #1e293b; color: #f1f5f9; }

    /* Loading skeleton */
    .skeleton {
        background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
        background-size: 200% 100%;
        animation: skeleton-loading 1.5s infinite;
        border-radius: 4px;
    }
    .glass-theme .skeleton {
        background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
        background-size: 200% 100%;
    }
    @keyframes skeleton-loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    .skeleton-row td { padding: 0.875rem 1rem; }
    .skeleton-cell { height: 1rem; border-radius: 4px; }
    .skeleton-cell.w-16 { width: 4rem; }
    .skeleton-cell.w-24 { width: 6rem; }
    .skeleton-cell.w-32 { width: 8rem; }
    .skeleton-cell.w-20 { width: 5rem; }

    /* ========================================
       TICKET DETAIL MODAL
       ======================================== */
    .detail-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        z-index: 60;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .detail-modal-content {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        width: 95%;
        max-width: 700px;
        max-height: 90vh;
        overflow: hidden;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        display: flex;
        flex-direction: column;
    }
    .detail-modal-header {
        padding: 1.25rem 1.5rem;
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        border-radius: 16px 16px 0 0;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }
    .detail-modal-header .ticket-nr {
        font-size: 1.75rem;
        font-weight: 700;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    .detail-modal-header .ticket-device {
        font-size: 1.125rem;
        font-weight: 500;
        opacity: 0.9;
        margin-top: 0.25rem;
    }
    .detail-modal-close {
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.25);
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        font-size: 1.25rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    .detail-modal-close:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: rotate(90deg);
    }
    .detail-modal-body {
        padding: 1.5rem;
        overflow-y: auto;
        flex: 1;
    }
    .detail-section {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 1rem 1.25rem;
        margin-bottom: 1rem;
    }
    .detail-section:last-child { margin-bottom: 0; }
    .detail-section-title {
        font-size: 0.75rem;
        font-weight: 600;
        color: #3b82f6;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .detail-section-title svg { width: 16px; height: 16px; opacity: 0.7; }
    .detail-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem 1.5rem;
    }
    .detail-item {
        display: flex;
        flex-direction: column;
        gap: 0.125rem;
    }
    .detail-item.full-width { grid-column: span 2; }
    .detail-label {
        font-size: 0.7rem;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }
    .detail-value {
        font-size: 0.875rem;
        color: #1e293b;
        font-weight: 500;
    }
    .detail-value.large { font-size: 1.125rem; font-weight: 600; }
    .detail-value.price { color: #22c55e; }

    /* Inline edit styles */
    .editable-field {
        position: relative;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0.5rem;
        margin: -0.25rem -0.5rem;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s;
    }
    .editable-field:hover { background: rgba(59, 130, 246, 0.08); }
    .editable-field .edit-icon {
        opacity: 0;
        color: #3b82f6;
        width: 14px;
        height: 14px;
        flex-shrink: 0;
        transition: opacity 0.15s;
    }
    .editable-field:hover .edit-icon { opacity: 1; }
    .editable-field .field-value { flex: 1; }
    .editable-field.editing { background: transparent; cursor: default; }
    .editable-field.editing:hover { background: transparent; }
    .editable-field.editing .edit-icon { display: none; }
    .inline-input {
        width: 100%;
        padding: 0.375rem 0.5rem;
        border: 2px solid #3b82f6;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        color: #1e293b;
        background: white;
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
    }
    .inline-input:focus { border-color: #2563eb; }
    .inline-input.large { font-size: 1.125rem; font-weight: 600; }
    .inline-textarea {
        width: 100%;
        padding: 0.5rem;
        border: 2px solid #3b82f6;
        border-radius: 6px;
        font-size: 0.875rem;
        color: #1e293b;
        background: white;
        outline: none;
        resize: vertical;
        min-height: 60px;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
    }
    .save-indicator {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        color: #22c55e;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        opacity: 0;
        transition: opacity 0.3s;
    }
    .save-indicator.show { opacity: 1; }

    /* Glass theme inline edit */
    .glass-theme .editable-field:hover { background: rgba(255, 255, 255, 0.05); }
    .glass-theme .editable-field .edit-icon { color: #60a5fa; }
    .glass-theme .inline-input {
        background: rgba(255, 255, 255, 0.05);
        border-color: #60a5fa;
        color: #f1f5f9;
    }
    .glass-theme .inline-textarea {
        background: rgba(255, 255, 255, 0.05);
        border-color: #60a5fa;
        color: #f1f5f9;
    }
    .detail-comment-box {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        color: #475569;
        line-height: 1.5;
    }
    .detail-modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.75rem;
    }
    .detail-modal-footer .btn-group { display: flex; gap: 0.5rem; }
    .detail-status-badge {
        padding: 0.375rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    .detail-status-badge.received { background: #dbeafe; color: #1e40af; }
    .detail-status-badge.in_progress { background: #fef3c7; color: #92400e; }
    .detail-status-badge.ready { background: #dcfce7; color: #166534; }
    .detail-status-badge.delivered { background: #f3f4f6; color: #374151; }
    .detail-status-badge.rejected { background: #fee2e2; color: #991b1b; }

    /* Glass theme detail modal */
    .glass-theme .detail-modal-overlay { background: rgba(0, 0, 0, 0.7); }
    .glass-theme .detail-modal-content {
        background: linear-gradient(145deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
    }
    .glass-theme .detail-modal-header {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(139, 92, 246, 0.2));
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .glass-theme .detail-modal-body { color: #f1f5f9; }
    .glass-theme .detail-section {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(10px);
    }
    .glass-theme .detail-section:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(59, 130, 246, 0.3);
    }
    .glass-theme .detail-section-title {
        color: #60a5fa;
        border-bottom-color: rgba(96, 165, 250, 0.3);
    }
    .glass-theme .detail-label { color: rgba(255, 255, 255, 0.5); }
    .glass-theme .detail-value { color: #f1f5f9; }
    .glass-theme .detail-value.price { color: #4ade80; }
    .glass-theme .detail-comment-box {
        background: rgba(255, 255, 255, 0.03);
        border-color: rgba(255, 255, 255, 0.1);
        color: #cbd5e1;
    }
    .glass-theme .detail-modal-footer { border-top-color: rgba(255, 255, 255, 0.1); }
    .glass-theme .detail-status-badge.received { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .glass-theme .detail-status-badge.in_progress { background: rgba(234, 179, 8, 0.2); color: #facc15; }
    .glass-theme .detail-status-badge.ready { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .glass-theme .detail-status-badge.delivered { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }
    .glass-theme .detail-status-badge.rejected { background: rgba(239, 68, 68, 0.2); color: #f87171; }

    /* History section styles */
    .history-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: transparent;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.875rem;
        color: #6b7280;
        transition: all 0.2s;
    }
    .history-toggle:hover { background: #f3f4f6; border-color: #d1d5db; }
    .history-toggle svg { width: 16px; height: 16px; }
    .history-list { margin-top: 12px; }
    .history-item {
        padding: 12px;
        background: #f9fafb;
        border-radius: 8px;
        margin-bottom: 8px;
        border-left: 3px solid #3b82f6;
    }
    .history-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        font-size: 0.75rem;
        color: #6b7280;
    }
    .history-item-action {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.65rem;
        padding: 2px 6px;
        background: #dbeafe;
        color: #1e40af;
        border-radius: 4px;
    }
    .history-change {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        font-size: 0.8rem;
        margin-top: 4px;
    }
    .history-field { font-weight: 600; color: #374151; }
    .history-old { color: #ef4444; text-decoration: line-through; }
    .history-arrow { color: #9ca3af; margin: 0 4px; }
    .history-new { color: #22c55e; }
    .glass-theme .history-toggle { border-color: rgba(255,255,255,0.2); color: #94a3b8; }
    .glass-theme .history-toggle:hover { background: rgba(255,255,255,0.05); }
    .glass-theme .history-item { background: rgba(255,255,255,0.03); border-left-color: #60a5fa; }
    .glass-theme .history-item-header { color: #94a3b8; }
    .glass-theme .history-item-action { background: rgba(59,130,246,0.2); color: #60a5fa; }
    .glass-theme .history-field { color: #f1f5f9; }

    @media (max-width: 640px) {
        .detail-grid { grid-template-columns: 1fr; }
        .detail-item.full-width { grid-column: span 1; }
    }
</style>

<div x-data="ticketsPage()" x-init="init()">
    <!-- Header -->
    <div class="page-header flex flex-wrap items-center justify-between gap-4 mb-6">
        <div>
            <h2 class="text-2xl font-bold">Servisni nalozi</h2>
            <p class="mt-1 text-sm">Upravljanje servisnim nalozima</p>
        </div>
        <div class="flex gap-3">
            <a href="/tickets/warranties" class="btn-secondary">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                </svg>
                Arhiva / Garancije
            </a>
            <button @click="showAddModal = true" class="btn-primary">
                <svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                </svg>
                Novi nalog
            </button>
        </div>
    </div>

    <!-- Stats cards -->
    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
        <div class="stat-card blue" @click="setFilter('open')">
            <div class="stat-value" x-text="stats.open_tickets || 0"></div>
            <div class="stat-label">Otvoreni</div>
        </div>
        <div class="stat-card green" @click="setFilter('closed')">
            <div class="stat-value" x-text="stats.closed_tickets || 0"></div>
            <div class="stat-label">Završeni</div>
        </div>
        <div class="stat-card yellow" @click="setFilter('ready')">
            <div class="stat-value" x-text="stats.ready_tickets || 0"></div>
            <div class="stat-label">Za naplatu</div>
        </div>
        <div class="stat-card purple" @click="window.location.href='/tickets/warranties'">
            <div class="stat-value" x-text="stats.active_warranties || 0"></div>
            <div class="stat-label">Aktivne garancije</div>
        </div>
        <div class="stat-card red" @click="setFilter('today')">
            <div class="stat-value" x-text="stats.today_tickets || 0"></div>
            <div class="stat-label">Danas</div>
        </div>
    </div>

    <!-- Search and filters -->
    <div class="flex flex-wrap gap-4 mb-6">
        <div class="search-container flex-1 min-w-[200px] max-w-md">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <input type="text" class="search-input" x-model="filters.search" @input.debounce.300ms="loadAllTickets()"
                   placeholder="Pretrazi po broju, kupcu, IMEI...">
        </div>
        <select x-model="filters.location_id" @change="loadAllTickets()" class="filter-select">
            <option value="">Sve lokacije</option>
            <template x-for="loc in locations" :key="loc.id">
                <option :value="loc.id" x-text="loc.name"></option>
            </template>
        </select>
    </div>

    <!-- Open tickets table -->
    <div class="glass-table-container">
        <div class="glass-table-header">
            <h3>Otvoreni nalozi (<span x-text="openTickets.length"></span>)</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="glass-table">
                <thead>
                    <tr>
                        <th>Br.</th>
                        <th>Datum</th>
                        <th>Klijent</th>
                        <th>Uredjaj</th>
                        <th>Opis</th>
                        <th>Stanje</th>
                        <th>Cena</th>
                        <th>Trajanje</th>
                        <th>Akcije</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Loading skeleton rows -->
                    <template x-if="loading">
                        <template x-for="i in 5" :key="'skeleton-'+i">
                            <tr class="skeleton-row">
                                <td><div class="skeleton skeleton-cell w-16"></div></td>
                                <td><div class="skeleton skeleton-cell w-20"></div></td>
                                <td><div class="skeleton skeleton-cell w-32"></div></td>
                                <td><div class="skeleton skeleton-cell w-32"></div></td>
                                <td><div class="skeleton skeleton-cell w-24"></div></td>
                                <td><div class="skeleton skeleton-cell w-16"></div></td>
                                <td><div class="skeleton skeleton-cell w-20"></div></td>
                                <td><div class="skeleton skeleton-cell w-24"></div></td>
                                <td><div class="skeleton skeleton-cell w-20"></div></td>
                            </tr>
                        </template>
                    </template>
                    <!-- Actual data rows -->
                    <template x-for="ticket in openTickets" :key="ticket.id">
                        <tr x-show="!loading" :class="{'strobe-alert': getDaysOpen(ticket) > 20}">
                            <td>
                                <span class="cell-link" @click="viewTicket(ticket)" x-text="'#' + ticket.ticket_number_formatted"></span>
                            </td>
                            <td x-text="formatDate(ticket.created_at)"></td>
                            <td>
                                <div class="cell-primary" x-text="ticket.customer_name"></div>
                                <div class="cell-muted" x-text="ticket.customer_phone || '-'"></div>
                            </td>
                            <td>
                                <div x-text="ticket.brand + ' ' + ticket.model"></div>
                                <div class="cell-muted" x-text="ticket.service_section || ticket.device_type || '-'"></div>
                            </td>
                            <td style="max-width: 150px;">
                                <span x-text="(ticket.problem_description || '-').substring(0, 40) + (ticket.problem_description && ticket.problem_description.length > 40 ? '...' : '')"></span>
                            </td>
                            <td>
                                <template x-if="ticket.device_condition_grade">
                                    <span class="grade-badge" :class="'grade-' + ticket.device_condition_grade" x-text="ticket.device_condition_grade"></span>
                                </template>
                                <template x-if="!ticket.device_condition_grade">
                                    <span>-</span>
                                </template>
                            </td>
                            <td>
                                <span class="cell-primary" x-text="formatPrice(ticket.estimated_price)"></span>
                                <span class="cell-muted" x-text="ticket.currency || 'RSD'"></span>
                            </td>
                            <td>
                                <div class="duration-bar">
                                    <div class="duration-fill" :class="getDurationClass(ticket)" :style="'width: ' + getDurationPercent(ticket) + '%'"></div>
                                    <span class="duration-text" x-text="getDaysOpen(ticket) + 'd'"></span>
                                </div>
                            </td>
                            <td>
                                <div class="flex gap-1">
                                    <button @click.stop="openFinishModal(ticket)" class="action-btn complete">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                        Završi
                                    </button>
                                    <button @click.stop="openRejectModal(ticket)" class="action-btn reject">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                        Odbij
                                    </button>
                                    <button @click.stop="printTicket(ticket)" class="action-btn print">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
            <div x-show="!loading && openTickets.length === 0" class="empty-state">
                Nema otvorenih naloga
            </div>
        </div>
    </div>

    <!-- Pending payment tickets table -->
    <div class="glass-table-container">
        <div class="glass-table-header pending">
            <h3>Čeka preuzimanje (<span x-text="pendingTickets.length"></span>)</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="glass-table">
                <thead>
                    <tr>
                        <th>Br.</th>
                        <th>Datum</th>
                        <th>Klijent</th>
                        <th>Uredjaj</th>
                        <th>Opis kvara</th>
                        <th>Cena</th>
                        <th>Čeka preuz.</th>
                        <th>Akcije</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="ticket in pendingTickets" :key="ticket.id">
                        <tr>
                            <td>
                                <span class="cell-link" @click="viewTicket(ticket)" x-text="'#' + ticket.ticket_number_formatted"></span>
                            </td>
                            <td x-text="formatDate(ticket.ready_at || ticket.created_at)"></td>
                            <td>
                                <div class="cell-primary" x-text="ticket.customer_name"></div>
                                <div class="cell-muted" x-text="ticket.customer_phone || '-'"></div>
                            </td>
                            <td x-text="ticket.brand + ' ' + ticket.model"></td>
                            <td>
                                <div class="cell-muted" style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" x-text="ticket.problem_description || '-'"></div>
                            </td>
                            <td>
                                <span class="cell-primary" x-text="formatPrice(ticket.final_price || ticket.estimated_price)"></span>
                                <span class="cell-muted" x-text="ticket.currency || 'RSD'"></span>
                            </td>
                            <td>
                                <div class="duration-bar">
                                    <div class="duration-fill"
                                         :class="getWaitingDurationClass(ticket)"
                                         :style="'width: ' + getWaitingDurationPercent(ticket) + '%'">
                                    </div>
                                    <span class="duration-text" x-text="getDaysWaiting(ticket) + 'd'"></span>
                                </div>
                            </td>
                            <td>
                                <div class="flex gap-1">
                                    <button @click.stop="openNotifyModal(ticket)"
                                            class="action-btn notify"
                                            :class="{'first-notify': (ticket.notification_count || 0) === 0, 'disabled': !ticket.can_notify}"
                                            :disabled="!ticket.can_notify">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                                        Obavesti
                                        <span x-show="ticket.notification_count > 0" class="notification-badge" x-text="ticket.notification_count"></span>
                                    </button>
                                    <button @click.stop="collectTicket(ticket)" class="action-btn collect">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                                        Naplati
                                    </button>
                                    <button @click.stop="printTicket(ticket)" class="action-btn print">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
            <div x-show="!loading && pendingTickets.length === 0" class="empty-state">
                Nema naloga za naplatu
            </div>
        </div>
    </div>

    <!-- Add Ticket Modal -->
    <div x-show="showAddModal" x-cloak class="modal-overlay" @click.self="showAddModal = false">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Novi servisni nalog</h3>
                <button class="modal-close" @click="showAddModal = false">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Section: Podaci o korisniku -->
                <div class="form-section-title">Podaci o korisniku</div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Ime i prezime *</label>
                        <input type="text" class="form-input" x-model="newTicket.customer_name" placeholder="Ime i prezime" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telefon *</label>
                        <input type="text" class="form-input" x-model="newTicket.customer_phone" placeholder="06X...">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" x-model="newTicket.customer_email" placeholder="email@primer.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ime firme</label>
                        <input type="text" class="form-input" x-model="newTicket.customer_company_name" placeholder="Naziv firme">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">PIB firme</label>
                        <input type="text" class="form-input" x-model="newTicket.customer_pib" placeholder="9 cifara" maxlength="15">
                    </div>
                    <div class="form-group"></div>
                </div>

                <!-- Section: Podaci o uredaju -->
                <div class="form-section-title" style="margin-top: 1.5rem;">Podaci o uredaju</div>
                <div class="form-group">
                    <label class="form-label">Kategorija *</label>
                    <div class="category-grid" style="grid-template-columns: repeat(5, 1fr);">
                        <div class="category-option" :class="{'selected': newTicket.device_type === 'phone'}" @click="setDeviceType('phone')">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                            <span>Telefon</span>
                        </div>
                        <div class="category-option" :class="{'selected': newTicket.device_type === 'tablet'}" @click="setDeviceType('tablet')">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                            <span>Tablet</span>
                        </div>
                        <div class="category-option" :class="{'selected': newTicket.device_type === 'laptop'}" @click="setDeviceType('laptop')">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                            <span>Laptop</span>
                        </div>
                        <div class="category-option" :class="{'selected': newTicket.device_type === 'console'}" @click="setDeviceType('console')">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/></svg>
                            <span>Konzola</span>
                        </div>
                        <div class="category-option" :class="{'selected': newTicket.device_type === 'other'}" @click="setDeviceType('other')">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                            <span>Drugo</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Marka *</label>
                        <input type="text" class="form-input" x-model="newTicket.brand" list="brandList" placeholder="Samsung, Apple..." autocomplete="off">
                        <datalist id="brandList">
                            <option value="Apple">
                            <option value="Samsung">
                            <option value="Xiaomi">
                            <option value="Huawei">
                            <option value="OnePlus">
                            <option value="Google">
                            <option value="Motorola">
                            <option value="LG">
                            <option value="Sony">
                            <option value="Nokia">
                            <option value="Lenovo">
                            <option value="Asus">
                            <option value="HP">
                            <option value="Dell">
                            <option value="PlayStation">
                            <option value="Xbox">
                            <option value="Nintendo">
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Model *</label>
                        <input type="text" class="form-input" x-model="newTicket.model" placeholder="Galaxy S21, iPhone 13...">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">IMEI / Serijski broj</label>
                    <input type="text" class="form-input" x-model="newTicket.imei" placeholder="IMEI ili serijski broj">
                </div>

                <!-- Section: Opis problema -->
                <div class="form-section-title" style="margin-top: 1.5rem;">Opis problema</div>
                <div class="form-group">
                    <label class="form-label">Brzi izbor problema</label>
                    <div class="problem-chips">
                        <template x-for="prob in currentProblems" :key="prob.id">
                            <span class="problem-chip"
                                  :class="{'selected': selectedProblems.includes(prob.id)}"
                                  @click="toggleProblem(prob.id)"
                                  x-text="prob.label"></span>
                        </template>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Opis kvara <span x-show="selectedProblems.length === 0">*</span></label>
                    <textarea class="form-input" rows="2" x-model="newTicket.problem_description" @input="syncSelectedProblems()" placeholder="Opišite problem..."></textarea>
                </div>

                <!-- Section: Stanje uredaja -->
                <div class="form-section-title" style="margin-top: 1.5rem;">Stanje uredaja pri prijemu</div>
                <div class="form-group">
                    <label class="form-label">Vizuelno stanje</label>
                    <div class="grade-grid">
                        <div class="grade-option grade-a" :class="{'selected': newTicket.device_condition_grade === 'A'}" @click="newTicket.device_condition_grade = 'A'">
                            <div class="grade-letter">A</div>
                            <div class="grade-text">Odlicno</div>
                        </div>
                        <div class="grade-option grade-b" :class="{'selected': newTicket.device_condition_grade === 'B'}" @click="newTicket.device_condition_grade = 'B'">
                            <div class="grade-letter">B</div>
                            <div class="grade-text">Dobro</div>
                        </div>
                        <div class="grade-option grade-c" :class="{'selected': newTicket.device_condition_grade === 'C'}" @click="newTicket.device_condition_grade = 'C'">
                            <div class="grade-letter">C</div>
                            <div class="grade-text">Ostecen</div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Napomena o stanju</label>
                    <textarea class="form-input" rows="2" x-model="newTicket.device_condition_notes" placeholder="Ogrebotine, ostecenja..."></textarea>
                </div>
                <div class="form-group" style="display: flex; justify-content: center;">
                    <label class="not-working-option" :class="{'selected': newTicket.device_not_working}" @click="newTicket.device_not_working = !newTicket.device_not_working">
                        <input type="checkbox" x-model="newTicket.device_not_working" style="display: none;">
                        <div class="not-working-icon">✕</div>
                        <div class="not-working-text">Ne pali</div>
                    </label>
                </div>

                <!-- Section: Servisne informacije -->
                <div class="form-section-title" style="margin-top: 1.5rem;">Servisne informacije</div>
                <div class="grid grid-cols-3 gap-4">
                    <div class="form-group">
                        <label class="form-label">Okvirna cena *</label>
                        <input type="number" class="form-input" x-model="newTicket.estimated_price" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Valuta</label>
                        <select class="form-input" x-model="newTicket.currency">
                            <option value="RSD">RSD</option>
                            <option value="EUR">EUR</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Prioritet</label>
                        <select class="form-input" x-model="newTicket.priority">
                            <option value="NORMAL">Normalan</option>
                            <option value="URGENT">Hitan</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Lokacija *</label>
                    <select class="form-input" x-model="newTicket.location_id">
                        <option value="">Izaberi lokaciju</option>
                        <template x-for="loc in locations" :key="loc.id">
                            <option :value="loc.id" x-text="loc.name"></option>
                        </template>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" @click="showAddModal = false">Otkaži</button>
                <button class="btn-primary" @click="saveTicket()" :disabled="saving">
                    <span x-show="!saving">Sačuvaj nalog</span>
                    <span x-show="saving">Čuvanje...</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div x-show="showNotifyModal" x-cloak class="modal-overlay" @click.self="showNotifyModal = false">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                <h3 style="color: white;">Obaveštenje kupca</h3>
                <button class="modal-close" @click="showNotifyModal = false" style="color: rgba(255,255,255,0.7);">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Ticket info card -->
                <div class="notify-info-card">
                    <div class="notify-info-row">
                        <span>Broj naloga:</span>
                        <span x-text="'#' + notifyTicket?.ticket_number_formatted"></span>
                    </div>
                    <div class="notify-info-row">
                        <span>Klijent:</span>
                        <span x-text="notifyTicket?.customer_name"></span>
                    </div>
                    <div class="notify-info-row">
                        <span>Kontakt:</span>
                        <span x-text="notifyTicket?.customer_phone || '-'"></span>
                    </div>
                    <div class="notify-info-row">
                        <span>Uređaj:</span>
                        <span x-text="(notifyTicket?.brand || '') + ' ' + (notifyTicket?.model || '')"></span>
                    </div>
                    <div class="notify-info-row">
                        <span>Broj obaveštenja:</span>
                        <span x-text="notifyTicket?.notification_count || 0"></span>
                    </div>
                </div>

                <!-- Notification history -->
                <div x-show="notificationHistory.length > 0" class="notify-history">
                    <h4>Istorija obaveštenja</h4>
                    <template x-for="n in notificationHistory" :key="n.id">
                        <div class="notify-history-item">
                            <span class="history-date" x-text="formatDate(n.timestamp)"></span>
                            <span class="history-comment" x-text="n.comment || '-'"></span>
                        </div>
                    </template>
                </div>

                <!-- Quick reply buttons -->
                <div class="quick-reply-section">
                    <label>Brzi odgovor:</label>
                    <div class="quick-reply-buttons">
                        <button type="button" class="quick-reply-btn" @click="notifyComment = 'Klijent rekao da će doći'">
                            Klijent će doći
                        </button>
                        <button type="button" class="quick-reply-btn" @click="notifyComment = 'Klijent se ne javlja na telefon'">
                            Ne javlja se
                        </button>
                        <button type="button" class="quick-reply-btn" @click="notifyComment = 'Ostavljena poruka'">
                            Ostavljena poruka
                        </button>
                    </div>
                </div>

                <!-- Comment input -->
                <div class="form-group">
                    <label class="form-label">Komentar:</label>
                    <textarea x-model="notifyComment" rows="2" class="form-input" placeholder="Šta je kupac rekao..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" @click="showNotifyModal = false">Otkaži</button>
                <button x-show="notifyTicket?.can_write_off" class="btn-danger" @click="writeOffTicket()">
                    Otpiši nalog
                </button>
                <button class="btn-primary" @click="confirmNotify()">
                    Potvrdi obaveštenje
                </button>
            </div>
        </div>
    </div>

    <!-- Collect Modal -->
    <div x-show="showCollectModal" x-cloak class="modal-overlay" @click.self="showCollectModal = false">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6, #6d28d9);">
                <h3 style="color: white;">Potvrda naplate</h3>
                <button class="modal-close" @click="showCollectModal = false" style="color: rgba(255,255,255,0.7);">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Ticket info card -->
                <div class="notify-info-card">
                    <div class="notify-info-row">
                        <span>Broj naloga:</span>
                        <span x-text="'#' + collectTicketData?.ticket_number_formatted"></span>
                    </div>
                    <div class="notify-info-row">
                        <span>Klijent:</span>
                        <span x-text="collectTicketData?.customer_name"></span>
                    </div>
                    <div class="notify-info-row">
                        <span>Uređaj:</span>
                        <span x-text="(collectTicketData?.brand || '') + ' ' + (collectTicketData?.model || '')"></span>
                    </div>
                </div>

                <div class="collect-price-section">
                    <label>Iznos za naplatu</label>
                    <div class="price-inputs">
                        <input type="number" x-model="collectPrice" placeholder="0" min="0">
                        <select x-model="collectCurrency">
                            <option value="RSD">RSD</option>
                            <option value="EUR">EUR</option>
                        </select>
                    </div>
                </div>

                <p class="collect-confirm-text">
                    Da li želite da potvrdite naplatu ovog servisnog naloga?
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" @click="showCollectModal = false">Otkaži</button>
                <button class="btn-primary" @click="confirmCollect()" style="background: linear-gradient(135deg, #8b5cf6, #6d28d9);">
                    Potvrdi naplatu
                </button>
            </div>
        </div>
    </div>

    <!-- Reject Modal -->
    <div x-show="showRejectModal" x-cloak class="modal-overlay" @click.self="showRejectModal = false">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                <h3 style="color: white;">Odbijanje naloga</h3>
                <button class="modal-close" @click="showRejectModal = false" style="color: rgba(255,255,255,0.7);">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Ticket info card -->
                <div class="notify-info-card">
                    <div class="notify-info-row">
                        <span>Broj naloga:</span>
                        <span x-text="'#' + rejectTicket?.ticket_number_formatted"></span>
                    </div>
                    <div class="notify-info-row">
                        <span>Klijent:</span>
                        <span x-text="rejectTicket?.customer_name"></span>
                    </div>
                    <div class="notify-info-row">
                        <span>Kontakt:</span>
                        <span x-text="rejectTicket?.customer_phone || '-'"></span>
                    </div>
                    <div class="notify-info-row">
                        <span>Uređaj:</span>
                        <span x-text="(rejectTicket?.brand || '') + ' ' + (rejectTicket?.model || '')"></span>
                    </div>
                    <div class="notify-info-row">
                        <span>Problem:</span>
                        <span x-text="rejectTicket?.problem_description || '-'"></span>
                    </div>
                </div>

                <!-- Quick reject reasons -->
                <div class="quick-reply-section">
                    <label>Razlog odbijanja:</label>
                    <div class="quick-reply-buttons">
                        <button type="button" class="quick-reply-btn" @click="rejectComment = 'Neisplativa popravka'">
                            Neisplativa popravka
                        </button>
                        <button type="button" class="quick-reply-btn" @click="rejectComment = 'Nema delova'">
                            Nema delova
                        </button>
                        <button type="button" class="quick-reply-btn" @click="rejectComment = 'Kupac odustao'">
                            Kupac odustao
                        </button>
                        <button type="button" class="quick-reply-btn" @click="rejectComment = 'Nije moguće popraviti'">
                            Nije moguće popraviti
                        </button>
                    </div>
                </div>

                <!-- Comment input -->
                <div class="form-group">
                    <label class="form-label">Komentar (obavezno):</label>
                    <textarea x-model="rejectComment" rows="3" class="form-input" placeholder="Unesite razlog odbijanja..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" @click="showRejectModal = false">Otkaži</button>
                <button class="btn-danger" @click="confirmReject()" :disabled="!rejectComment.trim()">
                    Potvrdi odbijanje
                </button>
            </div>
        </div>
    </div>

    <!-- Finish Modal -->
    <div x-show="showFinishModal" x-cloak class="modal-overlay" @click.self="showFinishModal = false">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                <h3 style="color: white;">Završavanje naloga</h3>
                <button class="modal-close" @click="showFinishModal = false" style="color: rgba(255,255,255,0.7);">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Ticket info card -->
                <div class="notify-info-card">
                    <div class="notify-info-row">
                        <span>Broj naloga:</span>
                        <span x-text="'#' + finishTicket?.ticket_number_formatted"></span>
                    </div>
                    <div class="notify-info-row">
                        <span>Klijent:</span>
                        <span x-text="finishTicket?.customer_name"></span>
                    </div>
                    <div class="notify-info-row">
                        <span>Kontakt:</span>
                        <span x-text="finishTicket?.customer_phone || '-'"></span>
                    </div>
                    <div class="notify-info-row">
                        <span>Uređaj:</span>
                        <span x-text="(finishTicket?.brand || '') + ' ' + (finishTicket?.model || '')"></span>
                    </div>
                    <div class="notify-info-row">
                        <span>Problem:</span>
                        <span x-text="finishTicket?.problem_description || '-'"></span>
                    </div>
                </div>

                <!-- Quick finish reasons -->
                <div class="quick-reply-section">
                    <label>Opis popravke:</label>
                    <div class="quick-reply-buttons">
                        <button type="button" class="quick-reply-btn" style="background: #dcfce7; color: #166534;" @click="finishResolution = 'Uređaj popravljen'">
                            Uređaj popravljen
                        </button>
                        <button type="button" class="quick-reply-btn" style="background: #dcfce7; color: #166534;" @click="finishResolution = 'Zamenjeni delovi'">
                            Zamenjeni delovi
                        </button>
                        <button type="button" class="quick-reply-btn" style="background: #dcfce7; color: #166534;" @click="finishResolution = 'Softverska intervencija'">
                            Softverska intervencija
                        </button>
                    </div>
                </div>

                <!-- Resolution input -->
                <div class="form-group">
                    <label class="form-label">Detalji popravke (opciono):</label>
                    <textarea x-model="finishResolution" rows="3" class="form-input" placeholder="Opišite šta je urađeno..."></textarea>
                </div>

                <p class="collect-confirm-text">
                    Da li želite da označite ovaj nalog kao završen i spreman za preuzimanje?
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" @click="showFinishModal = false">Otkaži</button>
                <button class="btn-primary" @click="confirmFinish()" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                    Potvrdi završetak
                </button>
            </div>
        </div>
    </div>

    <!-- Ticket Detail Modal -->
    <div x-show="showDetailModal" x-cloak class="detail-modal-overlay" @click.self="showDetailModal = false">
        <div class="detail-modal-content" @click.stop>
            <div class="detail-modal-header">
                <div>
                    <div class="ticket-nr" x-text="'#' + detailTicket?.ticket_number_formatted"></div>
                    <div class="ticket-device" x-text="(detailTicket?.brand || '') + ' ' + (detailTicket?.model || '')"></div>
                </div>
                <button class="detail-modal-close" @click="showDetailModal = false">&times;</button>
            </div>
            <div class="detail-modal-body">
                <!-- Customer Section -->
                <div class="detail-section">
                    <div class="detail-section-title">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                        Podaci o korisniku
                    </div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">Ime i prezime</span>
                            <div class="editable-field" :class="{ editing: editingField === 'customer_name' }" @click="startEdit('customer_name')">
                                <template x-if="editingField !== 'customer_name'">
                                    <span class="field-value detail-value" x-text="detailTicket?.customer_name || '-'"></span>
                                </template>
                                <template x-if="editingField === 'customer_name'">
                                    <input type="text" class="inline-input" x-model="inlineEditValue" @blur="saveInlineEdit('customer_name')" @keydown.enter="saveInlineEdit('customer_name')" @keydown.escape="cancelEdit()" x-ref="inlineInput">
                                </template>
                                <svg class="edit-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                            </div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Kontakt</span>
                            <div class="editable-field" :class="{ editing: editingField === 'customer_phone' }" @click="startEdit('customer_phone')">
                                <template x-if="editingField !== 'customer_phone'">
                                    <span class="field-value detail-value" x-text="detailTicket?.customer_phone || '-'"></span>
                                </template>
                                <template x-if="editingField === 'customer_phone'">
                                    <input type="tel" class="inline-input" x-model="inlineEditValue" @blur="saveInlineEdit('customer_phone')" @keydown.enter="saveInlineEdit('customer_phone')" @keydown.escape="cancelEdit()">
                                </template>
                                <svg class="edit-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                            </div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Email</span>
                            <div class="editable-field" :class="{ editing: editingField === 'customer_email' }" @click="startEdit('customer_email')">
                                <template x-if="editingField !== 'customer_email'">
                                    <span class="field-value detail-value" x-text="detailTicket?.customer_email || '-'"></span>
                                </template>
                                <template x-if="editingField === 'customer_email'">
                                    <input type="email" class="inline-input" x-model="inlineEditValue" @blur="saveInlineEdit('customer_email')" @keydown.enter="saveInlineEdit('customer_email')" @keydown.escape="cancelEdit()">
                                </template>
                                <svg class="edit-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Device Section -->
                <div class="detail-section">
                    <div class="detail-section-title">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                        Podaci o uređaju
                    </div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">Marka</span>
                            <div class="editable-field" :class="{ editing: editingField === 'brand' }" @click="startEdit('brand')">
                                <template x-if="editingField !== 'brand'">
                                    <span class="field-value detail-value" x-text="detailTicket?.brand || '-'"></span>
                                </template>
                                <template x-if="editingField === 'brand'">
                                    <input type="text" class="inline-input" x-model="inlineEditValue" @blur="saveInlineEdit('brand')" @keydown.enter="saveInlineEdit('brand')" @keydown.escape="cancelEdit()">
                                </template>
                                <svg class="edit-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                            </div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Model</span>
                            <div class="editable-field" :class="{ editing: editingField === 'model' }" @click="startEdit('model')">
                                <template x-if="editingField !== 'model'">
                                    <span class="field-value detail-value" x-text="detailTicket?.model || '-'"></span>
                                </template>
                                <template x-if="editingField === 'model'">
                                    <input type="text" class="inline-input" x-model="inlineEditValue" @blur="saveInlineEdit('model')" @keydown.enter="saveInlineEdit('model')" @keydown.escape="cancelEdit()">
                                </template>
                                <svg class="edit-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                            </div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">IMEI / Serijski</span>
                            <div class="editable-field" :class="{ editing: editingField === 'imei' }" @click="startEdit('imei')">
                                <template x-if="editingField !== 'imei'">
                                    <span class="field-value detail-value" x-text="detailTicket?.imei || '-'"></span>
                                </template>
                                <template x-if="editingField === 'imei'">
                                    <input type="text" class="inline-input" x-model="inlineEditValue" @blur="saveInlineEdit('imei')" @keydown.enter="saveInlineEdit('imei')" @keydown.escape="cancelEdit()">
                                </template>
                                <svg class="edit-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                            </div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Stanje pri prijemu</span>
                            <span class="detail-value" x-text="getGradeLabel(detailTicket?.device_condition_grade)"></span>
                        </div>
                    </div>
                </div>

                <!-- Problem Section -->
                <div class="detail-section">
                    <div class="detail-section-title">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                        Opis problema
                    </div>
                    <div class="editable-field" :class="{ editing: editingField === 'problem_description' }" @click="startEdit('problem_description')" style="margin: 0;">
                        <template x-if="editingField !== 'problem_description'">
                            <div class="detail-comment-box field-value" x-text="detailTicket?.problem_description || '-'" style="flex: 1;"></div>
                        </template>
                        <template x-if="editingField === 'problem_description'">
                            <textarea class="inline-textarea" x-model="inlineEditValue" @blur="saveInlineEdit('problem_description')" @keydown.escape="cancelEdit()" rows="3"></textarea>
                        </template>
                        <svg class="edit-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="align-self: flex-start; margin-top: 0.75rem;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                    </div>
                </div>

                <!-- Service Section -->
                <div class="detail-section">
                    <div class="detail-section-title">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                        Servisne informacije
                    </div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">Cena</span>
                            <div class="editable-field" :class="{ editing: editingField === 'final_price' }" @click="startEdit('final_price')">
                                <template x-if="editingField !== 'final_price'">
                                    <span class="field-value detail-value large price" x-text="formatPriceDisplay(detailTicket?.final_price || detailTicket?.estimated_price, detailTicket?.currency)"></span>
                                </template>
                                <template x-if="editingField === 'final_price'">
                                    <input type="number" class="inline-input large" x-model="inlineEditValue" @blur="saveInlineEdit('final_price')" @keydown.enter="saveInlineEdit('final_price')" @keydown.escape="cancelEdit()" step="0.01" min="0">
                                </template>
                                <svg class="edit-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                            </div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Status</span>
                            <span class="detail-status-badge" :class="getStatusClass(detailTicket?.status)" x-text="getStatusLabel(detailTicket?.status)"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Serviser</span>
                            <span class="detail-value" x-text="detailTicket?.assigned_technician_name || '-'"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Lokacija</span>
                            <span class="detail-value" x-text="detailTicket?.location_name || '-'"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Kreiran</span>
                            <span class="detail-value" x-text="formatDateTime(detailTicket?.created_at)"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Završen</span>
                            <span class="detail-value" x-text="detailTicket?.closed_at ? formatDateTime(detailTicket.closed_at) : '-'"></span>
                        </div>
                    </div>
                </div>

                <!-- Notes Section (if has notes) -->
                <div class="detail-section" x-show="detailTicket?.ticket_notes">
                    <div class="detail-section-title">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                        Napomene
                    </div>
                    <div class="detail-comment-box" x-text="detailTicket?.ticket_notes || '-'"></div>
                </div>

                <!-- Warranty Section (if closed) -->
                <div class="detail-section" x-show="detailTicket?.closed_at && detailTicket?.warranty_days">
                    <div class="detail-section-title">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                        Garancija
                    </div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">Trajanje garancije</span>
                            <span class="detail-value" x-text="(detailTicket?.warranty_days || 0) + ' dana'"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Preostalo dana</span>
                            <span class="detail-value" x-text="getWarrantyRemaining(detailTicket)"></span>
                        </div>
                    </div>
                </div>

                <!-- History Section -->
                <div class="detail-section">
                    <button class="history-toggle" @click="toggleHistory(detailTicket?.id)">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <span x-text="showHistory ? 'Sakrij istoriju promena' : 'Prikaži istoriju promena'"></span>
                        <svg x-show="loadingHistory" class="animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                    <div class="history-list" x-show="showHistory && ticketHistory.length > 0">
                        <template x-for="item in ticketHistory" :key="item.id">
                            <div class="history-item">
                                <div class="history-item-header">
                                    <span class="history-item-action" x-text="item.action"></span>
                                    <span x-text="item.user_email + ' • ' + formatDateTime(item.created_at)"></span>
                                </div>
                                <template x-for="(change, field) in item.changes" :key="field">
                                    <div class="history-change" x-show="field !== 'updated_at'">
                                        <span class="history-field" x-text="getFieldLabel(field) + ':'"></span>
                                        <span class="history-old" x-text="change.old || '(prazno)'"></span>
                                        <span class="history-arrow">→</span>
                                        <span class="history-new" x-text="change.new || '(prazno)'"></span>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                    <div x-show="showHistory && ticketHistory.length === 0 && !loadingHistory" class="text-center text-gray-500 text-sm py-4">
                        Nema zabeleženih promena
                    </div>
                </div>
            </div>
            <div class="detail-modal-footer">
                <div class="btn-group">
                    <button class="btn-secondary" @click="showDetailModal = false">Zatvori</button>
                </div>
                <div class="btn-group">
                    <button class="btn-secondary" @click="printTicket(detailTicket)">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
                        Štampaj
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
// Problem categories by device type
const PROBLEM_CATEGORIES = {
    phone: [
        { id: "zamena_ekrana", label: "Zamena ekrana" },
        { id: "zamena_baterije", label: "Zamena baterije" },
        { id: "zamena_punjenja", label: "Zamena punjenja" },
        { id: "zamena_kamere", label: "Zamena kamere" },
        { id: "zamena_zvucnika", label: "Zamena zvučnika" },
        { id: "zamena_mikrofona", label: "Zamena mikrofona" },
        { id: "signal_wifi", label: "Signal/WiFi" },
        { id: "softver", label: "Softver/OS" },
        { id: "voda_tecnost", label: "Voda/tečnost" },
        { id: "ostalo", label: "Ostalo" }
    ],
    tablet: [
        { id: "zamena_ekrana", label: "Zamena ekrana" },
        { id: "zamena_baterije", label: "Zamena baterije" },
        { id: "zamena_punjenja", label: "Zamena punjenja" },
        { id: "softver", label: "Softver/OS" },
        { id: "ostalo", label: "Ostalo" }
    ],
    laptop: [
        { id: "zamena_ekrana", label: "Zamena ekrana" },
        { id: "zamena_baterije", label: "Zamena baterije" },
        { id: "zamena_tastature", label: "Zamena tastature" },
        { id: "zamena_punjaca", label: "Zamena punjača" },
        { id: "zamena_hdd_ssd", label: "Zamena HDD/SSD" },
        { id: "zamena_rama", label: "Zamena RAM-a" },
        { id: "ciscenje_hladjenje", label: "Čišćenje/hlađenje" },
        { id: "softver", label: "Reinstalacija OS" },
        { id: "ostalo", label: "Ostalo" }
    ],
    console: [
        { id: "hdmi_port", label: "HDMI port" },
        { id: "blu_ray", label: "Blu-ray drive" },
        { id: "hdd_zamena", label: "HDD zamena" },
        { id: "ciscenje", label: "Čišćenje" },
        { id: "napajanje", label: "Napajanje" },
        { id: "kontroler", label: "Kontroler" },
        { id: "ostalo", label: "Ostalo" }
    ],
    other: [
        { id: "dijagnostika", label: "Dijagnostika" },
        { id: "popravka", label: "Popravka" },
        { id: "ostalo", label: "Ostalo" }
    ]
};

function ticketsPage() {
    return {
        loading: true,
        saving: false,
        showAddModal: false,
        openTickets: [],
        pendingTickets: [],
        stats: {},
        locations: [],
        filters: {
            search: '',
            location_id: ''
        },
        newTicket: {
            customer_name: '',
            customer_phone: '',
            customer_email: '',
            customer_company_name: '',
            customer_pib: '',
            device_type: 'phone',
            brand: '',
            model: '',
            imei: '',
            device_condition_grade: '',
            device_condition_notes: '',
            device_not_working: false,
            problem_description: '',
            problem_areas: [],
            estimated_price: '',
            currency: 'RSD',
            priority: 'NORMAL',
            location_id: ''
        },
        selectedProblems: [],
        currentProblems: PROBLEM_CATEGORIES['phone'] || [],

        // Notification modal state
        showNotifyModal: false,
        notifyTicket: null,
        notifyComment: '',
        notificationHistory: [],

        // Collect modal state
        showCollectModal: false,
        collectTicketData: null,
        collectPrice: '',
        collectCurrency: 'RSD',

        // Reject modal state
        showRejectModal: false,
        rejectTicket: null,
        rejectComment: '',

        // Finish modal state
        showFinishModal: false,
        finishTicket: null,
        finishResolution: '',

        // Detail modal state
        showDetailModal: false,
        detailTicket: null,

        // History state
        showHistory: false,
        loadingHistory: false,
        ticketHistory: [],

        // Inline edit state
        editingField: null,
        inlineEditValue: '',
        savingInline: false,

        async init() {
            await this.loadLocations();
            await this.loadAllTickets();

            // Check if we should open the add modal (from dashboard link)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('openModal') === 'true') {
                this.showAddModal = true;
                // Clean up URL
                window.history.replaceState({}, '', window.location.pathname);
            }
        },

        async loadLocations() {
            try {
                const r = await api('/api/v1/locations');
                if (r.ok) {
                    const data = await r.json();
                    this.locations = data.locations || [];
                }
            } catch (e) {
                console.error('Failed to load locations:', e);
            }
        },

        async loadAllTickets() {
            this.loading = true;
            try {
                let url = '/api/v1/tickets?per_page=100';
                if (this.filters.search) url += '&search=' + encodeURIComponent(this.filters.search);
                if (this.filters.location_id) url += '&location_id=' + this.filters.location_id;

                const r = await api(url);
                if (r.ok) {
                    const data = await r.json();
                    const tickets = data.items || [];  // API returns 'items' not 'tickets'

                    this.openTickets = tickets.filter(t => t.status === 'RECEIVED' || t.status === 'IN_PROGRESS' || t.status === 'DIAGNOSED');
                    this.pendingTickets = tickets.filter(t => t.status === 'READY');

                    this.stats = {
                        open_tickets: this.openTickets.length,
                        closed_tickets: tickets.filter(t => t.status === 'DELIVERED').length,
                        ready_tickets: this.pendingTickets.length,
                        active_warranties: data.active_warranties || 0,
                        today_tickets: tickets.filter(t => {
                            const today = new Date().toDateString();
                            return new Date(t.created_at).toDateString() === today;
                        }).length
                    };
                }
            } catch (e) {
                console.error('Failed to load tickets:', e);
            } finally {
                this.loading = false;
            }
        },

        setFilter(filter) {
            // Handle filter clicks
            console.log('Filter:', filter);
        },

        viewTicket(ticket) {
            this.detailTicket = ticket;
            this.showHistory = false;
            this.ticketHistory = [];
            this.editingField = null;
            this.showDetailModal = true;
        },

        startEdit(field) {
            if (this.editingField === field) return;
            if (this.savingInline) return;

            this.editingField = field;
            this.inlineEditValue = this.detailTicket?.[field] || '';

            // Focus input after Alpine updates DOM
            this.$nextTick(() => {
                const input = this.$el.querySelector('.inline-input, .inline-textarea');
                if (input) input.focus();
            });
        },

        cancelEdit() {
            this.editingField = null;
            this.inlineEditValue = '';
        },

        async saveInlineEdit(field) {
            if (!this.detailTicket || this.savingInline) return;

            const oldValue = this.detailTicket[field];
            const newValue = this.inlineEditValue;

            // If value hasn't changed, just cancel
            if (oldValue === newValue || (!oldValue && !newValue)) {
                this.cancelEdit();
                return;
            }

            this.savingInline = true;
            try {
                const r = await api('/api/v1/tickets/' + this.detailTicket.id, {
                    method: 'PUT',
                    body: JSON.stringify({ [field]: newValue })
                });

                if (r.ok) {
                    // Update local ticket data
                    this.detailTicket[field] = newValue;

                    // Also update in the tickets lists
                    const updateInList = (list) => {
                        const idx = list.findIndex(t => t.id === this.detailTicket.id);
                        if (idx !== -1) list[idx][field] = newValue;
                    };
                    updateInList(this.openTickets);
                    updateInList(this.pendingTickets);

                    showToast('Sačuvano', 'success');
                } else {
                    const err = await r.json();
                    showToast(err.message || 'Greška pri čuvanju', 'error');
                }
            } catch (e) {
                console.error('Failed to save:', e);
                showToast('Greška pri čuvanju', 'error');
            } finally {
                this.savingInline = false;
                this.editingField = null;
                this.inlineEditValue = '';
            }
        },

        async toggleHistory(ticketId) {
            if (this.showHistory) {
                this.showHistory = false;
                return;
            }

            this.loadingHistory = true;
            try {
                const r = await api('/api/v1/tickets/' + ticketId + '/history');
                if (r.ok) {
                    const data = await r.json();
                    this.ticketHistory = data.items || [];
                }
            } catch (e) {
                console.error('Failed to load history:', e);
            } finally {
                this.loadingHistory = false;
                this.showHistory = true;
            }
        },

        getFieldLabel(field) {
            const labels = {
                'customer_name': 'Ime',
                'customer_phone': 'Telefon',
                'customer_email': 'Email',
                'brand': 'Marka',
                'model': 'Model',
                'imei': 'IMEI',
                'device_type': 'Tip uređaja',
                'device_condition_grade': 'Ocena stanja',
                'device_condition_notes': 'Napomena o stanju',
                'device_not_working': 'Ne radi',
                'problem_description': 'Opis problema',
                'ticket_notes': 'Napomene',
                'estimated_price': 'Procenjena cena',
                'final_price': 'Konačna cena',
                'currency': 'Valuta',
                'warranty_days': 'Garancija',
                'status': 'Status',
                'priority': 'Prioritet'
            };
            return labels[field] || field;
        },

        getGradeLabel(grade) {
            const labels = {
                'A': 'A - Odlično',
                'B': 'B - Dobro',
                'C': 'C - Loše'
            };
            return labels[grade] || grade || '-';
        },

        getStatusClass(status) {
            const classes = {
                'RECEIVED': 'received',
                'DIAGNOSED': 'in_progress',
                'IN_PROGRESS': 'in_progress',
                'WAITING_PARTS': 'in_progress',
                'READY': 'ready',
                'DELIVERED': 'delivered',
                'REJECTED': 'rejected',
                'CANCELLED': 'rejected'
            };
            return classes[status] || 'received';
        },

        getStatusLabel(status) {
            const labels = {
                'RECEIVED': 'Primljeno',
                'DIAGNOSED': 'Dijagnostifikovano',
                'IN_PROGRESS': 'U obradi',
                'WAITING_PARTS': 'Čeka delove',
                'READY': 'Spremno',
                'DELIVERED': 'Preuzeto',
                'REJECTED': 'Odbijeno',
                'CANCELLED': 'Otkazano'
            };
            return labels[status] || status || '-';
        },

        formatPriceDisplay(price, currency) {
            if (!price) return '-';
            return parseFloat(price).toLocaleString('sr-RS') + ' ' + (currency || 'RSD');
        },

        formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('sr-RS') + ' ' + d.toLocaleTimeString('sr-RS', {hour: '2-digit', minute: '2-digit'});
        },

        getWarrantyRemaining(ticket) {
            if (!ticket?.closed_at || !ticket?.warranty_days) return '-';
            const closedDate = new Date(ticket.closed_at);
            const expiryDate = new Date(closedDate);
            expiryDate.setDate(expiryDate.getDate() + ticket.warranty_days);
            const now = new Date();
            const daysRemaining = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
            if (daysRemaining <= 0) return 'Istekla';
            return daysRemaining + ' dana';
        },

        // =============================================
        // FINISH MODAL SYSTEM
        // =============================================
        openFinishModal(ticket) {
            this.finishTicket = ticket;
            this.finishResolution = ticket.resolution || '';
            this.showFinishModal = true;
        },

        async confirmFinish() {
            if (!this.finishTicket) return;

            try {
                // First update resolution if provided
                if (this.finishResolution.trim()) {
                    await api('/api/v1/tickets/' + this.finishTicket.id, {
                        method: 'PATCH',
                        body: JSON.stringify({ resolution: this.finishResolution.trim() })
                    });
                }

                // Then change status to READY
                const r = await api('/api/v1/tickets/' + this.finishTicket.id + '/status', {
                    method: 'PATCH',
                    body: JSON.stringify({ status: 'READY' })
                });
                if (r.ok) {
                    this.showFinishModal = false;
                    await this.loadAllTickets();
                } else {
                    const err = await r.json();
                    alert(err.message || 'Greška pri završavanju naloga');
                }
            } catch (e) {
                console.error('Failed to finish ticket:', e);
                alert('Greška pri završavanju naloga');
            }
        },

        // =============================================
        // COLLECT MODAL SYSTEM
        // =============================================
        collectTicket(ticket) {
            // Open modal instead of confirm()
            this.collectTicketData = ticket;
            this.collectPrice = ticket.final_price || ticket.estimated_price || '';
            this.collectCurrency = ticket.currency || 'RSD';
            this.showCollectModal = true;
        },

        async confirmCollect() {
            if (!this.collectTicketData) return;

            try {
                const r = await api('/api/v1/tickets/' + this.collectTicketData.id + '/status', {
                    method: 'PATCH',
                    body: JSON.stringify({
                        status: 'DELIVERED',
                        final_price: this.collectPrice ? parseFloat(this.collectPrice) : null,
                        currency: this.collectCurrency
                    })
                });
                if (r.ok) {
                    this.showCollectModal = false;
                    await this.loadAllTickets();
                } else {
                    const err = await r.json();
                    alert(err.message || 'Greška pri naplati');
                }
            } catch (e) {
                console.error('Failed to collect ticket:', e);
                alert('Greška pri naplati');
            }
        },

        // =============================================
        // NOTIFICATION SYSTEM
        // =============================================
        async openNotifyModal(ticket) {
            this.notifyTicket = ticket;
            this.notifyComment = '';
            this.notificationHistory = [];

            // Load notification history
            try {
                const r = await api('/api/v1/tickets/' + ticket.id + '/notifications');
                if (r.ok) {
                    const data = await r.json();
                    this.notificationHistory = data.notifications || [];
                }
            } catch (e) {
                console.error('Failed to load notifications:', e);
            }

            this.showNotifyModal = true;
        },

        async confirmNotify() {
            if (!this.notifyTicket) return;

            try {
                const r = await api('/api/v1/tickets/' + this.notifyTicket.id + '/notify', {
                    method: 'POST',
                    body: JSON.stringify({ comment: this.notifyComment })
                });
                if (r.ok) {
                    this.showNotifyModal = false;
                    await this.loadAllTickets();
                } else {
                    const err = await r.json();
                    alert(err.message || 'Greška pri slanju obaveštenja');
                }
            } catch (e) {
                console.error('Failed to send notification:', e);
                alert('Greška pri slanju obaveštenja');
            }
        },

        async writeOffTicket() {
            if (!this.notifyTicket) return;
            if (!confirm('Da li ste sigurni da želite da otpišete ovaj nalog? Ova akcija se ne može poništiti.')) return;

            try {
                const r = await api('/api/v1/tickets/' + this.notifyTicket.id + '/write-off', {
                    method: 'POST'
                });
                if (r.ok) {
                    this.showNotifyModal = false;
                    await this.loadAllTickets();
                } else {
                    const err = await r.json();
                    alert(err.message || 'Greška pri otpisu naloga');
                }
            } catch (e) {
                console.error('Failed to write off ticket:', e);
                alert('Greška pri otpisu naloga');
            }
        },

        // =============================================
        // REJECT SYSTEM
        // =============================================
        openRejectModal(ticket) {
            this.rejectTicket = ticket;
            this.rejectComment = '';
            this.showRejectModal = true;
        },

        async confirmReject() {
            if (!this.rejectTicket || !this.rejectComment.trim()) return;

            try {
                const r = await api('/api/v1/tickets/' + this.rejectTicket.id + '/status', {
                    method: 'PATCH',
                    body: JSON.stringify({
                        status: 'REJECTED',
                        rejection_reason: this.rejectComment.trim()
                    })
                });
                if (r.ok) {
                    this.showRejectModal = false;
                    await this.loadAllTickets();
                } else {
                    const err = await r.json();
                    alert(err.message || 'Greška pri odbijanju naloga');
                }
            } catch (e) {
                console.error('Failed to reject ticket:', e);
                alert('Greška pri odbijanju naloga');
            }
        },

        printTicket(ticket) {
            window.open('/tickets/' + ticket.id + '/print', '_blank');
        },

        async saveTicket() {
            const hasProblem = this.newTicket.problem_description || this.selectedProblems.length > 0;
            if (!this.newTicket.customer_name || !this.newTicket.brand || !this.newTicket.model || !hasProblem) {
                alert('Popunite obavezna polja: ime, marka, model i opis problema');
                return;
            }
            this.saving = true;
            try {
                const r = await api('/api/v1/tickets', {
                    method: 'POST',
                    body: JSON.stringify(this.newTicket)
                });
                if (r.ok) {
                    this.showAddModal = false;
                    this.resetNewTicket();
                    await this.loadAllTickets();
                } else {
                    const err = await r.json();
                    alert(err.message || 'Greška pri čuvanju');
                }
            } catch (e) {
                console.error(e);
                alert('Greška pri čuvanju');
            } finally {
                this.saving = false;
            }
        },

        resetNewTicket() {
            this.newTicket = {
                customer_name: '',
                customer_phone: '',
                customer_email: '',
                customer_company_name: '',
                customer_pib: '',
                device_type: 'phone',
                brand: '',
                model: '',
                imei: '',
                device_condition_grade: '',
                device_condition_notes: '',
                device_not_working: false,
                problem_description: '',
                problem_areas: [],
                estimated_price: '',
                currency: 'RSD',
                priority: 'NORMAL',
                location_id: ''
            };
            this.selectedProblems = [];
            this.currentProblems = PROBLEM_CATEGORIES['phone'] || [];
        },

        setDeviceType(type) {
            this.newTicket.device_type = type;
            this.currentProblems = PROBLEM_CATEGORIES[type] || [];
            this.selectedProblems = [];
            this.newTicket.problem_areas = [];
            // Don't clear problem_description, user might have typed custom text
        },

        toggleProblem(id) {
            const idx = this.selectedProblems.indexOf(id);
            if (idx > -1) {
                this.selectedProblems.splice(idx, 1);
            } else {
                this.selectedProblems.push(id);
            }
            this.updateProblemDescription();
        },

        updateProblemDescription() {
            const labels = this.selectedProblems.map(id => {
                const prob = this.currentProblems.find(p => p.id === id);
                return prob ? prob.label : '';
            }).filter(Boolean);
            this.newTicket.problem_description = labels.join(', ');
            this.newTicket.problem_areas = [...this.selectedProblems];
        },

        syncSelectedProblems() {
            // Bidirectional sync: select chips matching text, deselect chips not in text
            const desc = (this.newTicket.problem_description || '').toLowerCase();

            // Build new selection based on what's in the description
            const newSelection = [];
            for (const prob of this.currentProblems) {
                if (desc.includes(prob.label.toLowerCase())) {
                    newSelection.push(prob.id);
                }
            }

            this.selectedProblems = newSelection;
            this.newTicket.problem_areas = [...this.selectedProblems];
        },

        getDaysOpen(ticket) {
            if (!ticket.created_at) return 0;
            const created = new Date(ticket.created_at);
            const now = new Date();
            return Math.floor((now - created) / (1000 * 60 * 60 * 24));
        },

        getDurationClass(ticket) {
            const days = this.getDaysOpen(ticket);
            if (days <= 10) return 'green';
            if (days <= 18) return 'yellow';
            return 'red';
        },

        getDurationPercent(ticket) {
            const days = this.getDaysOpen(ticket);
            return Math.min(100, (days / 30) * 100);
        },

        // Pending tickets - days waiting for pickup
        getDaysWaiting(ticket) {
            // Use ready_at (when status changed to READY)
            // Fallback to created_at for old tickets without ready_at
            const waitingSince = ticket.ready_at || ticket.created_at;
            if (!waitingSince) return 0;
            const startDate = new Date(waitingSince);
            const now = new Date();
            return Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
        },

        getWaitingDurationClass(ticket) {
            const days = this.getDaysWaiting(ticket);
            if (days <= 7) return 'green';
            if (days <= 15) return 'yellow';
            return 'red';
        },

        getWaitingDurationPercent(ticket) {
            const days = this.getDaysWaiting(ticket);
            return Math.min(100, (days / 30) * 100);
        },

        formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('sr-Latn-RS');
        },

        formatPrice(price) {
            if (!price) return '0';
            return new Intl.NumberFormat('sr-RS').format(price);
        }
    }
}
</script>
{% endblock %}
