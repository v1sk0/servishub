<!DOCTYPE html>
<html lang="sr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ServisHub{% endblock %}</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Custom styles -->
    <style>
        /* Prevent FOUC (Flash of Unstyled Content) */
        html:not(.theme-ready) body {
            visibility: hidden;
        }
        html.theme-ready body {
            visibility: visible;
        }

        [x-cloak] { display: none !important; }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Shimmer/shine effect for widgets - 45 degree angle, fast sweep */
        @keyframes shimmer {
            0% { transform: translateX(-100%) skewX(-25deg); }
            40% { transform: translateX(250%) skewX(-25deg); }
            100% { transform: translateX(250%) skewX(-25deg); }
        }
        .animate-shimmer {
            animation: shimmer 5s infinite;
            width: 50%;
        }

        /* Simple rounded border for subscription widget */
        .postmark-border {
            border: 2px solid rgba(255, 255, 255, 0.25);
            border-radius: 0.75rem;
        }

        /* ==================== GLASSMORPHISM THEME ==================== */
        .glass-theme {
            --glass-bg: rgba(15, 23, 42, 0.95);
            --glass-card: rgba(30, 41, 59, 0.8);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-text: #f1f5f9;
            --glass-text-muted: #94a3b8;
            --glass-accent: #8b5cf6;
        }

        .glass-theme body {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%) !important;
            background-attachment: fixed !important;
        }

        /* Sidebar */
        .glass-theme .lg\:flex.lg\:w-72.lg\:flex-col > div,
        .glass-theme .fixed.inset-y-0.left-0.z-50.w-72 > div {
            background: var(--glass-card) !important;
            backdrop-filter: blur(20px) !important;
            border-right: 1px solid var(--glass-border) !important;
        }

        /* Top bar */
        .glass-theme .sticky.top-0 {
            background: var(--glass-card) !important;
            backdrop-filter: blur(20px) !important;
            border-color: var(--glass-border) !important;
        }

        /* Cards */
        .glass-theme .bg-white {
            background: var(--glass-card) !important;
            backdrop-filter: blur(10px) !important;
            border-color: var(--glass-border) !important;
        }

        /* Text colors */
        .glass-theme .text-gray-900,
        .glass-theme .text-gray-800 {
            color: var(--glass-text) !important;
        }

        .glass-theme .text-gray-700,
        .glass-theme .text-gray-600,
        .glass-theme .text-gray-500 {
            color: var(--glass-text-muted) !important;
        }

        /* Input fields */
        .glass-theme input,
        .glass-theme select,
        .glass-theme textarea {
            background: rgba(15, 23, 42, 0.6) !important;
            border-color: var(--glass-border) !important;
            color: var(--glass-text) !important;
        }

        .glass-theme input::placeholder,
        .glass-theme textarea::placeholder {
            color: var(--glass-text-muted) !important;
        }

        .glass-theme input:focus,
        .glass-theme select:focus,
        .glass-theme textarea:focus {
            border-color: var(--glass-accent) !important;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.3) !important;
        }

        /* Tables */
        .glass-theme table {
            background: transparent !important;
        }

        .glass-theme thead {
            background: rgba(15, 23, 42, 0.5) !important;
        }

        .glass-theme tbody tr {
            border-color: var(--glass-border) !important;
        }

        .glass-theme tbody tr:hover {
            background: rgba(139, 92, 246, 0.1) !important;
        }

        /* Buttons - primary stays the same, secondary gets glass look */
        .glass-theme .border-gray-300 {
            border-color: var(--glass-border) !important;
            background: rgba(255, 255, 255, 0.05) !important;
            color: var(--glass-text) !important;
        }

        .glass-theme .border-gray-300:hover {
            background: rgba(255, 255, 255, 0.1) !important;
        }

        /* Modals */
        .glass-theme .fixed.inset-0 .bg-white {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.98) 100%) !important;
            backdrop-filter: blur(20px) !important;
            border: 1px solid var(--glass-border) !important;
        }

        /* Dividers */
        .glass-theme .border-gray-200,
        .glass-theme .divide-gray-200 > * {
            border-color: var(--glass-border) !important;
        }

        /* KPI Cards special styling */
        .glass-theme .kpi-card {
            background: var(--glass-card) !important;
            backdrop-filter: blur(10px) !important;
            border: 1px solid var(--glass-border) !important;
        }

        /* Status badges - keep their colors but add glass effect */
        .glass-theme [class*="bg-green-100"],
        .glass-theme [class*="bg-yellow-100"],
        .glass-theme [class*="bg-red-100"],
        .glass-theme [class*="bg-blue-100"],
        .glass-theme [class*="bg-purple-100"],
        .glass-theme [class*="bg-gray-100"] {
            backdrop-filter: blur(4px) !important;
        }

        /* Sidebar navigation items */
        .glass-theme nav a {
            color: var(--glass-text-muted) !important;
        }

        .glass-theme nav a:hover,
        .glass-theme nav a.active {
            background: rgba(139, 92, 246, 0.2) !important;
            color: var(--glass-text) !important;
        }

        /* Search input in top bar */
        .glass-theme #search-field {
            background: transparent !important;
        }

        /* Tab navigation */
        .glass-theme .border-b.border-gray-200 button {
            color: var(--glass-text-muted) !important;
        }

        .glass-theme .border-b.border-gray-200 button.border-blue-500 {
            color: var(--glass-accent) !important;
            border-color: var(--glass-accent) !important;
        }

        /* Disabled inputs */
        .glass-theme input:disabled,
        .glass-theme select:disabled {
            background: rgba(15, 23, 42, 0.3) !important;
            color: var(--glass-text-muted) !important;
        }

        /* Dropdown menus */
        .glass-theme .absolute.right-0.z-10 {
            background: var(--glass-card) !important;
            backdrop-filter: blur(20px) !important;
            border: 1px solid var(--glass-border) !important;
        }

        .glass-theme .absolute.right-0.z-10 a:hover {
            background: rgba(139, 92, 246, 0.2) !important;
        }
    </style>

    <!-- Theme initialization (before Alpine loads) - prevents FOUC -->
    <script>
        (function() {
            var root = document.documentElement;
            var theme = localStorage.getItem('servishub-theme') || 'light';
            if (theme === 'glass') {
                root.classList.add('glass-theme');
            }
            // Mark theme as ready to show body immediately
            root.classList.add('theme-ready');
        })();
    </script>

    {% block head %}{% endblock %}
</head>
<body class="h-full bg-gray-50" x-data="{ sidebarOpen: false }">
    {% block body %}
    <div class="min-h-full">
        {% block content %}{% endblock %}
    </div>
    {% endblock %}

    <!-- Toast notifications -->
    <div x-data="toastNotifications()"
         x-on:toast.window="addToast($event.detail)"
         class="fixed bottom-4 right-4 z-50 space-y-2">
        <template x-for="toast in toasts" :key="toast.id">
            <div x-show="toast.visible"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-2"
                 x-transition:enter-end="opacity-100 translate-y-0"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 :class="{
                     'bg-green-500': toast.type === 'success',
                     'bg-red-500': toast.type === 'error',
                     'bg-yellow-500': toast.type === 'warning',
                     'bg-blue-500': toast.type === 'info'
                 }"
                 class="px-4 py-3 rounded-lg shadow-lg text-white flex items-center space-x-3">
                <span x-text="toast.message"></span>
                <button @click="removeToast(toast.id)" class="ml-2 hover:opacity-75">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </template>
    </div>

    <script>
        // Toast notifications system
        function toastNotifications() {
            return {
                toasts: [],
                addToast(detail) {
                    const id = Date.now();
                    this.toasts.push({
                        id,
                        message: detail.message,
                        type: detail.type || 'info',
                        visible: true
                    });
                    setTimeout(() => this.removeToast(id), 5000);
                },
                removeToast(id) {
                    const toast = this.toasts.find(t => t.id === id);
                    if (toast) toast.visible = false;
                    setTimeout(() => {
                        this.toasts = this.toasts.filter(t => t.id !== id);
                    }, 300);
                }
            }
        }

        // Global fetch helper with auth
        // Supports: api('/path') or api('/path', 'POST', data) or api('/path', {method, body})
        async function api(url, methodOrOptions = 'GET', data = null) {
            // Add /api/v1 prefix if not already present
            if (!url.startsWith('/api/v1/') && !url.startsWith('/api/v1?')) {
                if (url.startsWith('/api/')) {
                    // Already has /api/ but not /api/v1/
                    url = '/api/v1' + url.substring(4);
                } else {
                    url = '/api/v1' + url;
                }
            }

            // Handle both api(url, method, data) and api(url, options) formats
            let options = {};
            if (typeof methodOrOptions === 'string') {
                options.method = methodOrOptions;
                if (data) {
                    options.body = JSON.stringify(data);
                }
            } else {
                options = methodOrOptions;
            }

            const token = localStorage.getItem('access_token');
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch(url, { ...options, headers });

            if (response.status === 401) {
                // Try refresh token
                const refreshed = await refreshToken();
                if (refreshed) {
                    headers['Authorization'] = `Bearer ${localStorage.getItem('access_token')}`;
                    return fetch(url, { ...options, headers });
                } else {
                    window.location.href = '/login';
                }
            }

            return response;
        }

        async function refreshToken() {
            const refreshToken = localStorage.getItem('refresh_token');
            if (!refreshToken) return false;

            try {
                const response = await fetch('/api/v1/auth/refresh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refresh_token: refreshToken })
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('access_token', data.access_token);
                    localStorage.setItem('refresh_token', data.refresh_token);
                    return true;
                }
            } catch (e) {
                console.error('Token refresh failed:', e);
            }

            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            return false;
        }

        // Show toast helper
        function showToast(message, type = 'info') {
            window.dispatchEvent(new CustomEvent('toast', {
                detail: { message, type }
            }));
        }
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
