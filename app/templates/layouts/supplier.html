{% extends "layouts/base.html" %}

{% block body %}
<div class="min-h-full" x-data="supplierApp()" x-init="init()">

    <!-- Mobile sidebar backdrop -->
    <div x-show="sidebarOpen"
         x-transition:enter="transition-opacity ease-linear duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition-opacity ease-linear duration-300"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-gray-900/80 z-40 lg:hidden"
         @click="sidebarOpen = false"></div>

    <!-- Mobile sidebar -->
    <div x-show="sidebarOpen"
         x-transition:enter="transition ease-in-out duration-300 transform"
         x-transition:enter-start="-translate-x-full"
         x-transition:enter-end="translate-x-0"
         x-transition:leave="transition ease-in-out duration-300 transform"
         x-transition:leave-start="translate-x-0"
         x-transition:leave-end="-translate-x-full"
         class="fixed inset-y-0 left-0 z-50 w-72 bg-white lg:hidden">
        {% include "components/supplier_sidebar.html" %}
    </div>

    <!-- Desktop sidebar -->
    <div class="hidden lg:fixed lg:inset-y-0 lg:z-50 lg:flex lg:w-72 lg:flex-col">
        {% include "components/supplier_sidebar.html" %}
    </div>

    <!-- Main content -->
    <div class="lg:pl-72">
        <!-- Top bar -->
        <div class="sticky top-0 z-40 flex h-16 shrink-0 items-center gap-x-4 border-b border-gray-200 bg-white px-4 shadow-sm sm:gap-x-6 sm:px-6 lg:px-8">

            <!-- Mobile menu button -->
            <button type="button" class="lg:hidden -m-2.5 p-2.5 text-gray-700" @click="sidebarOpen = true">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
            </button>

            <!-- Separator -->
            <div class="h-6 w-px bg-gray-200 lg:hidden"></div>

            <div class="flex flex-1 gap-x-4 self-stretch lg:gap-x-6">
                <!-- Search -->
                <div class="flex flex-1"></div>

                <div class="flex items-center gap-x-4 lg:gap-x-6">
                    <!-- Notifications -->
                    <button type="button" class="-m-2.5 p-2.5 text-gray-400 hover:text-gray-500">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" />
                        </svg>
                    </button>

                    <!-- Separator -->
                    <div class="hidden lg:block lg:h-6 lg:w-px lg:bg-gray-200"></div>

                    <!-- Profile dropdown -->
                    <div class="relative" x-data="{ open: false }">
                        <button type="button" class="-m-1.5 flex items-center p-1.5" @click="open = !open">
                            <span class="sr-only">Open user menu</span>
                            <div class="h-8 w-8 rounded-full bg-purple-600 flex items-center justify-center text-white font-medium" x-text="user?.ime?.charAt(0) || 'S'"></div>
                            <span class="hidden lg:flex lg:items-center">
                                <span class="ml-4 text-sm font-semibold text-gray-900" x-text="user?.ime + ' ' + user?.prezime"></span>
                                <svg class="ml-2 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                                </svg>
                            </span>
                        </button>

                        <div x-show="open" @click.away="open = false"
                             x-transition
                             class="absolute right-0 z-10 mt-2.5 w-48 origin-top-right rounded-md bg-white py-2 shadow-lg ring-1 ring-gray-900/5">
                            <a href="/supplier/settings" class="block px-3 py-1 text-sm text-gray-900 hover:bg-gray-50">Podesavanja</a>
                            <a href="#" @click.prevent="logout()" class="block px-3 py-1 text-sm text-gray-900 hover:bg-gray-50">Odjavi se</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page content -->
        <main class="py-6">
            <div class="px-4 sm:px-6 lg:px-8">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>
</div>

<script>
function supplierApp() {
    return {
        user: null,
        supplier: null,
        sidebarOpen: false,
        loading: true,

        async init() {
            await this.loadUser();
        },

        async loadUser() {
            try {
                const data = await supplierApi('/auth/me');
                this.user = data.user;
                this.supplier = data.supplier;
            } catch (e) {
                console.error('Failed to load user:', e);
                window.location.href = '/supplier/login';
            } finally {
                this.loading = false;
            }
        },

        async logout() {
            try {
                await supplierApi('/auth/logout', 'POST');
            } catch (e) {}

            localStorage.removeItem('supplier_access_token');
            localStorage.removeItem('supplier_refresh_token');
            window.location.href = '/supplier/login';
        }
    }
}

// Supplier API helper
async function supplierApi(endpoint, method = 'GET', data = null) {
    const token = localStorage.getItem('supplier_access_token');
    if (!token) {
        window.location.href = '/supplier/login';
        throw new Error('Not authenticated');
    }

    const options = {
        method,
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    };

    if (data) {
        options.body = JSON.stringify(data);
    }

    const response = await fetch(`/api/supplier${endpoint}`, options);

    if (response.status === 401) {
        // Try refresh
        const refreshed = await refreshSupplierToken();
        if (refreshed) {
            return supplierApi(endpoint, method, data);
        }
        window.location.href = '/supplier/login';
        throw new Error('Session expired');
    }

    const result = await response.json();
    if (!response.ok) {
        throw new Error(result.error || 'Request failed');
    }
    return result;
}

async function refreshSupplierToken() {
    const refreshToken = localStorage.getItem('supplier_refresh_token');
    if (!refreshToken) return false;

    try {
        const response = await fetch('/api/supplier/auth/refresh', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ refresh_token: refreshToken })
        });

        if (response.ok) {
            const data = await response.json();
            localStorage.setItem('supplier_access_token', data.access_token);
            localStorage.setItem('supplier_refresh_token', data.refresh_token);
            return true;
        }
    } catch (e) {}
    return false;
}
</script>
{% endblock %}
