{% extends "layouts/base.html" %}

{% block title %}Podesavanja - ServisHub Admin{% endblock %}

{% block head %}
{% include "admin/_admin_styles.html" %}
{% endblock %}

{% block content %}
<div :class="{'admin-glass': theme === 'glass', 'admin-light': theme === 'light'}"
     x-data="settingsPage()" x-init="init()">
    <div class="admin-wrapper min-h-screen bg-gray-100">
        {% set active_page = 'settings' %}
        {% include "admin/_sidebar.html" %}

        <!-- Main content -->
        <div class="ml-64">
            <div class="admin-topbar bg-white shadow-sm h-16 flex items-center justify-between px-8">
                <h1 class="text-xl font-semibold text-gray-900">Podesavanja platforme</h1>
                <div class="flex items-center space-x-4">
                    <!-- Theme Toggle -->
                    <div class="flex items-center space-x-2">
                        <button @click="setTheme('light')"
                                :class="{'ring-2 ring-red-500 ring-offset-2': theme === 'light'}"
                                class="theme-btn p-2 rounded-lg bg-white border border-gray-200 hover:border-gray-300"
                                title="Svetla tema">
                            <svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0z"/>
                            </svg>
                        </button>
                        <button @click="setTheme('glass')"
                                :class="{'ring-2 ring-red-500 ring-offset-2': theme === 'glass'}"
                                class="theme-btn p-2 rounded-lg bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-600 hover:border-gray-500"
                                title="Glassmorphism tema">
                            <svg class="w-4 h-4 text-purple-400" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="p-8">
                <!-- Theme Selection Card -->
                <div class="admin-card bg-white rounded-lg shadow p-6 mb-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Izgled panela</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Light Theme Preview -->
                        <div @click="setTheme('light')"
                             :class="{'ring-2 ring-red-500': theme === 'light'}"
                             class="cursor-pointer rounded-xl overflow-hidden border-2 border-gray-200 hover:border-gray-300 transition-all">
                            <div class="bg-gray-100 p-4">
                                <div class="flex">
                                    <div class="w-16 bg-gray-800 rounded-l-lg h-24"></div>
                                    <div class="flex-1 bg-white rounded-r-lg p-2">
                                        <div class="h-3 bg-gray-200 rounded w-3/4 mb-2"></div>
                                        <div class="h-2 bg-gray-100 rounded w-1/2"></div>
                                        <div class="mt-3 grid grid-cols-2 gap-1">
                                            <div class="h-6 bg-gray-50 rounded border"></div>
                                            <div class="h-6 bg-gray-50 rounded border"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white px-4 py-3 flex items-center justify-between">
                                <span class="font-medium text-gray-900">Svetla tema</span>
                                <div x-show="theme === 'light'" class="w-5 h-5 bg-red-500 rounded-full flex items-center justify-center">
                                    <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Glass Theme Preview -->
                        <div @click="setTheme('glass')"
                             :class="{'ring-2 ring-red-500': theme === 'glass'}"
                             class="cursor-pointer rounded-xl overflow-hidden border-2 border-gray-200 hover:border-gray-300 transition-all">
                            <div class="bg-gradient-to-br from-slate-900 via-purple-950 to-slate-900 p-4">
                                <div class="flex">
                                    <div class="w-16 bg-white/10 backdrop-blur rounded-l-lg h-24 border border-white/10"></div>
                                    <div class="flex-1 bg-white/10 backdrop-blur rounded-r-lg p-2 border border-white/10">
                                        <div class="h-3 bg-white/20 rounded w-3/4 mb-2"></div>
                                        <div class="h-2 bg-white/10 rounded w-1/2"></div>
                                        <div class="mt-3 grid grid-cols-2 gap-1">
                                            <div class="h-6 bg-white/5 rounded border border-white/10"></div>
                                            <div class="h-6 bg-white/5 rounded border border-white/10"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gradient-to-r from-slate-800 to-slate-900 px-4 py-3 flex items-center justify-between">
                                <span class="font-medium text-white">Glassmorphism</span>
                                <div x-show="theme === 'glass'" class="w-5 h-5 bg-red-500 rounded-full flex items-center justify-center">
                                    <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <form @submit.prevent="saveSettings" class="space-y-6">
                    <div class="admin-card bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Cenovnik</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Bazni paket (RSD/mesec)</label>
                                <input type="number" x-model="form.base_price" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Dodatna lokacija (RSD/mesec)</label>
                                <input type="number" x-model="form.location_price" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                            </div>
                        </div>
                    </div>

                    <div class="admin-card bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Trial i pretplate</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Trial period (dani)</label>
                                <input type="number" x-model="form.trial_days" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Grace period (dani)</label>
                                <input type="number" x-model="form.grace_period_days" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                            </div>
                        </div>
                    </div>

                    <div class="admin-card bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Dobavljaci</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Default provizija (%)</label>
                                <input type="number" x-model="form.default_commission" step="0.1" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end">
                        <button type="submit" :disabled="saving" class="btn-primary px-6 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-500 disabled:opacity-50 transition-colors">
                            <span x-show="!saving">Sacuvaj podesavanja</span>
                            <span x-show="saving">Cuvanje...</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function settingsPage() {
    return {
        loading: true,
        saving: false,
        theme: localStorage.getItem('admin-theme') || 'light',
        form: {
            base_price: 3600,
            location_price: 1800,
            trial_days: 90,
            grace_period_days: 7,
            default_commission: 5
        },

        init() {
            this.loadSettings();
        },

        setTheme(newTheme) {
            this.theme = newTheme;
            localStorage.setItem('admin-theme', newTheme);
        },

        logout() {
            localStorage.removeItem('admin_access_token');
            localStorage.removeItem('admin_refresh_token');
            window.location.href = '/admin/login';
        },

        async loadSettings() {
            const token = localStorage.getItem('admin_access_token');
            if (!token) {
                window.location.href = '/admin/login';
                return;
            }
            try {
                const r = await fetch('/api/admin/settings', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (r.ok) {
                    const data = await r.json();
                    Object.assign(this.form, data);
                } else if (r.status === 401) {
                    window.location.href = '/admin/login';
                }
            } catch (e) {
                console.error(e);
            } finally {
                this.loading = false;
            }
        },

        async saveSettings() {
            this.saving = true;
            const token = localStorage.getItem('admin_access_token');
            try {
                await fetch('/api/admin/settings', {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(this.form)
                });
                alert('Podesavanja sacuvana!');
            } catch (e) {
                console.error(e);
                alert('Greska pri cuvanju');
            } finally {
                this.saving = false;
            }
        }
    }
}
</script>
{% endblock %}
