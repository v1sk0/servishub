{% extends "layouts/base.html" %}

{% block title %}Podesavanja - ServisHub Admin{% endblock %}

{% block head %}
{% include "admin/_admin_styles.html" %}
{% endblock %}

{% block content %}
<div :class="{'admin-glass': theme === 'glass', 'admin-light': theme === 'light'}"
     x-data="settingsPage()" x-init="init()">
    <div class="admin-wrapper min-h-screen bg-gray-100">
        {% set active_page = 'settings' %}
        {% include "admin/_sidebar.html" %}

        <!-- Main content -->
        <div class="ml-64">
            <div class="admin-topbar bg-white shadow-sm h-16 flex items-center justify-between px-8">
                <h1 class="text-xl font-semibold text-gray-900">Podesavanja platforme</h1>
                <div class="flex items-center space-x-4">
                    <!-- Theme Toggle -->
                    <div class="flex items-center space-x-2">
                        <button @click="setTheme('light')"
                                :class="{'ring-2 ring-red-500 ring-offset-2': theme === 'light'}"
                                class="theme-btn p-2 rounded-lg bg-white border border-gray-200 hover:border-gray-300"
                                title="Svetla tema">
                            <svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0z"/>
                            </svg>
                        </button>
                        <button @click="setTheme('glass')"
                                :class="{'ring-2 ring-red-500 ring-offset-2': theme === 'glass'}"
                                class="theme-btn p-2 rounded-lg bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-600 hover:border-gray-500"
                                title="Glassmorphism tema">
                            <svg class="w-4 h-4 text-purple-400" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="p-8">
                <!-- Theme Selection Card -->
                <div class="admin-card bg-white rounded-lg shadow p-6 mb-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Izgled panela</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Light Theme Preview -->
                        <div @click="setTheme('light')"
                             :class="{'ring-2 ring-red-500': theme === 'light'}"
                             class="cursor-pointer rounded-xl overflow-hidden border-2 border-gray-200 hover:border-gray-300 transition-all">
                            <div class="bg-gray-100 p-4">
                                <div class="flex">
                                    <div class="w-16 bg-gray-800 rounded-l-lg h-24"></div>
                                    <div class="flex-1 bg-white rounded-r-lg p-2">
                                        <div class="h-3 bg-gray-200 rounded w-3/4 mb-2"></div>
                                        <div class="h-2 bg-gray-100 rounded w-1/2"></div>
                                        <div class="mt-3 grid grid-cols-2 gap-1">
                                            <div class="h-6 bg-gray-50 rounded border"></div>
                                            <div class="h-6 bg-gray-50 rounded border"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white px-4 py-3 flex items-center justify-between">
                                <span class="font-medium text-gray-900">Svetla tema</span>
                                <div x-show="theme === 'light'" class="w-5 h-5 bg-red-500 rounded-full flex items-center justify-center">
                                    <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Glass Theme Preview -->
                        <div @click="setTheme('glass')"
                             :class="{'ring-2 ring-red-500': theme === 'glass'}"
                             class="cursor-pointer rounded-xl overflow-hidden border-2 border-gray-200 hover:border-gray-300 transition-all">
                            <div class="bg-gradient-to-br from-slate-900 via-purple-950 to-slate-900 p-4">
                                <div class="flex">
                                    <div class="w-16 bg-white/10 backdrop-blur rounded-l-lg h-24 border border-white/10"></div>
                                    <div class="flex-1 bg-white/10 backdrop-blur rounded-r-lg p-2 border border-white/10">
                                        <div class="h-3 bg-white/20 rounded w-3/4 mb-2"></div>
                                        <div class="h-2 bg-white/10 rounded w-1/2"></div>
                                        <div class="mt-3 grid grid-cols-2 gap-1">
                                            <div class="h-6 bg-white/5 rounded border border-white/10"></div>
                                            <div class="h-6 bg-white/5 rounded border border-white/10"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gradient-to-r from-slate-800 to-slate-900 px-4 py-3 flex items-center justify-between">
                                <span class="font-medium text-white">Glassmorphism</span>
                                <div x-show="theme === 'glass'" class="w-5 h-5 bg-red-500 rounded-full flex items-center justify-center">
                                    <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2FA Security Section -->
                <div class="admin-card bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-lg font-medium text-gray-900">Dvofaktorska autentifikacija (2FA)</h3>
                            <p class="text-sm text-gray-500">Dodatna zastita vaseg admin naloga</p>
                        </div>
                        <div x-show="!twoFA.loading">
                            <span x-show="twoFA.enabled" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                                <svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                                Aktivirano
                            </span>
                            <span x-show="!twoFA.enabled" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                                <svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                </svg>
                                Nije aktivirano
                            </span>
                        </div>
                    </div>

                    <!-- 2FA Not Enabled - Setup Flow -->
                    <div x-show="!twoFA.enabled && !twoFA.setupInProgress">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                            <div class="flex">
                                <svg class="w-5 h-5 text-yellow-400 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                </svg>
                                <div class="ml-3">
                                    <h4 class="text-sm font-medium text-yellow-800">Preporucujemo aktiviranje 2FA</h4>
                                    <p class="text-sm text-yellow-700 mt-1">
                                        Dvofaktorska autentifikacija dodatno stiti vas nalog od neovlascenog pristupa.
                                    </p>
                                </div>
                            </div>
                        </div>
                        <button @click="start2FASetup()" :disabled="twoFA.loading"
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 disabled:opacity-50">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                            </svg>
                            Aktiviraj 2FA
                        </button>
                    </div>

                    <!-- 2FA Setup In Progress -->
                    <div x-show="twoFA.setupInProgress" class="space-y-4">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-blue-800 mb-2">Koraci za aktivaciju:</h4>
                            <ol class="list-decimal list-inside text-sm text-blue-700 space-y-1">
                                <li>Instalirajte autentifikator aplikaciju (Google Authenticator, Authy, 1Password...)</li>
                                <li>Skenirajte QR kod ispod ili unesite kljuc rucno</li>
                                <li>Unesite 6-cifreni kod iz aplikacije</li>
                            </ol>
                        </div>

                        <!-- QR Code -->
                        <div class="flex flex-col items-center py-4">
                            <div class="bg-white p-4 rounded-lg shadow-inner border-2 border-gray-200">
                                <img x-show="twoFA.qrCode" :src="'data:image/png;base64,' + twoFA.qrCode"
                                     alt="QR kod za 2FA" class="w-48 h-48">
                                <div x-show="!twoFA.qrCode" class="w-48 h-48 flex items-center justify-center bg-gray-100">
                                    <svg class="animate-spin h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500 mt-2">Skenirajte ovaj QR kod</p>
                        </div>

                        <!-- Manual Key -->
                        <div x-show="twoFA.secret" class="bg-gray-50 rounded-lg p-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ili unesite kljuc rucno:</label>
                            <div class="flex items-center">
                                <code class="flex-1 px-3 py-2 bg-white border border-gray-300 rounded-l-md text-sm font-mono" x-text="twoFA.secret"></code>
                                <button @click="copySecret()" class="px-3 py-2 border border-l-0 border-gray-300 rounded-r-md bg-gray-100 hover:bg-gray-200">
                                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Verification Code Input -->
                        <div class="pt-4 border-t border-gray-200">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Unesite kod iz aplikacije:</label>
                            <div class="flex space-x-3">
                                <input type="text" x-model="twoFA.verificationCode"
                                       maxlength="6" pattern="[0-9]*" inputmode="numeric"
                                       placeholder="000000"
                                       class="block w-32 px-4 py-2 text-center text-xl font-mono tracking-widest border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                                <button @click="verify2FA()" :disabled="twoFA.verificationCode.length !== 6 || twoFA.loading"
                                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50">
                                    <span x-show="!twoFA.loading">Verifikuj i aktiviraj</span>
                                    <span x-show="twoFA.loading">Provera...</span>
                                </button>
                                <button @click="cancel2FASetup()" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800">
                                    Odustani
                                </button>
                            </div>
                            <p x-show="twoFA.error" class="mt-2 text-sm text-red-600" x-text="twoFA.error"></p>
                        </div>
                    </div>

                    <!-- 2FA Enabled - Management -->
                    <div x-show="twoFA.enabled && !twoFA.setupInProgress" class="space-y-4">
                        <div class="bg-green-900 rounded-lg p-4">
                            <div class="flex">
                                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                                <div class="ml-3">
                                    <h4 class="text-sm font-medium text-white">2FA je aktivirano</h4>
                                    <p class="text-sm text-white/90 mt-1">
                                        Vas nalog je zasticen dvofaktorskom autentifikacijom.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Backup Codes Section -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <h4 class="text-sm font-medium text-gray-900">Backup kodovi</h4>
                                    <p class="text-xs text-gray-500">Koristite ako izgubite pristup autentifikator aplikaciji</p>
                                </div>
                                <button @click="showBackupCodesModal = true"
                                        class="text-sm text-red-600 hover:text-red-700 font-medium">
                                    Regenerisi kodove
                                </button>
                            </div>
                        </div>

                        <!-- Disable 2FA -->
                        <div class="pt-4 border-t border-gray-200">
                            <button @click="showDisable2FAModal = true"
                                    class="text-sm text-red-600 hover:text-red-700 font-medium">
                                Deaktiviraj 2FA
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Backup Codes Modal -->
                <div x-show="showBackupCodesModal" x-cloak
                     class="fixed inset-0 z-50 overflow-y-auto" aria-modal="true">
                    <div class="flex items-center justify-center min-h-screen px-4">
                        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showBackupCodesModal = false"></div>
                        <div class="relative bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Regenerisi backup kodove</h3>

                            <div x-show="!twoFA.newBackupCodes">
                                <p class="text-sm text-gray-500 mb-4">Unesite kod iz autentifikator aplikacije za potvrdu:</p>
                                <input type="text" x-model="twoFA.backupVerificationCode"
                                       maxlength="6" pattern="[0-9]*" inputmode="numeric"
                                       placeholder="000000"
                                       class="block w-full px-4 py-2 text-center text-xl font-mono tracking-widest border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500 mb-4">
                                <div class="flex justify-end space-x-3">
                                    <button @click="showBackupCodesModal = false" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800">
                                        Odustani
                                    </button>
                                    <button @click="regenerateBackupCodes()" :disabled="twoFA.backupVerificationCode.length !== 6 || twoFA.loading"
                                            class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 disabled:opacity-50">
                                        Regenerisi
                                    </button>
                                </div>
                            </div>

                            <div x-show="twoFA.newBackupCodes">
                                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                                    <p class="text-sm text-yellow-800 font-medium">SACUVAJTE OVE KODOVE!</p>
                                    <p class="text-xs text-yellow-700">Prikazuju se samo jednom. Stari kodovi vise ne vaze.</p>
                                </div>
                                <div class="grid grid-cols-2 gap-2 mb-4">
                                    <template x-for="code in twoFA.newBackupCodes" :key="code">
                                        <code class="px-3 py-2 bg-gray-100 rounded text-center font-mono text-sm" x-text="code"></code>
                                    </template>
                                </div>
                                <button @click="closeBackupCodesModal()"
                                        class="w-full px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700">
                                    Sacuvao sam kodove
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Disable 2FA Modal -->
                <div x-show="showDisable2FAModal" x-cloak
                     class="fixed inset-0 z-50 overflow-y-auto" aria-modal="true">
                    <div class="flex items-center justify-center min-h-screen px-4">
                        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showDisable2FAModal = false"></div>
                        <div class="relative bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Deaktiviraj 2FA</h3>
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                                <p class="text-sm text-red-800">
                                    <strong>Upozorenje:</strong> Deaktiviranje 2FA ce smanjiti sigurnost vaseg naloga.
                                </p>
                            </div>
                            <p class="text-sm text-gray-500 mb-4">Unesite vasu lozinku za potvrdu:</p>
                            <input type="password" x-model="twoFA.disablePassword"
                                   placeholder="Lozinka"
                                   class="block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500 mb-4">
                            <p x-show="twoFA.disableError" class="text-sm text-red-600 mb-4" x-text="twoFA.disableError"></p>
                            <div class="flex justify-end space-x-3">
                                <button @click="showDisable2FAModal = false" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800">
                                    Odustani
                                </button>
                                <button @click="disable2FA()" :disabled="!twoFA.disablePassword || twoFA.loading"
                                        class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 disabled:opacity-50">
                                    Deaktiviraj
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Company Data Card -->
                <div class="admin-card bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-medium text-gray-900">Podaci o firmi ServisHub</h3>
                                <p class="text-sm text-gray-500">Informacije koje se prikazuju na fakturama i notifikacijama</p>
                            </div>
                        </div>
                        <button @click="openCompanyModal()"
                                class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                            Izmeni
                        </button>
                    </div>

                    <!-- Company Data Preview -->
                    <div x-show="!companyLoading" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-3">
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wider">Naziv firme</p>
                                <p class="text-sm font-medium text-gray-900" x-text="company.name || '-'"></p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wider">Adresa</p>
                                <p class="text-sm font-medium text-gray-900" x-text="company.address || '-'"></p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wider">Grad</p>
                                <p class="text-sm font-medium text-gray-900" x-text="(company.postal_code ? company.postal_code + ' ' : '') + (company.city || '-')"></p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wider">PIB / Maticni broj</p>
                                <p class="text-sm font-medium text-gray-900" x-text="(company.pib || '-') + ' / ' + (company.mb || '-')"></p>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wider">Telefon</p>
                                <p class="text-sm font-medium text-gray-900" x-text="company.phone || '-'"></p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wider">Email</p>
                                <p class="text-sm font-medium text-gray-900" x-text="company.email || '-'"></p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wider">Web sajt</p>
                                <p class="text-sm font-medium text-gray-900" x-text="company.website || '-'"></p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wider">Banka / Racun</p>
                                <p class="text-sm font-medium text-gray-900" x-text="(company.bank_name || '-') + ' - ' + (company.bank_account || '-')"></p>
                            </div>
                        </div>
                    </div>
                    <div x-show="companyLoading" class="flex justify-center py-8">
                        <svg class="animate-spin h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                </div>

                <!-- Company Data Modal -->
                <div x-show="showCompanyModal" x-cloak
                     class="fixed inset-0 z-50 overflow-y-auto" aria-modal="true">
                    <div class="flex items-center justify-center min-h-screen px-4 py-6">
                        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showCompanyModal = false"></div>
                        <div class="relative bg-white rounded-lg shadow-xl max-w-2xl w-full p-6">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                        </svg>
                                    </div>
                                    <h3 class="text-lg font-medium text-gray-900">Podaci o firmi ServisHub</h3>
                                </div>
                                <button @click="showCompanyModal = false" class="text-gray-400 hover:text-gray-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>

                            <form @submit.prevent="saveCompany()">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                    <!-- Naziv firme -->
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Naziv firme</label>
                                        <input type="text" x-model="companyForm.company_name"
                                               class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm"
                                               placeholder="ServisHub DOO">
                                    </div>

                                    <!-- Adresa -->
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Adresa</label>
                                        <input type="text" x-model="companyForm.company_address"
                                               class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm"
                                               placeholder="Ulica i broj">
                                    </div>

                                    <!-- Grad -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Grad</label>
                                        <input type="text" x-model="companyForm.company_city"
                                               class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm"
                                               placeholder="Beograd">
                                    </div>

                                    <!-- Postanski broj -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Postanski broj</label>
                                        <input type="text" x-model="companyForm.company_postal_code"
                                               class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm"
                                               placeholder="11000">
                                    </div>

                                    <!-- Drzava -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Drzava</label>
                                        <input type="text" x-model="companyForm.company_country"
                                               class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm"
                                               placeholder="Srbija">
                                    </div>

                                    <!-- PIB -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">PIB</label>
                                        <input type="text" x-model="companyForm.company_pib"
                                               class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm"
                                               placeholder="123456789">
                                    </div>

                                    <!-- Maticni broj -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Maticni broj</label>
                                        <input type="text" x-model="companyForm.company_mb"
                                               class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm"
                                               placeholder="12345678">
                                    </div>

                                    <!-- Telefon -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Telefon</label>
                                        <input type="text" x-model="companyForm.company_phone"
                                               class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm"
                                               placeholder="+381 11 123 4567">
                                    </div>

                                    <!-- Email -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                        <input type="email" x-model="companyForm.company_email"
                                               class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm"
                                               placeholder="info@servishub.rs">
                                    </div>

                                    <!-- Web sajt -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Web sajt</label>
                                        <input type="text" x-model="companyForm.company_website"
                                               class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm"
                                               placeholder="https://servishub.rs">
                                    </div>

                                    <!-- Naziv banke -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Naziv banke</label>
                                        <input type="text" x-model="companyForm.company_bank_name"
                                               class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm"
                                               placeholder="AIK Banka">
                                    </div>

                                    <!-- Broj racuna -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Broj racuna</label>
                                        <input type="text" x-model="companyForm.company_bank_account"
                                               class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm"
                                               placeholder="265-1234567-89">
                                    </div>
                                </div>

                                <!-- Social Media Section -->
                                <div class="border-t border-gray-200 pt-4 mt-2">
                                    <h4 class="text-sm font-medium text-gray-900 mb-3">Drustvene mreze (za landing page)</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <!-- Facebook -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Facebook</label>
                                            <input type="url" x-model="companyForm.social_facebook"
                                                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm"
                                                   placeholder="https://facebook.com/servishub">
                                        </div>

                                        <!-- Instagram -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Instagram</label>
                                            <input type="url" x-model="companyForm.social_instagram"
                                                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm"
                                                   placeholder="https://instagram.com/servishub">
                                        </div>

                                        <!-- LinkedIn -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">LinkedIn</label>
                                            <input type="url" x-model="companyForm.social_linkedin"
                                                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm"
                                                   placeholder="https://linkedin.com/company/servishub">
                                        </div>

                                        <!-- Twitter/X -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Twitter/X</label>
                                            <input type="url" x-model="companyForm.social_twitter"
                                                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm"
                                                   placeholder="https://x.com/servishub">
                                        </div>

                                        <!-- YouTube -->
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">YouTube</label>
                                            <input type="url" x-model="companyForm.social_youtube"
                                                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm"
                                                   placeholder="https://youtube.com/@servishub">
                                        </div>
                                    </div>
                                </div>

                                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                                    <button type="button" @click="showCompanyModal = false"
                                            class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800">
                                        Odustani
                                    </button>
                                    <button type="submit" :disabled="companySaving"
                                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50">
                                        <svg x-show="companySaving" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                                        </svg>
                                        <span x-show="!companySaving">Sacuvaj</span>
                                        <span x-show="companySaving">Cuvanje...</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Packages Link -->
                <div class="admin-card bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <svg class="w-8 h-8 text-red-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <div>
                                <h3 class="text-lg font-medium text-gray-900">Paketi usluga i cenovnik</h3>
                                <p class="text-sm text-gray-500">Upravljanje cenama, trial periodima i provizijama</p>
                            </div>
                        </div>
                        <a href="/admin/paketi" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Otvori
                            <svg class="ml-2 -mr-1 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function settingsPage() {
    return {
        loading: false,
        theme: localStorage.getItem('admin-theme') || 'light',

        // 2FA State
        twoFA: {
            loading: false,
            enabled: false,
            setupInProgress: false,
            qrCode: null,
            secret: null,
            verificationCode: '',
            error: '',
            backupVerificationCode: '',
            newBackupCodes: null,
            disablePassword: '',
            disableError: ''
        },
        showBackupCodesModal: false,
        showDisable2FAModal: false,

        // Company Data State
        company: {
            name: '',
            address: '',
            city: '',
            postal_code: '',
            country: '',
            pib: '',
            mb: '',
            phone: '',
            email: '',
            website: '',
            bank_name: '',
            bank_account: '',
            // Social media links
            social_twitter: '',
            social_facebook: '',
            social_instagram: '',
            social_linkedin: '',
            social_youtube: ''
        },
        companyForm: {
            company_name: '',
            company_address: '',
            company_city: '',
            company_postal_code: '',
            company_country: '',
            company_pib: '',
            company_mb: '',
            company_phone: '',
            company_email: '',
            company_website: '',
            company_bank_name: '',
            company_bank_account: '',
            // Social media links
            social_twitter: '',
            social_facebook: '',
            social_instagram: '',
            social_linkedin: '',
            social_youtube: ''
        },
        companyLoading: true,
        companySaving: false,
        showCompanyModal: false,

        init() {
            this.checkAuth();
            this.load2FAStatus();
            this.loadCompanyData();
        },

        checkAuth() {
            const token = localStorage.getItem('admin_access_token');
            if (!token) {
                window.location.href = '/admin/login';
            }
        },

        setTheme(newTheme) {
            this.theme = newTheme;
            if (window.setAdminTheme) {
                window.setAdminTheme(newTheme);
            }
        },

        logout() {
            localStorage.removeItem('admin_access_token');
            localStorage.removeItem('admin_refresh_token');
            window.location.href = '/admin/login';
        },

        // =====================
        // 2FA Methods
        // =====================

        async load2FAStatus() {
            const token = localStorage.getItem('admin_access_token');
            if (!token) return;

            try {
                const r = await fetch('/api/admin/auth/2fa/status', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (r.ok) {
                    const data = await r.json();
                    this.twoFA.enabled = data.is_2fa_enabled;
                }
            } catch (e) {
                console.error('Failed to load 2FA status:', e);
            }
        },

        async start2FASetup() {
            this.twoFA.loading = true;
            this.twoFA.error = '';
            const token = localStorage.getItem('admin_access_token');

            try {
                const r = await fetch('/api/admin/auth/2fa/setup', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    }
                });

                if (r.ok) {
                    const data = await r.json();
                    this.twoFA.qrCode = data.qr_code;
                    this.twoFA.secret = data.secret;
                    this.twoFA.setupInProgress = true;
                } else {
                    const err = await r.json();
                    this.twoFA.error = err.message || 'Greska pri pokretanju 2FA setup-a';
                }
            } catch (e) {
                console.error(e);
                this.twoFA.error = 'Greska pri povezivanju sa serverom';
            } finally {
                this.twoFA.loading = false;
            }
        },

        async verify2FA() {
            this.twoFA.loading = true;
            this.twoFA.error = '';
            const token = localStorage.getItem('admin_access_token');

            try {
                const r = await fetch('/api/admin/auth/2fa/enable', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code: this.twoFA.verificationCode })
                });

                if (r.ok) {
                    const data = await r.json();
                    this.twoFA.enabled = true;
                    this.twoFA.setupInProgress = false;
                    this.twoFA.newBackupCodes = data.backup_codes;
                    this.showBackupCodesModal = true;
                    // Reset form
                    this.twoFA.qrCode = null;
                    this.twoFA.secret = null;
                    this.twoFA.verificationCode = '';
                } else {
                    const err = await r.json();
                    this.twoFA.error = err.message || 'Neispravan kod';
                }
            } catch (e) {
                console.error(e);
                this.twoFA.error = 'Greska pri povezivanju sa serverom';
            } finally {
                this.twoFA.loading = false;
            }
        },

        cancel2FASetup() {
            this.twoFA.setupInProgress = false;
            this.twoFA.qrCode = null;
            this.twoFA.secret = null;
            this.twoFA.verificationCode = '';
            this.twoFA.error = '';
        },

        copySecret() {
            navigator.clipboard.writeText(this.twoFA.secret).then(() => {
                alert('Kljuc kopiran u clipboard!');
            });
        },

        async regenerateBackupCodes() {
            this.twoFA.loading = true;
            const token = localStorage.getItem('admin_access_token');

            try {
                const r = await fetch('/api/admin/auth/2fa/backup-codes', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code: this.twoFA.backupVerificationCode })
                });

                if (r.ok) {
                    const data = await r.json();
                    this.twoFA.newBackupCodes = data.backup_codes;
                    this.twoFA.backupVerificationCode = '';
                } else {
                    const err = await r.json();
                    alert(err.message || 'Neispravan kod');
                }
            } catch (e) {
                console.error(e);
                alert('Greska pri povezivanju sa serverom');
            } finally {
                this.twoFA.loading = false;
            }
        },

        closeBackupCodesModal() {
            this.showBackupCodesModal = false;
            this.twoFA.newBackupCodes = null;
            this.twoFA.backupVerificationCode = '';
        },

        async disable2FA() {
            this.twoFA.loading = true;
            this.twoFA.disableError = '';
            const token = localStorage.getItem('admin_access_token');

            try {
                const r = await fetch('/api/admin/auth/2fa/disable', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password: this.twoFA.disablePassword })
                });

                if (r.ok) {
                    this.twoFA.enabled = false;
                    this.showDisable2FAModal = false;
                    this.twoFA.disablePassword = '';
                    alert('2FA je uspesno deaktiviran');
                } else {
                    const err = await r.json();
                    this.twoFA.disableError = err.message || 'Pogresna lozinka';
                }
            } catch (e) {
                console.error(e);
                this.twoFA.disableError = 'Greska pri povezivanju sa serverom';
            } finally {
                this.twoFA.loading = false;
            }
        },

        // =====================
        // Company Data Methods
        // =====================

        async loadCompanyData() {
            this.companyLoading = true;
            const token = localStorage.getItem('admin_access_token');
            if (!token) return;

            try {
                const r = await fetch('/api/admin/settings/company', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (r.ok) {
                    const data = await r.json();
                    this.company = data;
                }
            } catch (e) {
                console.error('Failed to load company data:', e);
            } finally {
                this.companyLoading = false;
            }
        },

        openCompanyModal() {
            // Popuni formu sa trenutnim podacima
            this.companyForm = {
                company_name: this.company.name || '',
                company_address: this.company.address || '',
                company_city: this.company.city || '',
                company_postal_code: this.company.postal_code || '',
                company_country: this.company.country || '',
                company_pib: this.company.pib || '',
                company_mb: this.company.mb || '',
                company_phone: this.company.phone || '',
                company_email: this.company.email || '',
                company_website: this.company.website || '',
                company_bank_name: this.company.bank_name || '',
                company_bank_account: this.company.bank_account || '',
                // Social media
                social_twitter: this.company.social_twitter || '',
                social_facebook: this.company.social_facebook || '',
                social_instagram: this.company.social_instagram || '',
                social_linkedin: this.company.social_linkedin || '',
                social_youtube: this.company.social_youtube || ''
            };
            this.showCompanyModal = true;
        },

        async saveCompany() {
            this.companySaving = true;
            const token = localStorage.getItem('admin_access_token');

            try {
                const r = await fetch('/api/admin/settings/company', {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(this.companyForm)
                });

                if (r.ok) {
                    const data = await r.json();
                    this.company = data.company;
                    this.showCompanyModal = false;
                    alert('Podaci o firmi uspesno azurirani');
                } else {
                    const err = await r.json();
                    alert(err.error || 'Greska pri cuvanju podataka');
                }
            } catch (e) {
                console.error(e);
                alert('Greska pri povezivanju sa serverom');
            } finally {
                this.companySaving = false;
            }
        }
    }
}
</script>
{% endblock %}
