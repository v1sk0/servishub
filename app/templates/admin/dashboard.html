{% extends "layouts/base.html" %}

{% block title %}Dashboard - ServisHub Admin{% endblock %}

{% block head %}
{% include "admin/_admin_styles.html" %}
{% endblock %}

{% block content %}
<div :class="{'admin-glass': theme === 'glass', 'admin-light': theme === 'light'}"
     x-data="adminDashboard()" x-init="loadData()">
    <div class="admin-wrapper min-h-screen bg-gray-100">
        {% set active_page = 'dashboard' %}
        {% include "admin/_sidebar.html" %}

        <!-- Main content -->
        <div class="ml-64">
            <!-- Top bar -->
            <div class="admin-topbar bg-white shadow-sm h-16 flex items-center justify-between px-8">
                <h1 class="text-xl font-semibold text-gray-900">Dashboard</h1>
                <div class="flex items-center space-x-4">
                    <!-- Theme Toggle -->
                    <div class="flex items-center space-x-2">
                        <button @click="setTheme('light')"
                                :class="{'ring-2 ring-red-500 ring-offset-2': theme === 'light'}"
                                class="theme-btn p-2 rounded-lg bg-white border border-gray-200 hover:border-gray-300"
                                title="Svetla tema">
                            <svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0z"/>
                            </svg>
                        </button>
                        <button @click="setTheme('glass')"
                                :class="{'ring-2 ring-red-500 ring-offset-2': theme === 'glass'}"
                                class="theme-btn p-2 rounded-lg bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-600 hover:border-gray-500"
                                title="Glassmorphism tema">
                            <svg class="w-4 h-4 text-purple-400" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"/>
                            </svg>
                        </button>
                    </div>
                    <span class="text-sm text-gray-600" x-text="admin?.email"></span>
                </div>
            </div>

            <!-- Content -->
            <div class="p-8">
                <!-- Stats -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Total tenants -->
                    <div class="stat-card blue admin-card bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-500">Ukupno servisa</p>
                                <p class="text-2xl font-bold text-gray-900" x-text="stats.total_tenants || 0"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Active tenants -->
                    <div class="stat-card green admin-card bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-500">Aktivni servisi</p>
                                <p class="text-2xl font-bold text-gray-900" x-text="stats.active_tenants || 0"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Pending KYC -->
                    <div class="stat-card yellow admin-card bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-yellow-500/20 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-500">Predstavnici na cekanju</p>
                                <p class="text-2xl font-bold text-gray-900" x-text="stats.pending_kyc || 0"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Revenue -->
                    <div class="stat-card purple admin-card bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-purple-500/20 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-500">Prihod ovog meseca</p>
                                <p class="text-2xl font-bold text-gray-900">
                                    <span x-text="formatPrice(stats.monthly_revenue || 0)"></span> RSD
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent activity -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Recent tenants -->
                    <div class="admin-card bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                            <h2 class="text-lg font-medium text-gray-900">Novi servisi</h2>
                            <a href="/admin/tenants" class="text-sm text-red-600 hover:text-red-700">Vidi sve</a>
                        </div>
                        <div class="divide-y divide-gray-200">
                            <template x-for="tenant in recentTenants" :key="tenant.id">
                                <div class="px-6 py-4 flex items-center justify-between">
                                    <div>
                                        <p class="font-medium text-gray-900" x-text="tenant.name"></p>
                                        <p class="text-sm text-gray-500" x-text="tenant.email"></p>
                                    </div>
                                    <span class="badge px-2 py-1 text-xs font-medium rounded-full"
                                          :class="{
                                              'bg-yellow-100 text-yellow-800': tenant.status === 'PENDING',
                                              'bg-purple-100 text-purple-800': tenant.status === 'DEMO',
                                              'bg-blue-100 text-blue-800': tenant.status === 'TRIAL',
                                              'bg-green-100 text-green-800': tenant.status === 'ACTIVE',
                                              'bg-red-100 text-red-800': tenant.status === 'SUSPENDED',
                                              'bg-orange-100 text-orange-800': tenant.status === 'EXPIRED'
                                          }"
                                          x-text="tenant.status"></span>
                                </div>
                            </template>
                            <div x-show="recentTenants.length === 0" x-cloak class="px-6 py-8 text-center text-gray-500">
                                Nema novih servisa
                            </div>
                        </div>
                    </div>

                    <!-- Pending KYC -->
                    <div class="admin-card bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                            <h2 class="text-lg font-medium text-gray-900">Verifikacija predstavnika</h2>
                            <a href="/admin/kyc" class="text-sm text-red-600 hover:text-red-700">Vidi sve</a>
                        </div>
                        <div class="divide-y divide-gray-200">
                            <template x-for="kyc in pendingKyc" :key="kyc.id">
                                <div class="px-6 py-4">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-medium text-gray-900" x-text="kyc.ime + ' ' + kyc.prezime"></p>
                                            <p class="text-sm text-gray-500" x-text="kyc.tenant_name"></p>
                                        </div>
                                        <a :href="'/admin/kyc/' + kyc.id" class="text-red-600 hover:text-red-700 text-sm font-medium">
                                            Pregledaj
                                        </a>
                                    </div>
                                </div>
                            </template>
                            <div x-show="pendingKyc.length === 0" x-cloak class="px-6 py-8 text-center text-gray-500">
                                Nema zahteva za verifikaciju
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function adminDashboard() {
    return {
        admin: null,
        stats: {},
        recentTenants: [],
        pendingKyc: [],
        theme: localStorage.getItem('admin-theme') || 'light',

        setTheme(newTheme) {
            this.theme = newTheme;
            // Koristi globalnu funkciju za cist theme switch
            if (window.setAdminTheme) {
                window.setAdminTheme(newTheme);
            }
        },

        logout() {
            localStorage.removeItem('admin_access_token');
            localStorage.removeItem('admin_refresh_token');
            window.location.href = '/admin/login';
        },

        async loadData() {
            const token = localStorage.getItem('admin_access_token');
            if (!token) {
                window.location.href = '/admin/login';
                return;
            }

            try {
                // Load admin info
                const meResponse = await fetch('/api/admin/auth/me', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (meResponse.ok) {
                    this.admin = await meResponse.json();
                } else {
                    window.location.href = '/admin/login';
                    return;
                }

                // Load dashboard stats
                const statsResponse = await fetch('/api/admin/dashboard', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (statsResponse.ok) {
                    const data = await statsResponse.json();
                    this.stats = data.stats || {};
                    this.recentTenants = data.recent_tenants || [];
                    this.pendingKyc = data.pending_kyc || [];
                }
            } catch (e) {
                console.error('Failed to load admin data:', e);
            }
        },

        formatPrice(price) {
            return new Intl.NumberFormat('sr-RS').format(price);
        }
    }
}
</script>
{% endblock %}
