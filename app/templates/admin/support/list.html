{% extends "layouts/base.html" %}

{% block title %}Podrska - ServisHub Admin{% endblock %}

{% block head %}
{% include "admin/_admin_styles.html" %}
<style>
    /* Thread List */
    .thread-item {
        transition: all 0.15s ease;
    }
    .thread-item:hover {
        background-color: #fef2f2;
    }
    .thread-item.selected {
        background-color: #fef2f2;
        border-left: 3px solid #dc2626;
    }
    .unread-dot {
        width: 8px;
        height: 8px;
        background: #dc2626;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    .sla-warning { color: #f59e0b; }
    .sla-critical { color: #dc2626; }

    /* Modern Chat Container */
    .chat-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 180px);
        background: #ffffff;
        border-radius: 12px;
        overflow: hidden;
    }

    /* Chat Header */
    .chat-header {
        padding: 1rem 1.25rem;
        background: linear-gradient(135deg, #fef2f2 0%, #fff7ed 100%);
        border-bottom: 1px solid #fecaca;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
    }
    .chat-header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    .chat-avatar {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: linear-gradient(135deg, #dc2626, #ef4444);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.9375rem;
    }
    .chat-info h2 {
        font-size: 0.9375rem;
        font-weight: 600;
        color: #0f172a;
        margin: 0;
    }
    .chat-info p {
        font-size: 0.75rem;
        color: #64748b;
        margin: 0.25rem 0 0;
    }

    /* Messages Area */
    .message-list {
        flex: 1;
        overflow-y: auto;
        padding: 1.25rem;
        background: linear-gradient(180deg, #fafafa 0%, #ffffff 100%);
    }

    /* Modern Message Bubble */
    .message-row {
        display: flex;
        gap: 0.625rem;
        margin-bottom: 0.75rem;
        animation: slideIn 0.25s ease-out;
    }
    @keyframes slideIn {
        from { opacity: 0; transform: translateY(8px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .message-row.admin {
        flex-direction: row-reverse;
    }

    .msg-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.6875rem;
        flex-shrink: 0;
        align-self: flex-end;
    }
    .msg-avatar.admin-avatar {
        background: linear-gradient(135deg, #dc2626, #b91c1c);
        color: white;
    }
    .msg-avatar.tenant-avatar {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
    }

    .msg-content {
        max-width: 70%;
    }
    .message-row.admin .msg-content {
        text-align: right;
    }

    .msg-sender {
        font-size: 0.6875rem;
        color: #64748b;
        font-weight: 500;
        margin-bottom: 0.25rem;
        padding: 0 0.375rem;
    }

    .message-bubble {
        padding: 0.75rem 1rem;
        border-radius: 18px;
        font-size: 0.875rem;
        line-height: 1.5;
        display: inline-block;
        text-align: left;
        word-wrap: break-word;
    }
    .message-bubble.message-admin {
        background: linear-gradient(135deg, #dc2626, #b91c1c);
        color: white;
        border-bottom-right-radius: 6px;
        box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
    }
    .message-bubble.message-tenant {
        background: #ffffff;
        color: #1e293b;
        border: 1px solid #e2e8f0;
        border-bottom-left-radius: 6px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .msg-meta {
        font-size: 0.625rem;
        color: #94a3b8;
        margin-top: 0.25rem;
        padding: 0 0.375rem;
        display: flex;
        gap: 0.5rem;
    }
    .message-row.admin .msg-meta {
        justify-content: flex-end;
    }

    /* Modern Typing Indicator */
    .typing-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0;
        margin-left: calc(32px + 0.625rem);
    }
    .typing-bubble {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: #ffffff;
        border: 1px solid #e2e8f0;
        padding: 0.625rem 1rem;
        border-radius: 18px;
        border-bottom-left-radius: 6px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    .typing-dots {
        display: flex;
        gap: 4px;
    }
    .typing-dots span {
        width: 7px;
        height: 7px;
        background: #94a3b8;
        border-radius: 50%;
        animation: typingPulse 1.4s infinite ease-in-out;
    }
    .typing-dots span:nth-child(1) { animation-delay: 0s; }
    .typing-dots span:nth-child(2) { animation-delay: 0.15s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.3s; }
    @keyframes typingPulse {
        0%, 60%, 100% { transform: scale(0.85); opacity: 0.5; }
        30% { transform: scale(1); opacity: 1; }
    }
    .typing-text {
        color: #64748b;
        font-size: 0.75rem;
    }

    /* Modern Reply Box */
    .reply-box {
        padding: 1rem 1.25rem 1.25rem;
        background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
        border-top: 1px solid #e2e8f0;
        flex-shrink: 0;
    }
    .reply-wrapper {
        display: flex;
        gap: 0.75rem;
        align-items: flex-end;
    }
    .reply-textarea {
        flex: 1;
        padding: 0.875rem 1rem;
        background: #ffffff;
        border: 2px solid #fecaca;
        border-radius: 24px;
        font-size: 0.875rem;
        resize: none;
        min-height: 48px;
        max-height: 150px;
        transition: all 0.2s;
        line-height: 1.4;
    }
    .reply-textarea:focus {
        outline: none;
        border-color: #dc2626;
        box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.1);
    }
    .reply-textarea::placeholder {
        color: #94a3b8;
    }
    .send-btn {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #dc2626, #b91c1c);
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.35);
        flex-shrink: 0;
    }
    .send-btn:hover:not(:disabled) {
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(220, 38, 38, 0.45);
    }
    .send-btn:disabled {
        background: #fca5a5;
        box-shadow: none;
        cursor: not-allowed;
    }
    .send-btn svg {
        width: 20px;
        height: 20px;
    }
    .reply-hint {
        font-size: 0.6875rem;
        color: #94a3b8;
        margin-top: 0.5rem;
        text-align: right;
    }

    /* Empty State */
    .empty-chat {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #94a3b8;
    }
    .empty-chat svg {
        width: 64px;
        height: 64px;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    .empty-chat p {
        font-size: 0.9375rem;
    }
</style>
{% endblock %}

{% block content %}
<div :class="{'admin-glass': theme === 'glass', 'admin-light': theme === 'light'}"
     x-data="supportPage()" x-init="init()">
    <div class="admin-wrapper min-h-screen bg-gray-100">
        {% set active_page = 'support' %}
        {% include "admin/_sidebar.html" %}

        <!-- Main content -->
        <div class="ml-64">
            <div class="admin-topbar bg-white shadow-sm h-16 flex items-center justify-between px-8">
                <h1 class="text-xl font-semibold text-gray-900">Podrska korisnicima</h1>
                <div class="flex items-center space-x-4">
                    <!-- SLA Stats -->
                    <div class="flex items-center space-x-4 text-sm mr-4">
                        <span class="text-gray-500">Cekaju odgovor:</span>
                        <span class="font-semibold" :class="stats.open > 5 ? 'text-red-600' : 'text-gray-900'" x-text="stats.open"></span>
                        <span class="text-gray-300">|</span>
                        <span class="text-gray-500">Nedodeljeni:</span>
                        <span class="font-semibold" :class="stats.unassigned > 0 ? 'text-orange-500' : 'text-gray-900'" x-text="stats.unassigned"></span>
                    </div>
                    <!-- Theme toggle -->
                    <div class="flex items-center space-x-2">
                        <button @click="setTheme('light')" :class="{'ring-2 ring-red-500 ring-offset-2': theme === 'light'}" class="theme-btn p-2 rounded-lg bg-white border border-gray-200 hover:border-gray-300" title="Svetla tema">
                            <svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0z"/></svg>
                        </button>
                        <button @click="setTheme('glass')" :class="{'ring-2 ring-red-500 ring-offset-2': theme === 'glass'}" class="theme-btn p-2 rounded-lg bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-600 hover:border-gray-500" title="Glassmorphism tema">
                            <svg class="w-4 h-4 text-purple-400" fill="currentColor" viewBox="0 0 24 24"><path d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"/></svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="p-6">
                <div class="flex gap-6">
                    <!-- Thread List (Left) -->
                    <div class="w-1/3 admin-card bg-white rounded-lg shadow">
                        <!-- Tabs -->
                        <div class="border-b border-gray-200">
                            <nav class="-mb-px flex px-4">
                                <button @click="filter = 'OPEN'" :class="filter === 'OPEN' ? 'border-red-500 text-red-600' : 'border-transparent text-gray-500'"
                                        class="whitespace-nowrap py-3 px-3 border-b-2 font-medium text-sm flex items-center">
                                    Otvoreni
                                    <span x-show="stats.open > 0" class="ml-2 bg-red-100 text-red-600 px-2 py-0.5 rounded-full text-xs" x-text="stats.open"></span>
                                </button>
                                <button @click="filter = 'PENDING'" :class="filter === 'PENDING' ? 'border-red-500 text-red-600' : 'border-transparent text-gray-500'"
                                        class="whitespace-nowrap py-3 px-3 border-b-2 font-medium text-sm flex items-center">
                                    Na cekanju
                                    <span x-show="stats.pending > 0" class="ml-2 bg-yellow-100 text-yellow-600 px-2 py-0.5 rounded-full text-xs" x-text="stats.pending"></span>
                                </button>
                                <button @click="filter = 'RESOLVED'" :class="filter === 'RESOLVED' ? 'border-red-500 text-red-600' : 'border-transparent text-gray-500'"
                                        class="whitespace-nowrap py-3 px-3 border-b-2 font-medium text-sm">Reseni</button>
                            </nav>
                        </div>

                        <!-- Thread items -->
                        <div class="overflow-y-auto" style="max-height: calc(100vh - 280px);">
                            <template x-for="thread in filteredThreads" :key="thread.id">
                                <div @click="selectThread(thread)"
                                     class="thread-item p-4 border-b cursor-pointer"
                                     :class="{'selected': selectedThread && selectedThread.id === thread.id}">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center">
                                                <span x-show="thread.sla.is_waiting" class="unread-dot mr-2"></span>
                                                <p class="text-sm font-medium text-gray-900 truncate" x-text="thread.subject"></p>
                                            </div>
                                            <p class="text-sm text-gray-500 mt-1" x-text="thread.tenant?.name || 'Nepoznat servis'"></p>
                                            <p class="text-xs text-gray-400 mt-1 truncate" x-text="thread.last_message?.preview || 'Nema poruka'"></p>
                                        </div>
                                        <div class="ml-2 text-right">
                                            <p class="text-xs text-gray-400" x-text="formatDate(thread.last_reply_at || thread.created_at)"></p>
                                            <span x-show="!thread.assigned_to" class="inline-block mt-1 text-xs bg-orange-100 text-orange-600 px-2 py-0.5 rounded">Nedodeljen</span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            <div x-show="filteredThreads.length === 0" class="p-8 text-center text-gray-500">
                                Nema konverzacija u ovoj kategoriji
                            </div>
                        </div>
                    </div>

                    <!-- Chat View (Right) - Modern Design -->
                    <div class="flex-1 admin-card bg-white rounded-lg shadow chat-container">
                        <!-- Empty State -->
                        <template x-if="!selectedThread">
                            <div class="empty-chat">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                </svg>
                                <p>Izaberi konverzaciju iz liste</p>
                            </div>
                        </template>

                        <template x-if="selectedThread">
                            <div class="flex flex-col h-full">
                                <!-- Modern Chat Header -->
                                <div class="chat-header">
                                    <div class="chat-header-left">
                                        <div class="chat-avatar" x-text="getInitials(selectedThread.tenant?.name || 'NN')"></div>
                                        <div class="chat-info">
                                            <h2 x-text="selectedThread.subject"></h2>
                                            <p>
                                                <span x-text="selectedThread.tenant?.name || 'Nepoznat'"></span>
                                                <span class="mx-1">·</span>
                                                <span x-text="formatDate(selectedThread.created_at)"></span>
                                                <template x-if="selectedThread.sla?.response_time_hours">
                                                    <span class="ml-2" :class="selectedThread.sla.response_time_hours > 24 ? 'sla-critical' : 'text-green-600'">
                                                        · Odgovor: <span x-text="selectedThread.sla.response_time_hours + 'h'"></span>
                                                    </span>
                                                </template>
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <!-- Tags -->
                                        <div class="flex items-center space-x-1">
                                            <template x-for="tag in selectedThread.tags" :key="tag">
                                                <span class="bg-red-50 text-red-600 text-xs px-2 py-1 rounded-full" x-text="tag"></span>
                                            </template>
                                        </div>
                                        <!-- Status -->
                                        <select x-model="selectedThread.status" @change="updateStatus()"
                                                class="text-sm border border-red-200 rounded-lg px-3 py-1.5 bg-white focus:ring-2 focus:ring-red-100 focus:border-red-300">
                                            <option value="OPEN">Otvoren</option>
                                            <option value="PENDING">Na cekanju</option>
                                            <option value="RESOLVED">Resen</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Messages -->
                                <div class="message-list" x-ref="messageList">
                                    <template x-for="msg in messages" :key="msg.id">
                                        <div class="message-row" :class="msg.sender.type === 'admin' ? 'admin' : ''">
                                            <!-- Avatar -->
                                            <div class="msg-avatar" :class="msg.sender.type === 'admin' ? 'admin-avatar' : 'tenant-avatar'">
                                                <span x-text="getInitials(msg.sender.name)"></span>
                                            </div>
                                            <!-- Content -->
                                            <div class="msg-content">
                                                <div class="msg-sender" x-text="msg.sender.name"></div>
                                                <div class="message-bubble" :class="msg.sender.type === 'admin' ? 'message-admin' : 'message-tenant'">
                                                    <span class="whitespace-pre-wrap" x-text="msg.body"></span>
                                                </div>
                                                <div class="msg-meta">
                                                    <span x-text="formatDateTime(msg.created_at)"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </template>

                                    <!-- Typing Indicator -->
                                    <template x-if="typingUsers.length > 0">
                                        <div class="typing-indicator">
                                            <div class="typing-bubble">
                                                <div class="typing-dots">
                                                    <span></span>
                                                    <span></span>
                                                    <span></span>
                                                </div>
                                                <span class="typing-text" x-text="typingUsers.map(u => u.name).join(', ') + ' kuca...'"></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>

                                <!-- Modern Reply Box -->
                                <template x-if="selectedThread.status !== 'RESOLVED'">
                                    <div class="reply-box">
                                        <div class="reply-wrapper">
                                            <textarea x-model="replyText"
                                                      class="reply-textarea"
                                                      rows="1"
                                                      placeholder="Napisi odgovor..."
                                                      @input="onTyping(); autoResize($event)"
                                                      @keydown.ctrl.enter="sendReply()"></textarea>
                                            <button @click="sendReply()"
                                                    :disabled="!replyText.trim() || sending"
                                                    class="send-btn">
                                                <template x-if="!sending">
                                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                                                    </svg>
                                                </template>
                                                <template x-if="sending">
                                                    <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                                </template>
                                            </button>
                                        </div>
                                        <div class="reply-hint">Ctrl+Enter za slanje</div>
                                    </div>
                                </template>

                                <!-- Resolved State -->
                                <template x-if="selectedThread.status === 'RESOLVED'">
                                    <div class="reply-box text-center text-gray-500 text-sm py-4">
                                        <svg class="w-5 h-5 inline-block mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        Konverzacija je zatvorena
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function supportPage() {
    return {
        loading: true,
        theme: localStorage.getItem('admin-theme') || 'light',
        threads: [],
        filter: 'OPEN',
        stats: { open: 0, pending: 0, unassigned: 0 },
        selectedThread: null,
        messages: [],
        replyText: '',
        sending: false,
        typingUsers: [],
        lastMessageId: 0,
        messagePollingInterval: null,
        typingPollingInterval: null,
        typingTimeout: null,
        isTyping: false,

        get filteredThreads() {
            return this.threads.filter(t => t.status === this.filter);
        },

        setTheme(newTheme) {
            this.theme = newTheme;
            localStorage.setItem('admin-theme', newTheme);
        },

        async init() {
            const token = localStorage.getItem('admin_access_token');
            if (!token) { window.location.href = '/admin/login'; return; }
            await this.loadThreads();
            // Poll for threads every 15s
            setInterval(() => this.loadThreads(), 15000);
        },

        async loadThreads() {
            const token = localStorage.getItem('admin_access_token');
            try {
                const response = await fetch('/api/admin/threads?type=SUPPORT', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (response.ok) {
                    const data = await response.json();
                    this.threads = data.threads || [];
                    this.stats = data.stats || { open: 0, pending: 0, unassigned: 0 };
                } else if (response.status === 401) {
                    window.location.href = '/admin/login';
                }
            } catch (e) {
                console.error('Greska pri ucitavanju:', e);
            } finally {
                this.loading = false;
            }
        },

        async selectThread(thread) {
            // Clear previous polling
            if (this.messagePollingInterval) clearInterval(this.messagePollingInterval);
            if (this.typingPollingInterval) clearInterval(this.typingPollingInterval);

            this.selectedThread = thread;
            this.messages = [];
            this.typingUsers = [];
            this.lastMessageId = 0;

            await this.loadMessages();

            // Start fast polling for this thread (every 3s)
            this.messagePollingInterval = setInterval(() => this.pollNewMessages(), 3000);
            this.typingPollingInterval = setInterval(() => this.pollTyping(), 2000);
        },

        async loadMessages() {
            const token = localStorage.getItem('admin_access_token');
            try {
                const response = await fetch(`/api/admin/threads/${this.selectedThread.id}/messages`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (response.ok) {
                    const data = await response.json();
                    this.messages = data.messages || [];
                    if (this.messages.length > 0) {
                        this.lastMessageId = this.messages[this.messages.length - 1].id;
                    }
                    this.$nextTick(() => this.scrollToBottom());
                }
            } catch (e) {
                console.error('Greska pri ucitavanju poruka:', e);
            }
        },

        async pollNewMessages() {
            if (!this.selectedThread) return;
            const token = localStorage.getItem('admin_access_token');
            try {
                // Use after_id to only get new messages
                const url = `/api/admin/threads/${this.selectedThread.id}/messages?after_id=${this.lastMessageId}`;
                const response = await fetch(url, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (response.ok) {
                    const data = await response.json();
                    const newMessages = data.messages || [];
                    if (newMessages.length > 0) {
                        // Add new messages
                        newMessages.forEach(msg => {
                            if (!this.messages.find(m => m.id === msg.id)) {
                                this.messages.push(msg);
                            }
                        });
                        this.lastMessageId = this.messages[this.messages.length - 1].id;
                        this.$nextTick(() => this.scrollToBottom());
                        // Also refresh thread list for updated status/preview
                        this.loadThreads();
                    }
                }
            } catch (e) {
                console.error('Polling error:', e);
            }
        },

        async pollTyping() {
            if (!this.selectedThread) return;
            const token = localStorage.getItem('admin_access_token');
            try {
                const response = await fetch(`/api/admin/threads/${this.selectedThread.id}/typing`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (response.ok) {
                    const data = await response.json();
                    this.typingUsers = data.typing || [];
                }
            } catch (e) {
                // Ignore typing errors
            }
        },

        onTyping() {
            if (!this.selectedThread) return;

            // Send typing indicator
            if (!this.isTyping) {
                this.isTyping = true;
                this.sendTypingStatus(true);
            }

            // Reset typing timeout
            if (this.typingTimeout) clearTimeout(this.typingTimeout);
            this.typingTimeout = setTimeout(() => {
                this.isTyping = false;
                this.sendTypingStatus(false);
            }, 2000);
        },

        async sendTypingStatus(typing) {
            if (!this.selectedThread) return;
            const token = localStorage.getItem('admin_access_token');
            try {
                await fetch(`/api/admin/threads/${this.selectedThread.id}/typing`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ typing })
                });
            } catch (e) {
                // Ignore typing errors
            }
        },

        async sendReply() {
            if (!this.replyText.trim() || this.sending) return;

            this.sending = true;
            this.isTyping = false;
            this.sendTypingStatus(false);

            const token = localStorage.getItem('admin_access_token');

            try {
                const response = await fetch(`/api/admin/threads/${this.selectedThread.id}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ body: this.replyText })
                });

                if (response.ok) {
                    const data = await response.json();
                    this.messages.push(data.data);
                    this.lastMessageId = data.data.id;
                    this.replyText = '';
                    this.selectedThread.status = 'PENDING';
                    this.$nextTick(() => this.scrollToBottom());
                    // Refresh threads to update stats
                    await this.loadThreads();
                } else {
                    const error = await response.json();
                    alert(error.message || 'Greska pri slanju');
                }
            } catch (e) {
                console.error('Greska:', e);
                alert('Greska pri slanju poruke');
            } finally {
                this.sending = false;
            }
        },

        async updateStatus() {
            const token = localStorage.getItem('admin_access_token');
            try {
                const response = await fetch(`/api/admin/threads/${this.selectedThread.id}/status`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: this.selectedThread.status })
                });
                if (response.ok) {
                    await this.loadThreads();
                }
            } catch (e) {
                console.error('Greska:', e);
            }
        },

        scrollToBottom() {
            const list = this.$refs.messageList;
            if (list) list.scrollTop = list.scrollHeight;
        },

        formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;

            if (diff < 86400000) { // 24h
                return date.toLocaleTimeString('sr-RS', { hour: '2-digit', minute: '2-digit' });
            }
            return date.toLocaleDateString('sr-RS', { day: 'numeric', month: 'short' });
        },

        formatDateTime(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleString('sr-RS', {
                day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
            });
        },

        getInitials(name) {
            if (!name) return '?';
            const parts = name.split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[1][0]).toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        },

        autoResize(event) {
            const textarea = event.target;
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }
    }
}
</script>
{% endblock %}