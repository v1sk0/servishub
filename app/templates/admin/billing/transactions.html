{% extends "layouts/base.html" %}

{% block title %}Bankovne Transakcije - ServisHub Admin{% endblock %}

{% block head %}
{% include "admin/_admin_styles.html" %}
{% endblock %}

{% block content %}
<div :class="{'admin-glass': theme === 'glass', 'admin-light': theme === 'light'}"
     x-data="transactionsPage()" x-init="loadTransactions()">
    <div class="admin-wrapper min-h-screen bg-gray-100">
        {% set active_page = 'transactions' %}
        {% include "admin/_sidebar.html" %}

        <!-- Main content -->
        <div class="ml-64">
            <div class="admin-topbar bg-white shadow-sm h-16 flex items-center justify-between px-8">
                <h1 class="text-xl font-semibold text-gray-900">Bankovne Transakcije</h1>
                <div class="flex items-center space-x-4">
                    <!-- Theme Toggle -->
                    <div class="flex items-center space-x-2">
                        <button @click="setTheme('light')"
                                :class="{'ring-2 ring-red-500 ring-offset-2': theme === 'light'}"
                                class="theme-btn p-2 rounded-lg bg-white border border-gray-200 hover:border-gray-300"
                                title="Svetla tema">
                            <svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0z"/>
                            </svg>
                        </button>
                        <button @click="setTheme('glass')"
                                :class="{'ring-2 ring-red-500 ring-offset-2': theme === 'glass'}"
                                class="theme-btn p-2 rounded-lg bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-600 hover:border-gray-500"
                                title="Glassmorphism tema">
                            <svg class="w-4 h-4 text-purple-400" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="p-8">
                <!-- Filteri -->
                <div class="admin-card bg-white rounded-lg shadow mb-6 p-4">
                    <div class="flex flex-wrap items-center gap-4">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Status</label>
                            <select x-model="filters.status" @change="loadTransactions()"
                                    class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-red-500 focus:border-red-500">
                                <option value="">Svi</option>
                                <option value="UNMATCHED">Neupareno</option>
                                <option value="MATCHED">Upareno</option>
                                <option value="MANUAL">Rucno upareno</option>
                                <option value="IGNORED">Ignorisano</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Datum od</label>
                            <input type="date" x-model="filters.date_from" @change="loadTransactions()"
                                   class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Datum do</label>
                            <input type="date" x-model="filters.date_to" @change="loadTransactions()"
                                   class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs text-gray-500 mb-1">Pretraga</label>
                            <input type="text" x-model="filters.search" @input.debounce.300ms="loadTransactions()"
                                   placeholder="Ime platioca, poziv na broj..."
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div class="pt-5">
                            <button @click="resetFilters()" class="text-gray-500 hover:text-gray-700 text-sm">
                                Resetuj filtere
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Statistike -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card yellow admin-card bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-yellow-500/20 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-500">Neupareno</p>
                                <p class="text-2xl font-bold text-gray-900" x-text="stats.unmatched || 0"></p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card green admin-card bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-500">Upareno</p>
                                <p class="text-2xl font-bold text-gray-900" x-text="stats.matched || 0"></p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card blue admin-card bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-500">Rucno upareno</p>
                                <p class="text-2xl font-bold text-gray-900" x-text="stats.manual || 0"></p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card gray admin-card bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-gray-500/20 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-500">Ignorisano</p>
                                <p class="text-2xl font-bold text-gray-900" x-text="stats.ignored || 0"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading -->
                <div x-show="loading" class="flex justify-center py-12">
                    <svg class="animate-spin h-8 w-8 text-red-600" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                </div>

                <!-- Transakcije lista -->
                <div x-show="!loading" x-cloak class="space-y-4">
                    <template x-for="txn in transactions" :key="txn.id">
                        <div class="admin-card bg-white rounded-lg shadow overflow-hidden">
                            <div class="p-4">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-4 mb-2">
                                            <span class="text-lg font-semibold text-gray-900" x-text="formatPrice(txn.amount)"></span>
                                            <span class="px-2 py-1 text-xs font-medium rounded-full"
                                                  :class="{
                                                      'bg-yellow-100 text-yellow-800': txn.match_status === 'UNMATCHED',
                                                      'bg-green-100 text-green-800': txn.match_status === 'MATCHED',
                                                      'bg-blue-100 text-blue-800': txn.match_status === 'MANUAL',
                                                      'bg-gray-100 text-gray-800': txn.match_status === 'IGNORED'
                                                  }"
                                                  x-text="statusLabels[txn.match_status]"></span>
                                        </div>
                                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                            <div>
                                                <span class="text-gray-500">Datum:</span>
                                                <span class="ml-1 text-gray-900" x-text="formatDate(txn.transaction_date)"></span>
                                            </div>
                                            <div>
                                                <span class="text-gray-500">Platioc:</span>
                                                <span class="ml-1 text-gray-900" x-text="txn.payer_name || '-'"></span>
                                            </div>
                                            <div>
                                                <span class="text-gray-500">Poziv:</span>
                                                <span class="ml-1 font-mono text-gray-900" x-text="txn.payment_reference || '-'"></span>
                                            </div>
                                            <div>
                                                <span class="text-gray-500">Svrha:</span>
                                                <span class="ml-1 text-gray-900 truncate" x-text="txn.purpose || '-'"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Akcije za neuparene -->
                                <template x-if="txn.match_status === 'UNMATCHED'">
                                    <div class="mt-4 pt-4 border-t border-gray-200">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-2">
                                                <button @click="loadSuggestions(txn.id)"
                                                        class="px-3 py-1.5 text-sm text-blue-600 hover:bg-blue-50 rounded-lg">
                                                    <span x-show="!loadingSuggestions[txn.id]">Prikazi predloge</span>
                                                    <span x-show="loadingSuggestions[txn.id]">
                                                        <svg class="animate-spin inline h-4 w-4" fill="none" viewBox="0 0 24 24">
                                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                                                        </svg>
                                                    </span>
                                                </button>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <button @click="ignoreTransaction(txn.id)"
                                                        class="px-3 py-1.5 text-sm text-gray-600 hover:bg-gray-100 rounded-lg">
                                                    Ignorisi
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Predlozi -->
                                        <template x-if="suggestions[txn.id] && suggestions[txn.id].length > 0">
                                            <div class="mt-4 space-y-2">
                                                <p class="text-sm text-gray-500">Moguci matchevi:</p>
                                                <template x-for="sug in suggestions[txn.id]" :key="sug.payment_id">
                                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                                        <div class="flex-1">
                                                            <div class="flex items-center space-x-3">
                                                                <span class="font-medium text-gray-900" x-text="sug.tenant_name"></span>
                                                                <span class="text-sm text-gray-500" x-text="sug.invoice"></span>
                                                                <span class="text-sm text-gray-900" x-text="formatPrice(sug.amount)"></span>
                                                                <span class="px-2 py-0.5 text-xs rounded-full"
                                                                      :class="{'bg-green-100 text-green-700': sug.confidence >= 0.9, 'bg-yellow-100 text-yellow-700': sug.confidence >= 0.7 && sug.confidence < 0.9, 'bg-gray-100 text-gray-700': sug.confidence < 0.7}"
                                                                      x-text="Math.round(sug.confidence * 100) + '%'"></span>
                                                            </div>
                                                            <div class="mt-1 text-xs text-gray-500" x-text="sug.match_reasons ? sug.match_reasons.join(', ') : ''"></div>
                                                        </div>
                                                        <button @click="matchTransaction(txn.id, sug.payment_id)"
                                                                class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg">
                                                            Upari
                                                        </button>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                        <template x-if="suggestions[txn.id] && suggestions[txn.id].length === 0">
                                            <div class="mt-4 text-sm text-gray-500">
                                                Nema predloga za ovu transakciju.
                                            </div>
                                        </template>
                                    </div>
                                </template>

                                <!-- Info za uparene -->
                                <template x-if="txn.match_status === 'MATCHED' || txn.match_status === 'MANUAL'">
                                    <div class="mt-4 pt-4 border-t border-gray-200">
                                        <div class="flex items-center justify-between">
                                            <div class="text-sm">
                                                <span class="text-gray-500">Upareno sa:</span>
                                                <span class="ml-1 font-medium text-gray-900" x-text="txn.matched_invoice || 'Faktura #' + txn.matched_payment_id"></span>
                                                <span class="ml-2 text-gray-500" x-text="'(' + txn.match_method + ')'"></span>
                                            </div>
                                            <button @click="unmatchTransaction(txn.id)"
                                                    class="px-3 py-1.5 text-sm text-red-600 hover:bg-red-50 rounded-lg">
                                                Ponisti uparivanje
                                            </button>
                                        </div>
                                    </div>
                                </template>

                                <!-- Info za ignorisane -->
                                <template x-if="txn.match_status === 'IGNORED'">
                                    <div class="mt-4 pt-4 border-t border-gray-200">
                                        <div class="flex items-center justify-between">
                                            <div class="text-sm text-gray-500">
                                                Ova transakcija je oznacena kao ignorisana.
                                            </div>
                                            <button @click="unignoreTransaction(txn.id)"
                                                    class="px-3 py-1.5 text-sm text-blue-600 hover:bg-blue-50 rounded-lg">
                                                Ponisti ignorisanje
                                            </button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <div x-show="transactions.length === 0" x-cloak class="text-center py-12 text-gray-500">
                        Nema transakcija koje odgovaraju filterima.
                    </div>

                    <!-- Paginacija -->
                    <div x-show="total > limit" x-cloak class="flex items-center justify-between mt-6">
                        <div class="text-sm text-gray-500">
                            Prikazano <span x-text="transactions.length"></span> od <span x-text="total"></span> transakcija
                        </div>
                        <div class="flex space-x-2">
                            <button @click="prevPage()" :disabled="offset === 0"
                                    class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50">
                                Prethodna
                            </button>
                            <button @click="nextPage()" :disabled="offset + limit >= total"
                                    class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50">
                                Sledeca
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function transactionsPage() {
    return {
        loading: true,
        transactions: [],
        stats: {},
        suggestions: {},
        loadingSuggestions: {},
        filters: {
            status: 'UNMATCHED',
            date_from: '',
            date_to: '',
            search: ''
        },
        offset: 0,
        limit: 20,
        total: 0,
        theme: localStorage.getItem('admin-theme') || 'light',

        statusLabels: {
            'UNMATCHED': 'Neupareno',
            'MATCHED': 'Upareno',
            'MANUAL': 'Rucno',
            'IGNORED': 'Ignorisano'
        },

        setTheme(newTheme) {
            this.theme = newTheme;
            if (window.setAdminTheme) {
                window.setAdminTheme(newTheme);
            }
        },

        logout() {
            sessionStorage.removeItem('admin_access_token');
            sessionStorage.removeItem('admin_refresh_token');
            window.location.href = '/admin/login';
        },

        async loadTransactions() {
            const token = sessionStorage.getItem('admin_access_token');
            if (!token) { window.location.href = '/admin/login'; return; }
            this.loading = true;

            try {
                const params = new URLSearchParams();
                if (this.filters.status) params.append('match_status', this.filters.status);
                if (this.filters.date_from) params.append('date_from', this.filters.date_from);
                if (this.filters.date_to) params.append('date_to', this.filters.date_to);
                if (this.filters.search) params.append('search', this.filters.search);
                params.append('offset', this.offset);
                params.append('limit', this.limit);

                const r = await fetch('/api/admin/bank-transactions?' + params.toString(), {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (r.ok) {
                    const data = await r.json();
                    this.transactions = data.transactions || [];
                    this.stats = data.stats || {};
                    this.total = data.total || 0;
                } else if (r.status === 401) {
                    window.location.href = '/admin/login';
                }
            } catch (e) {
                console.error(e);
            } finally {
                this.loading = false;
            }
        },

        resetFilters() {
            this.filters = { status: 'UNMATCHED', date_from: '', date_to: '', search: '' };
            this.offset = 0;
            this.loadTransactions();
        },

        prevPage() {
            if (this.offset > 0) {
                this.offset -= this.limit;
                this.loadTransactions();
            }
        },

        nextPage() {
            if (this.offset + this.limit < this.total) {
                this.offset += this.limit;
                this.loadTransactions();
            }
        },

        async loadSuggestions(txnId) {
            const token = sessionStorage.getItem('admin_access_token');
            this.loadingSuggestions[txnId] = true;

            try {
                const r = await fetch('/api/admin/bank-transactions/' + txnId + '/suggestions', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (r.ok) {
                    const data = await r.json();
                    this.suggestions[txnId] = data.suggestions || [];
                }
            } catch (e) {
                console.error(e);
            } finally {
                this.loadingSuggestions[txnId] = false;
            }
        },

        async matchTransaction(txnId, paymentId) {
            const token = sessionStorage.getItem('admin_access_token');
            try {
                const r = await fetch('/api/admin/bank-transactions/' + txnId + '/match', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ payment_id: paymentId })
                });

                if (r.ok) {
                    window.showToast && showToast('Transakcija uspesno uparena', 'success');
                    this.loadTransactions();
                } else {
                    const data = await r.json();
                    window.showToast && showToast(data.error || 'Greska pri uparivanju', 'error');
                }
            } catch (e) {
                console.error(e);
            }
        },

        async unmatchTransaction(txnId) {
            if (!confirm('Da li ste sigurni da zelite da ponistite uparivanje?')) return;

            const token = sessionStorage.getItem('admin_access_token');
            try {
                const r = await fetch('/api/admin/bank-transactions/' + txnId + '/unmatch', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (r.ok) {
                    window.showToast && showToast('Uparivanje ponisteno', 'success');
                    this.loadTransactions();
                } else {
                    const data = await r.json();
                    window.showToast && showToast(data.error || 'Greska', 'error');
                }
            } catch (e) {
                console.error(e);
            }
        },

        async ignoreTransaction(txnId) {
            const token = sessionStorage.getItem('admin_access_token');
            try {
                const r = await fetch('/api/admin/bank-transactions/' + txnId + '/ignore', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (r.ok) {
                    window.showToast && showToast('Transakcija ignorisana', 'info');
                    this.loadTransactions();
                }
            } catch (e) {
                console.error(e);
            }
        },

        async unignoreTransaction(txnId) {
            const token = sessionStorage.getItem('admin_access_token');
            try {
                const r = await fetch('/api/admin/bank-transactions/' + txnId + '/unignore', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (r.ok) {
                    window.showToast && showToast('Ignorisanje ponisteno', 'success');
                    this.loadTransactions();
                }
            } catch (e) {
                console.error(e);
            }
        },

        formatPrice(p) {
            return new Intl.NumberFormat('sr-RS').format(p || 0) + ' RSD';
        },

        formatDate(d) {
            return d ? new Date(d).toLocaleDateString('sr-Latn-RS') : '-';
        }
    }
}
</script>
{% endblock %}
