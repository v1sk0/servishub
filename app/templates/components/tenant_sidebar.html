<!-- Tenant Sidebar - Dark Glassmorphic Theme -->
<style>
    /* License widget skeleton */
    .license-skeleton {
        background: linear-gradient(135deg, rgba(100,100,100,0.3), rgba(80,80,80,0.3));
        animation: skeleton-pulse 1.5s ease-in-out infinite;
    }
    .license-skeleton .skeleton-bar {
        background: rgba(255,255,255,0.15);
        border-radius: 4px;
    }
    @keyframes skeleton-pulse {
        0%, 100% { opacity: 0.6; }
        50% { opacity: 0.4; }
    }
</style>
<div x-data="sidebarData()" x-init="init()" class="flex grow flex-col gap-y-5 overflow-y-auto px-6 pb-4">
    <!-- Logo / Ime servisa -->
    <div class="flex h-16 shrink-0 items-center">
        <a href="/dashboard" class="flex items-center">
            <div class="h-8 w-8 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                <svg class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
            </div>
            <span class="ml-3 text-xl font-bold sidebar-logo truncate max-w-[180px]" x-text="tenantName || 'Servis'"></span>
        </a>
    </div>

    <!-- Navigation -->
    <nav class="flex flex-1 flex-col">
        <ul role="list" class="flex flex-1 flex-col gap-y-7">
            <li>
                <ul role="list" class="-mx-2 space-y-1">
                    <!-- Dashboard -->
                    <li>
                        <a href="/dashboard"
                           class="nav-item group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6"
                           :class="{ 'active': window.location.pathname === '/dashboard' }">
                            <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                            </svg>
                            Dashboard
                        </a>
                    </li>

                    <!-- Tickets -->
                    <li>
                        <a href="/tickets"
                           class="nav-item group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6"
                           :class="{ 'active': window.location.pathname.startsWith('/tickets') }">
                            <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" />
                            </svg>
                            Servisni nalozi
                        </a>
                    </li>

                    <!-- Inventory -->
                    <li x-data="{ open: window.location.pathname.startsWith('/inventory') }">
                        <button @click="open = !open"
                                class="nav-item w-full group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6"
                                :class="{ 'active': window.location.pathname.startsWith('/inventory') }">
                            <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
                            </svg>
                            Inventar
                            <svg class="ml-auto h-5 w-5 shrink-0 transition-transform" :class="{ 'rotate-90': open }" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <ul x-show="open" x-collapse class="nav-submenu mt-1 px-2">
                            <li>
                                <a href="/inventory/phones"
                                   class="block rounded-md py-2 pl-9 pr-2 text-sm"
                                   :class="{ 'active': window.location.pathname === '/inventory/phones' }">
                                    Telefoni
                                </a>
                            </li>
                            <li>
                                <a href="/inventory/parts"
                                   class="block rounded-md py-2 pl-9 pr-2 text-sm"
                                   :class="{ 'active': window.location.pathname === '/inventory/parts' }">
                                    Rezervni delovi
                                </a>
                            </li>
                        </ul>
                    </li>

                    <!-- Marketplace -->
                    <li>
                        <a href="/marketplace"
                           class="nav-item group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6"
                           :class="{ 'active': window.location.pathname.startsWith('/marketplace') }">
                            <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 21v-7.5a.75.75 0 01.75-.75h3a.75.75 0 01.75.75V21m-4.5 0H2.36m11.14 0H18m0 0h3.64m-1.39 0V9.349m-16.5 11.65V9.35m0 0a3.001 3.001 0 003.75-.615A2.993 2.993 0 009.75 9.75c.896 0 1.7-.393 2.25-1.016a2.993 2.993 0 002.25 1.016c.896 0 1.7-.393 2.25-1.016a3.001 3.001 0 003.75.614m-16.5 0a3.004 3.004 0 01-.621-4.72L4.318 3.44A1.5 1.5 0 015.378 3h13.243a1.5 1.5 0 011.06.44l1.19 1.189a3 3 0 01-.621 4.72m-13.5 8.65h3.75a.75.75 0 00.75-.75V13.5a.75.75 0 00-.75-.75H6.75a.75.75 0 00-.75.75v3.75c0 .415.336.75.75.75z" />
                            </svg>
                            Marketplace
                        </a>
                    </li>

                    <!-- Orders -->
                    <li>
                        <a href="/orders"
                           class="nav-item group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6"
                           :class="{ 'active': window.location.pathname.startsWith('/orders') }">
                            <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 00-16.536-1.84M7.5 14.25L5.106 5.272M6 20.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm12.75 0a.75.75 0 11-1.5 0 .75.75 0 011.5 0z" />
                            </svg>
                            Narudzbine
                        </a>
                    </li>

                    <!-- Kasa (POS) - feature gated -->
                    <li x-show="posEnabled" x-cloak>
                        <a href="/pos"
                           class="nav-item group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6"
                           :class="{ 'active': window.location.pathname.startsWith('/pos') }">
                            <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z" />
                            </svg>
                            Kasa
                        </a>
                    </li>

                    <!-- Magacin - feature gated (POS) -->
                    <li x-show="posEnabled" x-cloak>
                        <a href="/goods"
                           class="nav-item group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6"
                           :class="{ 'active': window.location.pathname.startsWith('/goods') }">
                            <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
                            </svg>
                            Magacin
                        </a>
                    </li>

                    <!-- Finansije - feature gated (POS) -->
                    <li x-show="posEnabled" x-cloak>
                        <a href="/finance"
                           class="nav-item group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6"
                           :class="{ 'active': window.location.pathname.startsWith('/finance') }">
                            <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
                            </svg>
                            Finansije
                        </a>
                    </li>

                    <!-- Krediti - feature gated -->
                    <li x-show="creditsEnabled" x-cloak>
                        <a href="/credits"
                           class="nav-item group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6"
                           :class="{ 'active': window.location.pathname.startsWith('/credits') }">
                            <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75C20.25 16.153 16.556 18 12 18s-8.25-1.847-8.25-4.125v-3.75m16.5 0c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125" />
                            </svg>
                            Krediti
                        </a>
                    </li>

                    <!-- SMS Evidencija -->
                    <li>
                        <a href="/finance/sms"
                           class="nav-item group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6"
                           :class="{ 'active': window.location.pathname === '/finance/sms' }">
                            <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                            </svg>
                            SMS Evidencija
                        </a>
                    </li>

                    <!-- Cenovnik -->
                    <li>
                        <a href="/pricing"
                           class="nav-item group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6"
                           :class="{ 'active': window.location.pathname === '/pricing' }">
                            <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Cenovnik
                        </a>
                    </li>

                    <!-- Tim (samo za admina) -->
                    <li x-show="isAdmin()" x-cloak>
                        <a href="/team"
                           class="nav-item group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6"
                           :class="{ 'active': window.location.pathname.startsWith('/team') }">
                            <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
                            </svg>
                            Tim
                        </a>
                    </li>

                    <!-- Poruke -->
                    <li>
                        <a href="/messages"
                           class="nav-item group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6"
                           :class="{ 'active': window.location.pathname.startsWith('/messages') }">
                            <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
                            </svg>
                            Poruke
                        </a>
                    </li>

                    <!-- Mreža partnera -->
                    <li>
                        <a href="/network"
                           class="nav-item group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6"
                           :class="{ 'active': window.location.pathname.startsWith('/network') }">
                            <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z" />
                            </svg>
                            Mreža
                        </a>
                    </li>
                </ul>
            </li>

            <!-- Settings Section -->
            <li>
                <ul role="list" class="-mx-2 space-y-1">
                    <li>
                        <a href="/settings"
                           class="nav-item group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6"
                           :class="{ 'active': window.location.pathname === '/settings' }">
                            <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            Podesavanja
                        </a>
                    </li>
                </ul>
            </li>

            <!-- Subscription Widget -->
            <li class="mt-auto -mx-2">
                <!-- Powered by ServisHub -->
                <div class="text-center mb-2">
                    <span class="text-xs text-gray-400 opacity-70">powered by</span>
                    <a href="https://servishub.rs" target="_blank" class="text-xs font-semibold text-blue-400 hover:text-blue-300 ml-1">ServisHub</a>
                </div>

                <!-- Skeleton while loading (shows by default, hidden when loaded) -->
                <div x-show="!subscriptionLoaded" class="license-skeleton rounded-xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <div class="skeleton-bar w-9 h-9"></div>
                            <div>
                                <div class="skeleton-bar w-16 h-3 mb-1"></div>
                                <div class="skeleton-bar w-12 h-4"></div>
                            </div>
                        </div>
                        <div class="skeleton-bar w-14 h-5 rounded-full"></div>
                    </div>
                    <div class="skeleton-bar h-3 rounded-full mb-2"></div>
                    <div class="skeleton-bar w-24 h-3 mx-auto"></div>
                </div>

                <!-- Actual widget when loaded -->
                <a x-show="subscriptionLoaded" x-cloak href="/settings?tab=subscription" class="block">
                    <div class="subscription-widget rounded-xl p-4 transition-all hover:scale-[1.02] relative overflow-hidden license-widget"
                         :class="getWidgetClass()">
                        <!-- Shimmer effect -->
                        <div class="absolute inset-0 -translate-x-full animate-shimmer bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>

                        <!-- Header -->
                        <div class="flex items-center justify-between mb-3 relative">
                            <div class="flex items-center gap-2">
                                <div class="w-9 h-9 rounded-lg flex items-center justify-center"
                                     :class="getIconBgClass()">
                                    <!-- Key icon -->
                                    <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z"/>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-xs font-bold opacity-90" x-text="getPlanLabel()"></p>
                                    <p class="text-sm font-bold" x-text="getPlanName()"></p>
                                </div>
                            </div>
                            <span class="text-xs px-2 py-0.5 rounded-full font-medium"
                                  :class="getStatusPillClass()"
                                  x-text="getStatusPillText()"></span>
                        </div>

                        <!-- Progress bar -->
                        <div x-show="totalDays > 0" class="mb-2 relative">
                            <div class="h-3 rounded-full bg-white/20 overflow-hidden">
                                <div class="h-full rounded-full transition-all duration-500"
                                     :class="getProgressBarClass()"
                                     :style="'width: ' + getProgressPercent() + '%'"></div>
                            </div>
                        </div>

                        <!-- Days info -->
                        <div class="text-xs text-center">
                            <!-- GRACE period - neplacen racun, 15 dana za placanje -->
                            <template x-if="subscriptionStatus === 'GRACE'">
                                <span class="opacity-80">Jos <strong x-text="graceDaysRemaining"></strong> dana za placanje</span>
                            </template>
                            <!-- SUSPENDED - samo pregled -->
                            <template x-if="subscriptionStatus === 'SUSPENDED'">
                                <span class="text-red-200">Samo pregled i zatvaranje naloga</span>
                            </template>
                            <template x-if="subscriptionStatus === 'CANCELLED'">
                                <span class="text-gray-300">Nalog je otkazan</span>
                            </template>
                            <!-- Active statuses -->
                            <template x-if="subscriptionStatus === 'ACTIVE' || subscriptionStatus === 'TRIAL' || subscriptionStatus === 'DEMO' || subscriptionStatus === 'PROMO'">
                                <span class="opacity-80">
                                    Traje jos <strong x-text="daysRemaining"></strong> dana
                                    <span class="opacity-70" x-text="'(do ' + getEndDate() + ')'"></span>
                                </span>
                            </template>
                        </div>

                        <!-- Neplacen racun warning - only for GRACE status -->
                        <div x-show="subscriptionStatus === 'GRACE'" class="mt-2 flex items-center gap-1 text-xs text-amber-200">
                            <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                            </svg>
                            <span>Neplacen racun</span>
                        </div>
                    </div>
                </a>
            </li>
        </ul>
    </nav>
</div>

<script>
// Cache key for sidebar data
const SIDEBAR_CACHE_KEY = 'servishub_sidebar_cache';
const CACHE_TTL_MS = 5 * 60 * 1000; // 5 minutes

function sidebarData() {
    return {
        subscriptionStatus: null,
        daysRemaining: null,
        graceDaysRemaining: null,
        totalDays: 30,
        locationCount: 1,
        tenantName: '',
        userRole: '',
        roleLoaded: false,
        subscriptionLoaded: false,
        posEnabled: false,
        creditsEnabled: false,

        init() {
            // 1. Load from cache immediately (no flicker)
            this.loadFromCache();

            // 2. Refresh from API in background (if cache expired or missing)
            this.refreshFromAPI();
        },

        loadFromCache() {
            try {
                const cached = sessionStorage.getItem(SIDEBAR_CACHE_KEY);
                if (cached) {
                    const data = JSON.parse(cached);
                    // Apply cached data immediately
                    this.tenantName = data.tenantName || 'Servis';
                    this.userRole = data.userRole || '';
                    this.subscriptionStatus = data.subscriptionStatus;
                    this.daysRemaining = data.daysRemaining;
                    this.graceDaysRemaining = data.graceDaysRemaining || 0;
                    this.locationCount = data.locationCount || 1;
                    this.totalDays = data.totalDays || 30;

                    // Mark as loaded if we have data
                    this.posEnabled = data.posEnabled || false;
                    this.creditsEnabled = data.creditsEnabled || false;
                    if (data.userRole) this.roleLoaded = true;
                    if (data.subscriptionStatus) this.subscriptionLoaded = true;
                }
            } catch (e) {
                console.warn('Failed to load sidebar cache:', e);
            }
        },

        saveToCache() {
            try {
                const data = {
                    tenantName: this.tenantName,
                    userRole: this.userRole,
                    subscriptionStatus: this.subscriptionStatus,
                    daysRemaining: this.daysRemaining,
                    graceDaysRemaining: this.graceDaysRemaining,
                    locationCount: this.locationCount,
                    totalDays: this.totalDays,
                    posEnabled: this.posEnabled,
                    creditsEnabled: this.creditsEnabled,
                    cachedAt: Date.now()
                };
                sessionStorage.setItem(SIDEBAR_CACHE_KEY, JSON.stringify(data));
            } catch (e) {
                console.warn('Failed to save sidebar cache:', e);
            }
        },

        isCacheValid() {
            try {
                const cached = sessionStorage.getItem(SIDEBAR_CACHE_KEY);
                if (!cached) return false;
                const data = JSON.parse(cached);
                return data.cachedAt && (Date.now() - data.cachedAt) < CACHE_TTL_MS;
            } catch (e) {
                return false;
            }
        },

        async refreshFromAPI() {
            // Skip API call if cache is still valid
            if (this.isCacheValid() && this.subscriptionLoaded) {
                return;
            }

            // Fetch fresh data
            await Promise.all([
                this.loadTenantName(),
                this.loadSubscriptionStatus(),
                this.loadFeatureFlags()
            ]);

            // Save to cache
            this.saveToCache();
        },

        async loadTenantName() {
            try {
                const res = await api('/api/v1/auth/me');
                if (res.ok) {
                    const data = await res.json();
                    this.tenantName = data.tenant?.name || 'Servis';
                    this.userRole = data.user?.role || '';
                }
            } catch (e) {
                console.error('Failed to load tenant name:', e);
            }
            this.roleLoaded = true;
        },

        isAdmin() {
            const adminRoles = ['OWNER', 'ADMIN', 'MANAGER'];
            return this.roleLoaded && adminRoles.includes(this.userRole);
        },

        async loadFeatureFlags() {
            try {
                const res = await api('/api/v1/tenant/features');
                if (res.ok) {
                    const data = await res.json();
                    this.posEnabled = data.pos_enabled || false;
                    this.creditsEnabled = data.credits_enabled || false;
                }
            } catch (e) {
                console.error('Failed to load feature flags:', e);
            }
        },

        async loadSubscriptionStatus() {
            try {
                const res = await api('/api/v1/tenant/subscription');
                if (res.ok) {
                    const data = await res.json();
                    this.subscriptionStatus = data.status;
                    this.daysRemaining = data.days_remaining;
                    this.graceDaysRemaining = data.grace_days_remaining || 0;
                    this.locationCount = data.pricing?.locations_count || 1;
                    // Calculate total days based on plan type
                    if (data.status === 'DEMO') this.totalDays = 7;
                    else if (data.status === 'TRIAL') this.totalDays = 14;
                    else if (data.status === 'PROMO') this.totalDays = 60; // 2 months
                    else if (data.status === 'GRACE') this.totalDays = 15;
                    else this.totalDays = 30;
                }
            } catch (e) {
                console.error('Failed to load subscription status:', e);
            }
            this.subscriptionLoaded = true;
        },

        getPlanName() {
            // Always show location count
            const lokacija = this.locationCount === 1 ? 'Lokacija' : 'Lokacije';
            return `${this.locationCount} ${lokacija}`;
        },

        getPlanLabel() {
            // Licenca: Type
            const types = {
                'DEMO': 'Demo',
                'TRIAL': 'Trial',
                'PROMO': 'Promo',
                'ACTIVE': 'Standard',
                'GRACE': 'Na reč',
                'SUSPENDED': 'Suspendovano',
                'CANCELLED': 'Otkazano'
            };
            const type = types[this.subscriptionStatus] || '';
            return type ? `Licenca: ${type}` : 'Licenca';
        },

        getWidgetClass() {
            const classes = {
                'DEMO': 'bg-gradient-to-br from-slate-600 to-slate-700 text-white',
                'TRIAL': 'bg-gradient-to-br from-blue-600 to-indigo-700 text-white',
                'PROMO': 'bg-gradient-to-br from-purple-600 to-indigo-700 text-white',
                'ACTIVE': 'bg-gradient-to-br from-emerald-600 to-teal-700 text-white',
                'GRACE': 'bg-gradient-to-br from-amber-600 to-orange-700 text-white',
                'SUSPENDED': 'bg-gradient-to-br from-red-700 to-red-800 text-white',
                'CANCELLED': 'bg-gradient-to-br from-gray-600 to-gray-700 text-white'
            };
            return classes[this.subscriptionStatus] || 'bg-gradient-to-br from-gray-600 to-gray-700 text-white';
        },

        getIconBgClass() {
            // Yellow background for key icon
            return 'bg-amber-400';
        },

        getStatusPillClass() {
            if (this.subscriptionStatus === 'ACTIVE' || this.subscriptionStatus === 'TRIAL' || this.subscriptionStatus === 'DEMO' || this.subscriptionStatus === 'PROMO') {
                // Green button for active status
                return 'bg-emerald-500 text-white';
            }
            if (this.subscriptionStatus === 'GRACE') {
                return 'bg-amber-500 text-white';
            }
            if (this.subscriptionStatus === 'SUSPENDED') {
                return 'bg-red-500 text-white';
            }
            return 'bg-white/10 text-white/70';
        },

        getStatusPillText() {
            if (this.subscriptionStatus === 'ACTIVE' || this.subscriptionStatus === 'TRIAL' || this.subscriptionStatus === 'DEMO' || this.subscriptionStatus === 'PROMO') {
                return 'Aktivno';
            }
            if (this.subscriptionStatus === 'GRACE') {
                return 'Neplaceno';
            }
            return 'Neaktivno';
        },

        getProgressBarClass() {
            if (this.subscriptionStatus === 'GRACE') return 'bg-amber-400';
            if (this.daysRemaining <= 3) return 'bg-red-400';
            if (this.daysRemaining <= 7) return 'bg-amber-400';
            return 'bg-white/80';
        },

        getProgressPercent() {
            if (this.subscriptionStatus === 'GRACE') {
                // For grace period, show how many days left out of 15
                return Math.max(0, Math.min(100, (this.graceDaysRemaining / 15) * 100));
            }
            if (this.totalDays <= 0) return 0;
            const percent = (this.daysRemaining / this.totalDays) * 100;
            return Math.max(0, Math.min(100, percent));
        },

        getEndDate() {
            if (!this.daysRemaining) return '';
            const endDate = new Date();
            endDate.setDate(endDate.getDate() + this.daysRemaining);
            return endDate.toLocaleDateString('sr-RS', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
    }
}
</script>