<!-- Tenant Sidebar - Dark Glassmorphic Theme -->
<div x-data="sidebarData()" x-init="loadSubscriptionStatus()" class="flex grow flex-col gap-y-5 overflow-y-auto px-6 pb-4">
    <!-- Logo -->
    <div class="flex h-16 shrink-0 items-center">
        <a href="/dashboard" class="flex items-center">
            <div class="h-8 w-8 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                <svg class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
            </div>
            <span class="ml-3 text-xl font-bold text-slate-100">ServisHub</span>
        </a>
    </div>

    <!-- Navigation -->
    <nav class="flex flex-1 flex-col">
        <ul role="list" class="flex flex-1 flex-col gap-y-7">
            <li>
                <ul role="list" class="-mx-2 space-y-1">
                    <!-- Dashboard -->
                    <li>
                        <a href="/dashboard"
                           class="nav-item group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6"
                           :class="{ 'active': window.location.pathname === '/dashboard' }">
                            <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                            </svg>
                            Dashboard
                        </a>
                    </li>

                    <!-- Tickets -->
                    <li>
                        <a href="/tickets"
                           class="nav-item group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6"
                           :class="{ 'active': window.location.pathname.startsWith('/tickets') }">
                            <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" />
                            </svg>
                            Servisni nalozi
                        </a>
                    </li>

                    <!-- Inventory -->
                    <li x-data="{ open: window.location.pathname.startsWith('/inventory') }">
                        <button @click="open = !open"
                                class="nav-item w-full group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6"
                                :class="{ 'active': window.location.pathname.startsWith('/inventory') }">
                            <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
                            </svg>
                            Inventar
                            <svg class="ml-auto h-5 w-5 shrink-0 transition-transform" :class="{ 'rotate-90': open }" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <ul x-show="open" x-collapse class="nav-submenu mt-1 px-2">
                            <li>
                                <a href="/inventory/phones"
                                   class="block rounded-md py-2 pl-9 pr-2 text-sm"
                                   :class="{ 'active': window.location.pathname === '/inventory/phones' }">
                                    Telefoni
                                </a>
                            </li>
                            <li>
                                <a href="/inventory/parts"
                                   class="block rounded-md py-2 pl-9 pr-2 text-sm"
                                   :class="{ 'active': window.location.pathname === '/inventory/parts' }">
                                    Rezervni delovi
                                </a>
                            </li>
                        </ul>
                    </li>

                    <!-- Marketplace -->
                    <li>
                        <a href="/marketplace"
                           class="nav-item group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6"
                           :class="{ 'active': window.location.pathname.startsWith('/marketplace') }">
                            <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 21v-7.5a.75.75 0 01.75-.75h3a.75.75 0 01.75.75V21m-4.5 0H2.36m11.14 0H18m0 0h3.64m-1.39 0V9.349m-16.5 11.65V9.35m0 0a3.001 3.001 0 003.75-.615A2.993 2.993 0 009.75 9.75c.896 0 1.7-.393 2.25-1.016a2.993 2.993 0 002.25 1.016c.896 0 1.7-.393 2.25-1.016a3.001 3.001 0 003.75.614m-16.5 0a3.004 3.004 0 01-.621-4.72L4.318 3.44A1.5 1.5 0 015.378 3h13.243a1.5 1.5 0 011.06.44l1.19 1.189a3 3 0 01-.621 4.72m-13.5 8.65h3.75a.75.75 0 00.75-.75V13.5a.75.75 0 00-.75-.75H6.75a.75.75 0 00-.75.75v3.75c0 .415.336.75.75.75z" />
                            </svg>
                            Marketplace
                        </a>
                    </li>

                    <!-- Orders -->
                    <li>
                        <a href="/orders"
                           class="nav-item group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6"
                           :class="{ 'active': window.location.pathname.startsWith('/orders') }">
                            <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 00-16.536-1.84M7.5 14.25L5.106 5.272M6 20.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm12.75 0a.75.75 0 11-1.5 0 .75.75 0 011.5 0z" />
                            </svg>
                            Narudzbine
                        </a>
                    </li>
                </ul>
            </li>

            <!-- Settings Section -->
            <li>
                <ul role="list" class="-mx-2 space-y-1">
                    <li>
                        <a href="/settings"
                           class="nav-item group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6"
                           :class="{ 'active': window.location.pathname === '/settings' }">
                            <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            Podesavanja
                        </a>
                    </li>
                </ul>
            </li>

            <!-- Subscription Widget -->
            <li class="mt-auto -mx-2">
                <a href="/settings?tab=subscription" class="block">
                    <div class="subscription-widget rounded-xl p-4 transition-all hover:scale-[1.02]"
                         :class="getWidgetClass()">
                        <!-- Header -->
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded-lg flex items-center justify-center"
                                     :class="getIconBgClass()">
                                    <svg class="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-xs font-medium opacity-70" x-text="getPlanLabel()"></p>
                                    <p class="text-sm font-bold" x-text="getPlanName()"></p>
                                </div>
                            </div>
                            <span class="text-xs px-2 py-0.5 rounded-full font-medium"
                                  :class="getStatusPillClass()"
                                  x-text="subscriptionStatus === 'ACTIVE' || subscriptionStatus === 'TRIAL' || subscriptionStatus === 'DEMO' ? 'Aktivno' : 'Neaktivno'"></span>
                        </div>

                        <!-- Progress bar -->
                        <div x-show="totalDays > 0" class="mb-2">
                            <div class="h-1.5 rounded-full bg-white/20 overflow-hidden">
                                <div class="h-full rounded-full transition-all duration-500"
                                     :class="getProgressBarClass()"
                                     :style="'width: ' + getProgressPercent() + '%'"></div>
                            </div>
                        </div>

                        <!-- Days info -->
                        <div class="text-xs">
                            <template x-if="subscriptionStatus === 'EXPIRED'">
                                <span class="text-red-200">Isteklo pre <strong x-text="Math.abs(daysRemaining)"></strong> dana</span>
                            </template>
                            <template x-if="subscriptionStatus === 'SUSPENDED'">
                                <span class="text-red-200">Nalog je blokiran</span>
                            </template>
                            <template x-if="subscriptionStatus === 'CANCELLED'">
                                <span class="text-gray-300">Nalog je otkazan</span>
                            </template>
                            <template x-if="subscriptionStatus === 'ACTIVE' || subscriptionStatus === 'TRIAL' || subscriptionStatus === 'DEMO'">
                                <span class="opacity-80">Traje jos <strong x-text="daysRemaining"></strong> dana</span>
                            </template>
                        </div>

                        <!-- Debt warning -->
                        <div x-show="hasDebt" class="mt-2 flex items-center gap-1 text-xs text-amber-200">
                            <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                            </svg>
                            <span>Neplacen racun</span>
                        </div>
                    </div>
                </a>
            </li>
        </ul>
    </nav>
</div>

<script>
function sidebarData() {
    return {
        subscriptionStatus: null,
        daysRemaining: null,
        totalDays: 30,
        hasDebt: false,
        locationCount: 1,

        async loadSubscriptionStatus() {
            try {
                const res = await api('/api/v1/tenant/subscription');
                if (res.ok) {
                    const data = await res.json();
                    this.subscriptionStatus = data.status;
                    this.daysRemaining = data.days_remaining;
                    this.hasDebt = data.billing?.has_debt || false;
                    this.locationCount = data.pricing?.location_count || 1;
                    // Calculate total days based on plan type
                    if (data.status === 'DEMO') this.totalDays = 7;
                    else if (data.status === 'TRIAL') this.totalDays = 14;
                    else this.totalDays = 30;
                }
            } catch (e) {
                console.error('Failed to load subscription status:', e);
            }
        },

        getPlanName() {
            const names = {
                'DEMO': 'Demo',
                'TRIAL': 'Promo',
                'ACTIVE': 'Standard',
                'EXPIRED': 'Istekla',
                'SUSPENDED': 'Blokiran',
                'CANCELLED': 'Otkazan'
            };
            return names[this.subscriptionStatus] || this.subscriptionStatus;
        },

        getPlanLabel() {
            if (this.subscriptionStatus === 'EXPIRED' || this.subscriptionStatus === 'SUSPENDED' || this.subscriptionStatus === 'CANCELLED') {
                return 'Licenca';
            }
            return this.locationCount + ' lokacija' + (this.locationCount > 1 ? 'e' : '');
        },

        getWidgetClass() {
            const classes = {
                'DEMO': 'bg-gradient-to-br from-slate-600 to-slate-700 text-white',
                'TRIAL': 'bg-gradient-to-br from-blue-600 to-indigo-700 text-white',
                'ACTIVE': 'bg-gradient-to-br from-emerald-600 to-teal-700 text-white',
                'EXPIRED': 'bg-gradient-to-br from-red-600 to-rose-700 text-white',
                'SUSPENDED': 'bg-gradient-to-br from-red-700 to-red-800 text-white',
                'CANCELLED': 'bg-gradient-to-br from-gray-600 to-gray-700 text-white'
            };
            return classes[this.subscriptionStatus] || 'bg-gradient-to-br from-gray-600 to-gray-700 text-white';
        },

        getIconBgClass() {
            const classes = {
                'DEMO': 'bg-white/20',
                'TRIAL': 'bg-white/20',
                'ACTIVE': 'bg-white/20',
                'EXPIRED': 'bg-white/20',
                'SUSPENDED': 'bg-white/20',
                'CANCELLED': 'bg-white/20'
            };
            return classes[this.subscriptionStatus] || 'bg-white/20';
        },

        getStatusPillClass() {
            if (this.subscriptionStatus === 'ACTIVE' || this.subscriptionStatus === 'TRIAL' || this.subscriptionStatus === 'DEMO') {
                return 'bg-white/20 text-white';
            }
            return 'bg-white/10 text-white/70';
        },

        getProgressBarClass() {
            if (this.daysRemaining <= 3) return 'bg-red-400';
            if (this.daysRemaining <= 7) return 'bg-amber-400';
            return 'bg-white/80';
        },

        getProgressPercent() {
            if (this.totalDays <= 0) return 0;
            const percent = (this.daysRemaining / this.totalDays) * 100;
            return Math.max(0, Math.min(100, percent));
        }
    }
}
</script>